<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Master NestJS - The JavaScript Node.js Framework, HTML,CSS,React,Vue,Java,Go,微服务,linux">
    <meta name="description" content="2. Introduction to NestJS2.1. Installing and Using Nest CLInpm i -g @nestjs/cli


创建新项目

# nest new 
nest new nest-event">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Master NestJS - The JavaScript Node.js Framework | malred-blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/logo.png" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">malred-blog</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">malred-blog</div>
        <div class="logo-desc">
            
            前后端学习者,存放知识笔记
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
    </ul>

    <div class="social-link">
    <a href="https://github.com/malred" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:malguy2022@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2725953379" class="tooltipped" data-tooltip="QQ联系我: 2725953379" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
</div>

            </div>
        </div>

        
    </nav>
</header>


<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Master NestJS - The JavaScript Node.js Framework
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%89%8D%E7%AB%AF/" target="_blank">
                                <span class="chip bg-color">前端</span>
                            </a>
                        
                            <a href="/tags/nest/" target="_blank">
                                <span class="chip bg-color">nest</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/nest/" class="post-category" target="_blank">
                                nest
                            </a>
                        
                            <a href="/categories/nest/%E5%89%8D%E7%AB%AF/" class="post-category" target="_blank">
                                前端
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-06-25
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        7.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        44 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="2-Introduction-to-NestJS"><a href="#2-Introduction-to-NestJS" class="headerlink" title="2. Introduction to NestJS"></a>2. Introduction to NestJS</h1><h2 id="2-1-Installing-and-Using-Nest-CLI"><a href="#2-1-Installing-and-Using-Nest-CLI" class="headerlink" title="2.1. Installing and Using Nest CLI"></a>2.1. Installing and Using Nest CLI</h2><pre class=" language-shell"><code class="language-shell">npm i -g @nestjs/cli
</code></pre>
<blockquote>
<p>创建新项目</p>
</blockquote>
<pre class=" language-shell"><code class="language-shell"># nest new <project-name-here>
nest new nest-events-backend
</code></pre>
<p><img src="20230625202936.png" alt="选npm"></p>
<pre class=" language-shell"><code class="language-shell">npm run start:dev
</code></pre>
<p><img src="20230625203136.png" alt="默认端口3000"></p>
<h2 id="2-2-NestJS-Project-Structure"><a href="#2-2-NestJS-Project-Structure" class="headerlink" title="2.2. NestJS Project Structure"></a>2.2. NestJS Project Structure</h2><p><img src="20230625203048.png"><br><img src="20230625203228.png"><br><img src="20230625203254.png"><br><img src="20230625203340.png" alt="装饰器模式,注解"><br><img src="20230625203406.png" alt="请求处理器"><br><img src="20230625203421.png" alt="service"><br><img src="20230625203447.png" alt="控制器的测试文件"><br><img src="20230625203509.png"></p>
<h1 id="3-Rest-API"><a href="#3-Rest-API" class="headerlink" title="3. Rest API"></a>3. Rest API</h1><h2 id="3-1-Controllers"><a href="#3-1-Controllers" class="headerlink" title="3.1. Controllers"></a>3.1. Controllers</h2><p><img src="20230625203822.png"><br><img src="20230625203938.png"></p>
<pre class=" language-ts"><code class="language-ts">  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/bye"</span><span class="token punctuation">)</span>
  <span class="token function">getBye</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Bye!"</span>
  <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230625204104.png"><br><img src="20230625204115.png"></p>
<h2 id="3-2-Resource-Controller"><a href="#3-2-Resource-Controller" class="headerlink" title="3.2. Resource Controller"></a>3.2. Resource Controller</h2><p><img src="20230625204151.png" alt="what is resource"><br><img src="20230625204302.png" alt="生成controller"></p>
<pre class=" language-shell"><code class="language-shell">nest generate controller
nest g co
</code></pre>
<p><img src="20230625204406.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Delete<span class="token punctuation">,</span> Patch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"events"</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230625204829.png"><br><img src="20230625205628.png"></p>
<h2 id="3-3-Route-Parameters"><a href="#3-3-Route-Parameters" class="headerlink" title="3.3. Route Parameters"></a>3.3. Route Parameters</h2><p><img src="20230625205704.png"></p>
<blockquote>
<p>获取路由中特定参数</p>
</blockquote>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230625205935.png"></p>
<blockquote>
<p>@Param()没有指定路由参数名称,则获取所有</p>
</blockquote>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id/:event'</span><span class="token punctuation">)</span>
    <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token punctuation">)</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> params<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230625210122.png"><br><img src="20230625210220.png"></p>
<h2 id="3-4-Request-Body"><a href="#3-4-Request-Body" class="headerlink" title="3.4. Request Body"></a>3.4. Request Body</h2><pre class=" language-ts"><code class="language-ts">    @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> input<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230625210453.png"></p>
<h2 id="3-5-Responses-and-Status-Codes"><a href="#3-5-Responses-and-Status-Codes" class="headerlink" title="3.5. Responses and Status Codes"></a>3.5. Responses and Status Codes</h2><p><img src="20230625210520.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'First event'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'Second event'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// localhost:3000/events/id</span>
    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">'First event'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230625210902.png"><br><img src="20230625210819.png"><br><img src="20230625210916.png"><br><img src="20230625210948.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    <span class="token function">update</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">,</span> @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> input<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    @<span class="token function">HttpCode</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span>
    <span class="token function">remove</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230625211147.png"></p>
<h2 id="3-6-Request-Payload-Data-Transfer-Objects"><a href="#3-6-Request-Payload-Data-Transfer-Objects" class="headerlink" title="3.6. Request Payload - Data Transfer Objects"></a>3.6. Request Payload - Data Transfer Objects</h2><p><img src="20230626104125.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateEventDto</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  description<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  when<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  address<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626104909.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> CreateEventDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// DTO: data transfer object 定义了一个数据结构</span>
        <span class="token keyword">return</span> input<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="3-7-The-Update-Payload"><a href="#3-7-The-Update-Payload" class="headerlink" title="3.7. The Update Payload"></a>3.7. The Update Payload</h2><pre class=" language-ts"><code class="language-ts">    @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    <span class="token function">update</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">,</span> @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> UpdateEventDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> input<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>可选参数</p>
</blockquote>
<p><img src="20230626105308.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UpdateEventDto</span> <span class="token punctuation">{</span>
  name<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ?代表可选</span>
  description<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  when<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  address<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>另一种方式</p>
</blockquote>
<pre class=" language-shell"><code class="language-shell">npm i --save @nestjs/mapped-types
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> PartialType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/mapped-types"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./create-event.dto"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 继承CreateEventDto的所有字段,并且是可选的</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UpdateEventDto</span> <span class="token keyword">extends</span> <span class="token class-name">PartialType</span><span class="token punctuation">(</span>CreateEventDto<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<h2 id="3-8-A-Working-API-Example"><a href="#3-8-A-Working-API-Example" class="headerlink" title="3.8. A Working API Example"></a>3.8. A Working API Example</h2><p><img src="20230626111017.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  description<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  when<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>
  address<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626111218.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  Patch<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./create-event.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./update-event.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"events"</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsController</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> events<span class="token punctuation">:</span> Event<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// localhost:3000/events/id</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> event<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> CreateEventDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>input<span class="token punctuation">,</span>
      when<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">,</span>
      id<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> event<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">)</span>
  <span class="token function">update</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> id<span class="token punctuation">,</span> @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> UpdateEventDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 根据id找到要修改的</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> event<span class="token punctuation">.</span>id <span class="token operator">===</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>input<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 后面的会覆盖前面的</span>
      when<span class="token punctuation">:</span> input<span class="token punctuation">.</span>when <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>when<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">)</span>
  @<span class="token function">HttpCode</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span>
  <span class="token function">remove</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> event<span class="token punctuation">.</span>id <span class="token operator">!==</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="4-Database-Basics"><a href="#4-Database-Basics" class="headerlink" title="4. Database Basics"></a>4. Database Basics</h1><h2 id="4-1-Adding-Docker-to-the-Stack"><a href="#4-1-Adding-Docker-to-the-Stack" class="headerlink" title="4.1. Adding Docker to the Stack"></a>4.1. Adding Docker to the Stack</h2><p><img src="20230626112321.png"><br><img src="20230626112347.png"><br><img src="20230626112407.png"></p>
<h2 id="4-2-Running-the-Database-with-Docker-Compose"><a href="#4-2-Running-the-Database-with-Docker-Compose" class="headerlink" title="4.2. Running the Database with Docker Compose"></a>4.2. Running the Database with Docker Compose</h2><pre class=" language-yml"><code class="language-yml">version: "3.8"

services:
  mysql:
    image: mysql:8.0.23
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: example
    ports:
      - 3306:3306

  postgres:
    image: postgres:13.1
    restart: always
    environment:
      POSTGRES_PASSWORD: example
    ports:
      - 5432:5432

  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
</code></pre>
<pre class=" language-shell"><code class="language-shell"># 在有docker-compose.yml文件的目录运行
docker-compose up
</code></pre>
<p><img src="20230626112906.png"><br><img src="20230626112931.png"><br><img src="20230626112943.png"><br><img src="20230626113000.png"><br><img src="20230626113043.png"></p>
<h2 id="4-3-Introduction-to-ORMs"><a href="#4-3-Introduction-to-ORMs" class="headerlink" title="4.3. Introduction to ORMs"></a>4.3. Introduction to ORMs</h2><p><img src="20230626114202.png"></p>
<h2 id="4-5-Connecting-to-the-Database"><a href="#4-5-Connecting-to-the-Database" class="headerlink" title="4.5. Connecting to the Database"></a>4.5. Connecting to the Database</h2><pre class=" language-shell"><code class="language-shell">npm i --save @nestjs/typeorm typeorm mysql
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./app.controller"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./app.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventsController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./events/events.controller"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 导入orm框架,配置数据库连接</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    TypeOrmModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">"mysql"</span><span class="token punctuation">,</span>
      host<span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
      port<span class="token punctuation">:</span> <span class="token number">3307</span><span class="token punctuation">,</span>
      username<span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      password<span class="token punctuation">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>
      database<span class="token punctuation">:</span> <span class="token string">"nest-events"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment" spellcheck="true">// 引入controller</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">,</span> EventsController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<h2 id="4-7-The-Entity-Primary-Key-amp-Columns"><a href="#4-7-The-Entity-Primary-Key-amp-Columns" class="headerlink" title="4.7. The Entity (Primary Key &amp; Columns)"></a>4.7. The Entity (Primary Key &amp; Columns)</h2><pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.entity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Column<span class="token punctuation">,</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// name: 表名</span>
<span class="token comment" spellcheck="true">// @Entity('event', { name: 'event' })</span>
@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 改变name不会删旧表,而是会创建新表</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// @PrimaryGeneratedColumn('uuid')</span>
  <span class="token comment" spellcheck="true">// @PrimaryGeneratedColumn('rowid')</span>
  <span class="token comment" spellcheck="true">// @PrimaryColumn() // 如果是复合主键,就在每个主键上加</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 自动生成</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  description<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// name指定列名</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"when_date"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  when<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  address<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./app.controller"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./app.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventsController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./events/events.controller"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./events/event.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 导入orm框架,配置数据库连接</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    TypeOrmModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">"mysql"</span><span class="token punctuation">,</span>
      host<span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
      port<span class="token punctuation">:</span> <span class="token number">3307</span><span class="token punctuation">,</span>
      username<span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
      password<span class="token punctuation">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>
      database<span class="token punctuation">:</span> <span class="token string">"nest-events"</span><span class="token punctuation">,</span>
      <span class="token comment" spellcheck="true">// 使用实体需要在这里引入</span>
      entities<span class="token punctuation">:</span> <span class="token punctuation">[</span>Event<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment" spellcheck="true">// 自动建表，你修改 Entity 里面字段，</span>
      <span class="token comment" spellcheck="true">// 或者 *.entity{.ts,.js } 的名字，都会自动帮你修改。</span>
      synchronize<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment" spellcheck="true">// 引入controller</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">,</span> EventsController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626142440.png"></p>
<h2 id="4-8-Repository-Pattern"><a href="#4-8-Repository-Pattern" class="headerlink" title="4.8. Repository Pattern"></a>4.8. Repository Pattern</h2><p><img src="20230626143326.png"><br><img src="20230626143349.png"><br><img src="20230626143356.png"></p>
<h2 id="4-9-Repository-in-Practice"><a href="#4-9-Repository-in-Practice" class="headerlink" title="4.9. Repository in Practice"></a>4.9. Repository in Practice</h2><pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  Patch<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./create-event.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./update-event.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm/repository/Repository"</span><span class="token punctuation">;</span>
@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"events"</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsController</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 依赖注入</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Event<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly respository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Event<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  async <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>respository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// localhost:3000/events/id</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">)</span>
  async <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>respository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  async <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> CreateEventDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>respository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>input<span class="token punctuation">,</span>
      when<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">)</span>
  async <span class="token function">update</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> id<span class="token punctuation">,</span> @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> UpdateEventDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>respository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>respository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>event<span class="token punctuation">,</span>
      <span class="token operator">...</span>input<span class="token punctuation">,</span>
      when<span class="token punctuation">:</span> input<span class="token punctuation">.</span>when <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">:</span> event<span class="token punctuation">.</span>when<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">)</span>
  @<span class="token function">HttpCode</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span>
  async <span class="token function">remove</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>respository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    await <span class="token keyword">this</span><span class="token punctuation">.</span>respository<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626144507.png"></p>
<h2 id="4-10-Repository-Querying-Criteria-and-Options"><a href="#4-10-Repository-Querying-Criteria-and-Options" class="headerlink" title="4.10. Repository Querying Criteria and Options"></a>4.10. Repository Querying Criteria and Options</h2><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>event<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token keyword">when</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token string">'Let\'s meet together.'</span><span class="token punctuation">,</span>    <span class="token string">'2021-02-15 21:00:00'</span><span class="token punctuation">,</span>    <span class="token string">'Office St 120'</span><span class="token punctuation">,</span>    <span class="token string">'Team Meetup'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>    <span class="token string">'Let\'s learn something.'</span><span class="token punctuation">,</span>    <span class="token string">'2021-02-17 21:00:00'</span><span class="token punctuation">,</span>    <span class="token string">'Workshop St 80'</span><span class="token punctuation">,</span>    <span class="token string">'Workshop'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>    <span class="token string">'Let\'s meet with big bosses'</span><span class="token punctuation">,</span>    <span class="token string">'2021-02-17 21:00:00'</span><span class="token punctuation">,</span>    <span class="token string">'Boss St 100'</span><span class="token punctuation">,</span>    <span class="token string">'Strategy Meeting'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span>    <span class="token string">'Let\'s try to sell stuff'</span><span class="token punctuation">,</span>    <span class="token string">'2021-02-11 21:00:00'</span><span class="token punctuation">,</span>    <span class="token string">'Money St 34'</span><span class="token punctuation">,</span>    <span class="token string">'Sales Pitch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>    <span class="token string">'People meet to talk about business ideas'</span><span class="token punctuation">,</span>    <span class="token string">'2021-02-12 21:00:00'</span><span class="token punctuation">,</span>    <span class="token string">'Invention St 123'</span><span class="token punctuation">,</span>    <span class="token string">'Founders Meeting'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<blockquote>
<p>如果请求方法不对,也会报错 You must provide selection conditions in order to find a single row</p>
</blockquote>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice'</span><span class="token punctuation">)</span>
    async <span class="token function">practice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626151216.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice'</span><span class="token punctuation">)</span>
    async <span class="token function">practice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626151233.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice'</span><span class="token punctuation">)</span>
    async <span class="token function">practice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                id<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                when<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2021-02-12T13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626153333.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice'</span><span class="token punctuation">)</span>
    async <span class="token function">practice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 多个where是or</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    id<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    when<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2021-02-12T13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    description<span class="token punctuation">:</span> <span class="token function">Like</span><span class="token punctuation">(</span><span class="token string">'%meet%'</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626153512.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice'</span><span class="token punctuation">)</span>
    async <span class="token function">practice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 多个where是or</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    id<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    when<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2021-02-12T13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    description<span class="token punctuation">:</span> <span class="token function">Like</span><span class="token punctuation">(</span><span class="token string">'%meet%'</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 限制取几个</span>
            take<span class="token punctuation">:</span> <span class="token number">2</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626153700.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice'</span><span class="token punctuation">)</span>
    async <span class="token function">practice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 多个where是or</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    id<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    when<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2021-02-12T13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    description<span class="token punctuation">:</span> <span class="token function">Like</span><span class="token punctuation">(</span><span class="token string">'%meet%'</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 限制取几个</span>
            take<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            order<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 倒序</span>
                id<span class="token punctuation">:</span> <span class="token string">'desc'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626153801.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice'</span><span class="token punctuation">)</span>
    async <span class="token function">practice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 只取其中指定列</span>
            select<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'when'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 多个where是or</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    id<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    when<span class="token punctuation">:</span> <span class="token function">MoreThan</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2021-02-12T13:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    description<span class="token punctuation">:</span> <span class="token function">Like</span><span class="token punctuation">(</span><span class="token string">'%meet%'</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 限制取几个</span>
            take<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            order<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 倒序</span>
                id<span class="token punctuation">:</span> <span class="token string">'desc'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626153901.png"></p>
<h1 id="5-Data-Validation"><a href="#5-Data-Validation" class="headerlink" title="5. Data Validation"></a>5. Data Validation</h1><h2 id="5-1-Introduction-to-Pipes"><a href="#5-1-Introduction-to-Pipes" class="headerlink" title="5.1. Introduction to Pipes"></a>5.1. Introduction to Pipes</h2><p><img src="20230626154113.png"></p>
<pre class=" language-ts"><code class="language-ts">    <span class="token comment" spellcheck="true">// localhost:3000/events/id</span>
    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ParseIntPipe转为number类型</span>
    async <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> ParseIntPipe<span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// number</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>pipe 最有用的是用于参数校验</p>
</blockquote>
<h2 id="5-2-Input-Validation"><a href="#5-2-Input-Validation" class="headerlink" title="5.2. Input Validation"></a>5.2. Input Validation</h2><pre class=" language-shell"><code class="language-shell">npm i --save class-validator class-transformer
</code></pre>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ValidationPipe 自动校验</span>
    async <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span>ValidationPipe<span class="token punctuation">)</span> input<span class="token punctuation">:</span> CreateEventDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>input<span class="token punctuation">,</span>
            when<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Length <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-validator"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateEventDto</span> <span class="token punctuation">{</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  description<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  when<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  address<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626154724.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateEventDto</span> <span class="token punctuation">{</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">"the name length is wrong"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  description<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  when<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  address<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626154917.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateEventDto</span> <span class="token punctuation">{</span>
  @<span class="token function">IsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">"the name length is wrong"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
  description<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">IsDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  when<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
  address<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>开启全局验证,如果有使用 Dto,并且有校验装饰器(注解),则会自动校验,无需自己加 ValidationPipe</p>
</blockquote>
<blockquote>
<p>UpdateEventDto 继承了 CreateEventDto,它的属性也会带上校验注解.</p>
</blockquote>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// main.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/core"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./app.module"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ValidationPipe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>

async <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> await NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  await app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><img src="20230626155327.png"></p>
<h2 id="5-3-Validation-Groups-and-Options"><a href="#5-3-Validation-Groups-and-Options" class="headerlink" title="5.3. Validation Groups and Options"></a>5.3. Validation Groups and Options</h2><pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Length<span class="token punctuation">,</span> IsString<span class="token punctuation">,</span> IsDateString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-validator"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateEventDto</span> <span class="token punctuation">{</span>
  @<span class="token function">IsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">"the name length is wrong"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
  description<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">IsDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  when<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 分组</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> groups<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"create"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> groups<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"update"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  address<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ValidationPipe 自动校验</span>
    async <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> groups<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'create'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> CreateEventDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>input<span class="token punctuation">,</span>
            when<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    async <span class="token function">update</span><span class="token punctuation">(</span>
        @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">,</span>
        @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> groups<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'update'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> UpdateEventDto
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>

        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>event<span class="token punctuation">,</span> <span class="token operator">...</span>input<span class="token punctuation">,</span>
            when<span class="token punctuation">:</span> input<span class="token punctuation">.</span>when <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">:</span> event<span class="token punctuation">.</span>when
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>要使用分组校验,需要禁用全局校验</p>
</blockquote>
<p><img src="20230626163133.png"><br><img src="20230626163202.png"><br><img src="20230626163259.png" alt="也可以使用此装饰器"></p>
<h1 id="6-Modules-Providers-Dependency-Injection"><a href="#6-Modules-Providers-Dependency-Injection" class="headerlink" title="6. Modules, Providers, Dependency Injection"></a>6. Modules, Providers, Dependency Injection</h1><h2 id="6-1-Introduction-to-Modules-Providers-and-Dependency-Injection"><a href="#6-1-Introduction-to-Modules-Providers-and-Dependency-Injection" class="headerlink" title="6.1. Introduction to Modules, Providers and Dependency Injection"></a>6.1. Introduction to Modules, Providers and Dependency Injection</h2><p><img src="20230626163654.png"></p>
<pre class=" language-shell"><code class="language-shell">nest generate module events
</code></pre>
<p><img src="20230626164541.png"><br><img src="20230626164548.png"></p>
<h2 id="6-2-Creating-a-Custom-Module"><a href="#6-2-Creating-a-Custom-Module" class="headerlink" title="6.2. Creating a Custom Module"></a>6.2. Creating a Custom Module</h2><blockquote>
<p>使用@Module 定义的模块是静态的,提供固定功能,而动态模块提供多个可选的功能,动态模块可以按需导入</p>
</blockquote>
<p><img src="20230626164913.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// app.japan.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppJapanService</span> <span class="token punctuation">{</span>
  <span class="token function">getHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"ハローワールド"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626181257.png"><br><img src="20230626181234.png"><br><img src="20230626181652.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> Inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppJapanService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token string">"APP_NAME"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly name<span class="token punctuation">:</span> <span class="token keyword">string</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`ハローワールド from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626181642.png"><br><img src="20230626182011.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// app.dummy.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppDummy</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token function">dummy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"dummy"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626182136.png"><br><img src="20230626182145.png"></p>
<h1 id="7-Configuration-Logging-and-Errors"><a href="#7-Configuration-Logging-and-Errors" class="headerlink" title="7. Configuration, Logging, and Errors"></a>7. Configuration, Logging, and Errors</h1><h2 id="7-1-Application-Config-and-Environments"><a href="#7-1-Application-Config-and-Environments" class="headerlink" title="7.1. Application Config and Environments"></a>7.1. Application Config and Environments</h2><p><img src="20230626183926.png"></p>
<pre class=" language-shell"><code class="language-shell">npm i --save @nestjs/config
</code></pre>
<p><img src="20230626185050.png"><br><img src="20230626185101.png"><br><img src="20230626185110.png"><br><img src="20230626185123.png"><br><img src="20230626185408.png"><br><img src="20230626185400.png"></p>
<h2 id="7-2-Custom-Configuration-Files-and-Options"><a href="#7-2-Custom-Configuration-Files-and-Options" class="headerlink" title="7.2. Custom Configuration Files and Options"></a>7.2. Custom Configuration Files and Options</h2><blockquote>
<p>把 typeOrm 的配置放在单独的配置文件</p>
</blockquote>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// orm.config.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModuleOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/events/event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> registerAs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/config"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">registerAs</span><span class="token punctuation">(</span>
  <span class="token string">"org.config"</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> TypeOrmModuleOptions <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">"mysql"</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_HOST<span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_PORT<span class="token punctuation">)</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_USER<span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_PASS<span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_NAME<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 使用实体需要在这里引入</span>
    entities<span class="token punctuation">:</span> <span class="token punctuation">[</span>Event<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 自动建表，你修改 Entity 里面字段，</span>
    <span class="token comment" spellcheck="true">// 或者 *.entity{.ts,.js } 的名字，都会自动帮你修改。</span>
    synchronize<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// orm.config.prod.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModuleOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/events/event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> registerAs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/config"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">registerAs</span><span class="token punctuation">(</span>
  <span class="token string">"org.config"</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> TypeOrmModuleOptions <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">"mysql"</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_HOST<span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_PORT<span class="token punctuation">)</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_USER<span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_PASS<span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DB_NAME<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 使用实体需要在这里引入</span>
    entities<span class="token punctuation">:</span> <span class="token punctuation">[</span>Event<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 自动建表，你修改 Entity 里面字段，</span>
    <span class="token comment" spellcheck="true">// 或者 *.entity{.ts,.js } 的名字，都会自动帮你修改。</span>
    synchronize<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./app.controller"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./app.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventsModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./events/events.module"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppJapanService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./app.japan.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppDummy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./app.dummy"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/config"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ormConfig <span class="token keyword">from</span> <span class="token string">"./config/orm.config"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ormConfigProd <span class="token keyword">from</span> <span class="token string">"./config/orm.config.prod"</span><span class="token punctuation">;</span>
@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 导入orm框架,配置数据库连接</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment" spellcheck="true">// 配置这个,可以读取根目录的.env文件</span>
    ConfigModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      envFilePath<span class="token punctuation">:</span> <span class="token string">".env"</span><span class="token punctuation">,</span>
      isGlobal<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
      expandVariables<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
      load<span class="token punctuation">:</span> <span class="token punctuation">[</span>ormConfig<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    TypeOrmModule<span class="token punctuation">.</span><span class="token function">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      useFactory<span class="token punctuation">:</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">"production"</span> <span class="token operator">?</span> ormConfig <span class="token punctuation">:</span> ormConfigProd<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 导入子模块</span>
    EventsModule<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment" spellcheck="true">// 引入controller</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token comment" spellcheck="true">// 提供类</span>
    <span class="token punctuation">{</span>
      provide<span class="token punctuation">:</span> AppService<span class="token punctuation">,</span>
      useClass<span class="token punctuation">:</span> AppJapanService<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 提供变量</span>
    <span class="token punctuation">{</span>
      provide<span class="token punctuation">:</span> <span class="token string">"APP_NAME"</span><span class="token punctuation">,</span>
      useValue<span class="token punctuation">:</span> <span class="token string">"Nest Events Backend!"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 提供函数调用结果</span>
    <span class="token punctuation">{</span>
      provide<span class="token punctuation">:</span> <span class="token string">"MESSAGE"</span><span class="token punctuation">,</span>
      inject<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppDummy<span class="token punctuation">]</span><span class="token punctuation">,</span>
      useFactory<span class="token punctuation">:</span> <span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>app<span class="token punctuation">.</span><span class="token function">dummy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    AppDummy<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>expandVariables</p>
</blockquote>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">APP_URL</span><span class="token punctuation">=</span><span class="token attr-value">mywebsite.com</span>
<span class="token attr-name">SUPPORT_EMAIL</span><span class="token punctuation">=</span><span class="token attr-value">support@${APP_URL}</span>
</code></pre>
<p><img src="20230626191809.png"><br><img src="20230626191818.png"></p>
<h2 id="7-3-Logging"><a href="#7-3-Logging" class="headerlink" title="7.3. Logging"></a>7.3. Logging</h2><pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    async <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Hit the findAll route`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> events <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Found </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>events<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> events`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> events
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626193814.png"><br><img src="20230626194106.png" alt="main.ts"></p>
<h2 id="7-4-Exception-Filters"><a href="#7-4-Exception-Filters" class="headerlink" title="7.4. Exception Filters"></a>7.4. Exception Filters</h2><p><img src="20230626194147.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    async <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> ParseIntPipe<span class="token punctuation">)</span> id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> event
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230626194654.png"></p>
<h1 id="8-Intermediate-Database-Concepts"><a href="#8-Intermediate-Database-Concepts" class="headerlink" title="8. Intermediate Database Concepts"></a>8. Intermediate Database Concepts</h1><h2 id="8-1-Understanding-Relations"><a href="#8-1-Understanding-Relations" class="headerlink" title="8.1. Understanding Relations"></a>8.1. Understanding Relations</h2><p><img src="20230627061330.png" alt="数据库实例之间的关系1-1 1-n n-m"></p>
<h2 id="8-2-One-To-Many-Relation"><a href="#8-2-One-To-Many-Relation" class="headerlink" title="8.2. One To Many Relation"></a>8.2. One To Many Relation</h2><p><img src="20230627061527.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// attendee.entity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Column<span class="token punctuation">,</span> Entity<span class="token punctuation">,</span> ManyToOne<span class="token punctuation">,</span> PrimaryGeneratedColumn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Attendee</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Event<span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> event<span class="token punctuation">.</span>attendees<span class="token punctuation">)</span>
  event<span class="token punctuation">:</span> Event<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.entity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Column<span class="token punctuation">,</span> Entity<span class="token punctuation">,</span> OneToMany<span class="token punctuation">,</span> PrimaryGeneratedColumn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attendee <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 改变name不会删旧表,而是会创建新表</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>

  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Attendee<span class="token punctuation">,</span> <span class="token punctuation">(</span>attendee<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> attendee<span class="token punctuation">.</span>event<span class="token punctuation">)</span>
  attendees<span class="token punctuation">:</span> Attendee<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627062631.png"><br><img src="20230627063044.png"></p>
<h2 id="8-3-Loading-Related-Entities"><a href="#8-3-Loading-Related-Entities" class="headerlink" title="8.3. Loading Related Entities"></a>8.3. Loading Related Entities</h2><pre class=" language-sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span>
    <span class="token punctuation">`</span>event<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>description<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token keyword">when</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
    <span class="token punctuation">(</span>
        <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">'Let\'s meet together.'</span><span class="token punctuation">,</span>
        <span class="token string">'2021-02-15 21:00:00'</span><span class="token punctuation">,</span>
        <span class="token string">'Office St 120'</span><span class="token punctuation">,</span>
        <span class="token string">'Team Meetup'</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>
        <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token string">'Let\'s learn something.'</span><span class="token punctuation">,</span>
        <span class="token string">'2021-02-17 21:00:00'</span><span class="token punctuation">,</span>
        <span class="token string">'Workshop St 80'</span><span class="token punctuation">,</span>
        <span class="token string">'Workshop'</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>
        <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token string">'Let\'s meet with big bosses'</span><span class="token punctuation">,</span>
        <span class="token string">'2021-02-17 21:00:00'</span><span class="token punctuation">,</span>
        <span class="token string">'Boss St 100'</span><span class="token punctuation">,</span>
        <span class="token string">'Strategy Meeting'</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>
        <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token string">'Let\'s try to sell stuff'</span><span class="token punctuation">,</span>
        <span class="token string">'2021-02-11 21:00:00'</span><span class="token punctuation">,</span>
        <span class="token string">'Money St 34'</span><span class="token punctuation">,</span>
        <span class="token string">'Sales Pitch'</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>
        <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string">'People meet to talk about business ideas'</span><span class="token punctuation">,</span>
        <span class="token string">'2021-02-12 21:00:00'</span><span class="token punctuation">,</span>
        <span class="token string">'Invention St 123'</span><span class="token punctuation">,</span>
        <span class="token string">'Founders Meeting'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span>
    <span class="token punctuation">`</span>attendee<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>eventId<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Piotr'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Terry'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Bob'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Joe'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Donald'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Harry'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice2'</span><span class="token punctuation">)</span>
    async <span class="token function">practice2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627065405.png"><br><img src="20230627065353.png"></p>
<blockquote>
<p>这样也可以查出 attendees</p>
</blockquote>
<p><img src="20230627065646.png"><br><img src="20230627065707.png"></p>
<h2 id="8-4-Associating-Related-Entities"><a href="#8-4-Associating-Related-Entities" class="headerlink" title="8.4. Associating Related Entities"></a>8.4. Associating Related Entities</h2><p><img src="20230627065852.png"><img src="20230627070000.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice2'</span><span class="token punctuation">)</span>
    async <span class="token function">practice2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> attendee <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Attendee</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        attendee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Jetty'</span>
        attendee<span class="token punctuation">.</span>event <span class="token operator">=</span> event

        await <span class="token keyword">this</span><span class="token punctuation">.</span>attendeeRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>attendee<span class="token punctuation">)</span>
        <span class="token keyword">return</span> event
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627070203.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice2'</span><span class="token punctuation">)</span>
    async <span class="token function">practice2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        event<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span>

        <span class="token keyword">const</span> attendee <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Attendee</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        attendee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Jetty The Second'</span>
        attendee<span class="token punctuation">.</span>event <span class="token operator">=</span> event

        await <span class="token keyword">this</span><span class="token punctuation">.</span>attendeeRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>attendee<span class="token punctuation">)</span>
        <span class="token keyword">return</span> event
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627070322.png"></p>
<blockquote>
<p>级联操作(不是数据库的级联)</p>
</blockquote>
<p><img src="20230627070346.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice2'</span><span class="token punctuation">)</span>
    async <span class="token function">practice2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> relations<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'attendees'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> attendee <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Attendee</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        attendee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Using cascade'</span>

        event<span class="token punctuation">.</span>attendees<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>attendee<span class="token punctuation">)</span>

        await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
        <span class="token keyword">return</span> event
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627070715.png"></p>
<blockquote>
<p>如果 nullable 设置为 true</p>
</blockquote>
<p><img src="20230627070805.png"></p>
<blockquote>
<p>将 event 的 attendees 设为空</p>
</blockquote>
<p><img src="20230627070817.png"></p>
<blockquote>
<p>此时与之相关联的 attendee 的外键的值都置为 null</p>
</blockquote>
<p><img src="20230627070845.png"></p>
<h2 id="8-5-Many-To-Many-Relation"><a href="#8-5-Many-To-Many-Relation" class="headerlink" title="8.5. Many To Many Relation"></a>8.5. Many To Many Relation</h2><p><img src="20230627083519.png"><br><img src="20230627083706.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinTable<span class="token punctuation">,</span>
  ManyToMany<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Teacher <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./teacher.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Teacher<span class="token punctuation">,</span> <span class="token punctuation">(</span>teacher<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> teacher<span class="token punctuation">.</span>subjects<span class="token punctuation">,</span> <span class="token punctuation">{</span> cascade<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">JoinTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 会创建一个关系表(subject_teachers_teacher)</span>
  teachers<span class="token punctuation">:</span> Teacher<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Column<span class="token punctuation">,</span> Entity<span class="token punctuation">,</span> ManyToMany<span class="token punctuation">,</span> PrimaryGeneratedColumn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Subject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./subject.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Teacher</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Subject<span class="token punctuation">,</span> <span class="token punctuation">(</span>subject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> subject<span class="token punctuation">.</span>teachers<span class="token punctuation">)</span>
  subjects<span class="token punctuation">:</span> Subject<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627083810.png" alt="可以指定关联的列的名称,和反过来的关联列"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Post <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Subject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./subject.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Teacher <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./teacher.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"school"</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TrainingController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Subject<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly subjectRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Subject<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/create"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> async <span class="token function">savingRelation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    subject<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Math"</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> teacher1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Teacher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    teacher1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"John Doe"</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> teacher2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Teacher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    teacher2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Harry Doe"</span><span class="token punctuation">;</span>

    subject<span class="token punctuation">.</span>teachers <span class="token operator">=</span> <span class="token punctuation">[</span>teacher1<span class="token punctuation">,</span> teacher2<span class="token punctuation">]</span><span class="token punctuation">;</span>

    await <span class="token keyword">this</span><span class="token punctuation">.</span>subjectRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/remove"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> async <span class="token function">removingRelation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> subject <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>subjectRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      relations<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"teachers"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    subject<span class="token punctuation">.</span>teachers <span class="token operator">=</span> subject<span class="token punctuation">.</span>teachers<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>teacher<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> teacher<span class="token punctuation">.</span>id <span class="token operator">!==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    await <span class="token keyword">this</span><span class="token punctuation">.</span>subjectRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// school.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Subject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./subject.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Teacher <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./teacher.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TrainingController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./training.controller"</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>TypeOrmModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Subject<span class="token punctuation">,</span> Teacher<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>TrainingController<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SchoolModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627084338.png"></p>
<h2 id="8-6-Query-Builder-Introduction"><a href="#8-6-Query-Builder-Introduction" class="headerlink" title="8.6. Query Builder Introduction"></a>8.6. Query Builder Introduction</h2><pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/practice3'</span><span class="token punctuation">)</span>
    async <span class="token function">practice3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'e.id'</span><span class="token punctuation">,</span> <span class="token string">'e.name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'e.id'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627145450.png"><img src="20230627150616.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common/services"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> readonly logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span>EventsService<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Event<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly eventsRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Event<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>eventsRepository
        <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">"e"</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// .select(["e.id", "e.name"])</span>
        <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"e.id"</span><span class="token punctuation">,</span> <span class="token string">"ASC"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">getEvent</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Event <span class="token operator">|</span> undefined<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">"e.id = :id"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>await query<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> await query<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    <span class="token comment" spellcheck="true">// 依赖注入</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>
        @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Event<span class="token punctuation">)</span>
        <span class="token keyword">private</span> readonly repository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">,</span>
        @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Attendee<span class="token punctuation">)</span>
        <span class="token keyword">private</span> readonly attendeeRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Attendee<span class="token operator">></span><span class="token punctuation">,</span>
        <span class="token keyword">private</span> readonly eventsService<span class="token punctuation">:</span> EventsService
    <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    async <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> ParseIntPipe<span class="token punctuation">)</span> id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">getEvent</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> event
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627150842.png"><br><img src="20230627151046.png"></p>
<h2 id="8-7-Joins-And-Aggregation-with-Query-Builder"><a href="#8-7-Joins-And-Aggregation-with-Query-Builder" class="headerlink" title="8.7. Joins And Aggregation with Query Builder"></a>8.7. Joins And Aggregation with Query Builder</h2><pre class=" language-ts"><code class="language-ts">    <span class="token keyword">public</span> <span class="token function">getEventsWithAttendeeCountQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 查询到所有events</span>
            <span class="token punctuation">.</span><span class="token function">loadRelationCountAndMap</span><span class="token punctuation">(</span> <span class="token comment" spellcheck="true">// 给每个events的attendees注入值,值为关联的attendee的数量</span>
                <span class="token string">'e.attendeeCount'</span><span class="token punctuation">,</span> <span class="token string">'e.attendees'</span>
            <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> async <span class="token function">getEvent</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Event <span class="token operator">|</span> undefined<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsWithAttendeeCountQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">'e.id = :id'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 根据id筛选结果</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>await query<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> await query<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627153639.png"><br><img src="20230627153655.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// attendee.entity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  ManyToOne<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 参会意向</span>
<span class="token keyword">export</span> <span class="token keyword">enum</span> AttendeeAnswerEnum <span class="token punctuation">{</span>
  Accepted <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  Maybe<span class="token punctuation">,</span>
  Rejected<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Attendee</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//...</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token string">"enum"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">enum</span><span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">.</span>Accepted<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  answer<span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.entity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Column<span class="token punctuation">,</span> Entity<span class="token punctuation">,</span> OneToMany<span class="token punctuation">,</span> PrimaryGeneratedColumn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attendee <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>

  attendeeRejected<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  attendeeMaybe<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  attendeeAccepted<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common/services"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attendee<span class="token punctuation">,</span> AttendeeAnswerEnum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsService</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>

  <span class="token keyword">public</span> <span class="token function">getEventsWithAttendeeCountQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 查询到所有events</span>
      <span class="token punctuation">.</span><span class="token function">loadRelationCountAndMap</span><span class="token punctuation">(</span>
        <span class="token comment" spellcheck="true">// 给每个events的attendees注入值,值为关联的attendee的数量</span>
        <span class="token string">"e.attendeeCount"</span><span class="token punctuation">,</span>
        <span class="token string">"e.attendees"</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">loadRelationCountAndMap</span><span class="token punctuation">(</span>
        <span class="token string">"e.attendeeAccepted"</span><span class="token punctuation">,</span>
        <span class="token string">"e.attendees"</span><span class="token punctuation">,</span>
        <span class="token string">"attendee"</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>qb<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
          qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"attendee.answer = :answer"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            answer<span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">.</span>Accepted<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">loadRelationCountAndMap</span><span class="token punctuation">(</span>
        <span class="token string">"e.attendeeRejected"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// mapToProperty映射到哪个值</span>
        <span class="token string">"e.attendees"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// relationName关系名称</span>
        <span class="token string">"attendee"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// aliasName数据库名</span>
        <span class="token punctuation">(</span>qb<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
          qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"attendee.answer = :answer"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            answer<span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">.</span>Rejected<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">loadRelationCountAndMap</span><span class="token punctuation">(</span>
        <span class="token string">"e.attendeeMaybe"</span><span class="token punctuation">,</span>
        <span class="token string">"e.attendees"</span><span class="token punctuation">,</span>
        <span class="token string">"attendee"</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>qb<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
          qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"attendee.answer = :answer"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            answer<span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">.</span>Maybe<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627160617.png"></p>
<h2 id="8-8-Filtering-Data-Using-Query-Builder"><a href="#8-8-Filtering-Data-Using-Query-Builder" class="headerlink" title="8.8. Filtering Data Using Query Builder"></a>8.8. Filtering Data Using Query Builder</h2><p><img src="20230627163223.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// list.event.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ListEvents</span> <span class="token punctuation">{</span>
  when<span class="token operator">?</span><span class="token punctuation">:</span> WhenEventFilter <span class="token operator">=</span> WhenEventFilter<span class="token punctuation">.</span>All<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">enum</span> WhenEventFilter <span class="token punctuation">{</span>
  All <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  Today<span class="token punctuation">,</span>
  Tommorow<span class="token punctuation">,</span>
  ThisWeek<span class="token punctuation">,</span>
  NextWeek<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Query: ?xxx=xxx</span>
    async <span class="token function">findAll</span><span class="token punctuation">(</span>@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> filter<span class="token punctuation">:</span> ListEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Hit the findAll route`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> events <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService
            <span class="token punctuation">.</span><span class="token function">getEventsWithAttendeeCountFiltered</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Found </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>events<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> events`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> events
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    <span class="token keyword">public</span> async <span class="token function">getEventsWithAttendeeCountFiltered</span><span class="token punctuation">(</span>filter<span class="token operator">?</span><span class="token punctuation">:</span> ListEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsWithAttendeeCountQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> await query<span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>Today<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span>
                    <span class="token template-string"><span class="token string">`e.when >= CURDATE() AND e.when &lt;= CURDATE() + INTERVAL 1 DAY`</span></span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>Tommorow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span>
                    <span class="token template-string"><span class="token string">`e.when >= CURDATE() + INTERVAL 1 DAY AND e.when &lt;= CURDATE() + INTERVAL 2 DAY`</span></span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>ThisWeek<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">'YEARWEEK(e.when, 1) = YEARWEEK(CURDATE(), 1)'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>NextWeek<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">'YEARWEEK(e.when, 1) = YEARWEEK(CURDATE(), 1) + 1'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> await query<span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627164355.png"></p>
<h2 id="8-9-Pagination-Using-Query-Builder"><a href="#8-9-Pagination-Using-Query-Builder" class="headerlink" title="8.9. Pagination Using Query Builder"></a>8.9. Pagination Using Query Builder</h2><p><img src="20230627183603.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// paginator.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SelectQueryBuilder <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PaginateOptions</span> <span class="token punctuation">{</span>
  limit<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  currentPage<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  total<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 可以返回数组</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PaginationResult</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
  first<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  last<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  limit<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  total<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  data<span class="token punctuation">:</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> async <span class="token keyword">function</span> paginate<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>
  qb<span class="token punctuation">:</span> SelectQueryBuilder<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> PaginateOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    limit<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    currentPage<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PaginationResult<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>currentPage <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> options<span class="token punctuation">.</span>limit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> await qb<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    first<span class="token punctuation">:</span> offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    last<span class="token punctuation">:</span> offset <span class="token operator">+</span> data<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    limit<span class="token punctuation">:</span> options<span class="token punctuation">.</span>limit<span class="token punctuation">,</span>
    total<span class="token punctuation">:</span> options<span class="token punctuation">.</span>total <span class="token operator">?</span> await qb<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Query: ?xxx=xxx</span>
    @<span class="token function">UsePipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> transform<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 没有提供值时,会填充默认值</span>
    async <span class="token function">findAll</span><span class="token punctuation">(</span>@<span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> filter<span class="token punctuation">:</span> ListEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> events <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService
            <span class="token punctuation">.</span><span class="token function">getEventsWithAttendeeCountFilteredPaginated</span><span class="token punctuation">(</span>
                filter<span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    total<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
                    currentPage<span class="token punctuation">:</span> filter<span class="token punctuation">.</span>page<span class="token punctuation">,</span>
                    limit<span class="token punctuation">:</span> <span class="token number">10</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
        <span class="token keyword">return</span> events
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    <span class="token keyword">private</span> async <span class="token function">getEventsWithAttendeeCountFiltered</span><span class="token punctuation">(</span>filter<span class="token operator">?</span><span class="token punctuation">:</span> ListEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsWithAttendeeCountQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> query
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>Today<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span>
                    <span class="token template-string"><span class="token string">`e.when >= CURDATE() AND e.when &lt;= CURDATE() + INTERVAL 1 DAY`</span></span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>Tommorow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span>
                    <span class="token template-string"><span class="token string">`e.when >= CURDATE() + INTERVAL 1 DAY AND e.when &lt;= CURDATE() + INTERVAL 2 DAY`</span></span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>ThisWeek<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">'YEARWEEK(e.when, 1) = YEARWEEK(CURDATE(), 1)'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>NextWeek<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">'YEARWEEK(e.when, 1) = YEARWEEK(CURDATE(), 1) + 1'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> await query
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> async <span class="token function">getEventsWithAttendeeCountFilteredPaginated</span><span class="token punctuation">(</span>
        filter<span class="token punctuation">:</span> ListEvents<span class="token punctuation">,</span>
        paginateOptions<span class="token punctuation">:</span> PaginateOptions
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token function">paginate</span><span class="token punctuation">(</span>
            await <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsWithAttendeeCountFiltered</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">,</span>
            paginateOptions
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="8-10-Updating-Deleting-Modifying-Relations-using-QB"><a href="#8-10-Updating-Deleting-Modifying-Relations-using-QB" class="headerlink" title="8.10. Updating, Deleting, Modifying Relations using QB"></a>8.10. Updating, Deleting, Modifying Relations using QB</h2><p><img src="20230627193232.png"><br><img src="20230627193259.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
    @<span class="token function">HttpCode</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span>
    async <span class="token function">remove</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">deleteEvent</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">?</span><span class="token punctuation">.</span>affected <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 把name属性改成Confidential</span>
await <span class="token keyword">this</span><span class="token punctuation">.</span>subjectRepository
  <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">"e"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"Confidential"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><img src="20230627194121.png"></p>
<pre class=" language-ts"><code class="language-ts">    <span class="token keyword">constructor</span><span class="token punctuation">(</span>
        @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Subject<span class="token punctuation">)</span>
        <span class="token keyword">private</span> readonly subjectRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Subject<span class="token operator">></span><span class="token punctuation">,</span>
        @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Teacher<span class="token punctuation">)</span>
        <span class="token keyword">private</span> readonly teacherRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Teacher<span class="token operator">></span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/create'</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> async <span class="token function">savingRelation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subject<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Math'</span><span class="token punctuation">;</span>

        await <span class="token keyword">this</span><span class="token punctuation">.</span>subjectRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span>

        <span class="token keyword">const</span> teacher1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Teacher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        teacher1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'John Doe'</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> teacher2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Teacher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        teacher2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Harry Doe'</span><span class="token punctuation">;</span>

        await <span class="token keyword">this</span><span class="token punctuation">.</span>teacherRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">[</span>teacher1<span class="token punctuation">,</span> teacher2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627200852.png"></p>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/create'</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> async <span class="token function">savingRelation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> subject <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>subjectRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> t1 <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>teacherRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> t2 <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>teacherRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">4</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>subjectRepository
            <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">relation</span><span class="token punctuation">(</span>Subject<span class="token punctuation">,</span> <span class="token string">'teachers'</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">[</span>t1<span class="token punctuation">,</span> t2<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627201313.png"></p>
<h2 id="8-11-One-to-One-Relation"><a href="#8-11-One-to-One-Relation" class="headerlink" title="8.11. One to One Relation"></a>8.11. One to One Relation</h2><p><img src="20230627201428.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  OneToOne<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Profile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./profile.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  email<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  firstName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  lastName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">OneToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Profile<span class="token punctuation">)</span>
  @<span class="token function">JoinColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  profile<span class="token punctuation">:</span> Profile<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Column<span class="token punctuation">,</span> Entity<span class="token punctuation">,</span> PrimaryGeneratedColumn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Profile</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  age<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230627202623.png"></p>
<h1 id="9-Authentication-JWT-Authorization"><a href="#9-Authentication-JWT-Authorization" class="headerlink" title="9. Authentication, JWT, Authorization"></a>9. Authentication, JWT, Authorization</h1><h2 id="9-1-Introduction-to-Authentication"><a href="#9-1-Introduction-to-Authentication" class="headerlink" title="9.1. Introduction to Authentication"></a>9.1. Introduction to Authentication</h2><p><img src="20230627203659.png"></p>
<h2 id="9-2-Local-Passport-Strategy"><a href="#9-2-Local-Passport-Strategy" class="headerlink" title="9.2. Local Passport Strategy"></a>9.2. Local Passport Strategy</h2><pre class=" language-shell"><code class="language-shell">npm i --save @nestjs/passport passport passport-local  @types/passport-local
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// local.strategy.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> Logger<span class="token punctuation">,</span> UnauthorizedException <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/passport"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Strategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"passport-local"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LocalStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> readonly logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span>LocalStrategy<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly userRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>User<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">validate</span><span class="token punctuation">(</span>username<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`User </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found!`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>password <span class="token operator">!==</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Invalid credentials for user </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// auth.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./local.strategy"</span><span class="token punctuation">;</span>
@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>TypeOrmModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span>User<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>LocalStrategy<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<h2 id="9-3-Logging-In-Passport-Strategy-with-a-Nest-Guard"><a href="#9-3-Logging-In-Passport-Strategy-with-a-Nest-Guard" class="headerlink" title="9.3. Logging In - Passport Strategy with a Nest Guard"></a>9.3. Logging In - Passport Strategy with a Nest Guard</h2><pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Request<span class="token punctuation">,</span> UseGuards <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/passport"</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"auth"</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span>
  <span class="token comment" spellcheck="true">// 路由守卫</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  async <span class="token function">login</span><span class="token punctuation">(</span>@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      userId<span class="token punctuation">:</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      token<span class="token punctuation">:</span> <span class="token string">"the token will go here"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230628053222.png"></p>
<h2 id="9-4-JWT-JSON-Web-Tokens-Introduction"><a href="#9-4-JWT-JSON-Web-Tokens-Introduction" class="headerlink" title="9.4. JWT - JSON Web Tokens Introduction"></a>9.4. JWT - JSON Web Tokens Introduction</h2><p><img src="20230628053313.png"></p>
<h2 id="9-5-JWT-Generating-Token"><a href="#9-5-JWT-Generating-Token" class="headerlink" title="9.5. JWT - Generating Token"></a>9.5. JWT - Generating Token</h2><pre class=" language-shell"><code class="language-shell">npm i --save @nestjs/jwt passport-jwt
npm i --save-dev @types/passport-jwt
</code></pre>
<p><img src="20230628053932.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// auth.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TypeOrmModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./local.strategy"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./auth.controller"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/jwt"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./auth.service"</span><span class="token punctuation">;</span>
@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    TypeOrmModule<span class="token punctuation">.</span><span class="token function">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span>User<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    JwtModule<span class="token punctuation">.</span><span class="token function">registerAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 异步创建,防止环境变量在module创建时还无法读取</span>
      useFactory<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        secret<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>AUTH_SECRET<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// JWT密码(放到.env)</span>
        signOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          expiresIn<span class="token punctuation">:</span> <span class="token string">"60m"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 60min后过期</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>LocalStrategy<span class="token punctuation">,</span> AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AuthController<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Inject<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Request<span class="token punctuation">,</span> UseGuards <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/passport"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./auth.service"</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"auth"</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly authService<span class="token punctuation">:</span> AuthService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span>
  <span class="token comment" spellcheck="true">// 路由守卫</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  async <span class="token function">login</span><span class="token punctuation">(</span>@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      userId<span class="token punctuation">:</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      token<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">getTokenForUser</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// auth.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/jwt"</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly jwtService<span class="token punctuation">:</span> JwtService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">getTokenForUser</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> User<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      username<span class="token punctuation">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
      sub<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230628054742.png"></p>
<h2 id="9-6-JWT-Strategy-amp-Guard-Authenticating-with-JWT-Token"><a href="#9-6-JWT-Strategy-amp-Guard-Authenticating-with-JWT-Token" class="headerlink" title="9.6. JWT - Strategy &amp; Guard - Authenticating with JWT Token"></a>9.6. JWT - Strategy &amp; Guard - Authenticating with JWT Token</h2><pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/passport"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ExtractJwt<span class="token punctuation">,</span> Strategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"passport-jwt"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JwtStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly userRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>User<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      jwtFromRequest<span class="token punctuation">:</span> ExtractJwt<span class="token punctuation">.</span><span class="token function">fromAuthHeaderAsBearerToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ignoreExpiration<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
      secretOrKey<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>AUTH_SECRET<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  async <span class="token function">validate</span><span class="token punctuation">(</span>payload<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// sub是user.id</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> payload<span class="token punctuation">.</span>sub <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'profile'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 传递的'jwt'是策略名,</span>
    <span class="token comment" spellcheck="true">// 对应PassportStrategy(从passport-jwt导入就是jwt(默认值)),</span>
    <span class="token comment" spellcheck="true">// 可以通过 PassportStrategy(Strategy,'xxx')指定,</span>
    <span class="token comment" spellcheck="true">// 会自动找实现类</span>
    @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    async <span class="token function">getProfile</span><span class="token punctuation">(</span>@<span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> request<span class="token punctuation">.</span>user
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230628060652.png" alt="问题: 会返回密码"></p>
<h2 id="9-7-Hashing-Passwords-with-Bcrypt"><a href="#9-7-Hashing-Passwords-with-Bcrypt" class="headerlink" title="9.7. Hashing Passwords with Bcrypt"></a>9.7. Hashing Passwords with Bcrypt</h2><pre class=" language-shell"><code class="language-shell">npm i bcrypt
npm i --save-dev @types/bcrypt
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token operator">*</span> as bcrypt <span class="token keyword">from</span> <span class="token string">"bcrypt"</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JwtStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>

  <span class="token keyword">public</span> async <span class="token function">hashPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 参数2是hash的轮数</span>
    <span class="token keyword">return</span> await bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// ...</span>
<span class="token keyword">import</span> <span class="token operator">*</span> as bcrypt <span class="token keyword">from</span> <span class="token string">"bcrypt"</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LocalStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>

  <span class="token keyword">public</span> async <span class="token function">validate</span><span class="token punctuation">(</span>username<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>await bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Invalid credentials for user </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="9-8-Custom-CurrentUser-Decorator"><a href="#9-8-Custom-CurrentUser-Decorator" class="headerlink" title="9.8. Custom CurrentUser Decorator"></a>9.8. Custom CurrentUser Decorator</h2><pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// current-user.decorator.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ExecutionContext<span class="token punctuation">,</span> createParamDecorator <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> CurrentUser <span class="token operator">=</span> <span class="token function">createParamDecorator</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>data<span class="token punctuation">:</span> unknown<span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> ExecutionContext<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> request<span class="token punctuation">.</span>user <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 路由守卫</span>
    @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    async <span class="token function">login</span><span class="token punctuation">(</span>@<span class="token function">CurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            userId<span class="token punctuation">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            token<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">getTokenForUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'profile'</span><span class="token punctuation">)</span>
    @<span class="token function">UseGuards</span><span class="token punctuation">(</span><span class="token function">AuthGuard</span><span class="token punctuation">(</span><span class="token string">'jwt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    async <span class="token function">getProfile</span><span class="token punctuation">(</span>@<span class="token function">CurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> user
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="9-9-User-Registration"><a href="#9-9-User-Registration" class="headerlink" title="9.9. User Registration"></a>9.9. User Registration</h2><p><img src="20230628064631.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// create.user.dto.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IsEmail<span class="token punctuation">,</span> Length <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-validator"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateUserDto</span> <span class="token punctuation">{</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
  retypedPassword<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  firstName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">Length</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  lastName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
  @<span class="token function">IsEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  email<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/jwt"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> as bcrypt <span class="token keyword">from</span> <span class="token string">"bcrypt"</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>
  <span class="token keyword">public</span> async <span class="token function">hashPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Body<span class="token punctuation">,</span> BadRequestException <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./auth.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateUserDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/create.user.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"users"</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> readonly authService<span class="token punctuation">:</span> AuthService<span class="token punctuation">,</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly userRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>User<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  async <span class="token function">create</span><span class="token punctuation">(</span>@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> createUserDto<span class="token punctuation">:</span> CreateUserDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>createUserDto<span class="token punctuation">.</span>password <span class="token operator">!==</span> createUserDto<span class="token punctuation">.</span>retypedPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Passwords are not identical"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 当根据email或username查找到,说明已存在,不能添加</span>
    <span class="token keyword">const</span> existingUser <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> username<span class="token punctuation">:</span> createUserDto<span class="token punctuation">.</span>username <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> email<span class="token punctuation">:</span> createUserDto<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"username or email is already taken"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    user<span class="token punctuation">.</span>username <span class="token operator">=</span> createUserDto<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
    user<span class="token punctuation">.</span>password <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">hashPassword</span><span class="token punctuation">(</span>createUserDto<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span>email <span class="token operator">=</span> createUserDto<span class="token punctuation">.</span>email<span class="token punctuation">;</span>
    user<span class="token punctuation">.</span>firstName <span class="token operator">=</span> createUserDto<span class="token punctuation">.</span>firstName<span class="token punctuation">;</span>
    user<span class="token punctuation">.</span>lastName <span class="token operator">=</span> createUserDto<span class="token punctuation">.</span>lastName<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token punctuation">(</span>await <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      token<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">getTokenForUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230628083143.png"></p>
<h2 id="9-10-Only-Authenticated-Users-Can-Create-Events"><a href="#9-10-Only-Authenticated-Users-Can-Create-Events" class="headerlink" title="9.10. Only Authenticated Users Can Create Events"></a>9.10. Only Authenticated Users Can Create Events</h2><p><img src="20230628083244.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  ManyToOne<span class="token punctuation">,</span>
  OneToMany<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attendee <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/user.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//</span>

  @<span class="token function">ManyToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> User<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> user<span class="token punctuation">.</span>organized<span class="token punctuation">)</span>
  @<span class="token function">JoinColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"organizerId"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  organizer<span class="token punctuation">:</span> User<span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nullable<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 如果不能null,创建会报错</span>
  organizerId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">//</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  OneToMany<span class="token punctuation">,</span>
  OneToOne<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Profile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./profile.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/events/event.entity"</span><span class="token punctuation">;</span>
@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//</span>
  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Event<span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> event<span class="token punctuation">.</span>organizer<span class="token punctuation">)</span>
  organized<span class="token punctuation">:</span> Event<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.service.ts</span>
    <span class="token keyword">public</span> async <span class="token function">createEvent</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> CreateEventDto<span class="token punctuation">,</span> user<span class="token punctuation">:</span> User<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Event<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>input<span class="token punctuation">,</span>
            organizer<span class="token punctuation">:</span> user<span class="token punctuation">,</span>
            when<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// auth-guard.local.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/passport"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthGuardLocal</span> <span class="token keyword">extends</span> <span class="token class-name">AuthGuard</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// auth-guard.jwt.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/passport"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthGuardJwt</span> <span class="token keyword">extends</span> <span class="token class-name">AuthGuard</span><span class="token punctuation">(</span><span class="token string">"jwt"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuardLocal<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// ...</span>
    @<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuardJwt<span class="token punctuation">)</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts">    @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    @<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuardJwt<span class="token punctuation">)</span>
    async <span class="token function">create</span><span class="token punctuation">(</span>
        @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> CreateEventDto<span class="token punctuation">,</span>
        @<span class="token function">CurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> User
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">createEvent</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230628101639.png"></p>
<h2 id="9-11-Only-The-Owners-Can-Edit-or-Delete-Events"><a href="#9-11-Only-The-Owners-Can-Edit-or-Delete-Events" class="headerlink" title="9.11. Only The Owners Can Edit or Delete Events"></a>9.11. Only The Owners Can Edit or Delete Events</h2><pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  ForbiddenException<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  Patch<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
  ValidationPipe<span class="token punctuation">,</span>
  Logger<span class="token punctuation">,</span>
  NotFoundException<span class="token punctuation">,</span>
  Query<span class="token punctuation">,</span>
  UsePipes<span class="token punctuation">,</span>
  UseGuards<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/create-event.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/update-event.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MoreThan <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm/find-options/operator/MoreThan"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm/repository/Repository"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Like <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attendee <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ListEvents <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/list.event"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CurrentUser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/current-user.decorate"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuardJwt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/auth-guard.jwt"</span><span class="token punctuation">;</span>
@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"events"</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsController</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>

  @<span class="token function">Patch</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">)</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuardJwt<span class="token punctuation">)</span>
  async <span class="token function">update</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> id<span class="token punctuation">,</span>
    @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> UpdateEventDto<span class="token punctuation">,</span>
    @<span class="token function">CurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> User
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">getEvent</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>organizerId <span class="token operator">!==</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ForbiddenException</span><span class="token punctuation">(</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token string">`You are not allowed to change this event`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">updateEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">Delete</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">)</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuardJwt<span class="token punctuation">)</span>
  @<span class="token function">HttpCode</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span>
  async <span class="token function">remove</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> id<span class="token punctuation">,</span> @<span class="token function">CurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">getEvent</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>organizerId <span class="token operator">!==</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ForbiddenException</span><span class="token punctuation">(</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token string">`You are not allowed to remove this event`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">deleteEvent</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.service.ts</span>
    <span class="token keyword">public</span> async <span class="token function">updateEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> Event<span class="token punctuation">,</span> input<span class="token punctuation">:</span> UpdateEventDto<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Event<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>event<span class="token punctuation">,</span> <span class="token operator">...</span>input<span class="token punctuation">,</span>
            when<span class="token punctuation">:</span> input<span class="token punctuation">.</span>when <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">:</span> event<span class="token punctuation">.</span>when
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p><img src="20230628104449.png"></p>
<h1 id="10-Data-Serialization"><a href="#10-Data-Serialization" class="headerlink" title="10. Data Serialization"></a>10. Data Serialization</h1><h2 id="10-1-Interceptors-and-Serialization"><a href="#10-1-Interceptors-and-Serialization" class="headerlink" title="10.1. Interceptors and Serialization"></a>10.1. Interceptors and Serialization</h2><p><img src="20230628105946.png"></p>
<h2 id="10-2-Serializing-Data"><a href="#10-2-Serializing-Data" class="headerlink" title="10.2. Serializing Data"></a>10.2. Serializing Data</h2><pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
  ForbiddenException<span class="token punctuation">,</span>
  Delete<span class="token punctuation">,</span>
  Patch<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  HttpCode<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
  ValidationPipe<span class="token punctuation">,</span>
  Logger<span class="token punctuation">,</span>
  NotFoundException<span class="token punctuation">,</span>
  Query<span class="token punctuation">,</span>
  UsePipes<span class="token punctuation">,</span>
  UseGuards<span class="token punctuation">,</span>
  SerializeOptions<span class="token punctuation">,</span>
  UseInterceptors<span class="token punctuation">,</span>
  ClassSerializerInterceptor<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/create-event.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/update-event.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm/repository/Repository"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ListEvents <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/list.event"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CurrentUser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/current-user.decorate"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuardJwt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/auth-guard.jwt"</span><span class="token punctuation">;</span>
@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"events"</span><span class="token punctuation">)</span>
@<span class="token function">SerializeOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  strategy<span class="token punctuation">:</span> <span class="token string">"excludeAll"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 序列化时排除所有,res为空</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsController</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">)</span>
  @<span class="token function">UseInterceptors</span><span class="token punctuation">(</span>ClassSerializerInterceptor<span class="token punctuation">)</span>
  async <span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> ParseIntPipe<span class="token punctuation">)</span> id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">getEvent</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> event<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230628110727.png"><br><img src="20230628110713.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// user.entity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  OneToMany<span class="token punctuation">,</span>
  OneToOne<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Profile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./profile.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/events/event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Expose <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-transformer"</span><span class="token punctuation">;</span>
@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> unique<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  username<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  password<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> unique<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  email<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  firstName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  lastName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">OneToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Profile<span class="token punctuation">)</span>
  @<span class="token function">JoinColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  profile<span class="token punctuation">:</span> Profile<span class="token punctuation">;</span>

  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Event<span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> event<span class="token punctuation">.</span>organizer<span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  organized<span class="token punctuation">:</span> Event<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// attendee.entity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  ManyToOne<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Expose <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-transformer"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 参会意向</span>
<span class="token keyword">export</span> <span class="token keyword">enum</span> AttendeeAnswerEnum <span class="token punctuation">{</span>
  Accepted <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  Maybe<span class="token punctuation">,</span>
  Rejected<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Attendee</span> <span class="token punctuation">{</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Event<span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> event<span class="token punctuation">.</span>attendees<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    nullable<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment" spellcheck="true">// @JoinColumn({</span>
  <span class="token comment" spellcheck="true">//     name: 'event_id',</span>
  <span class="token comment" spellcheck="true">//     referencedColumnName: 'secondary'</span>
  <span class="token comment" spellcheck="true">// })</span>
  @<span class="token function">JoinColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  event<span class="token punctuation">:</span> Event<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token string">"enum"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">enum</span><span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">.</span>Accepted<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  answer<span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// event.entity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  ManyToOne<span class="token punctuation">,</span>
  OneToMany<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attendee <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Expose <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-transformer"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// name: 表名</span>
<span class="token comment" spellcheck="true">// @Entity('event', { name: 'event' })</span>
@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 改变name不会删旧表,而是会创建新表</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// @PrimaryGeneratedColumn('uuid')</span>
  <span class="token comment" spellcheck="true">// @PrimaryGeneratedColumn('rowid')</span>
  <span class="token comment" spellcheck="true">// @PrimaryColumn() // 如果是复合主键,就在每个主键上加</span>
  @<span class="token function">PrimaryGeneratedColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 自动生成</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 暴露,序列化可以返回</span>
  id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token punctuation">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  description<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// name指定列名</span>
  <span class="token comment" spellcheck="true">// @Column({ name: 'when_date' })</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  when<span class="token punctuation">:</span> Date<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  address<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Attendee<span class="token punctuation">,</span> <span class="token punctuation">(</span>attendee<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> attendee<span class="token punctuation">.</span>event<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// eager: true, // 联表查询</span>
    cascade<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  attendees<span class="token punctuation">:</span> Attendee<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> User<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> user<span class="token punctuation">.</span>organized<span class="token punctuation">)</span>
  @<span class="token function">JoinColumn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"organizerId"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  organizer<span class="token punctuation">:</span> User<span class="token punctuation">;</span>
  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nullable<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  organizerId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  attendeeCount<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 不会保存到数据库</span>

  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  attendeeRejected<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  attendeeMaybe<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  attendeeAccepted<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230628111506.png" alt="auth.controller.tsf"><br><img src="20230628111721.png" alt="验证登录状态,可以看到,没有返回password"></p>
<blockquote>
<p>!!!不知道为啥 findAll 为空{},findAll 查询结果正常,但是返回序列化出错?</p>
</blockquote>
<h2 id="10-3-Serializing-Nested-Objects"><a href="#10-3-Serializing-Nested-Objects" class="headerlink" title="10.3. Serializing Nested Objects"></a>10.3. Serializing Nested Objects</h2><blockquote>
<p>PaginationResult 的结果被 ts 编译,但是返回的不是 js 对象,不会被序列化处理,应该把它变成 js 对象</p>
</blockquote>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PaginationResult</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Partial: 使 中的所有属性可选</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>partial<span class="token punctuation">:</span> Partial<span class="token operator">&lt;</span>PaginationResult<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 将所有可枚举自身属性的值从一个或多个源对象复制到 目标对象。返回目标对象</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partial<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  first<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  last<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  limit<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  total<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  data<span class="token punctuation">:</span> T<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> async <span class="token keyword">function</span> paginate<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>
  qb<span class="token punctuation">:</span> SelectQueryBuilder<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> PaginateOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    limit<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    currentPage<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PaginationResult<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>currentPage <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> options<span class="token punctuation">.</span>limit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> await qb<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PaginationResult</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    first<span class="token punctuation">:</span> offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    last<span class="token punctuation">:</span> offset <span class="token operator">+</span> data<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    limit<span class="token punctuation">:</span> options<span class="token punctuation">.</span>limit<span class="token punctuation">,</span>
    total<span class="token punctuation">:</span> options<span class="token punctuation">.</span>total <span class="token operator">?</span> await qb<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>破案了,要把 PaginationResult 改为 class,能被序列化,findall 才可以返回</p>
</blockquote>
<h1 id="11-Practical-Building-Full-Events-API"><a href="#11-Practical-Building-Full-Events-API" class="headerlink" title="11. (Practical) Building Full Events API"></a>11. (Practical) Building Full Events API</h1><h2 id="11-1-Practical-Building-Full-Events-API"><a href="#11-1-Practical-Building-Full-Events-API" class="headerlink" title="11.1. (Practical) Building Full Events API"></a>11.1. (Practical) Building Full Events API</h2><p><img src="20230628151233.png"><br><img src="20230628151301.png"></p>
<h2 id="11-2-Relations-Between-Entities"><a href="#11-2-Relations-Between-Entities" class="headerlink" title="11.2. Relations Between Entities"></a>11.2. Relations Between Entities</h2><pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  OneToMany<span class="token punctuation">,</span>
  OneToOne<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Profile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./profile.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/events/event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Expose <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-transformer"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attendee <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/events/attendee.entity"</span><span class="token punctuation">;</span>
@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>

  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Event<span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> event<span class="token punctuation">.</span>organizer<span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  organized<span class="token punctuation">:</span> Event<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  @<span class="token function">OneToMany</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Attendee<span class="token punctuation">,</span> <span class="token punctuation">(</span>attendee<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> attendee<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  attended<span class="token punctuation">:</span> Attendee<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  ManyToOne<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Expose <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-transformer"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/user.entity"</span><span class="token punctuation">;</span>

@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Attendee</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//...</span>

  @<span class="token function">ManyToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Event<span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> event<span class="token punctuation">.</span>attendees<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    nullable<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
    onDelete<span class="token punctuation">:</span> <span class="token string">"CASCADE"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  @<span class="token function">JoinColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  event<span class="token punctuation">:</span> Event<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  eventId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>

  @<span class="token function">ManyToOne</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> User<span class="token punctuation">,</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> user<span class="token punctuation">.</span>attended<span class="token punctuation">)</span>
  @<span class="token function">Expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  user<span class="token punctuation">:</span> User<span class="token punctuation">;</span>

  @<span class="token function">Column</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nullable<span class="token punctuation">:</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  userId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  Entity<span class="token punctuation">,</span>
  JoinColumn<span class="token punctuation">,</span>
  ManyToOne<span class="token punctuation">,</span>
  OneToMany<span class="token punctuation">,</span>
  PrimaryGeneratedColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attendee <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Expose <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-transformer"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PaginationResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/pagination/paginator"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// 定义返回类型</span>
<span class="token keyword">export</span> type PaginatedEvents <span class="token operator">=</span> PaginationResult<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">;</span>
</code></pre>
<h2 id="11-3-Getting-Event-Attendees"><a href="#11-3-Getting-Event-Attendees" class="headerlink" title="11.3. Getting Event Attendees"></a>11.3. Getting Event Attendees</h2><pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// attendee.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attendee <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AttendeesService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Attendee<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly attendeeRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Attendee<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">findByEventId</span><span class="token punctuation">(</span>eventId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Attendee<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>attendeeRepository<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> eventId <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event-attendees.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  UseInterceptors<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  SerializeOptions<span class="token punctuation">,</span>
  ClassSerializerInterceptor<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AttendeesService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.service"</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"events/:eventId/attendees"</span><span class="token punctuation">)</span>
@<span class="token function">SerializeOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span> strategy<span class="token punctuation">:</span> <span class="token string">"excludeAll"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventAttendeesController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly attendeesService<span class="token punctuation">:</span> AttendeesService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">UseInterceptors</span><span class="token punctuation">(</span>ClassSerializerInterceptor<span class="token punctuation">)</span>
  async <span class="token function">findAll</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"eventId"</span><span class="token punctuation">)</span> eventId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>attendeesService<span class="token punctuation">.</span><span class="token function">findByEventId</span><span class="token punctuation">(</span>eventId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="11-4-Getting-Events-Organized-by-User"><a href="#11-4-Getting-Events-Organized-by-User" class="headerlink" title="11.4. Getting Events Organized by User"></a>11.4. Getting Events Organized by User</h2><pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.service.ts</span>
    <span class="token keyword">public</span> async <span class="token function">getEventsOrganizedByUserIdPaginated</span><span class="token punctuation">(</span>
        userId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span> paginateOptions<span class="token punctuation">:</span> PaginateOptions
    <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PaginatedEvents<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await paginate<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsOrganizedByUserIdQuery</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
            paginateOptions
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">getEventsOrganizedByUserIdQuery</span><span class="token punctuation">(</span>
        userId<span class="token punctuation">:</span> <span class="token keyword">number</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'e.organizerId = :userId'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> userId <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event-organized-by-user.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  Query<span class="token punctuation">,</span>
  SerializeOptions<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  UseInterceptors<span class="token punctuation">,</span>
  ClassSerializerInterceptor<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.service"</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"events-organized-by-user/:userId"</span><span class="token punctuation">)</span>
@<span class="token function">SerializeOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span> strategy<span class="token punctuation">:</span> <span class="token string">"excludeAll"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsOrganizedByUserController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> readonly eventsService<span class="token punctuation">:</span> EventsService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">UseInterceptors</span><span class="token punctuation">(</span>ClassSerializerInterceptor<span class="token punctuation">)</span>
  async <span class="token function">findAll</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> userId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span> @<span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"page"</span><span class="token punctuation">)</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">getEventsOrganizedByUserIdPaginated</span><span class="token punctuation">(</span>
      userId<span class="token punctuation">,</span>
      <span class="token punctuation">{</span> currentPage<span class="token punctuation">:</span> page<span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.service.ts</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsService</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ...</span>
  <span class="token keyword">public</span> async <span class="token function">getEventsOrganizedByUserIdPaginated</span><span class="token punctuation">(</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span>
    paginateOptions<span class="token punctuation">:</span> PaginateOptions
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PaginatedEvents<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await paginate<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsOrganizedByUserIdQuery</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
      paginateOptions
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">getEventsOrganizedByUserIdQuery</span><span class="token punctuation">(</span>userId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"e.organizerId = :userId"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      userId<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="11-5-Current-User-Event-Attendance-the-Business-Logic"><a href="#11-5-Current-User-Event-Attendance-the-Business-Logic" class="headerlink" title="11.5. Current User Event Attendance - the Business Logic"></a>11.5. Current User Event Attendance - the Business Logic</h2><pre class=" language-ts"><code class="language-ts">  <span class="token comment" spellcheck="true">// event.service.ts</span>
<span class="token keyword">public</span> async <span class="token function">getEventsAttendedByUserIdPaginated</span><span class="token punctuation">(</span>
        userId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span> paginateOptions<span class="token punctuation">:</span> PaginateOptions
    <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PaginatedEvents<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> await paginate<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsAttendedByUserIdQuery</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
            paginateOptions
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">getEventsAttendedByUserIdQuery</span><span class="token punctuation">(</span>
        userId<span class="token punctuation">:</span> <span class="token keyword">number</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">'e.attendees'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'a.userId = :userId'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> userId <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// attendee.service.ts</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AttendeesService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Attendee<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly attendeeRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Attendee<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// ...</span>

  <span class="token keyword">public</span> async <span class="token function">findOneByEventIdAndUserId</span><span class="token punctuation">(</span>
    eventId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">number</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Attendee <span class="token operator">|</span> undefined<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>attendeeRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> eventId <span class="token punctuation">}</span><span class="token punctuation">,</span>
        user<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> userId <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">createOrUpdate</span><span class="token punctuation">(</span>
    input<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">,</span>
    eventId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">number</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Attendee<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> attendee <span class="token operator">=</span>
      <span class="token punctuation">(</span>await <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findOneByEventIdAndUserId</span><span class="token punctuation">(</span>eventId<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Attendee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    attendee<span class="token punctuation">.</span>eventId <span class="token operator">=</span> eventId<span class="token punctuation">;</span>
    attendee<span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// rest of input</span>

    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>attendeeRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>attendee<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="11-6-Current-User-Event-Attendance-the-Controller"><a href="#11-6-Current-User-Event-Attendance-the-Controller" class="headerlink" title="11.6. Current User Event Attendance - the Controller"></a>11.6. Current User Event Attendance - the Controller</h2><pre class=" language-ts"><code class="language-ts">    <span class="token keyword">public</span> async <span class="token function">createOrUpdate</span><span class="token punctuation">(</span>
        input<span class="token punctuation">:</span> CreateAttendeeDto<span class="token punctuation">,</span> eventId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span> userId<span class="token punctuation">:</span> <span class="token keyword">number</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Attendee<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> attendee <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findOneByEventIdAndUserId</span><span class="token punctuation">(</span>eventId<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
            <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Attendee</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        attendee<span class="token punctuation">.</span>eventId <span class="token operator">=</span> eventId
        attendee<span class="token punctuation">.</span>userId <span class="token operator">=</span> userId
        attendee<span class="token punctuation">.</span>answer <span class="token operator">=</span> input<span class="token punctuation">.</span>answer

        <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>attendeeRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>attendee<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// create-attendee.dto.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IsEnum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"class-validator"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AttendeeAnswerEnum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../attendee.entity"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateAttendeeDto</span> <span class="token punctuation">{</span>
  @<span class="token function">IsEnum</span><span class="token punctuation">(</span>AttendeeAnswerEnum<span class="token punctuation">)</span>
  answer<span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// create-user-event-attendance.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Param<span class="token punctuation">,</span>
  ParseIntPipe<span class="token punctuation">,</span>
  Body<span class="token punctuation">,</span>
  Query<span class="token punctuation">,</span>
  Put<span class="token punctuation">,</span>
  UseGuards<span class="token punctuation">,</span>
  SerializeOptions<span class="token punctuation">,</span>
  UseInterceptors<span class="token punctuation">,</span>
  ClassSerializerInterceptor<span class="token punctuation">,</span>
  NotFoundException<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AttendeesService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateAttendeeDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/create-attendee.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CurrentUser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/current-user.decorate"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthGuardJwt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/auth-guard.jwt"</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">"events-attendance"</span><span class="token punctuation">)</span>
@<span class="token function">SerializeOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span> strategy<span class="token punctuation">:</span> <span class="token string">"excludeAll"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CurrentUserEventAttendanceController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> readonly eventsService<span class="token punctuation">:</span> EventsService<span class="token punctuation">,</span>
    <span class="token keyword">private</span> readonly attendeesService<span class="token punctuation">:</span> AttendeesService
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuardJwt<span class="token punctuation">)</span>
  @<span class="token function">UseInterceptors</span><span class="token punctuation">(</span>ClassSerializerInterceptor<span class="token punctuation">)</span>
  async <span class="token function">findAll</span><span class="token punctuation">(</span>@<span class="token function">CurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> User<span class="token punctuation">,</span> @<span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"page"</span><span class="token punctuation">)</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsService<span class="token punctuation">.</span><span class="token function">getEventsAttendedByUserIdPaginated</span><span class="token punctuation">(</span>
      user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token punctuation">{</span> limit<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> currentPage<span class="token punctuation">:</span> page <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">":/eventId"</span><span class="token punctuation">)</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuardJwt<span class="token punctuation">)</span>
  @<span class="token function">UseInterceptors</span><span class="token punctuation">(</span>ClassSerializerInterceptor<span class="token punctuation">)</span>
  async <span class="token function">findOne</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"eventId"</span><span class="token punctuation">,</span> ParseIntPipe<span class="token punctuation">)</span> eventId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span>
    @<span class="token function">CurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> User
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> attendee <span class="token operator">=</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>attendeesService<span class="token punctuation">.</span><span class="token function">findOneByEventIdAndUserId</span><span class="token punctuation">(</span>
      eventId<span class="token punctuation">,</span>
      user<span class="token punctuation">.</span>id
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>attendee<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> attendee<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Put</span><span class="token punctuation">(</span><span class="token string">":/eventId"</span><span class="token punctuation">)</span>
  @<span class="token function">UseGuards</span><span class="token punctuation">(</span>AuthGuardJwt<span class="token punctuation">)</span>
  @<span class="token function">UseInterceptors</span><span class="token punctuation">(</span>ClassSerializerInterceptor<span class="token punctuation">)</span>
  async <span class="token function">createOrUpdate</span><span class="token punctuation">(</span>
    @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"eventId"</span><span class="token punctuation">,</span> ParseIntPipe<span class="token punctuation">)</span> eventId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span>
    @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> input<span class="token punctuation">:</span> CreateAttendeeDto<span class="token punctuation">,</span>
    @<span class="token function">CurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token punctuation">:</span> User
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attendeesService<span class="token punctuation">.</span><span class="token function">createOrUpdate</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> eventId<span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="11-7-Events-Refactoring"><a href="#11-7-Events-Refactoring" class="headerlink" title="11.7. Events Refactoring"></a>11.7. Events Refactoring</h2><p><img src="20230628170813.png"><br><img src="20230628170903.png"><br><img src="20230628170915.png"><br><img src="20230628171000.png"><br><img src="20230628171445.png" alt="保证是int类型"><br><img src="20230628171611.png"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// 每个方法都有返回值类型定义</span>
<span class="token comment" spellcheck="true">// event.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common/services"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectRepository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/auth/user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PaginateOptions<span class="token punctuation">,</span> paginate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"src/pagination/paginator"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DeleteResult<span class="token punctuation">,</span> Repository<span class="token punctuation">,</span> SelectQueryBuilder <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AttendeeAnswerEnum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./attendee.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event<span class="token punctuation">,</span> PaginatedEvents <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CreateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/create-event.dto"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ListEvents<span class="token punctuation">,</span> WhenEventFilter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/list.event"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateEventDto <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/update-event.dto"</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventsService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> readonly logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span>EventsService<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">InjectRepository</span><span class="token punctuation">(</span>Event<span class="token punctuation">)</span>
    <span class="token keyword">private</span> readonly eventsRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Event<span class="token operator">></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> SelectQueryBuilder<span class="token operator">&lt;</span>Event<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>eventsRepository
        <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">"e"</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// .select(['e.id', 'e.name'])</span>
        <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">"e.id"</span><span class="token punctuation">,</span> <span class="token string">"ASC"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token function">getEventsWithAttendeeCountQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> SelectQueryBuilder<span class="token operator">&lt;</span>Event<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 查询到所有events</span>
      <span class="token punctuation">.</span><span class="token function">loadRelationCountAndMap</span><span class="token punctuation">(</span>
        <span class="token comment" spellcheck="true">// 给每个events的attendees注入值,值为关联的attendee的数量</span>
        <span class="token string">"e.attendeeCount"</span><span class="token punctuation">,</span>
        <span class="token string">"e.attendees"</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">loadRelationCountAndMap</span><span class="token punctuation">(</span>
        <span class="token string">"e.attendeeAccepted"</span><span class="token punctuation">,</span>
        <span class="token string">"e.attendees"</span><span class="token punctuation">,</span>
        <span class="token string">"attendee"</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>qb<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
          qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"attendee.answer = :answer"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            answer<span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">.</span>Accepted<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">loadRelationCountAndMap</span><span class="token punctuation">(</span>
        <span class="token string">"e.attendeeRejected"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// mapToProperty映射到哪个值</span>
        <span class="token string">"e.attendees"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// relationName关系名称</span>
        <span class="token string">"attendee"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// aliasName数据库名</span>
        <span class="token punctuation">(</span>qb<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
          qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"attendee.answer = :answer"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            answer<span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">.</span>Rejected<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">loadRelationCountAndMap</span><span class="token punctuation">(</span>
        <span class="token string">"e.attendeeMaybe"</span><span class="token punctuation">,</span>
        <span class="token string">"e.attendees"</span><span class="token punctuation">,</span>
        <span class="token string">"attendee"</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>qb<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
          qb<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"attendee.answer = :answer"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            answer<span class="token punctuation">:</span> AttendeeAnswerEnum<span class="token punctuation">.</span>Maybe<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">getEventsWithAttendeeCountFilteredQuery</span><span class="token punctuation">(</span>
    filter<span class="token operator">?</span><span class="token punctuation">:</span> ListEvents
  <span class="token punctuation">)</span><span class="token punctuation">:</span> SelectQueryBuilder<span class="token operator">&lt;</span>Event<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsWithAttendeeCountQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> query<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>Today<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token string">`e.when >= CURDATE() AND e.when &lt;= CURDATE() + INTERVAL 1 DAY`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>Tommorow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token string">`e.when >= CURDATE() + INTERVAL 1 DAY AND e.when &lt;= CURDATE() + INTERVAL 2 DAY`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>ThisWeek<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token string">"YEARWEEK(e.when, 1) = YEARWEEK(CURDATE(), 1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>when <span class="token operator">==</span> WhenEventFilter<span class="token punctuation">.</span>NextWeek<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span>
          <span class="token string">"YEARWEEK(e.when, 1) = YEARWEEK(CURDATE(), 1) + 1"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> query<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">getEventsWithAttendeeCountFilteredPaginated</span><span class="token punctuation">(</span>
    filter<span class="token punctuation">:</span> ListEvents<span class="token punctuation">,</span>
    paginateOptions<span class="token punctuation">:</span> PaginateOptions
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PaginatedEvents<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token function">paginate</span><span class="token punctuation">(</span>
      await <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsWithAttendeeCountFilteredQuery</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">,</span>
      paginateOptions
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">getEventWithAttendeeCount</span><span class="token punctuation">(</span>
    id<span class="token punctuation">:</span> <span class="token keyword">number</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Event <span class="token operator">|</span> undefined<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsWithAttendeeCountQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span>
      <span class="token string">"e.id = :id"</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 根据id筛选结果</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>await query<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> await query<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Event <span class="token operator">|</span> undefined<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token punctuation">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">createEvent</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> CreateEventDto<span class="token punctuation">,</span> user<span class="token punctuation">:</span> User<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Event<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>input<span class="token punctuation">,</span>
      organizer<span class="token punctuation">:</span> user<span class="token punctuation">,</span>
      when<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">updateEvent</span><span class="token punctuation">(</span>
    event<span class="token punctuation">:</span> Event<span class="token punctuation">,</span>
    input<span class="token punctuation">:</span> UpdateEventDto
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>Event<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>event<span class="token punctuation">,</span>
      <span class="token operator">...</span>input<span class="token punctuation">,</span>
      when<span class="token punctuation">:</span> input<span class="token punctuation">.</span>when <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">:</span> event<span class="token punctuation">.</span>when<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">deleteEvent</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>DeleteResult<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await <span class="token keyword">this</span><span class="token punctuation">.</span>eventsRepository
      <span class="token punctuation">.</span><span class="token function">createQueryBuilder</span><span class="token punctuation">(</span><span class="token string">"e"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"id = :id"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">getEventsOrganizedByUserIdPaginated</span><span class="token punctuation">(</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span>
    paginateOptions<span class="token punctuation">:</span> PaginateOptions
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PaginatedEvents<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await paginate<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsOrganizedByUserIdQuery</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
      paginateOptions
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">getEventsOrganizedByUserIdQuery</span><span class="token punctuation">(</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">number</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> SelectQueryBuilder<span class="token operator">&lt;</span>Event<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"e.organizerId = :userId"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      userId<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> async <span class="token function">getEventsAttendedByUserIdPaginated</span><span class="token punctuation">(</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">,</span>
    paginateOptions<span class="token punctuation">:</span> PaginateOptions
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>PaginatedEvents<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> await paginate<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsAttendedByUserIdQuery</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
      paginateOptions
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">getEventsAttendedByUserIdQuery</span><span class="token punctuation">(</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">number</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> SelectQueryBuilder<span class="token operator">&lt;</span>Event<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEventsBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">leftJoinAndSelect</span><span class="token punctuation">(</span><span class="token string">"e.attendees"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"a.userId = :userId"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> userId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>nestjs 可能出现循环依赖,写代码时要注意</p>
</blockquote>
<blockquote>
<p>如果返回的是普通对象(没有 constructer),不会被序列化,要转为 js 对象</p>
</blockquote>
<pre class=" language-ts"><code class="language-ts">@<span class="token function">Entity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>parial<span class="token operator">?</span><span class="token punctuation">:</span> Partial<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> parial<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// 定义返回类型</span>
<span class="token keyword">export</span> type PaginatedEvents <span class="token operator">=</span> PaginationResult<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">;</span>
</code></pre>
<p><img src="20230628172453.png"></p>
<blockquote>
<p>定义默认值需要用到 Default…pipe</p>
</blockquote>
<p><img src="20230628185355.png"></p>
<h1 id="12-Testing"><a href="#12-Testing" class="headerlink" title="12. Testing"></a>12. Testing</h1><h2 id="12-1-Manual-Testing-with-Postman"><a href="#12-1-Manual-Testing-with-Postman" class="headerlink" title="12.1. Manual Testing with Postman"></a>12.1. Manual Testing with Postman</h2><h2 id="12-2-Introduction-to-Automated-Testing"><a href="#12-2-Introduction-to-Automated-Testing" class="headerlink" title="12.2. Introduction to Automated Testing"></a>12.2. Introduction to Automated Testing</h2><p><img src="20230628190939.png"></p>
<h2 id="12-3-Introduction-to-Jest"><a href="#12-3-Introduction-to-Jest" class="headerlink" title="12.3. Introduction to Jest"></a>12.3. Introduction to Jest</h2><pre class=" language-shell"><code class="language-shell">npm i --save-dev @nestjs/testing
</code></pre>
<p><img src="20230628191140.png" alt="安装后有的jest配置"></p>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// test.spec.ts</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"test is null"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-shell"><code class="language-shell">npm run test
# or
yarn test
</code></pre>
<p><img src="20230628191553.png"><br><img src="20230628191905.png"></p>
<h1 id="13-Unit-Testing"><a href="#13-Unit-Testing" class="headerlink" title="13. Unit Testing"></a>13. Unit Testing</h1><h2 id="13-1-Basic-Unit-Test-and-Code-Coverage"><a href="#13-1-Basic-Unit-Test-and-Code-Coverage" class="headerlink" title="13.1. Basic Unit Test and Code Coverage"></a>13.1. Basic Unit Test and Code Coverage</h2><blockquote>
<p>测试时,要把 src/目录换成相对路径,不然找不到</p>
</blockquote>
<pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.entity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// test("Event should be initialized through constructor", () => {</span>
<span class="token comment" spellcheck="true">//   const event = new Event({</span>
<span class="token comment" spellcheck="true">//     name: "Interesting event",</span>
<span class="token comment" spellcheck="true">//     description: "That was fun",</span>
<span class="token comment" spellcheck="true">//   });</span>

<span class="token comment" spellcheck="true">//   expect(event).toEqual({</span>
<span class="token comment" spellcheck="true">//     name: "Interesting event",</span>
<span class="token comment" spellcheck="true">//     description: "That was fun",</span>
<span class="token comment" spellcheck="true">//   });</span>
<span class="token comment" spellcheck="true">// });</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"Event should be initialized through constructor"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"Interesting event"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"That was fun"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"Interesting event"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"That was fun"</span><span class="token punctuation">,</span>
    id<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    when<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    address<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    attendees<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    organizer<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    organizerId<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    event<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    attendeeCount<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    attendeeRejected<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    attendeeMaybe<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
    attendeeAccepted<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-shell"><code class="language-shell">npm run test:cov
</code></pre>
<p><img src="20230628193240.png" alt="测试覆盖率"></p>
<h2 id="13-2-Test-Grouping-Spies-Mocks-Setup-and-Teardown"><a href="#13-2-Test-Grouping-Spies-Mocks-Setup-and-Teardown" class="headerlink" title="13.2. Test Grouping, Spies, Mocks, Setup and Teardown"></a>13.2. Test Grouping, Spies, Mocks, Setup and Teardown</h2><pre class=" language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// event.controller.spec.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"typeorm"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventsService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.service"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventsController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./events.controller"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./event.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ListEvents <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./input/list.event"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../auth/user.entity"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NotFoundException <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@nestjs/common"</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"EventsController"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> eventsService<span class="token punctuation">:</span> EventsService<span class="token punctuation">;</span>
  <span class="token keyword">let</span> eventsController<span class="token punctuation">:</span> EventsController<span class="token punctuation">;</span>
  <span class="token keyword">let</span> eventsRepository<span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Event<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"this logged once"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    eventsService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventsService</span><span class="token punctuation">(</span>eventsRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    eventsController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventsController</span><span class="token punctuation">(</span>eventsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// it === test</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should return a list of events"</span><span class="token punctuation">,</span> async <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
      first<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      last<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      limit<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 模拟方法,并提供方法实现(不依赖/使用外部方法,只提供模拟调用的结果,查看功能是否可用)</span>
    <span class="token comment" spellcheck="true">// eventsService.getEventsWithAttendeeCountFilteredPaginated</span>
    <span class="token comment" spellcheck="true">//     = jest.fn().mockImplementation((): any => result)</span>

    <span class="token comment" spellcheck="true">// 监视并模拟方法</span>
    <span class="token keyword">const</span> spy <span class="token operator">=</span> jest
      <span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>eventsService<span class="token punctuation">,</span> <span class="token string">"getEventsWithAttendeeCountFilteredPaginated"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">any</span> <span class="token operator">=</span><span class="token operator">></span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>await eventsController<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 只想调用一次</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should not delete an event, when it's not found"</span><span class="token punctuation">,</span> async <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> deleteSpy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>eventsService<span class="token punctuation">,</span> <span class="token string">"deleteEvent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> findSpy <span class="token operator">=</span> jest
      <span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>eventsService<span class="token punctuation">,</span> <span class="token string">"findOne"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">any</span> <span class="token operator">=</span><span class="token operator">></span> undefined<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      await eventsController<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeInstanceOf</span><span class="token punctuation">(</span>NotFoundException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 找不到就不能删除</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>deleteSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>findSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff;
        background-color: #22AB38;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff;
        background-color: #019FE8;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs">
                        <li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li>
                        <li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('#reward .reward-link').on('click', function () {
            $('#rewardModal').openModal();
        });

        $('#rewardModal .close').on('click', function () {
            $('#rewardModal').closeModal();
        });
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://malred.github.io" class="b-link-green">malred-blog</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2023/06/25/backend/node/master-nestjs-the-javascript-node.js-framework/z/" class="b-link-green">Master NestJS - The JavaScript Node.js Framework</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '676b06df8b7379e50e35',
        clientSecret: '9159b4de0f716ba7bdab9bc02151a90e6961246b',
        repo: 'comment_repo',
        owner: 'malred',
        admin: "malred",
        id: '2023-06-25T20-25-57',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    
        <link rel="stylesheet" href="/libs/gitment/gitment-default.css">
<link rel="stylesheet" href="/css/gitment.css">

<div class="gitment-card card" data-aos="fade-up">
    <div id="gitment-content" class="card-content"></div>
</div>

<script src="/libs/gitment/gitment.js"></script>
<script>
var gitment = new Gitment({
    id: 'Sun Jun 25 2023 20:25:57 GMT+0800',
    owner: 'malred',
    repo: 'comment_repo',
    oauth: {
        client_id: '676b06df8b7379e50e35',
        client_secret: '9159b4de0f716ba7bdab9bc02151a90e6961246b'
    }
});

gitment.render('gitment-content');
</script>
    

    
        <div class="disqus-card card" data-aos="fade-up">
    <div id="disqus_thread" class="card-content">
        <noscript>Please enable JavaScript to view the
            <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
    </div>
</div>

<script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://malred.github.io/2023/06/25/backend/node/master-nestjs-the-javascript-node.js-framework/z/';
        this.page.identifier = '/2023/06/25/backend/node/master-nestjs-the-javascript-node.js-framework/z/';
        this.page.title = 'Master NestJS - The JavaScript Node.js Framework';
    };
    let disqus_shortname = '';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://blinkfox.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'mipjlux8dRwbE7yY1zP3v13z-gzGzoHsz',
        appKey: 'cIy0pwvRAK8cuOCZRjuoHHfy',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '留下友善的评论~'
    });
</script>
    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/06/26/backend/c-c/hei-ma-c-nian-du/z/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="黑马c++视频">
                        
                        <span class="card-title">黑马c++视频</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary"></div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2023-06-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/c-c/" class="post-category" target="_blank">
                                    c/c++
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/c-c/" target="_blank">
                        <span class="chip bg-color">c/c++</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/06/24/backend/assembly/rustwebassemblywithjs-ts-thepracticalguide/z/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="Rust & WebAssembly with JS (TS) - The Practical Guide">
                        
                        <span class="card-title">Rust & WebAssembly with JS (TS) - The Practical Guide</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">01 - Introduction
02 - Rust Preparation001 Rust Installation
002 Rust Versionsrustc --version


003 Main Func
fn main() </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2023-06-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/wasm/" class="post-category" target="_blank">
                                    wasm
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/wasm/" target="_blank">
                        <span class="chip bg-color">wasm</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站由&copy;<a href="https://blinkfox.github.io/" target="_blank">Blinkfox</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">588.3k</span>
            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/malred" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:malguy2022@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2725953379" class="tooltipped" data-tooltip="QQ联系我: 2725953379" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<!--动态线条背景-->
<script type="text/javascript" color="122 103 238" opacity='0.7' zIndex="-2" count="200"
    src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
<script src="/js/matery.js"></script>
<script src="/js/snow.js"></script>

<!-- 引用Aplayer和metingjs -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script>
<div id="my-aplayer" class="aplayer" data-id="7363940489" data-server="netease" data-type="playlist" data-fixed="true"
    // 吸底模式可以固定播放器于页面底部 data-autoplay="true" data-order="list" data-volume="0.55" data-theme="#cc543a"
    data-preload="auto"></div>  
<!-- <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script> -->
<!-- <script src="https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<script>
    // 对所有链接跳转事件绑定pjax容器container
    $(document).pjax('a[target!=_blank]', '.container', { fragment: '.container', timeout: 8000 })
</script> -->


<!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-MSEYRC5EW5"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-MSEYRC5EW5');
</script>



    <script src="/libs/others/clicklove.js"></script>


    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>