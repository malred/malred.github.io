<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="a, HTML,CSS,React,Vue,Java,Go,微服务,linux">
    <meta name="description" content="Let’s Build a Simple DatabaseHow Does a Database Work?
What format is data saved in? (in memory and on disk)

数据以什么格式保存？">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>a | malred-blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/logo.png" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">malred-blog</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">malred-blog</div>
        <div class="logo-desc">
            
            前后端学习者,存放知识笔记
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>

    <div class="social-link">
    <a href="https://github.com/malred" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:malguy2022@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2725953379" class="tooltipped" data-tooltip="QQ联系我: 2725953379" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
</div>

            </div>
        </div>

        
        <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>
</header>





<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        a
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E9%80%A0%E8%BD%AE%E5%AD%90/" target="_blank">
                                <span class="chip bg-color">造轮子</span>
                            </a>
                        
                            <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" target="_blank">
                                <span class="chip bg-color">数据库</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E9%80%A0%E8%BD%AE%E5%AD%90/" class="post-category" target="_blank">
                                造轮子
                            </a>
                        
                            <a href="/categories/%E9%80%A0%E8%BD%AE%E5%AD%90/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category" target="_blank">
                                数据库
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-06-09
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        6.5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        32 分
                    </div>
                    
                
				
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Let’s-Build-a-Simple-Database"><a href="#Let’s-Build-a-Simple-Database" class="headerlink" title="Let’s Build a Simple Database"></a>Let’s Build a Simple Database</h1><h1 id="How-Does-a-Database-Work"><a href="#How-Does-a-Database-Work" class="headerlink" title="How Does a Database Work?"></a>How Does a Database Work?</h1><ul>
<li>What format is data saved in? (in memory and on disk)</li>
</ul>
<p>数据以什么格式保存？（在内存和磁盘上）</p>
<ul>
<li>When does it move from memory to disk?</li>
</ul>
<p>它何时从内存移动到磁盘？</p>
<ul>
<li>Why can there only be one primary key per table?</li>
</ul>
<p>为什么每个表只能有一个主键？</p>
<ul>
<li>How does rolling back a transaction work?</li>
</ul>
<p>回滚事务如何工作？</p>
<ul>
<li>How are indexes formatted?</li>
</ul>
<p>索引的格式如何？</p>
<ul>
<li>When and how does a full table scan happen?</li>
</ul>
<p>何时以及如何进行全表扫描？</p>
<ul>
<li>What format is a prepared statement saved in?</li>
</ul>
<p>预处理语句以什么格式保存？</p>
<p>In short, how does a database work?</p>
<p>简而言之，数据库是如何工作的？</p>
<p>I’m building a clone of sqlite from scratch in C in order to understand, and I’m going to document my process as I go.</p>
<p>为了理解，我正在用 C 从头开始构建 sqlite 的克隆，并且我将随时记录我的流程。</p>
<h1 id="Part-1-Introduction-and-Setting-up-the-REPL"><a href="#Part-1-Introduction-and-Setting-up-the-REPL" class="headerlink" title="Part 1 - Introduction and Setting up the REPL"></a>Part 1 - Introduction and Setting up the REPL</h1><blockquote>
<p>第 1 部分 - 简介和设置 REPL</p>
</blockquote>
<h2 id="sqlite"><a href="#sqlite" class="headerlink" title="sqlite"></a>sqlite</h2><p><a target="_blank" rel="noopener" href="https://www.sqlite.org/arch.html">sqlite文档</a></p>
<p><a target="_blank" rel="noopener" href="https://play.google.com/store/books/details?id=9Z6IQQnX1JEC">谷歌book</a></p>
<p>There’s lots of documentation of sqlite internals on their website, plus I’ve got a copy of SQLite Database System: Design and Implementation.</p>
<p>他们的网站上有很多关于sqlite内部的文档，另外我还有一份SQLite数据库系统：设计和实现。</p>
<p><img src="20230609171433.png"></p>
<p>A query goes through a chain of components in order to retrieve or modify data. The front-end consists of the:</p>
<p>查询通过组件链来检索或修改数据。前端包括：</p>
<ul>
<li>tokenizer 分词器</li>
<li>parser 解析 器</li>
<li>code generator 代码生成器</li>
</ul>
<p>The input to the front-end is a SQL query. the output is sqlite virtual machine bytecode (essentially a compiled program that can operate on the database).</p>
<p>前端的输入是 SQL 查询。输出是SQLite虚拟机字节码（本质上是一个可以在数据库上运行的编译程序）。</p>
<p>The back-end consists of the:<br>后端包括：</p>
<ul>
<li>virtual machine 虚拟机</li>
<li>B-tree B树</li>
<li>pager 呼叫器</li>
<li>os interface 界面</li>
</ul>
<p>The virtual machine takes bytecode generated by the front-end as instructions. It can then perform operations on one or more tables or indexes, each of which is stored in a data structure called a B-tree. The VM is essentially a big switch statement on the type of bytecode instruction.</p>
<p>虚拟机将前端生成的字节码作为指令。然后，它可以对一个或多个表或索引执行操作，每个表或索引都存储在称为 B 树的数据结构中。VM 本质上是关于字节码指令类型的大开关语句。</p>
<p>Each B-tree consists of many nodes. Each node is one page in length. The B-tree can retrieve a page from disk or save it back to disk by issuing commands to the pager.</p>
<p>每个 B 树由许多节点组成。每个节点的长度为一页。B树可以从磁盘检索页面，也可以通过向寻呼机发出命令将其保存回磁盘。</p>
<p>The pager receives commands to read or write pages of data. It is responsible for reading/writing at appropriate offsets in the database file. It also keeps a cache of recently-accessed pages in memory, and determines when those pages need to be written back to disk.</p>
<p>寻呼机接收用于读取或写入数据页的命令。它负责在数据库文件中以适当的偏移量读取/写入。它还在内存中保留最近访问的页面的缓存，并确定何时需要将这些页面写回磁盘。</p>
<p>The os interface is the layer that differs depending on which operating system sqlite was compiled for. In this tutorial, I’m not going to support multiple platforms.</p>
<p>操作系统接口是因编译 sqlite 所针对的操作系统而异的层。在本教程中，我不打算支持多个平台。</p>
<p>A journey of a thousand miles begins with a single step, so let’s start with something a little more straightforward: the REPL.</p>
<p>千里之行始于足下，所以让我们从更直接的东西开始：REPL。</p>
<h2 id="Making-a-Simple-REPL"><a href="#Making-a-Simple-REPL" class="headerlink" title="Making a Simple REPL"></a>Making a Simple REPL</h2><p>制作一个简单的 REPL</p>
<p>Sqlite starts a read-execute-print loop when you start it from the command line:</p>
<p>当您从命令行启动 Sqlite 时，它会启动读取-执行-打印循环：</p>
<pre class=" language-shell"><code class="language-shell">~ sqlite3
SQLite version 3.16.0 2016-11-04 19:09:39
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
sqlite> create table users (id int, username varchar(255), email varchar(255));
sqlite> .tables
users
sqlite> .exit
~
</code></pre>
<p>To do that, our main function will have an infinite loop that prints the prompt, gets a line of input, then processes that line of input:</p>
<p>为此，我们的 main 函数将有一个无限循环，用于打印提示，获取一行输入，然后处理该行输入：</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  InputBuffer<span class="token operator">*</span> input_buffer <span class="token operator">=</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read_input</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">".exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized command '%s'.\n"</span><span class="token punctuation">,</span> input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We’ll define InputBuffer as a small wrapper around the state we need to store to interact with getline(). (More on that in a minute)</p>
<p>我们将 InputBuffer 定义为我们需要存储以与 getline（） 交互的状态的小包装器。（稍后会详细介绍）</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">;</span>
  size_t buffer_length<span class="token punctuation">;</span>
  ssize_t input_length<span class="token punctuation">;</span>
<span class="token punctuation">}</span> InputBuffer<span class="token punctuation">;</span>

InputBuffer<span class="token operator">*</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  InputBuffer<span class="token operator">*</span> input_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>InputBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  input_buffer<span class="token operator">-></span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  input_buffer<span class="token operator">-></span>buffer_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  input_buffer<span class="token operator">-></span>input_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> input_buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ext, print_prompt() prints a prompt to the user. We do this before reading each line of input.</p>
<p>接下来， print_prompt() 向用户打印提示。我们在读取每行输入之前执行此操作。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"db > "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
<p>To read a line of input, use getline():</p>
<p>要读取输入行，请使用 getline（）：</p>
<pre class=" language-c"><code class="language-c">ssize_t <span class="token function">getline</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>lineptr<span class="token punctuation">,</span> size_t <span class="token operator">*</span>n<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>lineptr : a pointer to the variable we use to point to the buffer containing the read line. If it set to NULL it is mallocatted by getline and should thus be freed by the user, even if the command fails.</p>
<p>lineptr ：指向我们用来指向包含读取行的缓冲区的变量的指针。如果它设置为 NULL ，则它被 getline 错误定位，因此即使命令失败，用户也应释放它。</p>
<p>n : a pointer to the variable we use to save the size of allocated buffer.</p>
<p>n ：指向我们用来保存分配缓冲区大小的变量的指针。</p>
<p>stream : the input stream to read from. We’ll be reading from standard input.</p>
<p>stream ：要从中读取的输入流。我们将从标准输入中读取。</p>
<p>return value : the number of bytes read, which may be less than the size of the buffer.</p>
<p>return value ：读取的字节数，可能小于缓冲区的大小。</p>
<p>We tell getline to store the read line in input_buffer-&gt;buffer and the size of the allocated buffer in input_buffer-&gt;buffer_length. We store the return value in input_buffer-&gt;input_length.</p>
<p>我们告诉 getline 将读取行存储在 input_buffer-&gt;buffer 中，将分配的缓冲区的大小存储在 input_buffer-&gt;buffer_length 中。我们将返回值存储在 input_buffer-&gt;input_length 中。</p>
<p>buffer starts as null, so getline allocates enough memory to hold the line of input and makes buffer point to it.</p>
<p>buffer 以 null 开头，因此 getline 分配足够的内存来保存输入行并使其指向 buffer 。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">read_input</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ssize_t bytes_read <span class="token operator">=</span>
      <span class="token function">getline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer_length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_read <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error reading input\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// Ignore trailing newline</span>
  input_buffer<span class="token operator">-></span>input_length <span class="token operator">=</span> bytes_read <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">[</span>bytes_read <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now it is proper to define a function that frees the memory allocated for an instance of InputBuffer * and the buffer element of the respective structure (getline allocates memory for input_buffer-&gt;buffer in read_input).</p>
<p>现在定义一个函数来释放分配给 InputBuffer * 实例和相应结构的 buffer 元素的内存是合适的（ getline 为 input_buffer-&gt;buffer in read_input 分配内存）。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Finally, we parse and execute the command. There is only one recognized command right now : .exit, which terminates the program. Otherwise we print an error message and continue the loop.</p>
<p>最后，我们解析并执行命令。现在只有一个可识别的命令： .exit ，它终止程序。否则，我们将打印错误消息并继续循环。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">".exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized command '%s'.\n"</span><span class="token punctuation">,</span> input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>本章代码(实现读取命令行一行,识别.exit并退出)</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 读取的字符(缓冲区)</span>
    size_t buffer_length<span class="token punctuation">;</span>
    ssize_t input_length<span class="token punctuation">;</span>
<span class="token punctuation">}</span> InputBuffer<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 创建InputBuffer</span>
InputBuffer <span class="token operator">*</span><span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 分配内存给input</span>
    InputBuffer <span class="token operator">*</span>input_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>InputBuffer <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>InputBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    input_buffer<span class="token operator">-></span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    input_buffer<span class="token operator">-></span>buffer_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    input_buffer<span class="token operator">-></span>input_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> input_buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 打印提示</span>
<span class="token keyword">void</span> <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"db > "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 读取一行(linux才有(猜的))</span>
<span class="token comment" spellcheck="true">// ssize_t getline(char **lineptr, size_t *n, FILE *stream);</span>
<span class="token comment" spellcheck="true">// gcc编译报错没有getline(windows)</span>
ssize_t <span class="token function">mygetline</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>line<span class="token punctuation">,</span> size_t <span class="token operator">*</span>n<span class="token punctuation">,</span> FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token operator">*</span>line<span class="token punctuation">;</span>
    ssize_t c<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// i来记录字符串长度，c来存储字符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token operator">*</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>line <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf <span class="token operator">=</span> <span class="token operator">*</span>line<span class="token punctuation">;</span>
        <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// buf为或n为0时动态为期分配空间</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token operator">*</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 留2个空间给\n和\0</span>
        <span class="token punctuation">{</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token operator">*</span>n <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 空间不足时，重新进行分配</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 读取输入</span>
<span class="token keyword">void</span> <span class="token function">read_input</span><span class="token punctuation">(</span>InputBuffer <span class="token operator">*</span>input_buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    ssize_t bytes_read <span class="token operator">=</span>
        <span class="token function">mygetline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer_length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_read <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error reading input\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Ignore trailing newline</span>
    input_buffer<span class="token operator">-></span>input_length <span class="token operator">=</span> bytes_read <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">[</span>bytes_read <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 释放inputBuffer占用的内存</span>
<span class="token keyword">void</span> <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>InputBuffer <span class="token operator">*</span>input_buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    InputBuffer <span class="token operator">*</span>input_buffer <span class="token operator">=</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 借由InputBuffer接收输入</span>
        <span class="token function">read_input</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 解析命令 .exit</span>
        <span class="token comment" spellcheck="true">// 如果输入的是.exit,就退出</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">".exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 释放内存</span>
            <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 未知命令</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized command '%s'.\n"</span><span class="token punctuation">,</span> input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="Part-2-World’s-Simplest-SQL-Compiler-and-Virtual-Machine"><a href="#Part-2-World’s-Simplest-SQL-Compiler-and-Virtual-Machine" class="headerlink" title="Part 2 - World’s Simplest SQL Compiler and Virtual Machine"></a>Part 2 - World’s Simplest SQL Compiler and Virtual Machine</h1><blockquote>
<p>第 2 部分 - 世界上最简单的 SQL 编译器和虚拟机</p>
</blockquote>
<p>The “front-end” of sqlite is a SQL compiler that parses a string and outputs an internal representation called bytecode.</p>
<p>我们正在制作 sqlite 的克隆。sqlite 的“前端”是一个 SQL 编译器，它解析字符串并输出称为字节码的内部表示。</p>
<p>This bytecode is passed to the virtual machine, which executes it.</p>
<p>此字节码将传递到虚拟机，由虚拟机执行它。</p>
<p><img src="20230610065811.png"></p>
<p>Breaking things into two steps like this has a couple advantages:</p>
<p>像这样将事情分成两个步骤有几个优点：</p>
<ul>
<li>Reduces the complexity of each part (e.g. virtual machine does not worry about syntax errors)</li>
</ul>
<p>降低每个部分的复杂性（例如，虚拟机不必担心语法错误）</p>
<ul>
<li>Allows compiling common queries once and caching the bytecode for improved performance</li>
</ul>
<p>允许编译一次常见查询并缓存字节码以提高性能</p>
<p>With this in mind, let’s refactor our main function and support two new keywords in the process:</p>
<p>考虑到这一点，让我们重构我们的 main 函数，并在此过程中支持两个新关键字：</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    InputBuffer <span class="token operator">*</span>input_buffer <span class="token operator">=</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 借由InputBuffer接收输入</span>
        <span class="token function">read_input</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">do_meta_command</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span>META_COMMAND_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span>META_COMMAND_UNRECOGNIZED_COMMAND<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized command '%s'\n"</span><span class="token punctuation">,</span> input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Statement statement<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">prepare_statement</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statement<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_UNRECOGNIZED_STATEMENT<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized keyword at start of '%s'.\n"</span><span class="token punctuation">,</span>
                   input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">execute_statement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Executed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Non-SQL statements like .exit are called “meta-commands”. They all start with a dot, so we check for them and handle them in a separate function.</p>
<p>像 .exit 这样的非 SQL 语句称为“元命令”。它们都以点开头，因此我们检查它们并在单独的函数中处理它们。</p>
<p>Next, we add a step that converts the line of input into our internal representation of a statement. This is our hacky version of the sqlite front-end.</p>
<p>接下来，我们添加一个步骤，将输入行转换为语句的内部表示形式。这是我们的 sqlite 前端的黑客版本。</p>
<p>Lastly, we pass the prepared statement to execute_statement. This function will eventually become our virtual machine.</p>
<p>最后，我们将准备好的语句传递给 execute_statement 。这个功能最终将成为我们的虚拟机。</p>
<p>Notice that two of our new functions return enums indicating success or failure:</p>
<p>请注意，我们的两个新函数返回指示成功或失败的枚举：</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
  META_COMMAND_SUCCESS<span class="token punctuation">,</span>
  META_COMMAND_UNRECOGNIZED_COMMAND
<span class="token punctuation">}</span> MetaCommandResult<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> PREPARE_SUCCESS<span class="token punctuation">,</span> PREPARE_UNRECOGNIZED_STATEMENT <span class="token punctuation">}</span> PrepareResult<span class="token punctuation">;</span>
</code></pre>
<p>“Unrecognized statement”? That seems a bit like an exception. I prefer not to use exceptions (and C doesn’t even support them), so I’m using enum result codes wherever practical. The C compiler will complain if my switch statement doesn’t handle a member of the enum, so we can feel a little more confident we handle every result of a function. Expect more result codes to be added in the future.</p>
<p>“无法识别的声明”？这似乎有点像一个例外。我不喜欢使用异常（C 甚至不支持它们），所以我在可行的情况下使用枚举结果代码。如果我的switch语句没有处理枚举的成员，C编译器会抱怨，所以我们可以更有信心地处理函数的每个结果。预计将来会添加更多结果代码。</p>
<p>do_meta_command is just a wrapper for existing functionality that leaves room for more commands:</p>
<p>do_meta_command 只是现有功能的包装器，为更多命令留出了空间：</p>
<pre class=" language-c"><code class="language-c">MetaCommandResult <span class="token function">do_meta_command</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">".exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Our “prepared statement” right now just contains an enum with two possible values. It will contain more data as we allow parameters in statements:</p>
<p>我们现在的“准备好的语句”只包含一个具有两个可能值的枚举。它将包含更多数据，因为我们允许在语句中使用参数：</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> STATEMENT_INSERT<span class="token punctuation">,</span> STATEMENT_SELECT <span class="token punctuation">}</span> StatementType<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  StatementType type<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Statement<span class="token punctuation">;</span>
</code></pre>
<p>prepare_statement (our “SQL Compiler”) does not understand SQL right now. In fact, it only understands two words:</p>
<p>prepare_statement （我们的“SQL 编译器”）现在不理解 SQL。其实它只懂两个字： </p>
<pre class=" language-c"><code class="language-c">PrepareResult <span class="token function">prepare_statement</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">,</span>
                                Statement<span class="token operator">*</span> statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"insert"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    statement<span class="token operator">-></span>type <span class="token operator">=</span> STATEMENT_INSERT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> PREPARE_SUCCESS<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"select"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    statement<span class="token operator">-></span>type <span class="token operator">=</span> STATEMENT_SELECT<span class="token punctuation">;</span>
    <span class="token keyword">return</span> PREPARE_SUCCESS<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Note that we use strncmp for “insert” since the “insert” keyword will be followed by data. (e.g. insert 1 cstack <a href="mailto:foo@bar.com">foo@bar.com</a>)</p>
<p>请注意，我们使用 strncmp 表示“插入”，因为 “insert” 关键字后跟数据。（例如 insert 1 cstack <a href="mailto:foo@bar.com">foo@bar.com</a> ）</p>
<p>Lastly, execute_statement contains a few stubs:</p>
<p>最后， execute_statement 包含几个存根：</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">execute_statement</span><span class="token punctuation">(</span>Statement<span class="token operator">*</span> statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>statement<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_INSERT<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is where we would do an insert.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_SELECT<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is where we would do a select.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Note that it doesn’t return any error codes because there’s nothing that could go wrong yet.</p>
<p>请注意，它不会返回任何错误代码，因为目前还没有可能出错的问题。</p>
<p>With these refactors, we now recognize two new keywords!</p>
<p>通过这些重构，我们现在认识到两个新关键字！</p>
<p><img src="20230610070822.png"></p>
<p>The skeleton of our database is taking shape… wouldn’t it be nice if it stored data? In the next part, we’ll implement insert and select, creating the world’s worst data store. In the mean time, here’s the entire diff from this part:</p>
<p>我们数据库的骨架正在形成…如果它存储数据不是很好吗？在下一部分中，我们将实现 insert 和 select ，创建世界上最差的数据存储。同时，这是与这部分的全部区别：</p>
<pre class=" language-c"><code class="language-c">@@ <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">23</span> @@ <span class="token keyword">struct</span> InputBuffer_t <span class="token punctuation">{</span>
 <span class="token punctuation">}</span> InputBuffer<span class="token punctuation">;</span>
 
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  META_COMMAND_SUCCESS<span class="token punctuation">,</span>
<span class="token operator">+</span>  META_COMMAND_UNRECOGNIZED_COMMAND
<span class="token operator">+</span><span class="token punctuation">}</span> MetaCommandResult<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> PREPARE_SUCCESS<span class="token punctuation">,</span> PREPARE_UNRECOGNIZED_STATEMENT <span class="token punctuation">}</span> PrepareResult<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> STATEMENT_INSERT<span class="token punctuation">,</span> STATEMENT_SELECT <span class="token punctuation">}</span> StatementType<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  StatementType type<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span> Statement<span class="token punctuation">;</span>
<span class="token operator">+</span>
 InputBuffer<span class="token operator">*</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   InputBuffer<span class="token operator">*</span> input_buffer <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>InputBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   input_buffer<span class="token operator">-></span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">17</span> <span class="token operator">+</span><span class="token number">57</span><span class="token punctuation">,</span><span class="token number">67</span> @@ <span class="token keyword">void</span> <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">free</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
<span class="token operator">+</span>MetaCommandResult <span class="token function">do_meta_command</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">".exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>PrepareResult <span class="token function">prepare_statement</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">,</span>
<span class="token operator">+</span>                                Statement<span class="token operator">*</span> statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"insert"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    statement<span class="token operator">-></span>type <span class="token operator">=</span> STATEMENT_INSERT<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> PREPARE_SUCCESS<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"select"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    statement<span class="token operator">-></span>type <span class="token operator">=</span> STATEMENT_SELECT<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> PREPARE_SUCCESS<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>  <span class="token keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">void</span> <span class="token function">execute_statement</span><span class="token punctuation">(</span>Statement<span class="token operator">*</span> statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>statement<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_INSERT<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is where we would do an insert.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_SELECT<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is where we would do a select.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
 <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   InputBuffer<span class="token operator">*</span> input_buffer <span class="token operator">=</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">read_input</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token operator">-</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">".exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">-</span>      <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>      <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token operator">-</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized command '%s'.\n"</span><span class="token punctuation">,</span> input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>      <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">do_meta_command</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>        <span class="token keyword">case</span> <span class="token punctuation">(</span>META_COMMAND_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>          <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">case</span> <span class="token punctuation">(</span>META_COMMAND_UNRECOGNIZED_COMMAND<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized command '%s'\n"</span><span class="token punctuation">,</span> input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>          <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>      <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    Statement statement<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">prepare_statement</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>      <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token operator">+</span>      <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_UNRECOGNIZED_STATEMENT<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized keyword at start of '%s'.\n"</span><span class="token punctuation">,</span>
<span class="token operator">+</span>               input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    <span class="token function">execute_statement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Executed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 读取的字符(缓冲区)</span>
    size_t buffer_length<span class="token punctuation">;</span>
    ssize_t input_length<span class="token punctuation">;</span>
<span class="token punctuation">}</span> InputBuffer<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 创建InputBuffer</span>
InputBuffer <span class="token operator">*</span><span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 分配内存给input</span>
    InputBuffer <span class="token operator">*</span>input_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>InputBuffer <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>InputBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    input_buffer<span class="token operator">-></span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    input_buffer<span class="token operator">-></span>buffer_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    input_buffer<span class="token operator">-></span>input_length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> input_buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 打印提示</span>
<span class="token keyword">void</span> <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"db > "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 读取一行(linux才有(猜的))</span>
<span class="token comment" spellcheck="true">// ssize_t getline(char **lineptr, size_t *n, FILE *stream);</span>
<span class="token comment" spellcheck="true">// gcc编译报错没有getline(windows)</span>
ssize_t <span class="token function">mygetline</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>line<span class="token punctuation">,</span> size_t <span class="token operator">*</span>n<span class="token punctuation">,</span> FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token operator">*</span>line<span class="token punctuation">;</span>
    ssize_t c<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// i来记录字符串长度，c来存储字符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buf <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> <span class="token operator">*</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token operator">*</span>line <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf <span class="token operator">=</span> <span class="token operator">*</span>line<span class="token punctuation">;</span>
        <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// buf为或n为0时动态为期分配空间</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token operator">*</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 留2个空间给\n和\0</span>
        <span class="token punctuation">{</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token operator">*</span>n <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
            buf <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 空间不足时，重新进行分配</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'\n'</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 读取输入</span>
<span class="token keyword">void</span> <span class="token function">read_input</span><span class="token punctuation">(</span>InputBuffer <span class="token operator">*</span>input_buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    ssize_t bytes_read <span class="token operator">=</span>
        <span class="token function">mygetline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer_length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_read <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error reading input\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Ignore trailing newline</span>
    input_buffer<span class="token operator">-></span>input_length <span class="token operator">=</span> bytes_read <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">[</span>bytes_read <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 释放inputBuffer占用的内存</span>
<span class="token keyword">void</span> <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>InputBuffer <span class="token operator">*</span>input_buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{</span>
    META_COMMAND_SUCCESS<span class="token punctuation">,</span>
    META_COMMAND_UNRECOGNIZED_COMMAND
<span class="token punctuation">}</span> MetaCommandResult<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{</span>
    PREPARE_SUCCESS<span class="token punctuation">,</span>
    PREPARE_UNRECOGNIZED_STATEMENT
<span class="token punctuation">}</span> PrepareResult<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 . 开头的参数</span>
MetaCommandResult <span class="token function">do_meta_command</span><span class="token punctuation">(</span>InputBuffer <span class="token operator">*</span>input_buffer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">".exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 退出系统</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 语句关键字类型(insert/select)</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{</span>
    STATEMENT_INSERT<span class="token punctuation">,</span>
    STATEMENT_SELECT
<span class="token punctuation">}</span> StatementType<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 语句类型</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    StatementType type<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Statement<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析关键字开头的语句(select xxx)</span>
PrepareResult <span class="token function">prepare_statement</span><span class="token punctuation">(</span>InputBuffer <span class="token operator">*</span>input_buffer<span class="token punctuation">,</span>
                                Statement <span class="token operator">*</span>statement<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// C 库函数 int strncmp(const char *str1, const char *str2, size_t n)</span>
    <span class="token comment" spellcheck="true">// 把 str1 和 str2 进行比较，最多比较前 n 个字节</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"insert"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        statement<span class="token operator">-></span>type <span class="token operator">=</span> STATEMENT_INSERT<span class="token punctuation">;</span>
        <span class="token keyword">return</span> PREPARE_SUCCESS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"select"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        statement<span class="token operator">-></span>type <span class="token operator">=</span> STATEMENT_SELECT<span class="token punctuation">;</span>
        <span class="token keyword">return</span> PREPARE_SUCCESS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 执行语句</span>
<span class="token keyword">void</span> <span class="token function">execute_statement</span><span class="token punctuation">(</span>Statement <span class="token operator">*</span>statement<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>statement<span class="token operator">-></span>type<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_INSERT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is where we would do an insert.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_SELECT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is where we would do a select.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    InputBuffer <span class="token operator">*</span>input_buffer <span class="token operator">=</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 借由InputBuffer接收输入</span>
        <span class="token function">read_input</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">do_meta_command</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span>META_COMMAND_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token punctuation">(</span>META_COMMAND_UNRECOGNIZED_COMMAND<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized command '%s'\n"</span><span class="token punctuation">,</span> input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Statement statement<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 解析并判断是否是可解析语句,不是就打印错误</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">prepare_statement</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statement<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_UNRECOGNIZED_STATEMENT<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized keyword at start of '%s'.\n"</span><span class="token punctuation">,</span>
                   input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">execute_statement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Executed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="Part-3-An-In-Memory-Append-Only-Single-Table-Database"><a href="#Part-3-An-In-Memory-Append-Only-Single-Table-Database" class="headerlink" title="Part 3 - An In-Memory, Append-Only, Single-Table Database"></a>Part 3 - An In-Memory, Append-Only, Single-Table Database</h1><blockquote>
<p>第 3 部分 - 内存中、仅追加、单表数据库</p>
</blockquote>
<p>We’re going to start small by putting a lot of limitations on our database. For now, it will:</p>
<p>我们将从小处着手，对数据库施加很多限制。目前，它将：</p>
<ul>
<li>support two operations: inserting a row and printing all rows</li>
</ul>
<p>支持两种操作：插入一行和打印所有行</p>
<ul>
<li>reside only in memory (no persistence to disk)</li>
</ul>
<p>仅驻留在内存中（无磁盘持久性）</p>
<ul>
<li>support a single, hard-coded table</li>
</ul>
<p>支持单个硬编码表</p>
<p>Our hard-coded table is going to store users and look like this:</p>
<p>我们的硬编码表将存储用户，如下所示：</p>
<p><img src="20230610071436.png"></p>
<p>This is a simple schema, but it gets us to support multiple data types and multiple sizes of text data types.</p>
<p>这是一个简单的架构，但它使我们能够支持多种数据类型和多种大小的文本数据类型。</p>
<p>insert statements are now going to look like this:</p>
<p>insert 语句现在将如下所示：</p>
<pre class=" language-shell"><code class="language-shell">insert 1 cstack foo@bar.com
</code></pre>
<p>That means we need to upgrade our prepare_statement function to parse arguments</p>
<p>这意味着我们需要升级我们的 prepare_statement 函数来解析参数</p>
<pre class=" language-c"><code class="language-c">PrepareResult <span class="token function">prepare_statement</span><span class="token punctuation">(</span>InputBuffer <span class="token operator">*</span>input_buffer<span class="token punctuation">,</span>
                                Statement <span class="token operator">*</span>statement<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// C 库函数 int strncmp(const char *str1, const char *str2, size_t n)</span>
    <span class="token comment" spellcheck="true">// 把 str1 和 str2 进行比较，最多比较前 n 个字节</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"insert"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        statement<span class="token operator">-></span>type <span class="token operator">=</span> STATEMENT_INSERT<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 读取输入的insert语句参数,这里硬编码(固定输入的是insert id username email)</span>
        <span class="token keyword">int</span> args_assigned <span class="token operator">=</span> <span class="token function">sscanf</span><span class="token punctuation">(</span>
            input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"insert %d %s %s"</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token punctuation">(</span>statement<span class="token operator">-></span>row_to_insert<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
            statement<span class="token operator">-></span>row_to_insert<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            statement<span class="token operator">-></span>row_to_insert<span class="token punctuation">.</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 参数不够,记为错</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args_assigned <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> PREPARE_SYNTAX_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> PREPARE_SUCCESS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We store those parsed arguments into a new Row data structure inside the statement object:</p>
<p>我们将这些解析的参数存储到语句对象内的新 Row 数据结构中：</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLUMN_USERNAME_SIZE 32</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLUMN_EMAIL_SIZE 255</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    uint32_t id<span class="token punctuation">;</span>
    <span class="token keyword">char</span> username<span class="token punctuation">[</span>COLUMN_USERNAME_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> email<span class="token punctuation">[</span>COLUMN_EMAIL_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> Row<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    StatementType type<span class="token punctuation">;</span>
    Row row_to_insert<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// only used by insert statement</span>
<span class="token punctuation">}</span> Statement<span class="token punctuation">;</span>
</code></pre>
<p>Now we need to copy that data into some data structure representing the table. SQLite uses a B-tree for fast lookups, inserts and deletes. We’ll start with something simpler. Like a B-tree, it will group rows into pages, but instead of arranging those pages as a tree it will arrange them as an array.</p>
<p>现在我们需要将该数据复制到表示表的某个数据结构中。SQLite使用B树进行快速查找，插入和删除。我们将从更简单的东西开始。像B树一样，它会将行分组到页面中，但不是将这些页面排列为树，而是将它们排列为一个数组。</p>
<p>Here’s my plan: 这是我的计划：</p>
<ul>
<li>Store rows in blocks of memory called pages</li>
</ul>
<p>将行存储在称为页的内存块中</p>
<ul>
<li>Each page stores as many rows as it can fit</li>
</ul>
<p>每个页面存储尽可能多的行</p>
<ul>
<li>Rows are serialized into a compact representation with each page</li>
</ul>
<p>行被序列化为每页的紧凑表示形式</p>
<ul>
<li>Pages are only allocated as needed</li>
</ul>
<p>仅根据需要分配页面</p>
<ul>
<li>Keep a fixed-size array of pointers to pages</li>
</ul>
<p>保留指向页面的固定大小的指针数组</p>
<p>First we’ll define the compact representation of a row:</p>
<p>首先，我们将定义一行的紧凑表示：</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> size_of_attribute(Struct, Attribute) sizeof(((Struct *)0)->Attribute)</span>
<span class="token keyword">const</span> uint32_t ID_SIZE <span class="token operator">=</span> <span class="token function">size_of_attribute</span><span class="token punctuation">(</span>Row<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uint32_t USERNAME_SIZE <span class="token operator">=</span> <span class="token function">size_of_attribute</span><span class="token punctuation">(</span>Row<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uint32_t EMAIL_SIZE <span class="token operator">=</span> <span class="token function">size_of_attribute</span><span class="token punctuation">(</span>Row<span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uint32_t ID_OFFSET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uint32_t USERNAME_OFFSET <span class="token operator">=</span> ID_OFFSET <span class="token operator">+</span> ID_SIZE<span class="token punctuation">;</span>
<span class="token keyword">const</span> uint32_t EMAIL_OFFSET <span class="token operator">=</span> USERNAME_OFFSET <span class="token operator">+</span> USERNAME_SIZE<span class="token punctuation">;</span>
<span class="token keyword">const</span> uint32_t ROW_SIZE <span class="token operator">=</span> ID_SIZE <span class="token operator">+</span> USERNAME_SIZE <span class="token operator">+</span> EMAIL_SIZE<span class="token punctuation">;</span>
</code></pre>
<p>This means the layout of a serialized row will look like this:</p>
<p>这意味着序列化行的布局将如下所示：</p>
<p><img src="20230610073508.png"></p>
<p>We also need code to convert to and from the compact representation.</p>
<p>我们还需要代码来与紧凑表示进行转换。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">serialize_row</span><span class="token punctuation">(</span>Row <span class="token operator">*</span>source<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>destination<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>destination <span class="token operator">+</span> ID_OFFSET<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>source<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> ID_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>destination <span class="token operator">+</span> USERNAME_OFFSET<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>source<span class="token operator">-></span>username<span class="token punctuation">)</span><span class="token punctuation">,</span> USERNAME_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>destination <span class="token operator">+</span> EMAIL_OFFSET<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>source<span class="token operator">-></span>email<span class="token punctuation">)</span><span class="token punctuation">,</span> EMAIL_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">deserialize_row</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>source<span class="token punctuation">,</span> Row <span class="token operator">*</span>destination<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>destination<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> source <span class="token operator">+</span> ID_OFFSET<span class="token punctuation">,</span> ID_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>destination<span class="token operator">-></span>username<span class="token punctuation">)</span><span class="token punctuation">,</span> source <span class="token operator">+</span> USERNAME_OFFSET<span class="token punctuation">,</span> USERNAME_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>destination<span class="token operator">-></span>email<span class="token punctuation">)</span><span class="token punctuation">,</span> source <span class="token operator">+</span> EMAIL_OFFSET<span class="token punctuation">,</span> EMAIL_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Next, a Table structure that points to pages of rows and keeps track of how many rows there are:</p>
<p>接下来，一个指向行页并跟踪行数的 Table 结构：</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">const</span> uint32_t PAGE_SIZE <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TABLE_MAX_PAGES 100</span>
<span class="token keyword">const</span> uint32_t ROWS_PER_PAGE <span class="token operator">=</span> PAGE_SIZE <span class="token operator">/</span> ROW_SIZE<span class="token punctuation">;</span>
<span class="token keyword">const</span> uint32_t TABLE_MAX_ROWS <span class="token operator">=</span> ROWS_PER_PAGE <span class="token operator">*</span> TABLE_MAX_PAGES<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    uint32_t num_rows<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>pages<span class="token punctuation">[</span>TABLE_MAX_PAGES<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> Table<span class="token punctuation">;</span>
</code></pre>
<p>I’m making our page size 4 kilobytes because it’s the same size as a page used in the virtual memory systems of most computer architectures. This means one page in our database corresponds to one page used by the operating system. The operating system will move pages in and out of memory as whole units instead of breaking them up.</p>
<p>我将页面大小设为 4 KB，因为它与大多数计算机体系结构的虚拟内存系统中使用的页面大小相同。这意味着我们数据库中的一页对应于操作系统使用的一个页面。操作系统会将页面作为整个单元移入和移出内存，而不是分解它们。</p>
<p>I’m setting an arbitrary limit of 100 pages that we will allocate. When we switch to a tree structure, our database’s maximum size will only be limited by the maximum size of a file. (Although we’ll still limit how many pages we keep in memory at once)</p>
<p>我设置了一个任意限制，即我们将分配的 100 页。当我们切换到树结构时，数据库的最大大小将仅受文件最大大小的限制。（尽管我们仍然会限制一次在内存中保留的页面数）</p>
<p>Rows should not cross page boundaries. Since pages probably won’t exist next to each other in memory, this assumption makes it easier to read/write rows.</p>
<p>行不应跨越页面边界。由于页面在内存中可能不会彼此相邻存在，因此此假设使读取/写入行变得更加容易。</p>
<p>Speaking of which, here is how we figure out where to read/write in memory for a particular row:</p>
<p>说到这里，以下是我们如何确定特定行在内存中读取/写入的位置：</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">row_slot</span><span class="token punctuation">(</span>Table <span class="token operator">*</span>table<span class="token punctuation">,</span> uint32_t row_num<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    uint32_t page_num <span class="token operator">=</span> row_num <span class="token operator">/</span> ROWS_PER_PAGE<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>page <span class="token operator">=</span> table<span class="token operator">-></span>pages<span class="token punctuation">[</span>page_num<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>page <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Allocate memory only when we try to access page</span>
        page <span class="token operator">=</span> table<span class="token operator">-></span>pages<span class="token punctuation">[</span>page_num<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    uint32_t row_offset <span class="token operator">=</span> row_num <span class="token operator">%</span> ROWS_PER_PAGE<span class="token punctuation">;</span>
    uint32_t byte_offset <span class="token operator">=</span> row_offset <span class="token operator">*</span> ROW_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">return</span> page <span class="token operator">+</span> byte_offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now we can make execute_statement read/write from our table structure:</p>
<p>现在我们可以从表结构中进行 execute_statement 读/写：</p>
<pre class=" language-c"><code class="language-c">ExecuteResult <span class="token function">execute_insert</span><span class="token punctuation">(</span>Statement <span class="token operator">*</span>statement<span class="token punctuation">,</span> Table <span class="token operator">*</span>table<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token operator">-></span>num_rows <span class="token operator">>=</span> TABLE_MAX_ROWS<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> EXECUTE_TABLE_FULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Row <span class="token operator">*</span>row_to_insert <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>statement<span class="token operator">-></span>row_to_insert<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">serialize_row</span><span class="token punctuation">(</span>row_to_insert<span class="token punctuation">,</span> <span class="token function">row_slot</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> table<span class="token operator">-></span>num_rows<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token operator">-></span>num_rows <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> EXECUTE_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ExecuteResult <span class="token function">execute_select</span><span class="token punctuation">(</span>Statement <span class="token operator">*</span>statement<span class="token punctuation">,</span> Table <span class="token operator">*</span>table<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Row row<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> table<span class="token operator">-></span>num_rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">deserialize_row</span><span class="token punctuation">(</span><span class="token function">row_slot</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">print_row</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> EXECUTE_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ExecuteResult <span class="token function">execute_statement</span><span class="token punctuation">(</span>Statement <span class="token operator">*</span>statement<span class="token punctuation">,</span> Table <span class="token operator">*</span>table<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>statement<span class="token operator">-></span>type<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_INSERT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">execute_insert</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_SELECT<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token function">execute_select</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Lastly, we need to initialize the table, create the respective memory release function and handle a few more error cases:</p>
<p>最后，我们需要初始化表，创建相应的内存释放函数并处理更多错误情况：</p>
<pre class=" language-c"><code class="language-c">Table <span class="token operator">*</span><span class="token function">new_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Table <span class="token operator">*</span>table <span class="token operator">=</span> <span class="token punctuation">(</span>Table <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token operator">-></span>num_rows <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TABLE_MAX_PAGES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        table<span class="token operator">-></span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> table<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 释放数据表空间</span>
<span class="token keyword">void</span> <span class="token function">free_table</span><span class="token punctuation">(</span>Table <span class="token operator">*</span>table<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> table<span class="token operator">-></span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">free</span><span class="token punctuation">(</span>table<span class="token operator">-></span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  Table<span class="token operator">*</span> table <span class="token operator">=</span> <span class="token function">new_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   InputBuffer<span class="token operator">*</span> input_buffer <span class="token operator">=</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">prepare_statement</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token operator">+</span>      <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_SYNTAX_ERROR<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Syntax error. Could not parse statement.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>
       <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_UNRECOGNIZED_STATEMENT<span class="token punctuation">)</span><span class="token punctuation">:</span>
         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized keyword at start of '%s'.\n"</span><span class="token punctuation">,</span>
                input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">continue</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

<span class="token operator">-</span>    <span class="token function">execute_statement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Executed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">execute_statement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>statement<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>      <span class="token keyword">case</span> <span class="token punctuation">(</span>EXECUTE_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Executed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token operator">+</span>      <span class="token keyword">case</span> <span class="token punctuation">(</span>EXECUTE_TABLE_FULL<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error: Table full.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre>
<p>With those changes we can actually save data in our database!</p>
<p>通过这些更改，我们实际上可以将数据保存在数据库中！</p>
<pre class=" language-c"><code class="language-c">@@ <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span> @@
 <span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
 <span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
 <span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token operator">+</span>#include <span class="token operator">&lt;</span>stdint<span class="token punctuation">.</span>h<span class="token operator">></span>

 <span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">105</span> @@ <span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span> InputBuffer<span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> EXECUTE_SUCCESS<span class="token punctuation">,</span> EXECUTE_TABLE_FULL <span class="token punctuation">}</span> ExecuteResult<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  META_COMMAND_SUCCESS<span class="token punctuation">,</span>
<span class="token operator">+</span>  META_COMMAND_UNRECOGNIZED_COMMAND
<span class="token operator">+</span><span class="token punctuation">}</span> MetaCommandResult<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  PREPARE_SUCCESS<span class="token punctuation">,</span>
<span class="token operator">+</span>  PREPARE_SYNTAX_ERROR<span class="token punctuation">,</span>
<span class="token operator">+</span>  PREPARE_UNRECOGNIZED_STATEMENT
<span class="token operator">+</span> <span class="token punctuation">}</span> PrepareResult<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span> STATEMENT_INSERT<span class="token punctuation">,</span> STATEMENT_SELECT <span class="token punctuation">}</span> StatementType<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>#define COLUMN_USERNAME_SIZE <span class="token number">32</span>
<span class="token operator">+</span>#define COLUMN_EMAIL_SIZE <span class="token number">255</span>
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  uint32_t id<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token keyword">char</span> username<span class="token punctuation">[</span>COLUMN_USERNAME_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token keyword">char</span> email<span class="token punctuation">[</span>COLUMN_EMAIL_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span> Row<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  StatementType type<span class="token punctuation">;</span>
<span class="token operator">+</span>  Row row_to_insert<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//only used by insert statement</span>
<span class="token operator">+</span><span class="token punctuation">}</span> Statement<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>#define <span class="token function">size_of_attribute</span><span class="token punctuation">(</span>Struct<span class="token punctuation">,</span> Attribute<span class="token punctuation">)</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Struct<span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-></span>Attribute<span class="token punctuation">)</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t ID_SIZE <span class="token operator">=</span> <span class="token function">size_of_attribute</span><span class="token punctuation">(</span>Row<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t USERNAME_SIZE <span class="token operator">=</span> <span class="token function">size_of_attribute</span><span class="token punctuation">(</span>Row<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t EMAIL_SIZE <span class="token operator">=</span> <span class="token function">size_of_attribute</span><span class="token punctuation">(</span>Row<span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t ID_OFFSET <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t USERNAME_OFFSET <span class="token operator">=</span> ID_OFFSET <span class="token operator">+</span> ID_SIZE<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t EMAIL_OFFSET <span class="token operator">=</span> USERNAME_OFFSET <span class="token operator">+</span> USERNAME_SIZE<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t ROW_SIZE <span class="token operator">=</span> ID_SIZE <span class="token operator">+</span> USERNAME_SIZE <span class="token operator">+</span> EMAIL_SIZE<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t PAGE_SIZE <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
<span class="token operator">+</span>#define TABLE_MAX_PAGES <span class="token number">100</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t ROWS_PER_PAGE <span class="token operator">=</span> PAGE_SIZE <span class="token operator">/</span> ROW_SIZE<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token keyword">const</span> uint32_t TABLE_MAX_ROWS <span class="token operator">=</span> ROWS_PER_PAGE <span class="token operator">*</span> TABLE_MAX_PAGES<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  uint32_t num_rows<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token keyword">void</span><span class="token operator">*</span> pages<span class="token punctuation">[</span>TABLE_MAX_PAGES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span> Table<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">void</span> <span class="token function">print_row</span><span class="token punctuation">(</span>Row<span class="token operator">*</span> row<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"(%d, %s, %s)\n"</span><span class="token punctuation">,</span> row<span class="token operator">-></span>id<span class="token punctuation">,</span> row<span class="token operator">-></span>username<span class="token punctuation">,</span> row<span class="token operator">-></span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">void</span> <span class="token function">serialize_row</span><span class="token punctuation">(</span>Row<span class="token operator">*</span> source<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> destination<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span>destination <span class="token operator">+</span> ID_OFFSET<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>source<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> ID_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span>destination <span class="token operator">+</span> USERNAME_OFFSET<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>source<span class="token operator">-></span>username<span class="token punctuation">)</span><span class="token punctuation">,</span> USERNAME_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span>destination <span class="token operator">+</span> EMAIL_OFFSET<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>source<span class="token operator">-></span>email<span class="token punctuation">)</span><span class="token punctuation">,</span> EMAIL_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">void</span> <span class="token function">deserialize_row</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>source<span class="token punctuation">,</span> Row<span class="token operator">*</span> destination<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>destination<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> source <span class="token operator">+</span> ID_OFFSET<span class="token punctuation">,</span> ID_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>destination<span class="token operator">-></span>username<span class="token punctuation">)</span><span class="token punctuation">,</span> source <span class="token operator">+</span> USERNAME_OFFSET<span class="token punctuation">,</span> USERNAME_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>destination<span class="token operator">-></span>email<span class="token punctuation">)</span><span class="token punctuation">,</span> source <span class="token operator">+</span> EMAIL_OFFSET<span class="token punctuation">,</span> EMAIL_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">row_slot</span><span class="token punctuation">(</span>Table<span class="token operator">*</span> table<span class="token punctuation">,</span> uint32_t row_num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  uint32_t page_num <span class="token operator">=</span> row_num <span class="token operator">/</span> ROWS_PER_PAGE<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token keyword">void</span> <span class="token operator">*</span>page <span class="token operator">=</span> table<span class="token operator">-></span>pages<span class="token punctuation">[</span>page_num<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>page <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     <span class="token comment" spellcheck="true">// Allocate memory only when we try to access page</span>
<span class="token operator">+</span>     page <span class="token operator">=</span> table<span class="token operator">-></span>pages<span class="token punctuation">[</span>page_num<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span>  uint32_t row_offset <span class="token operator">=</span> row_num <span class="token operator">%</span> ROWS_PER_PAGE<span class="token punctuation">;</span>
<span class="token operator">+</span>  uint32_t byte_offset <span class="token operator">=</span> row_offset <span class="token operator">*</span> ROW_SIZE<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token keyword">return</span> page <span class="token operator">+</span> byte_offset<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>Table<span class="token operator">*</span> <span class="token function">new_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  Table<span class="token operator">*</span> table <span class="token operator">=</span> <span class="token punctuation">(</span>Table<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  table<span class="token operator">-></span>num_rows <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> TABLE_MAX_PAGES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     table<span class="token operator">-></span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span>  <span class="token keyword">return</span> table<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">void</span> <span class="token function">free_table</span><span class="token punctuation">(</span>Table<span class="token operator">*</span> table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> table<span class="token operator">-></span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     <span class="token function">free</span><span class="token punctuation">(</span>table<span class="token operator">-></span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span>  <span class="token function">free</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
 InputBuffer<span class="token operator">*</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   InputBuffer<span class="token operator">*</span> input_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>InputBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   input_buffer<span class="token operator">-></span>buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">17</span> <span class="token operator">+</span><span class="token number">140</span><span class="token punctuation">,</span><span class="token number">105</span> @@ <span class="token keyword">void</span> <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">free</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token operator">+</span>MetaCommandResult <span class="token function">do_meta_command</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">,</span> Table <span class="token operator">*</span>table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">".exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token function">free_table</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>PrepareResult <span class="token function">prepare_statement</span><span class="token punctuation">(</span>InputBuffer<span class="token operator">*</span> input_buffer<span class="token punctuation">,</span>
<span class="token operator">+</span>                                Statement<span class="token operator">*</span> statement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"insert"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    statement<span class="token operator">-></span>type <span class="token operator">=</span> STATEMENT_INSERT<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">int</span> args_assigned <span class="token operator">=</span> <span class="token function">sscanf</span><span class="token punctuation">(</span>
<span class="token operator">+</span>    input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"insert %d %s %s"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>statement<span class="token operator">-></span>row_to_insert<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">+</span>    statement<span class="token operator">-></span>row_to_insert<span class="token punctuation">.</span>username<span class="token punctuation">,</span> statement<span class="token operator">-></span>row_to_insert<span class="token punctuation">.</span>email
<span class="token operator">+</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>args_assigned <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> PREPARE_SYNTAX_ERROR<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> PREPARE_SUCCESS<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">"select"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    statement<span class="token operator">-></span>type <span class="token operator">=</span> STATEMENT_SELECT<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> PREPARE_SUCCESS<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>  <span class="token keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>ExecuteResult <span class="token function">execute_insert</span><span class="token punctuation">(</span>Statement<span class="token operator">*</span> statement<span class="token punctuation">,</span> Table<span class="token operator">*</span> table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token operator">-></span>num_rows <span class="token operator">>=</span> TABLE_MAX_ROWS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     <span class="token keyword">return</span> EXECUTE_TABLE_FULL<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>  Row<span class="token operator">*</span> row_to_insert <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>statement<span class="token operator">-></span>row_to_insert<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>  <span class="token function">serialize_row</span><span class="token punctuation">(</span>row_to_insert<span class="token punctuation">,</span> <span class="token function">row_slot</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> table<span class="token operator">-></span>num_rows<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  table<span class="token operator">-></span>num_rows <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>  <span class="token keyword">return</span> EXECUTE_SUCCESS<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>ExecuteResult <span class="token function">execute_select</span><span class="token punctuation">(</span>Statement<span class="token operator">*</span> statement<span class="token punctuation">,</span> Table<span class="token operator">*</span> table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  Row row<span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> table<span class="token operator">-></span>num_rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     <span class="token function">deserialize_row</span><span class="token punctuation">(</span><span class="token function">row_slot</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>     <span class="token function">print_row</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span>  <span class="token keyword">return</span> EXECUTE_SUCCESS<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>ExecuteResult <span class="token function">execute_statement</span><span class="token punctuation">(</span>Statement<span class="token operator">*</span> statement<span class="token punctuation">,</span> Table <span class="token operator">*</span>table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>statement<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_INSERT<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>           <span class="token keyword">return</span> <span class="token function">execute_insert</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">case</span> <span class="token punctuation">(</span>STATEMENT_SELECT<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">execute_select</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
 <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  Table<span class="token operator">*</span> table <span class="token operator">=</span> <span class="token function">new_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   InputBuffer<span class="token operator">*</span> input_buffer <span class="token operator">=</span> <span class="token function">new_input_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">print_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">read_input</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">-</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">,</span> <span class="token string">".exit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">-</span>      <span class="token function">close_input_buffer</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>      <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token operator">-</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized command '%s'.\n"</span><span class="token punctuation">,</span> input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>      <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">do_meta_command</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>        <span class="token keyword">case</span> <span class="token punctuation">(</span>META_COMMAND_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>          <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">case</span> <span class="token punctuation">(</span>META_COMMAND_UNRECOGNIZED_COMMAND<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized command '%s'\n"</span><span class="token punctuation">,</span> input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>          <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>      <span class="token punctuation">}</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    Statement statement<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">prepare_statement</span><span class="token punctuation">(</span>input_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>      <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token operator">+</span>      <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_SYNTAX_ERROR<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Syntax error. Could not parse statement.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>      <span class="token keyword">case</span> <span class="token punctuation">(</span>PREPARE_UNRECOGNIZED_STATEMENT<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unrecognized keyword at start of '%s'.\n"</span><span class="token punctuation">,</span>
<span class="token operator">+</span>               input_buffer<span class="token operator">-></span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">execute_statement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>statement<span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    <span class="token keyword">case</span> <span class="token punctuation">(</span>EXECUTE_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Executed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">case</span> <span class="token punctuation">(</span>EXECUTE_TABLE_FULL<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token operator">+</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error: Table full.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre>
<pre class=" language-shell"><code class="language-shell">~ ./db
db > insert 1 cstack foo@bar.com
Executed.
db > insert 2 bob bob@example.com
Executed.
db > select
(1, cstack, foo@bar.com)
(2, bob, bob@example.com)
Executed.
db > insert foo bar 1
Syntax error. Could not parse statement.
db > .exit
~
</code></pre>
<blockquote>
<p>有坑,弃了</p>
</blockquote>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff;
        background-color: #22AB38;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff;
        background-color: #019FE8;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs">
                        <li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li>
                        <li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('#reward .reward-link').on('click', function () {
            $('#rewardModal').openModal();
        });

        $('#rewardModal .close').on('click', function () {
            $('#rewardModal').closeModal();
        });
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://malred.github.io" class="b-link-green">malred-blog</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2023/06/09/bigdata/let-sbuildasimpledatabase/a/" class="b-link-green">a</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/06/10/ai/udemymachinelearningdeeplearningandbayesianlearning/udemymachinelearningdeeplearningandbayesianlearning/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="UdemyMachineLearningDeepLearningAndBayesianLearning">
                        
                        <span class="card-title">UdemyMachineLearningDeepLearningAndBayesianLearning</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">01 - Introductioninstall something to get start至少需要python3.6
google drive
google colab他使用的编辑器是vscode
01.04 Jupyter Noteb</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2023-06-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/udemy/" class="post-category" target="_blank">
                                    udemy
                                </a>
                            
                            <a href="/categories/udemy/ai/" class="post-category" target="_blank">
                                    ai
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/ai/" target="_blank">
                        <span class="chip bg-color">ai</span>
                    </a>
                    
                    <a href="/tags/udemy/" target="_blank">
                        <span class="chip bg-color">udemy</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/06/09/backend/golang/go-compile/2/byq/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="用go语言实现编译器">
                        
                        <span class="card-title">用go语言实现编译器</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary"></div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2023-06-09
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/golang/" class="post-category" target="_blank">
                                    golang
                                </a>
                            
                            <a href="/categories/golang/%E7%BC%96%E8%AF%91%E5%99%A8/" class="post-category" target="_blank">
                                    编译器
                                </a>
                            
                            <a href="/categories/golang/%E7%BC%96%E8%AF%91%E5%99%A8/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" class="post-category" target="_blank">
                                    编译原理
                                </a>
                            
                            <a href="/categories/golang/%E7%BC%96%E8%AF%91%E5%99%A8/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/%E9%80%A0%E8%BD%AE%E5%AD%90/" class="post-category" target="_blank">
                                    造轮子
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E9%80%A0%E8%BD%AE%E5%AD%90/" target="_blank">
                        <span class="chip bg-color">造轮子</span>
                    </a>
                    
                    <a href="/tags/golang/" target="_blank">
                        <span class="chip bg-color">golang</span>
                    </a>
                    
                    <a href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" target="_blank">
                        <span class="chip bg-color">编译器</span>
                    </a>
                    
                    <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" target="_blank">
                        <span class="chip bg-color">编译原理</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: malred-blog<br />'
            + '作者: malred<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处 -> https://malred.github.io/。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站由&copy;<a href="https://blinkfox.github.io/" target="_blank">Blinkfox</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">179.3k</span>
            

            
			
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/malred" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:malguy2022@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2725953379" class="tooltipped" data-tooltip="QQ联系我: 2725953379" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-MSEYRC5EW5"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-MSEYRC5EW5');
</script>



    <script src="/libs/others/clicklove.js"></script>



</body>
</html>