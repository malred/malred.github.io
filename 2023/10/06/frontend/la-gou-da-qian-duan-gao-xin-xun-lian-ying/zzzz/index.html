<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="拉勾大前端高薪训练营, HTML,CSS,React,Vue,Java,Go,微服务,linux">
    <meta name="description" content="01.Part 1 · JavaScript 深度剖析02.Part 2 · 前端工程化实战02.模块二 模块化开发与规范化标准05.任务五：webpack源码01.内容概述
02.打包后文件分析
key: ‘src/inedx.js’, ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>拉勾大前端高薪训练营 | malred-blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/logo.png" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">malred-blog</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">malred-blog</div>
        <div class="logo-desc">
            
            前后端学习者,存放知识笔记
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
    </ul>

    <div class="social-link">
    <a href="https://github.com/malred" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:malguy2022@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2725953379" class="tooltipped" data-tooltip="QQ联系我: 2725953379" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
</div>

            </div>
        </div>

        
    </nav>
</header>


<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        拉勾大前端高薪训练营
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%89%8D%E7%AB%AF/" target="_blank">
                                <span class="chip bg-color">前端</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%89%8D%E7%AB%AF/" class="post-category" target="_blank">
                                前端
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-10-06
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        15.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        75 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="01-Part-1-·-JavaScript-深度剖析"><a href="#01-Part-1-·-JavaScript-深度剖析" class="headerlink" title="01.Part 1 · JavaScript 深度剖析"></a>01.Part 1 · JavaScript 深度剖析</h1><h1 id="02-Part-2-·-前端工程化实战"><a href="#02-Part-2-·-前端工程化实战" class="headerlink" title="02.Part 2 · 前端工程化实战"></a>02.Part 2 · 前端工程化实战</h1><h2 id="02-模块二-模块化开发与规范化标准"><a href="#02-模块二-模块化开发与规范化标准" class="headerlink" title="02.模块二 模块化开发与规范化标准"></a>02.模块二 模块化开发与规范化标准</h2><h3 id="05-任务五：webpack源码"><a href="#05-任务五：webpack源码" class="headerlink" title="05.任务五：webpack源码"></a>05.任务五：webpack源码</h3><h4 id="01-内容概述"><a href="#01-内容概述" class="headerlink" title="01.内容概述"></a>01.内容概述</h4><p><img src="3a1faad7.png"></p>
<h4 id="02-打包后文件分析"><a href="#02-打包后文件分析" class="headerlink" title="02.打包后文件分析"></a>02.打包后文件分析</h4><p><img src="49f4b12c.png"><img src="1ff309f9.png"><img src="9e277a19.png"><img src="0f8d1ee9.png"></p>
<p>key: ‘src/inedx.js’, val(模块函数): (function(){})<br><img src="3bcd6e31.png" alt="匿名函数自调用"><img src="569af4d2.png"><img src="d183114d.png" alt="传入模块id,找到对应模块,解析返回模块export的内容"></p>
<h4 id="03-单文件打包后源码调试"><a href="#03-单文件打包后源码调试" class="headerlink" title="03.单文件打包后源码调试"></a>03.单文件打包后源码调试</h4><p><img src="c471deba.png" alt="vscode调试的配置"><img src="31a514e4.png"><img src="bdb800ee.png"><img src="62d6d151.png"><img src="20991c7c.png"><br><img src="bc833ed8.png"><img src="0b02ed1a.png"><img src="bf9d6ae0.png" alt="缓存并赋值"><img src="56f23934.png" alt="调用模块定义函数"><br><img src="1d9656d1.png"><img src="9e8f28e4.png"><img src="01592a74.png" alt="调用完module,就把module的export赋值给export字段,l表示该模块加载过"><br><img src="82fc11c2.png"><img src="96eab715.png" alt="导出exports的值"></p>
<h4 id="04-功能函数说明"><a href="#04-功能函数说明" class="headerlink" title="04.功能函数说明"></a>04.功能函数说明</h4><p><img src="062ef2e8.png"><img src="f2330fdb.png"><img src="95fbc2c0.png"><img src="ec7fbe15.png"><img src="04f99065.png"><br><img src="e68d703e.png"><img src="84712da2.png"><img src="53fd683d.png"><img src="fb363ae9.png"><img src="38cf0455.png"><br><img src="8a5f28e8.png"><img src="6aae6511.png"></p>
<h4 id="05-CommonJS模块打包"><a href="#05-CommonJS模块打包" class="headerlink" title="05.CommonJS模块打包"></a>05.CommonJS模块打包</h4><p><img src="67cc0114.png"><img src="224c1ab9.png"><img src="fdb20b20.png"><img src="51704b50.png"><img src="24af1f75.png"><br><img src="653f0c36.png"><img src="23a5dc21.png"><img src="e8358c8a.png"><img src="633f4298.png"><img src="ceb146af.png"><br><img src="4375e845.png"></p>
<h4 id="06-eModule模块打包"><a href="#06-eModule模块打包" class="headerlink" title="06.eModule模块打包"></a>06.eModule模块打包</h4><p><img src="95c692c2.png"><img src="5242b4b7.png" alt="import"><img src="cacfc474.png"><img src="d728c3aa.png"><img src="9b57f933.png"><br><img src="f1dc76ee.png"><img src="3fa1e49d.png"><img src="f4be997b.png"><img src="1eb2ba71.png"><img src="dc12710e.png"><br><img src="c68e14a9.png"><img src="b4af7dd3.png"><img src="2e3dbd52.png"></p>
<h4 id="07-功能函数手写实现"><a href="#07-功能函数手写实现" class="headerlink" title="07.功能函数手写实现"></a>07.功能函数手写实现</h4><pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--index.html--></span>
<span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mybuilt.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// mybuild.js</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. 用于缓存加载过的模块</span>
    <span class="token keyword">let</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2. 定义一个 __webpack_require__ 方法来替换 import require 加载操作</span>
    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 2-1 判断当前缓存中是否存在要被加载的模块内容,如果存在则直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 2-2 如果当前缓存中不存在则需要我们自己定义{} 执行被导入的模块内容加载</span>
        <span class="token keyword">let</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 是否被加载</span>
            l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 导出内容</span>
            exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 2-3 调用当前 moduleId 对应的函数,然后完成内容的加载</span>
        modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 2-4 上述方法调用完成后,就可以修改 l 的值,表示当前模块已经加载完成</span>
        module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token comment" spellcheck="true">// 2-5 加载工作完成之后,要将拿回来的内容返回至调用的位置</span>
        <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 3. 定义 m 属性用于保存 modules</span>
    __webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> modules

    <span class="token comment" spellcheck="true">// 4. 定义 c 属性用于保存cache</span>
    __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> installedModules

    <span class="token comment" spellcheck="true">// 5. 定义 o 方法用于判断对象的身上是否存在指定的属性</span>
    __webpack_require__<span class="token punctuation">.</span>o <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 6. 定义 d 方法用于在对象的身上添加指定的属性,同时给该属性提供gatter</span>
    __webpack_require__<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 对象身上没有该属性</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span>enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">:</span> getter<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 7. 定义 r 方法用于标识当前模块是 es6(esModule) 类型</span>
    __webpack_require__<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">,</span> <span class="token punctuation">{</span>value<span class="token punctuation">:</span> <span class="token string">"Module"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'__esModule'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>value<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 8. 定义 n 方法用于设置具体的getter</span>
    __webpack_require__<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> getter <span class="token operator">=</span> module <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>__esModule <span class="token operator">?</span>
            <span class="token keyword">function</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> module<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span> <span class="token punctuation">:</span>
            <span class="token keyword">function</span> <span class="token function">getModuleExports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> module
            <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 给getter定义a属性,获取方法是getter</span>
        __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> getter<span class="token punctuation">)</span>
        <span class="token keyword">return</span> getter
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 9. 定义 p 属性,用于保存资源访问路径</span>
    __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span>

    <span class="token comment" spellcheck="true">// 10. 调用 __webpack_require__ 方法执行模块导入与加载操作</span>
    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span>
        <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token string">"use strict"</span><span class="token punctuation">;</span>
            __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> _login__WEBPACK_IMPORTED_MODULE_0__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/*! ./login */</span> <span class="token string">"./src/login.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'indexjs'</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_login__WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">"default"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'&lt;-----'</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_login__WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">"age"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'&lt;-----'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"./src/login.js"</span><span class="token punctuation">:</span>
        <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token string">"use strict"</span><span class="token punctuation">;</span>
            __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
            __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> age<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            __webpack_exports__<span class="token punctuation">[</span><span class="token string">"default"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'我很帅'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span>
<span class="token comment" spellcheck="true">// let name = require('./login')</span>
<span class="token keyword">import</span> name<span class="token punctuation">,</span> <span class="token punctuation">{</span>age<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./login'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'indexjs'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'&lt;-----'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">,</span> <span class="token string">'&lt;-----'</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// login.js</span>
<span class="token comment" spellcheck="true">// module.exports = '拉勾教育'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'我很帅'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span>
</code></pre>
<h4 id="09-懒加载实现流程梳理"><a href="#09-懒加载实现流程梳理" class="headerlink" title="09.懒加载实现流程梳理"></a>09.懒加载实现流程梳理</h4><p><img src="cab27dd0.png"><img src="4a76e5df.png"><img src="02ea492e.png"><img src="57f2d76c.png"><img src="0685fa84.png"><br>在懒加载时生成script标签(e方法)来引入<br><img src="aabe4545.png"><img src="ebaac1aa.png"></p>
<h4 id="10-t方法分析及实现"><a href="#10-t方法分析及实现" class="headerlink" title="10.t方法分析及实现"></a>10.t方法分析及实现</h4><p><img src="bd5d009c.png"><img src="b7e784e6.png"><img src="09cd52e2.png"><img src="a73627eb.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 11. 定义 t 方法,用于加载指定 value 的模块内容,之后对内容进行处理再返回</span>
    __webpack_require__<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 01 加载 value 对应的模块内容( value 一般就是模块id)</span>
        <span class="token comment" spellcheck="true">// 加载之后的内容又重新赋值给 value 变量</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 加载了可以直接返回使用的内容</span>
            <span class="token keyword">return</span> value
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 到这说明没有return</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__esModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> value
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果8和4都不成立,则需要自定义 ns 来通过 default 属性返回内容</span>
        <span class="token keyword">let</span> ns <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

        __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span>

        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> value<span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bin</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> ns
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 9. 定义 p 属性,用于保存资源访问路径</span>
    __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">""</span>

    <span class="token comment" spellcheck="true">// 10. 调用 __webpack_require__ 方法执行模块导入与加载操作</span>
    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span>
        <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// let name = __webpack_require__.t(</span><span class="token comment" spellcheck="true">/*! ./login */</span> <span class="token string">"./src/login.js"</span><span class="token punctuation">,</span><span class="token number">0b1001</span><span class="token punctuation">)</span>
            <span class="token keyword">let</span> name <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/*! ./login */</span> <span class="token string">"./src/login.js"</span><span class="token punctuation">,</span> <span class="token number">0b0111</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index.js'</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token string">"./src/login.js"</span><span class="token punctuation">:</span>
        <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">'拉勾教育'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="11-单文件懒加载源码分析"><a href="#11-单文件懒加载源码分析" class="headerlink" title="11.单文件懒加载源码分析"></a>11.单文件懒加载源码分析</h4><p><img src="8b2eeb93.png"><img src="1059b38e.png"><img src="4df79cd1.png"><img src="274aab68.png"><img src="72178f47.png"><br><img src="4803a9fb.png"><img src="dba78324.png"><img src="e866d1fa.png" alt="重写push"><img src="52adea60.png" alt="合并模块依赖关系"><img src="39ad8daf.png"><br><img src="0653f8fa.png"><img src="785a27a8.png"></p>
<p><img src="86daba71.png"><img src="e31e289f.png"><img src="2140fc24.png" alt="保存resolve reject"><img src="c9afa068.png"><br><img src="0d570b5a.png"><img src="8ea1e116.png"><img src="cf71781e.png"><img src="4629af87.png"><img src="6683fe5a.png"><br><img src="c1c21184.png"><img src="ef4cbdad.png"><img src="81a4a4f3.png"><img src="5bf8c50c.png" alt="标识为加载过 0"><br><img src="38bcb32d.png"><img src="a89d90b9.png" alt="执行resolve"><img src="32cbd145.png"></p>
<h4 id="13-单文件懒加载手写实现"><a href="#13-单文件懒加载手写实现" class="headerlink" title="13.单文件懒加载手写实现"></a>13.单文件懒加载手写实现</h4><p><img src="8b2eeb93.png"><img src="1059b38e.png"><img src="4df79cd1.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 14. 定义 webpackJsonpCallback 实现: 合并模块定义,改变 promise 状态执行后续行为</span>
    <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 1 获取需要被动态加载的模块 id</span>
        <span class="token keyword">let</span> chunkIds <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true">// 2 获取需要被动态加载的模块依赖关系对象</span>
        <span class="token keyword">let</span> moreModules <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">let</span> chunkId<span class="token punctuation">,</span> resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true">// 3 循环判断 chunkIds 里对应的模块内容是否已经完成了加载</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
                Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>inStalledChunks<span class="token punctuation">,</span> chunkId<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> inStalledChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>inStalledChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 更新当前 chunk 的状态</span>
            inStalledChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>moreModules<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 挂载动态加载的module的依赖关系到传入的modules</span>
                modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>resolves<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 执行操作</span>
            resolves<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 1. 用于缓存加载过的模块</span>
    <span class="token keyword">let</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 15 定义 inStalledChunks 对象,用于标识某个 chunkId 对应的 chunk 是否完成了加载</span>
    <span class="token keyword">let</span> inStalledChunks <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 0 -> 已加载</span>
        main<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 17 定义 jsonpScriptSrc 来实现 src 的处理</span>
    <span class="token keyword">function</span> <span class="token function">jsonpScriptSrc</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">""</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">".built.js"</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 16 定义 e 方法用于实现: 实现jsonp来加载内容, 利用promise 实现异步加载操作</span>
    __webpack_require__<span class="token punctuation">.</span>e <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 1 定义一个数组用于存放 promise</span>
        <span class="token keyword">let</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true">// 2 获取 chunkId 对应的 chunk 是否已经完成了加载</span>
        <span class="token keyword">let</span> installedChunkData <span class="token operator">=</span> inStalledChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true">// 3 依据当前是否已完成加载的状态来执行后续的逻辑</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    installedChunkData <span class="token operator">=</span> inStalledChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>

                <span class="token comment" spellcheck="true">// installedChunkData [resolve,reject,promise]</span>
                promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> promise<span class="token punctuation">)</span>

                <span class="token comment" spellcheck="true">// 创建标签</span>
                <span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 设置src</span>
                script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token function">jsonpScriptSrc</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 写入 script 标签</span>
                document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 执行promise</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...    </span>

    <span class="token comment" spellcheck="true">// 11/2. 定义变量存放数组</span>
    <span class="token keyword">let</span> jsonArray <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">'webpackJsonp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">'webpackJsonp'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">// 12. 保存原生的push方法</span>
    <span class="token keyword">let</span> oldJsonpFunction <span class="token operator">=</span> jsonArray<span class="token punctuation">.</span>push<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>jsonArray<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 13. 重写push方法</span>
    jsonArray<span class="token punctuation">.</span>push <span class="token operator">=</span> webpackJsonpCallback

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"./src/index.js"</span><span class="token punctuation">:</span>
        <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">let</span> oBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span>

            oBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                __webpack_require__<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/*! import() | login */</span> <span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>t<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/*! ./login */</span> <span class="token string">"./src/login.js"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>login<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>login<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index.js'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="14-webpack-与-tapable"><a href="#14-webpack-与-tapable" class="headerlink" title="14.webpack 与 tapable"></a>14.webpack 与 tapable</h4><p><img src="9c8aed33.png"><img src="cf6e2103.png"><img src="c52af30e.png"><img src="1e31478e.png"><img src="857ad860.png"><br><img src="e89ef8cf.png"><img src="251784e4.png"><img src="eb585235.png"><img src="7bacf85b.png"><img src="b9cd0958.png"><br><img src="5e4c4a27.png"><img src="5c555d6c.png"></p>
<h4 id="15-同步钩子使用及调试"><a href="#15-同步钩子使用及调试" class="headerlink" title="15.同步钩子使用及调试"></a>15.同步钩子使用及调试</h4><p><img src="8af2a73f.png" alt="tap会将函数加入一个数组"><img src="17a619d2.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>SyncHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 定义</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 调用</span>
hook<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'zoe'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span> 
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>SyncBailHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 定义</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回undefined不会熔断</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">return</span> undefined
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回!undefined会熔断</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'ret2'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 调用</span>
hook<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'lg'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>SyncWaterfallHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 定义</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'ret1'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回undefined不会熔断</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'ret2'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回!undefined会熔断</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'ret3'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'water'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>SyncLoopHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> count1 <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> count2 <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> count3 <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment" spellcheck="true">// 定义</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count1 <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count1 <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment" spellcheck="true">// 返回undefined退出loop</span>
        <span class="token keyword">return</span> undefined
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回undefined不会熔断</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 不满足条件,从头开始(fn1)执行</span>
    <span class="token comment" spellcheck="true">// count++ -> count+=1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count2 <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count2 <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">return</span> undefined
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回!undefined会熔断</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count3 <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count3 <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">return</span> undefined
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="16-异步钩子使用"><a href="#16-异步钩子使用" class="headerlink" title="16.异步钩子使用"></a>16.异步钩子使用</h4><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>AsyncParallelHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 异步钩子的使用,有三种方式: tap tapAsync tapPromise</span>
<span class="token comment" spellcheck="true">// hook.tap('fn1', function (name) {</span>
<span class="token comment" spellcheck="true">//     console.log('fn1--->', name)</span>
<span class="token comment" spellcheck="true">// })</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// hook.tap('fn2', function (name) {</span>
<span class="token comment" spellcheck="true">//     console.log('fn2--->', name)</span>
<span class="token comment" spellcheck="true">// })</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// hook.callAsync('zoe', function () {</span>
<span class="token comment" spellcheck="true">//     console.log('last callback')</span>
<span class="token comment" spellcheck="true">// })</span>

<span class="token comment" spellcheck="true">// console.time('time')</span>
<span class="token comment" spellcheck="true">// hook.tapAsync('fn1', function (name, callback) {</span>
<span class="token comment" spellcheck="true">//     setTimeout(() => {</span>
<span class="token comment" spellcheck="true">//         console.log('fn1--->', name)</span>
<span class="token comment" spellcheck="true">//         callback()</span>
<span class="token comment" spellcheck="true">//     }, 1000)</span>
<span class="token comment" spellcheck="true">// })</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// hook.tapAsync('fn2', function (name, callback) {</span>
<span class="token comment" spellcheck="true">//     setTimeout(() => {</span>
<span class="token comment" spellcheck="true">//         console.log('fn2--->', name)</span>
<span class="token comment" spellcheck="true">//         callback()</span>
<span class="token comment" spellcheck="true">//     }, 2000)</span>
<span class="token comment" spellcheck="true">// })</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// hook.callAsync('lg', function () {</span>
<span class="token comment" spellcheck="true">//     console.log('last callback')</span>
<span class="token comment" spellcheck="true">//     console.timeEnd('time')</span>
<span class="token comment" spellcheck="true">// })</span>

console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>AsyncParallelBailHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 参数1是错误</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'zce'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'last callback'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>AsyncSeriesHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'zce'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'last callback'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="17-SyncHook源码调试"><a href="#17-SyncHook源码调试" class="headerlink" title="17.SyncHook源码调试"></a>17.SyncHook源码调试</h4><p><img src="9e94e825.png"><img src="d7e9051c.png"><img src="ee42ae95.png"><img src="66f271df.png"><img src="ef222a47.png"><br><img src="84a31845.png" alt="很多实现都在父类hook里,子类覆盖或去除特定方法"><img src="69b22704.png"><img src="c645f0eb.png"><br><img src="d36ba243.png"><img src="24271b1b.png"><img src="6933a486.png"><img src="7ba99197.png"><img src="55e8f595.png"><br><img src="5b19335e.png"><img src="a9dbcd97.png"><img src="394cb113.png"><img src="fe9dd314.png"><img src="4de1cbae.png"><br><img src="22125611.png"><img src="283a0123.png"><img src="9b268bad.png"><img src="9b657aee.png"><img src="b6997b97.png"><br><img src="62e2687a.png"><img src="d9652bb0.png" alt="删掉之前初始化的内容,下一次重新开始"><img src="6c5d26b1.png"><img src="182d72da.png"></p>
<h4 id="19-手写-SyncHook"><a href="#19-手写-SyncHook" class="headerlink" title="19.手写 SyncHook"></a>19.手写 SyncHook</h4><p><img src="9c072b51.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// useHook.js</span>
<span class="token comment" spellcheck="true">// const {SyncHook} = require('tapable')</span>
<span class="token keyword">const</span> SyncHook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./SyncHook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'zoeee'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// SyncHook.js</span>
<span class="token keyword">const</span> Hook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Hook'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>
    <span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ['name','age'] --(to str)--> name,age</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`var _x = this._x;`</span></span>
    <span class="token punctuation">}</span>

    <span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token string">``</span></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            code <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`var _fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = _x[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">];_fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);`</span></span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> code
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// instance是hook实例</span>
    <span class="token comment" spellcheck="true">// options是{tags:[{},{}],args:[name,age]}</span>
    <span class="token function">setup</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 准备后续要用到的数据</span>
        <span class="token comment" spellcheck="true">// tapable源码中,这里通过init方法实现</span>
        <span class="token comment" spellcheck="true">// 我们这里直接挂载到this上</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
        <span class="token comment" spellcheck="true">// this._x = [f1,f2,...]</span>
        instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> o<span class="token punctuation">.</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 核心是创建可执行的代码体,然后返回</span>
        <span class="token keyword">let</span> fn
        <span class="token comment" spellcheck="true">// fn=new Function ("name, age","var _x = this._x, var _fn0 = x[0]; _fn0(name, age);")</span>
        fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> fn
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">compile</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
        <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> SyncHook
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Hook.js</span>
<span class="token keyword">class</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args
        <span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 用于存放组装好的 {}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> undefined <span class="token comment" spellcheck="true">// 将来在代码工厂函数中会给 _x = [f1,f2,...]</span>
    <span class="token punctuation">}</span>

    <span class="token function">tap</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            options <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> options<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 合并 {fn: ..., name: fn1}</span>
        options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>fn<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 将组装好的options添加到[]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">]</span> <span class="token operator">=</span> options
    <span class="token punctuation">}</span>

    <span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 1. 创建将来要具体执行的函数代码结构</span>
        <span class="token keyword">let</span> callFn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 2. 调用函数</span>
        <span class="token keyword">return</span> callFn<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            taps<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
            args<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Hook
</code></pre>
<h4 id="21-AyncParallelHook源码分析"><a href="#21-AyncParallelHook源码分析" class="headerlink" title="21.AyncParallelHook源码分析"></a>21.AyncParallelHook源码分析</h4><p><img src="8e3258fc.png"><img src="fcf619c6.png"><img src="986ce6db.png"><img src="ec68d6a7.png"><img src="26af2962.png"><br><img src="79c1113a.png"><img src="94c5486e.png"><img src="7be6ef41.png"><img src="a1c46090.png"><img src="c63affc1.png"><br><img src="d1147913.png"><img src="ce21a3d9.png"><img src="74082ddd.png"><img src="dfc919e5.png"><img src="77417e6b.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// useHook.js</span>
<span class="token keyword">const</span> AsyncParallelHook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./AsyncParallelHook'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2--->'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'zoeee'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end~'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// hook.js</span>
<span class="token keyword">class</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token function">tapAsync</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            options <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> options<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>fn<span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// {fn:..., name:fn1}</span>

        <span class="token comment" spellcheck="true">// 调用方法将组装好的options添加到[]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> callFn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> callFn<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Hook
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// AsyncParallelHook.js</span>
<span class="token keyword">const</span> Hook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Hook'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>
    <span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>after<span class="token punctuation">,</span> before<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> allArgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>args
        <span class="token comment" spellcheck="true">// before拼接allArgs</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> allArgs <span class="token operator">=</span> <span class="token punctuation">[</span>before<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>allArgs<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// allArgs拼接after</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>after<span class="token punctuation">)</span> allArgs <span class="token operator">=</span> allArgs<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>after<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// ['name','age'] --(to str)--> name,age</span>
        <span class="token keyword">return</span> allArgs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`"use strict";var _context;var _x = this._x;`</span></span>
    <span class="token punctuation">}</span>

    <span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
        var _counter = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
        var _done = (function (){ _callback(); });
        `</span></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            code <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`var _fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = _x[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">];_fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(name, age, (function (){
                if (--_counter === 0) _done();
            }));            
            `</span></span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> code
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// instance是hook实例</span>
    <span class="token comment" spellcheck="true">// options是{tags:[{},{}],args:[name,age]}</span>
    <span class="token function">setup</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 准备后续要用到的数据</span>
        <span class="token comment" spellcheck="true">// tapable源码中,这里通过init方法实现</span>
        <span class="token comment" spellcheck="true">// 我们这里直接挂载到this上</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
        <span class="token comment" spellcheck="true">// this._x = [f1,f2,...]</span>
        instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> o<span class="token punctuation">.</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 核心是创建可执行的代码体,然后返回</span>
        <span class="token keyword">let</span> fn
        <span class="token comment" spellcheck="true">// fn=new Function ("name, age","var _x = this._x, var _fn0 = x[0]; _fn0(name, age);")</span>
        fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>after<span class="token punctuation">:</span> <span class="token string">'_callback'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> fn
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">AsyncParallelHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">compile</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
        <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> AsyncParallelHook
</code></pre>
<h4 id="23-定位-webpack-打包入口"><a href="#23-定位-webpack-打包入口" class="headerlink" title="23.定位 webpack 打包入口"></a>23.定位 webpack 打包入口</h4><p><img src="2b070ec6.png"><img src="d7c617bc.png"><img src="207ae09a.png"><img src="d33e41cb.png"><img src="1e3e9ca9.png"><br><img src="f00a1ac7.png"><img src="3cafffea.png"><img src="a02318c8.png"><img src="34ebd3e4.png"><img src="bb4e4301.png"><br><img src="43bb2fd5.png"><img src="befecdeb.png"><img src="06dbf604.png" alt="解析命令行参数"><img src="27b8e34d.png" alt="管理参数"><br><img src="c2229a6a.png"><img src="7d9de864.png" alt="编译"><img src="019b631c.png"></p>
<h4 id="24-编译主流程调试"><a href="#24-编译主流程调试" class="headerlink" title="24.编译主流程调试"></a>24.编译主流程调试</h4><p><img src="0a6b4d5e.png"><img src="0f2d2613.png"><img src="28ac27b7.png"><img src="ff87f540.png"><img src="a412aee5.png"><br><img src="c71b1ce4.png"><img src="8dc9594e.png"><img src="06b3166c.png" alt="此时compiler具备了文件读写的能力"><img src="9ce2604d.png" alt="挂载插件"><br><img src="7d4f5094.png" alt="默认插件挂载"><img src="50bea042.png"><img src="edb88dbf.png"><img src="cd580d8f.png" alt="webpack默认装备好了很多hook"><br><img src="e20844aa.png"><img src="93ef9bb6.png"><img src="d5938051.png"><img src="78deaf3c.png"></p>
<h4 id="25-手写-webpack-js-实现"><a href="#25-手写-webpack-js-实现" class="headerlink" title="25.手写 webpack.js 实现"></a>25.手写 webpack.js 实现</h4><p><img src="0bc89c3d.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// run.js</span>
<span class="token keyword">let</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lgPack'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>

compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        entries<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        chunks<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        assets<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.config.js</span>
<span class="token keyword">let</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lgPack'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>

compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        entries<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        chunks<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        assets<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="ed1bd774.png" alt="lgPack/package.json"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// lgPack/lib/webpack.js</span>
<span class="token keyword">const</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Compiler'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> NodeEnvironmentPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./node/NodeEnvironmentPlugin'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. 实例化compiler对象</span>
    <span class="token keyword">let</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
    compiler<span class="token punctuation">.</span>options <span class="token operator">=</span> options
    <span class="token comment" spellcheck="true">// 2. 初始化NodeEnvironmentPlugin(让compiler具备文件读写能力)</span>
    <span class="token keyword">new</span> <span class="token class-name">NodeEnvironmentPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 3. 挂载所有的plugins插件至compiler对象身上</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            plugin<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 4. 挂载所有webpack内置的插件(入口)</span>
    <span class="token comment" spellcheck="true">// compiler.options = new WebpackOptionsApply().process(options, compiler)</span>
    <span class="token comment" spellcheck="true">// 5. 返回compiler对象</span>
    <span class="token keyword">return</span> compiler
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> webpack
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// lgPack/lib/Compiler.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
    Tapable<span class="token punctuation">,</span> AsyncSeriesHook
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            done<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'stats'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">run</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    entries<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 当前次打包的入口信息</span>
                    chunks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 当前次打包的chunk信息</span>
                    modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 模块信息</span>
                    assets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 当前次打包最终生成的资源</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// lgPack/lib/node/NodeEnvironmentPlugin.js</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">NodeEnvironmentPlugin</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// compiler可以调用fs,得到文件读写能力</span>
        compiler<span class="token punctuation">.</span>inputFileSystem <span class="token operator">=</span> fs
        compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> fs
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NodeEnvironmentPlugin
</code></pre>
<h4 id="26-EntryOptionPlugin-分析"><a href="#26-EntryOptionPlugin-分析" class="headerlink" title="26.EntryOptionPlugin 分析"></a>26.EntryOptionPlugin 分析</h4><p><img src="5bf91340.png"><img src="1c9177e1.png"><img src="a254e7b0.png"><img src="69e962b7.png"><img src="d9db497a.png"><br><img src="4b1a0805.png"><img src="e6567d55.png"><img src="cce3aec8.png"><img src="d1f2d623.png"><img src="9e562799.png"></p>
<h4 id="27-EntryOptionPlugin流程手写"><a href="#27-EntryOptionPlugin流程手写" class="headerlink" title="27.EntryOptionPlugin流程手写"></a>27.EntryOptionPlugin流程手写</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.js</span>
<span class="token keyword">const</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Compiler'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> NodeEnvironmentPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./node/NodeEnvironmentPlugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> WebpackOptionsApply <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./WebpackOptionsApply'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
    <span class="token comment" spellcheck="true">// 4. 挂载所有webpack内置的插件(入口)</span>
    compiler<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebpackOptionsApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 5. 返回compiler对象</span>
    <span class="token keyword">return</span> compiler
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> webpack
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// WebpackOptionsApply.js</span>
<span class="token keyword">const</span> EntryOptionPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./EntryOptionPlugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">WebpackOptionsApply</span> <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">EntryOptionPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span>

        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>entryOption<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">,</span> options<span class="token punctuation">.</span>entry<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> WebpackOptionsApply
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// EntryOptionPlugin.js</span>
<span class="token keyword">const</span> SingleEntryPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./SingleEntryPlugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">itemToPlugin</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> item<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SingleEntryPlugin</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> item<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">EntryOptionPlugin</span> <span class="token punctuation">{</span>
    <span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>entryOption<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'EntryOptionPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token function">itemToPlugin</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> EntryOptionPlugin
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// SingleEntryPlugin.js</span>
<span class="token keyword">class</span> <span class="token class-name">SingleEntryPlugin</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context
        <span class="token keyword">this</span><span class="token punctuation">.</span>entry <span class="token operator">=</span> entry
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
    <span class="token punctuation">}</span>

    <span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'SingleEntryPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"make 方法执行"</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// compilation.addEntry(context, entry, name, callback)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> SingleEntryPlugin
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compiler.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
    Tapable<span class="token punctuation">,</span> AsyncSeriesHook<span class="token punctuation">,</span> SyncBailHook<span class="token punctuation">,</span> SyncHook<span class="token punctuation">,</span> AsyncParallelHook
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            done<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'stats'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entryOption<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'context'</span><span class="token punctuation">,</span> <span class="token string">'entry'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            beforeCompile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            compile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            make<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"compilation"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            afterCompile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"compilation"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">run</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler
</code></pre>
<h4 id="28-run方法分析及实现"><a href="#28-run方法分析及实现" class="headerlink" title="28.run方法分析及实现"></a>28.run方法分析及实现</h4><p><img src="dbeed858.png"><img src="c0e73adb.png"><img src="ab7d5873.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compiler.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
    Tapable<span class="token punctuation">,</span> AsyncSeriesHook<span class="token punctuation">,</span> SyncBailHook<span class="token punctuation">,</span> SyncHook<span class="token punctuation">,</span> AsyncParallelHook
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            done<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'stats'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entryOption<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'context'</span><span class="token punctuation">,</span> <span class="token string">'entry'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            beforeCompile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            compile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            make<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"compilation"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            afterCompile<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"compilation"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            thisCompilation<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"compilation"</span><span class="token punctuation">,</span> <span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            compilation<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"compilation"</span><span class="token punctuation">,</span> <span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            beforeRun<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"compiler"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            run<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"compiler"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">run</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'run 方法执行'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> finalCallback <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> onCompiled <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> compilation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onCompiled'</span><span class="token punctuation">)</span>
            <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                <span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">{</span>
                        entries<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        chunk<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        modules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        assets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>onCompiled<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">compile</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler
</code></pre>
<h4 id="29-compile-分析及实现"><a href="#29-compile-分析及实现" class="headerlink" title="29.compile 分析及实现"></a>29.compile 分析及实现</h4><p><img src="8886ec58.png"><img src="734d5e1d.png"><img src="654e55a6.png"><img src="bdd594d4.png"><img src="eaee5d7b.png"><br><img src="2ab72a60.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compiler.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
    Tapable<span class="token punctuation">,</span> AsyncSeriesHook<span class="token punctuation">,</span> SyncBailHook<span class="token punctuation">,</span> SyncHook<span class="token punctuation">,</span> AsyncParallelHook
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Compilation <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./Compilation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token function">compile</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
            <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilation</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'make钩子监听触发'</span><span class="token punctuation">)</span>
                <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// normalModuleFactory = new NormalModuleFactory()</span>
            normalModuleFactory<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">NormalModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> params<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">newCompilation</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">createCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Compilation 代表某一次编译, Compiler 代表整个编译流程</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Compilation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler
</code></pre>
<h4 id="30-make-前流程回顾"><a href="#30-make-前流程回顾" class="headerlink" title="30.make 前流程回顾"></a>30.make 前流程回顾</h4><p><img src="ebef8454.png"><img src="d70490b8.png"><img src="bbd4605a.png"><img src="0d722358.png"><img src="47ee2353.png"><br><img src="71818bd8.png"><img src="cf34f85f.png"><img src="d4d126fd.png"><img src="ff696111.png"><img src="95fdb79a.png"><br><img src="988e5872.png"><img src="7d9c3dc7.png"><img src="4c53ce01.png"><br><img src="19cb2298.png"><img src="8068f8fc.png"><img src="2c32a342.png"></p>
<h4 id="31-addEntry-流程分析"><a href="#31-addEntry-流程分析" class="headerlink" title="31.addEntry 流程分析"></a>31.addEntry 流程分析</h4><p><img src="eeb7fa0a.png"><img src="a8cf2b18.png"><img src="446a19d3.png"><img src="860245e4.png"><img src="dd4de934.png"><br><img src="8ac22686.png"><img src="b1c0720a.png"><img src="878d3201.png"><img src="8e0db63a.png"><img src="b0a9bd58.png"><br><img src="46caca1e.png"><img src="51e407c7.png"><img src="2c1e421c.png"><img src="b542dbee.png"><img src="edd3fde0.png"><br><img src="b59d4d0b.png"><img src="1dd121e1.png"><img src="1352b296.png"><img src="7302ec8d.png"></p>
<p><img src="0e570735.png"><img src="fda8016b.png"><img src="19b3269f.png"><img src="a495406e.png"><img src="967f5d3e.png"><br><img src="584368b2.png"><img src="3641e004.png"><img src="dcfc8902.png"><img src="bdf80eb1.png"><img src="8b39db39.png"><br><img src="a57afab4.png"><img src="631f375c.png" alt="编译就是拿到源码中的export import等commonjs语法, 转换为浏览器可以执行的语法esm"><br><img src="727c65f4.png"><img src="9fe5c976.png"><img src="0ba39ca0.png"><img src="53a0e2ce.png"></p>
<h4 id="33-addEntry-初始化"><a href="#33-addEntry-初始化" class="headerlink" title="33.addEntry 初始化"></a>33.addEntry 初始化</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// compilation.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>compiler <span class="token operator">=</span> compiler
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> compiler<span class="token punctuation">.</span>context
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options
        <span class="token comment" spellcheck="true">// compilation具备文件读写能力</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inputFileSystem <span class="token operator">=</span> compiler<span class="token punctuation">.</span>inputFileSystem
        <span class="token keyword">this</span><span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem
        <span class="token keyword">this</span><span class="token punctuation">.</span>entries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 存放所有入口模块</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 存放所有模块</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            succeedModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'module'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 完成模块编译
     * @param context 当前项目的根
     * @param entry 当前入口的相对路径
     * @param name chunkName: main
     * @param callback 回调
     */</span>
    <span class="token function">addEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addModuleChain</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> module<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> module<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compilation
</code></pre>
<h4 id="34-addModuleChain实现"><a href="#34-addModuleChain实现" class="headerlink" title="34._addModuleChain实现"></a>34._addModuleChain实现</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compilation.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token function">_addModuleChain</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> entryModule <span class="token operator">=</span> normalModuleFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token punctuation">,</span> context<span class="token punctuation">,</span>
            rawRequest<span class="token punctuation">:</span> entry<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 相对路径拼接成当前目录的绝对路径</span>
            resource<span class="token punctuation">:</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// todo: parser</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> afterBuild <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> entryModule<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">,</span> afterBuild<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// 完成本次build后, 保存模块</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compilation
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// NormalModuleFactory.js</span>
<span class="token keyword">const</span> NormalModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModule"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">NormalModuleFactory</span> <span class="token punctuation">{</span>
    <span class="token function">create</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NormalModule</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NormalModuleFactory
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// NormalModule.js</span>
<span class="token keyword">class</span> <span class="token class-name">NormalModule</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> data<span class="token punctuation">.</span>name
        <span class="token keyword">this</span><span class="token punctuation">.</span>entry <span class="token operator">=</span> data<span class="token punctuation">.</span>entry
        <span class="token keyword">this</span><span class="token punctuation">.</span>rawRequest <span class="token operator">=</span> data<span class="token punctuation">.</span>rawRequest
        <span class="token keyword">this</span><span class="token punctuation">.</span>parser <span class="token operator">=</span> data<span class="token punctuation">.</span>parser
        <span class="token comment" spellcheck="true">// todo: 等待完成</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> data<span class="token punctuation">.</span>resource
        <span class="token keyword">this</span><span class="token punctuation">.</span>_source <span class="token comment" spellcheck="true">// 存放某个模块的源代码</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token comment" spellcheck="true">// 存放某个模块源代码的 ast</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NormalModule
</code></pre>
<h4 id="35-buildModule实现"><a href="#35-buildModule实现" class="headerlink" title="35.buildModule实现"></a>35.buildModule实现</h4><p><img src="a2a8efb2.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compilation.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> normalModuleFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NormalModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">/**
     * 完成具体的 build 行为
     * @param module 当前需要被编译的模块
     * @param callback
     */</span>
    <span class="token function">buildModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// module -> entryModule</span>
        module<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 走到这里表示当前代码编译完成</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>succeedModule<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> module<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compilation
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// NormalModule.js </span>

<span class="token keyword">class</span> <span class="token class-name">NormalModule</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> data<span class="token punctuation">.</span>name
        <span class="token keyword">this</span><span class="token punctuation">.</span>entry <span class="token operator">=</span> data<span class="token punctuation">.</span>entry
        <span class="token keyword">this</span><span class="token punctuation">.</span>rawRequest <span class="token operator">=</span> data<span class="token punctuation">.</span>rawRequest
        <span class="token keyword">this</span><span class="token punctuation">.</span>parser <span class="token operator">=</span> data<span class="token punctuation">.</span>parser
        <span class="token comment" spellcheck="true">// todo: 等待完成</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> data<span class="token punctuation">.</span>resource
        <span class="token keyword">this</span><span class="token punctuation">.</span>_source <span class="token comment" spellcheck="true">// 存放某个模块的源代码</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token comment" spellcheck="true">// 存放某个模块源代码的 ast</span>
    <span class="token punctuation">}</span>

    <span class="token function">build</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doBuild</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_source<span class="token punctuation">)</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">doBuild</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> source<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_source <span class="token operator">=</span> source
            <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">getSource</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compilation<span class="token punctuation">.</span>inputFileSystem<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resource<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NormalModule
</code></pre>
<h4 id="36-build及parser-实现"><a href="#36-build及parser-实现" class="headerlink" title="36.build及parser 实现"></a>36.build及parser 实现</h4><pre class=" language-shell"><code class="language-shell">npm i babylon -D
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Parser.js</span>
<span class="token keyword">const</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Parser</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            sourceType<span class="token punctuation">:</span> <span class="token string">'module'</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 当前插件支持动态导入的语法</span>
            plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'dynamicImport'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Parser
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Stats.js</span>
<span class="token keyword">class</span> <span class="token class-name">Stats</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entries <span class="token operator">=</span> compilation<span class="token punctuation">.</span>entries
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> compilation<span class="token punctuation">.</span>modules
    <span class="token punctuation">}</span>

    <span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Stats
</code></pre>
<p><img src="e7885f5a.png"><img src="af63d4f7.png"></p>
<h4 id="37-依赖模块处理"><a href="#37-依赖模块处理" class="headerlink" title="37.依赖模块处理"></a>37.依赖模块处理</h4><p><img src="265dc971.png"><img src="dccad4e5.png"><img src="78e7af90.png"><img src="5a5e55cc.png"><img src="ef0d520d.png"><br><img src="04e7a578.png"><img src="50fbfe38.png"><img src="fddef681.png"><img src="703c02a7.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// NormalModule.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 提供修改ast节点的方法</span>
<span class="token keyword">const</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@babel/traverse"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span>

<span class="token keyword">class</span> <span class="token class-name">NormalModule</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// process.cwd()</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> data<span class="token punctuation">.</span>context
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> data<span class="token punctuation">.</span>name
        <span class="token comment" spellcheck="true">// this.entry = data.entry</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rawRequest <span class="token operator">=</span> data<span class="token punctuation">.</span>rawRequest
        <span class="token keyword">this</span><span class="token punctuation">.</span>parser <span class="token operator">=</span> data<span class="token punctuation">.</span>parser
        <span class="token comment" spellcheck="true">// todo: 等待完成</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> data<span class="token punctuation">.</span>resource <span class="token comment" spellcheck="true">// 文件绝对路径</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_source <span class="token comment" spellcheck="true">// 存放某个模块的源代码</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token comment" spellcheck="true">// 存放某个模块源代码的 ast</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 定义一个空数组保存被依赖加载的模块信息</span>
    <span class="token punctuation">}</span>

    <span class="token function">build</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doBuild</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_source<span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 修改ast</span>
            <span class="token function">traverse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                CallExpression<span class="token punctuation">:</span> <span class="token punctuation">(</span>nodePath<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 拿到ast上的node</span>
                    <span class="token keyword">let</span> node <span class="token operator">=</span> nodePath<span class="token punctuation">.</span>node

                    <span class="token comment" spellcheck="true">// 定位require所在节点</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'require'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 获取原始请求路径</span>
                        <span class="token keyword">let</span> modulePath <span class="token operator">=</span> node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token comment" spellcheck="true">// './title'</span>
                        <span class="token comment" spellcheck="true">// 取出当前被加载的模块名称(根据分隔符拆分)</span>
                        <span class="token comment" spellcheck="true">// path.posix.sep -> 拿到当前操作系统的分隔符</span>
                        <span class="token keyword">let</span> moduleName <span class="token operator">=</span> modulePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>sep<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// title</span>
                        <span class="token comment" spellcheck="true">// 当前我们只能打包处理js</span>
                        <span class="token comment" spellcheck="true">// moduleName有 . 表示有指定后缀, 没有就默认指定为js</span>
                        <span class="token keyword">let</span> extName <span class="token operator">=</span> moduleName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">'.js'</span> <span class="token punctuation">:</span> <span class="token string">''</span>
                        moduleName <span class="token operator">+</span><span class="token operator">=</span> extName <span class="token comment" spellcheck="true">// title.js</span>
                        <span class="token comment" spellcheck="true">// 最终要有绝对路径, 以便读取文件</span>
                        <span class="token comment" spellcheck="true">// 拼接当前文件的父目录 和 导入文件名</span>
                        <span class="token keyword">let</span> depResource <span class="token operator">=</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">,</span> moduleName<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// 定义当前模块的id</span>
                        <span class="token comment" spellcheck="true">// this.context - depResource -> ./src/title.js</span>
                        <span class="token keyword">let</span> depModuleId <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> depResource<span class="token punctuation">)</span>

                        <span class="token comment" spellcheck="true">// 记录当前被依赖模块的信息, 方便后面加载</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            name<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// todo 动态修改</span>
                            context<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span>
                            rawRequest<span class="token punctuation">:</span> moduleName<span class="token punctuation">,</span>
                            moduleId<span class="token punctuation">:</span> depModuleId<span class="token punctuation">,</span>
                            resource<span class="token punctuation">:</span> depResource
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>

                        <span class="token comment" spellcheck="true">// 替换内容</span>
                        node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'__webpack_require__'</span>
                        <span class="token comment" spellcheck="true">// types.stringLiteral 创建string类型的值</span>
                        <span class="token comment" spellcheck="true">// node.arguments 替换为 depModuleId (string)</span>
                        node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> <span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>depModuleId<span class="token punctuation">)</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 将修改后的ast转为code(可执行代码)</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span>code<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_ast<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_source <span class="token operator">=</span> code
            <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NormalModule
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compilation.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">,</span> SyncHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> normalModuleFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NormalModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token function">_addModuleChain</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> entryModule <span class="token operator">=</span> normalModuleFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token punctuation">,</span> context<span class="token punctuation">,</span>
            rawRequest<span class="token punctuation">:</span> entry<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 相对路径拼接成当前目录的绝对路径</span>
            resource<span class="token punctuation">:</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span>
            parser
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> afterBuild <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 需要判断当前module加载完成之后是否需要处理依赖加载</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 当前逻辑表示module有需要依赖加载的模块, 单独定义一个方法实现</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processDependencies</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> module<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> module<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">,</span> afterBuild<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// 完成本次build后, 保存模块</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token function">processDependencies</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compilation
</code></pre>
<h4 id="39-抽离createModule方法"><a href="#39-抽离createModule方法" class="headerlink" title="39.抽离createModule方法"></a>39.抽离createModule方法</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compilation.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">,</span> SyncHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> normalModuleFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NormalModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token function">_addModuleChain</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            parser<span class="token punctuation">,</span>
            name<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
            context<span class="token punctuation">:</span> context<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 原始请求路径</span>
            rawRequest<span class="token punctuation">:</span> entry<span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span>
            moduleId<span class="token punctuation">:</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 创建模块的方法
     * @param data 创建模块需要的属性值
     * @param doAndEntry 可选参数, 在加载入口模块的时候, 将入口模块的id 写入 this.entries
     * @param callback
     */</span>
    <span class="token function">createModule</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> doAndEntry<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> module <span class="token operator">=</span> normalModuleFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

        <span class="token keyword">const</span> afterBuild <span class="token operator">=</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> module<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 需要判断当前module加载完成之后是否需要处理依赖加载</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 当前逻辑表示module有需要依赖加载的模块, 单独定义一个方法实现</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processDependencies</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> module<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> module<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> afterBuild<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// 完成本次build后, 保存模块</span>
        <span class="token comment" spellcheck="true">// this.entries.push(module)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>
        doAndEntry <span class="token operator">&amp;&amp;</span> <span class="token function">doAndEntry</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compilation
</code></pre>
<h4 id="40-编译依赖模块"><a href="#40-编译依赖模块" class="headerlink" title="40.编译依赖模块"></a>40.编译依赖模块</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compilation.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">,</span> SyncHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">async</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'neo-async'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> normalModuleFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NormalModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token function">processDependencies</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 实现被依赖模块的加载</span>
        <span class="token comment" spellcheck="true">// 创建对应模块,然后想办法拿出其中的内容</span>
        <span class="token comment" spellcheck="true">// 在所有被依赖模块加载完后再 callback</span>
        <span class="token keyword">let</span> dependencies <span class="token operator">=</span> module<span class="token punctuation">.</span>dependencies

        <span class="token keyword">async</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">,</span> <span class="token punctuation">(</span>dependency<span class="token punctuation">,</span> done<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 调用done表示执行完毕</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                parser<span class="token punctuation">,</span>
                name<span class="token punctuation">:</span> dependency<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                context<span class="token punctuation">:</span> dependency<span class="token punctuation">.</span>context<span class="token punctuation">,</span>
                rawRequest<span class="token punctuation">:</span> dependency<span class="token punctuation">.</span>rawRequest<span class="token punctuation">,</span>
                moduleId<span class="token punctuation">:</span> dependency<span class="token punctuation">.</span>moduleId<span class="token punctuation">,</span>
                resource<span class="token punctuation">:</span> dependency<span class="token punctuation">.</span>resource
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> done<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compilation
</code></pre>
<h4 id="41-chunk流程分析及实现"><a href="#41-chunk流程分析及实现" class="headerlink" title="41.chunk流程分析及实现"></a>41.chunk流程分析及实现</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compilation.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">,</span> SyncHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">async</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'neo-async'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Chunk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./Chunk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> normalModuleFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NormalModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>compiler <span class="token operator">=</span> compiler
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> compiler<span class="token punctuation">.</span>context
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options
        <span class="token comment" spellcheck="true">// compilation具备文件读写能力</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inputFileSystem <span class="token operator">=</span> compiler<span class="token punctuation">.</span>inputFileSystem
        <span class="token keyword">this</span><span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem
        <span class="token keyword">this</span><span class="token punctuation">.</span>entries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 存放所有入口模块</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 存放所有模块</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 存放当前次打包产出的chunk</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            succeedModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'module'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            seal<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            beforeChunks<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            afterChunks<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 封装chunk</span>
    <span class="token function">seal</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>seal<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeChunks<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// 所有入口模块都存放在了 compilation 对象的 entires 数组里</span>
        <span class="token comment" spellcheck="true">// 封装 chunk 就是根据某个入口，将它所有依赖和源代码放在一起，之后做合并</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entryModule <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 核心：创建模块加载已有模块内容，同时记录模块信息</span>
            <span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chunk</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 给chunk赋值</span>
            chunk<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>module <span class="token operator">=</span><span class="token operator">></span> module<span class="token punctuation">.</span>name <span class="token operator">===</span> chunk<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compilation
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compiler.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
    Tapable<span class="token punctuation">,</span> AsyncSeriesHook<span class="token punctuation">,</span> SyncBailHook<span class="token punctuation">,</span> SyncHook<span class="token punctuation">,</span> AsyncParallelHook
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Compilation <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./Compilation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Stats <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./Stats"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//...</span>

    <span class="token function">compile</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
            <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilation</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// console.log('make钩子监听触发')</span>
                <span class="token comment" spellcheck="true">// callback(err,compilation)</span>

                <span class="token comment" spellcheck="true">// 处理chunk</span>
                compilation<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> compilation<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Stats.js</span>
<span class="token keyword">class</span> <span class="token class-name">Stats</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entries <span class="token operator">=</span> compilation<span class="token punctuation">.</span>entries
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> compilation<span class="token punctuation">.</span>modules
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunks <span class="token operator">=</span> compilation<span class="token punctuation">.</span>chunks
    <span class="token punctuation">}</span>

    <span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Stats
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Chunk.js</span>
<span class="token keyword">class</span> <span class="token class-name">Chunk</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entryModule <span class="token operator">=</span> entryModule
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> entryModule<span class="token punctuation">.</span>name
        <span class="token keyword">this</span><span class="token punctuation">.</span>files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 打包后文件名称</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 当前chunk里的所有模块</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Chunk
</code></pre>
<h4 id="42-生成chunk代码"><a href="#42-生成chunk代码" class="headerlink" title="42.生成chunk代码"></a>42.生成chunk代码</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compilation.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Tapable<span class="token punctuation">,</span> SyncHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"tapable"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">async</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'neo-async'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Chunk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./Chunk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> normalModuleFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NormalModuleFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>compiler <span class="token operator">=</span> compiler
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> compiler<span class="token punctuation">.</span>context
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options
        <span class="token comment" spellcheck="true">// compilation具备文件读写能力</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inputFileSystem <span class="token operator">=</span> compiler<span class="token punctuation">.</span>inputFileSystem
        <span class="token keyword">this</span><span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem
        <span class="token keyword">this</span><span class="token punctuation">.</span>entries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 存放所有入口模块</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 存放所有模块</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 存放当前次打包产出的chunk</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            succeedModule<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'module'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            seal<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            beforeChunks<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            afterChunks<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 封装chunk</span>
    <span class="token function">seal</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>seal<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeChunks<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// 所有入口模块都存放在了 compilation 对象的 entires 数组里</span>
        <span class="token comment" spellcheck="true">// 封装 chunk 就是根据某个入口，将它所有依赖和源代码放在一起，之后做合并</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entryModule <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 核心：创建模块加载已有模块内容，同时记录模块信息</span>
            <span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chunk</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 给chunk赋值</span>
            chunk<span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>module <span class="token operator">=</span><span class="token operator">></span> module<span class="token punctuation">.</span>name <span class="token operator">===</span> chunk<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// chunk流程处理完就进入chunk代码处理环节(模板文件+模块中的源代码 -> chunk.js)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterChunks<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// 生成代码内容</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">const</span> fileName <span class="token operator">=</span> chunk<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'.js'</span>
            chunk<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 生成具体的chunk内容</span>
            <span class="token comment" spellcheck="true">// 获取模板文件的路径</span>
            <span class="token keyword">let</span> tempPath <span class="token operator">=</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'temp/main.ejs'</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 读取模块文件中的内容</span>
            <span class="token keyword">let</span> tempCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inputFileSystem<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 获取渲染函数</span>
            <span class="token keyword">let</span> tempRender <span class="token operator">=</span> ejs<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>tempCode<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 渲染数据</span>
            <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token function">tempRender</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                entryModuleId<span class="token punctuation">:</span> chunk<span class="token punctuation">.</span>entryModule<span class="token punctuation">.</span>moduleId<span class="token punctuation">,</span>
                modules<span class="token punctuation">:</span> chunk<span class="token punctuation">.</span>modules
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 输出文件</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitAssets</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> source<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">emitAssets</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">[</span>fileName<span class="token punctuation">]</span> <span class="token operator">=</span> source
        <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compilation
</code></pre>
<pre class=" language-ejs"><code class="language-ejs">// lib/temp/main.ejs
(function (modules) {
// 14. 定义 webpackJsonpCallback 实现: 合并模块定义,改变 promise 状态执行后续行为
function webpackJsonpCallback(data) {
// 1 获取需要被动态加载的模块 id
let chunkIds = data[0]
// 2 获取需要被动态加载的模块依赖关系对象
let moreModules = data[1]
let chunkId, resolves = []
// 3 循环判断 chunkIds 里对应的模块内容是否已经完成了加载
for (let i = 0; i < chunkIds.length; i++) {
chunkId = chunkIds[i]
if (
Object.prototype.hasOwnProperty.call(inStalledChunks, chunkId)
&& inStalledChunks[chunkId]
) {
resolves.push(inStalledChunks[chunkId][0])
}
// 更新当前 chunk 的状态
inStalledChunks[chunkId] = 0
}

for (moduleId in moreModules) {
if (Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {
// 挂载动态加载的module的依赖关系到传入的modules
modules[moduleId] = moreModules[moduleId]
}
}

while (resolves.length) {
// 执行操作
resolves.shift()()
}
}

// 1. 用于缓存加载过的模块
let installedModules = {}

// 15 定义 inStalledChunks 对象,用于标识某个 chunkId 对应的 chunk 是否完成了加载
let inStalledChunks = {
// 0 -> 已加载
main: 0
}

// 2. 定义一个 __webpack_require__ 方法来替换 import require 加载操作
function __webpack_require__(moduleId) {
// 2-1 判断当前缓存中是否存在要被加载的模块内容,如果存在则直接返回
if (installedModules[moduleId]) {
return installedModules[moduleId].exports
}
// 2-2 如果当前缓存中不存在则需要我们自己定义{} 执行被导入的模块内容加载
let module = installedModules[moduleId] = {
i: moduleId,
// 是否被加载
l: false,
// 导出内容
exports: {}
}
// 2-3 调用当前 moduleId 对应的函数,然后完成内容的加载
modules[moduleId].call(module.exports, module, module.exports, __webpack_require__)
// 2-4 上述方法调用完成后,就可以修改 l 的值,表示当前模块已经加载完成
module.l = true
// 2-5 加载工作完成之后,要将拿回来的内容返回至调用的位置
return module.exports
}

// 3. 定义 m 属性用于保存 modules
__webpack_require__.m = modules

// 4. 定义 c 属性用于保存cache
__webpack_require__.c = installedModules

// 5. 定义 o 方法用于判断对象的身上是否存在指定的属性
__webpack_require__.o = function (object, property) {
return Object.prototype.hasOwnProperty(object, property)
}

// 6. 定义 d 方法用于在对象的身上添加指定的属性,同时给该属性提供gatter
__webpack_require__.d = function (exports, name, getter) {
// 对象身上没有该属性
if (!__webpack_require__.o(exports, name)) {
Object.defineProperty(exports, name, {enumerable: true, get: getter})
}
}

// 7. 定义 r 方法用于标识当前模块是 es6(esModule) 类型
__webpack_require__.r = function (exports) {
if (typeof Symbol !== 'undefined' && Symbol.toStringTag) {
Object.defineProperty(exports, Symbol.toStringTag, {value: "Module"})
}
Object.defineProperty(exports, '__esModule', {value: true})
}

// 8. 定义 n 方法用于设置具体的getter
__webpack_require__.n = function (module) {
let getter = module && module.__esModule ?
function getDefault() {
return module['default']
} :
function getModuleExports() {
return module
}

// 给getter定义a属性,获取方法是getter
__webpack_require__.d(getter, 'a', getter)
return getter
}

// 17 定义 jsonpScriptSrc 来实现 src 的处理
function jsonpScriptSrc(chunkId) {
return __webpack_require__.p + "" + chunkId + ".built.js"
}

// 16 定义 e 方法用于实现: 实现jsonp来加载内容, 利用promise 实现异步加载操作
__webpack_require__.e = function (chunkId) {
// 1 定义一个数组用于存放 promise
let promises = []
// 2 获取 chunkId 对应的 chunk 是否已经完成了加载
let installedChunkData = inStalledChunks[chunkId]
// 3 依据当前是否已完成加载的状态来执行后续的逻辑
if (installedChunkData !== 0) {
if (installedChunkData) {
promises.push(installedChunkData[2])
} else {
let promise = new Promise((resolve, reject) => {
installedChunkData = inStalledChunks[chunkId] = [resolve, reject]
})

// installedChunkData [resolve,reject,promise]
promises.push(installedChunkData[2] = promise)

// 创建标签
let script = document.createElement('script')
// 设置src
script.src = jsonpScriptSrc(chunkId)
// 写入 script 标签
document.head.appendChild(script)
}
}
// 执行promise
return Promise.all(promises)
}

// 11. 定义 t 方法,用于加载指定 value 的模块内容,之后对内容进行处理再返回
__webpack_require__.t = function (value, mode) {
// 01 加载 value 对应的模块内容( value 一般就是模块id)
// 加载之后的内容又重新赋值给 value 变量
if (mode & 1) {
value = __webpack_require__(value)
}
if (mode & 8) { // 加载了可以直接返回使用的内容
return value
}
// 到这说明没有return
if ((mode & 4) && typeof value === 'object' && value && value.__esModule) {
return value
}
// 如果8和4都不成立,则需要自定义 ns 来通过 default 属性返回内容
let ns = Object.create(null)

__webpack_require__.r(ns)

Object.defineProperty(ns, 'default', {enumerable: true, value: value})

if (mode & 2 && typeof value !== 'string') {
for (var key in value) {
__webpack_require__.d(ns, key, function (key) {
return value[key]
}.bind(null, key))
}
}

return ns
}

// 9. 定义 p 属性,用于保存资源访问路径
__webpack_require__.p = ""

// 11/2. 定义变量存放数组
let jsonArray = window['webpackJsonp'] = window['webpackJsonp'] || []

// 12. 保存原生的push方法
let oldJsonpFunction = jsonArray.push.bind(jsonArray)

// 13. 重写push方法
jsonArray.push = webpackJsonpCallback

// 10. 调用 __webpack_require__ 方法执行模块导入与加载操作
return __webpack_require__(__webpack_require__.s = '<%- entryModuleId %>')
})
({
<% for(let module of modules) { %>
    "<%- module.moduleId %>":
    (function (module, exports, __webpack_require__) {
    <%- module._source %>
    }),
<% } %>

});
</code></pre>
<h4 id="43-生成打包文件"><a href="#43-生成打包文件" class="headerlink" title="43.生成打包文件"></a>43.生成打包文件</h4><p><img src="d8c0b678.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Compiler.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
    Tapable<span class="token punctuation">,</span> AsyncSeriesHook<span class="token punctuation">,</span> SyncBailHook<span class="token punctuation">,</span> SyncHook<span class="token punctuation">,</span> AsyncParallelHook
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> NormalModuleFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./NormalModuleFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Compilation <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./Compilation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Stats <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./Stats"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mkdirp'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>

            emit<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'compilation'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">emitAssets</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 1. 创建dist 2. 写文件</span>
        <span class="token comment" spellcheck="true">// 定义一个执行文件生成操作的工具方法</span>
        <span class="token keyword">const</span> emitFiles <span class="token operator">=</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> assets <span class="token operator">=</span> compilation<span class="token punctuation">.</span>assets
            <span class="token keyword">let</span> outputPath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> file <span class="token keyword">in</span> assets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> source <span class="token operator">=</span> assets<span class="token punctuation">[</span>file<span class="token punctuation">]</span>
                <span class="token keyword">let</span> targetPath <span class="token operator">=</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> file<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>outputFileSystem<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 创建目录后写入</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            mkdirp<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 创建dist</span>
            <span class="token function">emitFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">run</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'run 方法执行'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> finalCallback <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> onCompiled <span class="token operator">=</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> compilation<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onCompiled'</span><span class="token punctuation">)</span>
            <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Stats</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 最终在这里将处理好的chunk写入指定文件并输出到dist</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitAssets</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> stats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stats</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span>
                <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>onCompiled<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler
</code></pre>
<h1 id="03-Part-3-·-Vue-js-框架源码与进阶"><a href="#03-Part-3-·-Vue-js-框架源码与进阶" class="headerlink" title="03.Part 3 · Vue.js 框架源码与进阶"></a>03.Part 3 · Vue.js 框架源码与进阶</h1><h2 id="01-模块一-手写-Vue-Router、手写响应式实现、虚拟-DOM-和-Diff-算法"><a href="#01-模块一-手写-Vue-Router、手写响应式实现、虚拟-DOM-和-Diff-算法" class="headerlink" title="01.模块一 手写 Vue Router、手写响应式实现、虚拟 DOM 和 Diff 算法"></a>01.模块一 手写 Vue Router、手写响应式实现、虚拟 DOM 和 Diff 算法</h2><h2 id="02-模块二-Vue-js-源码分析（响应式、虚拟-DOM、模板编译和组件化）"><a href="#02-模块二-Vue-js-源码分析（响应式、虚拟-DOM、模板编译和组件化）" class="headerlink" title="02.模块二 Vue.js 源码分析（响应式、虚拟 DOM、模板编译和组件化）"></a>02.模块二 Vue.js 源码分析（响应式、虚拟 DOM、模板编译和组件化）</h2><h2 id="03-模块三-Vuex-数据流管理及Vue-js-服务端渲染（SSR）"><a href="#03-模块三-Vuex-数据流管理及Vue-js-服务端渲染（SSR）" class="headerlink" title="03.模块三 Vuex 数据流管理及Vue.js 服务端渲染（SSR）"></a>03.模块三 Vuex 数据流管理及Vue.js 服务端渲染（SSR）</h2><h2 id="04-模块四-搭建自己的SSR、静态站点生成（SSG）及封装-Vue-js-组件库"><a href="#04-模块四-搭建自己的SSR、静态站点生成（SSG）及封装-Vue-js-组件库" class="headerlink" title="04.模块四 搭建自己的SSR、静态站点生成（SSG）及封装 Vue.js 组件库"></a>04.模块四 搭建自己的SSR、静态站点生成（SSG）及封装 Vue.js 组件库</h2><h3 id="01-任务一：搭建自己的SSR"><a href="#01-任务一：搭建自己的SSR" class="headerlink" title="01.任务一：搭建自己的SSR"></a>01.任务一：搭建自己的SSR</h3><h4 id="01-渲染一个Vue实例"><a href="#01-渲染一个Vue实例" class="headerlink" title="01.渲染一个Vue实例"></a>01.渲染一个Vue实例</h4><p><img src="046e3a24.png"></p>
<pre class=" language-shell"><code class="language-shell">#npm i vue vue-server-renderer
npm i vue@2.6.14 vue-server-renderer@2.6.14
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

    template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
      &lt;div id="app">
        &lt;h1>{{ message }}&lt;/h1>
      &lt;/div>
    `</span></span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        message<span class="token punctuation">:</span> <span class="token string">'malred'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 渲染为纯文本字符串</span>
renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="d0bccc0f.png"></p>
<h4 id="02-结合到Web服务中"><a href="#02-结合到Web服务中" class="headerlink" title="02.结合到Web服务中"></a>02.结合到Web服务中</h4><pre class=" language-shell"><code class="language-shell">npm i express
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
          &lt;div id="app">
            &lt;h1>{{ message }}&lt;/h1>
          &lt;/div>
        `</span></span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">:</span> <span class="token string">'我是malred'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 渲染为纯文本字符串</span>
    renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Internal Server Error.'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// html发送到客户端</span>
        <span class="token comment" spellcheck="true">// 防止中文乱码</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf8'</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// res.end(html)</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`
            &lt;!DOCTYPE html>
            &lt;html lang="en">
            &lt;head>
                &lt;!--编码-->
                &lt;meta charset="UTF-8">
                &lt;title>Title&lt;/title>
            &lt;/head>
            &lt;body>
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
            &lt;/body>
            &lt;/html>
        `</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at port 3001.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-shell"><code class="language-shell">nodemon server.js
</code></pre>
<h4 id="03-使用HTML模板"><a href="#03-使用HTML模板" class="headerlink" title="03.使用HTML模板"></a>03.使用HTML模板</h4><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 解析结果会填入模板里</span>
    template<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">"./index.template.html"</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 渲染为纯文本字符串</span>
    renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at port 3001.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--index.template.html--></span>
<span class="token doctype">&lt;!doctype html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>
          <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, user-scalable<span class="token punctuation">=</span>no, initial-scale<span class="token punctuation">=</span>1.0, maximum-scale<span class="token punctuation">=</span>1.0, minimum-scale<span class="token punctuation">=</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ie<span class="token punctuation">=</span>edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!--内容将渲染到这--></span>
<span class="token comment" spellcheck="true">&lt;!--vue-ssr-outlet--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<h4 id="04-在模板中使用外部数据"><a href="#04-在模板中使用外部数据" class="headerlink" title="04.在模板中使用外部数据"></a>04.在模板中使用外部数据</h4><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!doctype html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>
          <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, user-scalable<span class="token punctuation">=</span>no, initial-scale<span class="token punctuation">=</span>1.0, maximum-scale<span class="token punctuation">=</span>1.0, minimum-scale<span class="token punctuation">=</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ie<span class="token punctuation">=</span>edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!--3个大括号,直接原文输出,vue不会进行处理--></span>
    {{{ meta }}}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!--内容将渲染到这--></span>
<span class="token comment" spellcheck="true">&lt;!--vue-ssr-outlet--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 渲染为纯文本字符串</span>
    renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 上下文对象,可以传入数据,在模板里使用</span>
            title<span class="token punctuation">:</span> <span class="token string">'示例页面'</span><span class="token punctuation">,</span>
            meta<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
                &lt;meta name="description"  content="一个测试页面"/>
            `</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at port 3001.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="构建配置"><a href="#构建配置" class="headerlink" title="构建配置"></a>构建配置</h4><h5 id="05-构建配置-基本思路"><a href="#05-构建配置-基本思路" class="headerlink" title="05.构建配置-基本思路"></a>05.构建配置-基本思路</h5><blockquote>
<p>需要有客户端脚本,接管服务端渲染好的内容,实现为动态页面</p>
</blockquote>
<p><img src="dfafbe37.png" alt="动态交互和事件绑定等功能无法使用了,现在的页面只是静态字符串"><img src="2d09e57a.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ...</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        template<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
          &lt;div id="app">
            &lt;h1>{{ message }}&lt;/h1>
            &lt;h2>客户端动态交互&lt;/h2>
            &lt;div>
              &lt;input v-model="message">
            &lt;/div>
            &lt;div>
              &lt;button @click="onClick">点击测试&lt;/button>
            &lt;/div>
          &lt;/div>
        `</span></span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">:</span> <span class="token string">'我是malred'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 渲染为纯文本字符串</span>
    renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at port 3001.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="06-构建配置-源码结构"><a href="#06-构建配置-源码结构" class="headerlink" title="06.构建配置-源码结构"></a>06.构建配置-源码结构</h5><p><img src="5355ce83.png"><img src="ca659ace.png"><img src="ebeffc3a.png"><img src="f3363801.png"><img src="320040f4.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"App"</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> <span class="token string">'我是malred'</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>

<span class="token operator">&lt;</span>template<span class="token operator">></span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"app"</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>h1<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">{</span>message<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>
        <span class="token operator">&lt;</span>h2<span class="token operator">></span>客户端动态交互<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>
        <span class="token operator">&lt;</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span>input v<span class="token operator">-</span>model<span class="token operator">=</span><span class="token string">"message"</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>div<span class="token operator">></span>
            <span class="token operator">&lt;</span>button
            @click<span class="token operator">=</span><span class="token string">"onClick"</span><span class="token operator">></span>点击测试
        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span> 
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.js</span>
<span class="token comment" spellcheck="true">/**
 * 通用启动入口
 */</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>

<span class="token comment" spellcheck="true">// 导出一个工厂函数,用于创建新的</span>
<span class="token comment" spellcheck="true">// 应用程序 router 和 store 实例</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 根实例简单的渲染应用程序组件</span>
        render<span class="token punctuation">:</span> h <span class="token operator">=</span><span class="token operator">></span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>app<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// entry-client.js</span>
<span class="token comment" spellcheck="true">/**
 * 客户端启动入口
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token comment" spellcheck="true">// 客户端特定引导逻辑……</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 这里假定 App.vue 模板中根元素具有 `id="app"`</span>
app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// entry-server.js</span>
<span class="token comment" spellcheck="true">/**
 * 服务端启动入口
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> context <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 服务端路由处理 / 数据预取 ...</span>
    <span class="token keyword">return</span> app
<span class="token punctuation">}</span>
</code></pre>
<h5 id="07-构建配置-安装依赖"><a href="#07-构建配置-安装依赖" class="headerlink" title="07.构建配置-安装依赖"></a>07.构建配置-安装依赖</h5><p><img src="127de2fb.png"><img src="e4e0374e.png"></p>
<pre class=" language-shell"><code class="language-shell">npm i cross-env
npm i -D webpack webpack-cli webpack-merge webpack-node-externals @babel/core @babel/plugin-transform-runtime @babel/preset-env babel-loader css-loader url-loader file-loader rimraf vue-loader vue-template-compiler friendly-errors-webpack-plugin
npm i vue-loader@15.10.2
</code></pre>
<h5 id="08-构建配置-webpack配置文件"><a href="#08-构建配置-webpack配置文件" class="headerlink" title="08.构建配置-webpack配置文件"></a>08.构建配置-webpack配置文件</h5><p><img src="e6ded862.png"><img src="1ce3cdbc.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.base.config.js</span>
<span class="token comment" spellcheck="true">/**
 * 公共配置
 */</span>
<span class="token keyword">const</span> VueLoaderPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-loader/lib/plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// 友好的日志打印</span>
<span class="token keyword">const</span> FriendlyErrorsWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'friendly-errors-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// 安全的文件路径</span>
<span class="token keyword">const</span> resolve <span class="token operator">=</span> file <span class="token operator">=</span><span class="token operator">></span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> file<span class="token punctuation">)</span>
<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">===</span> <span class="token string">'production'</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    mode<span class="token punctuation">:</span> isProd <span class="token operator">?</span> <span class="token string">'production'</span> <span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'../dist/'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        publicPath<span class="token punctuation">:</span> <span class="token string">'/dist/'</span><span class="token punctuation">,</span>
        filename<span class="token punctuation">:</span> <span class="token string">'[name].[chunkhash].js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 路径别名，@ 指向 src</span>
            <span class="token string">'@'</span><span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'../src/'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 可以省略的扩展名</span>
        <span class="token comment" spellcheck="true">// 当省略扩展名的时候，按照从前往后的顺序依次解析</span>
        extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.vue'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 调试信息</span>
    devtool<span class="token punctuation">:</span> isProd <span class="token operator">?</span> <span class="token string">'source-map'</span> <span class="token punctuation">:</span> <span class="token string">'cheap-module-eval-source-map'</span><span class="token punctuation">,</span>
    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token comment" spellcheck="true">// 处理图片资源</span>
            <span class="token punctuation">{</span>
                test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpg|gif)$/i</span><span class="token punctuation">,</span>
                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        loader<span class="token punctuation">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span>
                        options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                            limit<span class="token punctuation">:</span> <span class="token number">8192</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 处理字体资源</span>
            <span class="token punctuation">{</span>
                test<span class="token punctuation">:</span> <span class="token regex">/\.(woff|woff2|eot|ttf|otf)$/</span><span class="token punctuation">,</span>
                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token string">'file-loader'</span><span class="token punctuation">,</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 处理 .vue 资源</span>
            <span class="token punctuation">{</span>
                test<span class="token punctuation">:</span> <span class="token regex">/\.vue$/</span><span class="token punctuation">,</span>
                loader<span class="token punctuation">:</span> <span class="token string">'vue-loader'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 处理 CSS 资源</span>
            <span class="token comment" spellcheck="true">// 它会应用到普通的 `.css` 文件</span>
            <span class="token comment" spellcheck="true">// 以及 `.vue` 文件中的 `&lt;style>` 块</span>
            <span class="token punctuation">{</span>
                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>
                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token string">'vue-style-loader'</span><span class="token punctuation">,</span>
                    <span class="token string">'css-loader'</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// CSS 预处理器，参考：https://vue-loader.vuejs.org/zh/guide/pre-processors.html</span>
            <span class="token comment" spellcheck="true">// 例如处理 Less 资源</span>
            <span class="token comment" spellcheck="true">// {</span>
            <span class="token comment" spellcheck="true">//     test: /\.less$/,</span>
            <span class="token comment" spellcheck="true">//     use: [</span>
            <span class="token comment" spellcheck="true">//         'vue-style-loader',</span>
            <span class="token comment" spellcheck="true">//         'css-loader',</span>
            <span class="token comment" spellcheck="true">//         'less-loader'</span>
            <span class="token comment" spellcheck="true">//     ]</span>
            <span class="token comment" spellcheck="true">// },</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">FriendlyErrorsWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.client.config.js</span>
<span class="token comment" spellcheck="true">/**
 * 客户端打包配置
 */</span>
<span class="token comment" spellcheck="true">// merge用于合并webpack配置信息</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>merge<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.config.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> VueSSRClientPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer/client-plugin'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 合并baseConfig和当前config</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 该相对路径是相对于执行打包的目录</span>
        app<span class="token punctuation">:</span> <span class="token string">'./src/entry-client.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token comment" spellcheck="true">// ES6 转 ES5</span>
            <span class="token punctuation">{</span>
                test<span class="token punctuation">:</span> <span class="token regex">/\.m?js$/</span><span class="token punctuation">,</span>
                exclude<span class="token punctuation">:</span> <span class="token regex">/(node_modules|bower_components)/</span><span class="token punctuation">,</span>
                use<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
                    options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        presets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        cacheDirectory<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 重要信息：这将 webpack 运行时分离到一个引导 chunk 中，</span>
    <span class="token comment" spellcheck="true">// 以便可以在之后正确注入异步 chunk。</span>
    optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"manifest"</span><span class="token punctuation">,</span>
            minChunks<span class="token punctuation">:</span> <span class="token number">Infinity</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token comment" spellcheck="true">// 此插件在输出目录中生成 `vue-ssr-client-manifest.json`。</span>
        <span class="token keyword">new</span> <span class="token class-name">VueSSRClientPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// webpack.server.config.js</span>
<span class="token comment" spellcheck="true">/**
 * 服务端打包配置
 */</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>merge<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-node-externals'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.config.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> VueSSRServerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer/server-plugin'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 合并配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 将 entry 指向应用程序的 server entry 文件</span>
    entry<span class="token punctuation">:</span> <span class="token string">'./src/entry-server.js'</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// 这允许 webpack 以 Node 适用方式处理模块加载</span>
    <span class="token comment" spellcheck="true">// 并且还会在编译 Vue 组件时，</span>
    <span class="token comment" spellcheck="true">// 告知 `vue-loader` 输送面向服务器代码(server-oriented code)。</span>
    target<span class="token punctuation">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        filename<span class="token punctuation">:</span> <span class="token string">'server-bundle.js'</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 此处告知 server bundle 使用 Node 风格导出模块(Node-style exports)</span>
        libraryTarget<span class="token punctuation">:</span> <span class="token string">'commonjs2'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 不打包 node_modules 第三方包，而是保留 require 方式直接加载</span>
    externals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 白名单中的资源依然正常打包</span>
        allowlist<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">/</span>\<span class="token punctuation">.</span>css$<span class="token operator">/</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token comment" spellcheck="true">// 这是将服务器的整个输出构建为单个 JSON 文件的插件。</span>
        <span class="token comment" spellcheck="true">// 默认文件名为 `vue-ssr-server-bundle.json`</span>
        <span class="token keyword">new</span> <span class="token class-name">VueSSRServerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="09-构建配置-配置构建命令"><a href="#09-构建配置-配置构建命令" class="headerlink" title="09.构建配置-配置构建命令"></a>09.构建配置-配置构建命令</h5><blockquote>
<p>package.json</p>
</blockquote>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span><span class="token punctuation">,</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node server.js"</span><span class="token punctuation">,</span>
    <span class="token property">"build:client"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production webpack --config build/webpack.client.config.js"</span><span class="token punctuation">,</span>
    <span class="token property">"build:server"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production webpack --config build/webpack.server.config.js"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"rimraf dist &amp;&amp; npm run build:client &amp;&amp; npm run build:server"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"axios"</span><span class="token operator">:</span> <span class="token string">"^0.19.2"</span><span class="token punctuation">,</span>
    <span class="token property">"chokidar"</span><span class="token operator">:</span> <span class="token string">"^3.4.0"</span><span class="token punctuation">,</span>
    <span class="token property">"cross-env"</span><span class="token operator">:</span> <span class="token string">"^7.0.2"</span><span class="token punctuation">,</span>
    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"^4.17.1"</span><span class="token punctuation">,</span>
    <span class="token property">"vue"</span><span class="token operator">:</span> <span class="token string">"^2.6.11"</span><span class="token punctuation">,</span>
    <span class="token property">"vue-meta"</span><span class="token operator">:</span> <span class="token string">"^2.4.0"</span><span class="token punctuation">,</span>
    <span class="token property">"vue-router"</span><span class="token operator">:</span> <span class="token string">"^3.3.4"</span><span class="token punctuation">,</span>
    <span class="token property">"vue-server-renderer"</span><span class="token operator">:</span> <span class="token string">"^2.6.11"</span><span class="token punctuation">,</span>
    <span class="token property">"vuex"</span><span class="token operator">:</span> <span class="token string">"^3.5.1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"@babel/core"</span><span class="token operator">:</span> <span class="token string">"^7.10.4"</span><span class="token punctuation">,</span>
    <span class="token property">"@babel/plugin-transform-runtime"</span><span class="token operator">:</span> <span class="token string">"^7.10.4"</span><span class="token punctuation">,</span>
    <span class="token property">"@babel/preset-env"</span><span class="token operator">:</span> <span class="token string">"^7.10.4"</span><span class="token punctuation">,</span>
    <span class="token property">"babel-loader"</span><span class="token operator">:</span> <span class="token string">"^8.1.0"</span><span class="token punctuation">,</span>
    <span class="token property">"css-loader"</span><span class="token operator">:</span> <span class="token string">"^3.6.0"</span><span class="token punctuation">,</span>
    <span class="token property">"file-loader"</span><span class="token operator">:</span> <span class="token string">"^6.0.0"</span><span class="token punctuation">,</span>
    <span class="token property">"friendly-errors-webpack-plugin"</span><span class="token operator">:</span> <span class="token string">"^1.7.0"</span><span class="token punctuation">,</span>
    <span class="token property">"rimraf"</span><span class="token operator">:</span> <span class="token string">"^3.0.2"</span><span class="token punctuation">,</span>
    <span class="token property">"url-loader"</span><span class="token operator">:</span> <span class="token string">"^4.1.0"</span><span class="token punctuation">,</span>
    <span class="token property">"vue-loader"</span><span class="token operator">:</span> <span class="token string">"^15.9.3"</span><span class="token punctuation">,</span>
    <span class="token property">"vue-template-compiler"</span><span class="token operator">:</span> <span class="token string">"^2.6.11"</span><span class="token punctuation">,</span>
    <span class="token property">"webpack"</span><span class="token operator">:</span> <span class="token string">"^4.43.0"</span><span class="token punctuation">,</span>
    <span class="token property">"webpack-cli"</span><span class="token operator">:</span> <span class="token string">"^3.3.12"</span><span class="token punctuation">,</span>
    <span class="token property">"webpack-dev-middleware"</span><span class="token operator">:</span> <span class="token string">"^3.7.2"</span><span class="token punctuation">,</span>
    <span class="token property">"webpack-hot-middleware"</span><span class="token operator">:</span> <span class="token string">"^2.25.0"</span><span class="token punctuation">,</span>
    <span class="token property">"webpack-merge"</span><span class="token operator">:</span> <span class="token string">"^5.0.9"</span><span class="token punctuation">,</span>
    <span class="token property">"webpack-node-externals"</span><span class="token operator">:</span> <span class="token string">"^2.5.0"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="b1f00536.png"></p>
<h5 id="10-构建配置-启动应用"><a href="#10-构建配置-启动应用" class="headerlink" title="10.构建配置-启动应用"></a>10.构建配置-启动应用</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// server.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> serverBundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-server-bundle.json'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> clientManifest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-client-manifest.json'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">"./index.template.html"</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>
    serverBundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 解析结果会填入模板里</span>
        template<span class="token punctuation">,</span> clientManifest
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 客户端会从server端调用编译后的js,这里需要开放dist目录给客户端</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/dist'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 渲染为纯文本字符串</span>
    <span class="token comment" spellcheck="true">// 会从entry-server里拿到vue实例</span>
    renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at port 3001.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="11-构建配置-解析渲染流程"><a href="#11-构建配置-解析渲染流程" class="headerlink" title="11.构建配置-解析渲染流程"></a>11.构建配置-解析渲染流程</h5><blockquote>
<p>serverBundle文件files就是打包后的js,entry表示入口,map是用于调试的信息,通过entry找到打包后的server-bundle.js,然后得到vue实例</p>
</blockquote>
<p><img src="a0de15bd.png"><img src="52e8979c.png"></p>
<blockquote>
<p>client-manifest描述了客户端构建需要的资源信息,initial中指定的资源会被自动配置到html中,<br>async中是异步的资源,modules存放的是针对原始模块的依赖信息</p>
</blockquote>
<p><img src="a580bef0.png" alt="自动将加载js的代码添加到了html"><img src="da9890d6.png"><img src="799c3f5d.png"><br><img src="7edca388.png"><img src="abf3b9d9.png" alt="激活html为动态的过程也叫注水操作"><img src="435de52c.png"><br><img src="d89a31ed.png"></p>
<h4 id="构建配置开发模式"><a href="#构建配置开发模式" class="headerlink" title="构建配置开发模式"></a>构建配置开发模式</h4><h5 id="12-构建配置开发模式-基本思路"><a href="#12-构建配置开发模式-基本思路" class="headerlink" title="12.构建配置开发模式-基本思路"></a>12.构建配置开发模式-基本思路</h5><blockquote>
<p>希望写完代码(src下的源代码)能自动重启服务器,自动加载资源文件,自动打开浏览器</p>
</blockquote>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production &amp;&amp; node server.js"</span><span class="token punctuation">,</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"node server.js"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// const Vue = require('vue')</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">===</span> <span class="token string">'production'</span>

<span class="token comment" spellcheck="true">// ssr渲染器</span>
<span class="token keyword">let</span> renderer
<span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 生产模式: 基于构建好的文件启动</span>
    <span class="token keyword">const</span> serverBundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-server-bundle.json'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> clientManifest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-client-manifest.json'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">"./index.template.html"</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>
        serverBundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 解析结果会填入模板里</span>
            template<span class="token punctuation">,</span> clientManifest
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 开发模式: 监视打包构建 -> 重新生成renderer</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 客户端会从server端调用编译后的js,这里需要开放dist目录给客户端</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/dist'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 路由处理的渲染函数</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 渲染为纯文本字符串</span>
    <span class="token comment" spellcheck="true">// 会从entry-server里拿到vue实例</span>
    renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 上下文对象,可以传入数据,在模板里使用</span>
            title<span class="token punctuation">:</span> <span class="token string">'示例页面'</span><span class="token punctuation">,</span>
            meta<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
                &lt;meta name="description"  content="一个测试页面"/>
            `</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Internal Server Error.'</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// html发送到客户端</span>
            <span class="token comment" spellcheck="true">// 防止中文乱码</span>
            res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf8'</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// res.end(html)</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> isProd <span class="token operator">?</span>
    render
    <span class="token punctuation">:</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// TODO: 等待renderer重新构建完成后,再调用render渲染</span>
        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at port 3001.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="13-构建配置开发模式-提取处理模块"><a href="#13-构建配置开发模式-提取处理模块" class="headerlink" title="13.构建配置开发模式-提取处理模块"></a>13.构建配置开发模式-提取处理模块</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// build/setup-dev-server.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> onReady <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 监视构建 -> 更新renderer</span>

    <span class="token keyword">return</span> onReady
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// const Vue = require('vue')</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>createBundleRenderer<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> setupDevServer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/setup-dev-server'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">===</span> <span class="token string">'production'</span>

<span class="token comment" spellcheck="true">// ssr渲染器</span>
<span class="token keyword">let</span> renderer
<span class="token comment" spellcheck="true">// 开发模式是否构建renderer完成</span>
<span class="token keyword">let</span> onReady
<span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 生产模式: 基于构建好的文件启动</span>
    <span class="token keyword">const</span> serverBundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-server-bundle.json'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> clientManifest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-client-manifest.json'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">"./index.template.html"</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    renderer <span class="token operator">=</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>
        serverBundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 解析结果会填入模板里</span>
            template<span class="token punctuation">,</span> clientManifest
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 开发模式: 监视打包构建 -> 重新生成renderer</span>
    onReady <span class="token operator">=</span> <span class="token function">setupDevServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token punctuation">(</span>serverBundle<span class="token punctuation">,</span> template<span class="token punctuation">,</span> clientManifest<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        renderer <span class="token operator">=</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>
            serverBundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 解析结果会填入模板里</span>
                template<span class="token punctuation">,</span> clientManifest
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 客户端会从server端调用编译后的js,这里需要开放dist目录给客户端</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/dist'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 路由处理的渲染函数</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 渲染为纯文本字符串</span>
    <span class="token comment" spellcheck="true">// 会从entry-server里拿到vue实例</span>
    renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> html<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> isProd <span class="token operator">?</span>
    render
    <span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 等待renderer重新构建完成后,再调用render渲染</span>
        <span class="token keyword">await</span> onReady
        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at port 3001.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="14-构建配置开发模式-update更新函数"><a href="#14-构建配置开发模式-update更新函数" class="headerlink" title="14.构建配置开发模式-update更新函数"></a>14.构建配置开发模式-update更新函数</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// setup-dev-server.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ready <span class="token comment" spellcheck="true">// promise的结果</span>
    <span class="token keyword">const</span> onReady <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>r <span class="token operator">=</span><span class="token operator">></span> ready <span class="token operator">=</span> r<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 监视构建 -> 更新renderer</span>
    <span class="token keyword">let</span> template
    <span class="token keyword">let</span> serverBundle
    <span class="token keyword">let</span> clientManifest

    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverBundle <span class="token operator">&amp;&amp;</span> template <span class="token operator">&amp;&amp;</span> clientManifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>serverBundle<span class="token punctuation">,</span> template<span class="token punctuation">,</span> clientManifest<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 监视构建template -> 调用update -> 更新renderer渲染器</span>
    <span class="token comment" spellcheck="true">// 监视构建serverBundle -> 调用update -> 更新renderer渲染器</span>
    <span class="token comment" spellcheck="true">// 监视构建clientManifest -> 调用update -> 更新renderer渲染器</span>

    <span class="token keyword">return</span> onReady
<span class="token punctuation">}</span>
</code></pre>
<h5 id="15-构建配置开发模式-处理模板文件"><a href="#15-构建配置开发模式-处理模板文件" class="headerlink" title="15.构建配置开发模式-处理模板文件"></a>15.构建配置开发模式-处理模板文件</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// setup-dev-server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chokidar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"chokidar"</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ready <span class="token comment" spellcheck="true">// promise的结果</span>
    <span class="token keyword">const</span> onReady <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>r <span class="token operator">=</span><span class="token operator">></span> ready <span class="token operator">=</span> r<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 监视构建 -> 更新renderer</span>
    <span class="token keyword">let</span> template
    <span class="token keyword">let</span> serverBundle
    <span class="token keyword">let</span> clientManifest

    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverBundle <span class="token operator">&amp;&amp;</span> template <span class="token operator">&amp;&amp;</span> clientManifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>serverBundle<span class="token punctuation">,</span> template<span class="token punctuation">,</span> clientManifest<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 监视构建template -> 调用update -> 更新renderer渲染器</span>
    <span class="token keyword">const</span> tempPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../index.template.html'</span><span class="token punctuation">)</span>
    template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// console.log(template)</span>
    <span class="token comment" spellcheck="true">// 监视: fs.watch | fs.watchFile</span>
    <span class="token comment" spellcheck="true">// 使用第三方库, 监视文件改变</span>
    chokidar<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// console.log('template change')</span>
        template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 监视构建serverBundle -> 调用update -> 更新renderer渲染器</span>
    <span class="token comment" spellcheck="true">// 监视构建clientManifest -> 调用update -> 更新renderer渲染器</span>

    <span class="token keyword">return</span> onReady
<span class="token punctuation">}</span>
</code></pre>
<h5 id="16-构建配置开发模式-服务端监视打包"><a href="#16-构建配置开发模式-服务端监视打包" class="headerlink" title="16.构建配置开发模式-服务端监视打包"></a>16.构建配置开发模式-服务端监视打包</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// setup-dev-server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chokidar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"chokidar"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> resolve <span class="token operator">=</span> file <span class="token operator">=</span><span class="token operator">></span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> file<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
    <span class="token comment" spellcheck="true">// 监视构建serverBundle -> 调用update -> 更新renderer渲染器</span>
    <span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.server.config'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 通过webpack创建编译器</span>
    <span class="token keyword">const</span> serverCompiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>serverConfig<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 执行打包构建,并监视变化</span>
    serverCompiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token comment" spellcheck="true">// console.log('success')</span>
        <span class="token comment" spellcheck="true">// 不用require是因为require有缓存,文件再次加载会用缓存</span>
        serverBundle <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"../dist/vue-ssr-server-bundle.json"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// console.log(serverBundle)</span>
        <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 监视构建clientManifest -> 调用update -> 更新renderer渲染器</span>

    <span class="token keyword">return</span> onReady
<span class="token punctuation">}</span>
</code></pre>
<h5 id="17-构建配置开发模式-把数据写入内存中"><a href="#17-构建配置开发模式-把数据写入内存中" class="headerlink" title="17.构建配置开发模式-把数据写入内存中"></a>17.构建配置开发模式-把数据写入内存中</h5><p><img src="86ea9f5f.png"><img src="20fd84d8.png"></p>
<pre class=" language-shell"><code class="language-shell">npm i webpack-dev-middleware --save-dev
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// setup-dev-server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chokidar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"chokidar"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> devMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-middleware'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> resolve <span class="token operator">=</span> file <span class="token operator">=</span><span class="token operator">></span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> file<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 监视构建serverBundle -> 调用update -> 更新renderer渲染器</span>
    <span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.server.config'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 通过webpack创建编译器</span>
    <span class="token keyword">const</span> serverCompiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>serverConfig<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 缓存在内存,自动监听并打包</span>
    <span class="token keyword">const</span> serverDevMiddleware <span class="token operator">=</span> <span class="token function">devMiddleware</span><span class="token punctuation">(</span>serverCompiler<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 关闭日志输出,由FriendlyErrorsWebpackPlugin处理</span>
        logLevel<span class="token punctuation">:</span> <span class="token string">'silent'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 编译器的钩子,相对于注册了插件</span>
    serverCompiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        serverBundle <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>
            <span class="token comment" spellcheck="true">// devMiddleware的文件读写方法</span>
            serverDevMiddleware<span class="token punctuation">.</span>fileSystem<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"../dist/vue-ssr-server-bundle.json"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// console.log(serverBundle)</span>
        <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 监视构建clientManifest -> 调用update -> 更新renderer渲染器</span>

    <span class="token keyword">return</span> onReady
<span class="token punctuation">}</span>
</code></pre>
<h5 id="18-构建配置开发模式-客户端构建"><a href="#18-构建配置开发模式-客户端构建" class="headerlink" title="18.构建配置开发模式-客户端构建"></a>18.构建配置开发模式-客户端构建</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// setup-dev-server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chokidar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"chokidar"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> devMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-middleware'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./webpack.server.config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> resolve <span class="token operator">=</span> file <span class="token operator">=</span><span class="token operator">></span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> file<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 监视构建clientManifest -> 调用update -> 更新renderer渲染器</span>
    <span class="token keyword">const</span> clientConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.client.config'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 通过webpack创建编译器</span>
    <span class="token keyword">const</span> clientCompiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 缓存在内存,自动监听并打包</span>
    <span class="token keyword">const</span> clientDevMiddleware <span class="token operator">=</span> <span class="token function">devMiddleware</span><span class="token punctuation">(</span>clientCompiler<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 请求资源url的前缀</span>
        publicPath<span class="token punctuation">:</span> clientConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 关闭日志输出,由FriendlyErrorsWebpackPlugin处理</span>
        logLevel<span class="token punctuation">:</span> <span class="token string">'silent'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 编译器的钩子,相对于注册了插件</span>
    clientCompiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'client'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        clientManifest <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>
            <span class="token comment" spellcheck="true">// devMiddleware的文件读写方法</span>
            clientDevMiddleware<span class="token punctuation">.</span>fileSystem<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"../dist/vue-ssr-client-manifest.json"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// console.log(clientManifest)</span>
        <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// !!!将clientDevMiddleware挂载到express服务中,提供对其内存中文件的访问</span>
    server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>clientDevMiddleware<span class="token punctuation">)</span>

    <span class="token keyword">return</span> onReady
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// server.js</span>
<span class="token comment" spellcheck="true">// 客户端会从server端调用编译后的js,这里需要开放dist目录给客户端</span>
<span class="token comment" spellcheck="true">// 处理的是物理磁盘的文件,而我们现在是内存里的文件</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/dist'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> isProd <span class="token operator">?</span>
    render
    <span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 等待renderer重新构建完成后,再调用render渲染</span>
        <span class="token keyword">await</span> onReady
        <span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre>
<h5 id="19-构建配置开发模式-热更新"><a href="#19-构建配置开发模式-热更新" class="headerlink" title="19.构建配置开发模式-热更新"></a>19.构建配置开发模式-热更新</h5><pre class=" language-shell"><code class="language-shell">npm i --save-dev webpack-hot-middleware
</code></pre>
<p><img src="9fb2e97c.png"><img src="3ee5fcc5.png"><img src="9a122033.png" alt="热更新需要打包出的文件hash一致"><img src="8c342041.png"><br><img src="48b73644.png" alt="想要在开发的时候关闭日志"><img src="4fabcffb.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// setup-dev-server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chokidar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"chokidar"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> devMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-middleware'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> hotMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-hot-middleware'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./webpack.server.config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> resolve <span class="token operator">=</span> file <span class="token operator">=</span><span class="token operator">></span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> file<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 监视构建clientManifest -> 调用update -> 更新renderer渲染器</span>
    <span class="token keyword">const</span> clientConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.client.config'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 热更新插件</span>
    clientConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    clientConfig<span class="token punctuation">.</span>entry<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">'webpack-hot-middleware/client?quiet=true&amp;reload=true'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">// 和服务端交互处理热更新的一个客户端脚本</span>
        clientConfig<span class="token punctuation">.</span>entry<span class="token punctuation">.</span>app<span class="token comment" spellcheck="true">// 原本的入口</span>
    <span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true">// 热更新需要每次打包的文件名(hash)一致</span>
    clientConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token string">'[name].js'</span>
    <span class="token comment" spellcheck="true">// 通过webpack创建编译器</span>
    <span class="token keyword">const</span> clientCompiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 热更新服务</span>
    server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">hotMiddleware</span><span class="token punctuation">(</span>clientCompiler<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">// 关闭本身的日志</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// !!!将clientDevMiddleware挂载到express服务中,提供对其内存中文件的访问</span>
    server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>clientDevMiddleware<span class="token punctuation">)</span>

    <span class="token keyword">return</span> onReady
<span class="token punctuation">}</span>
</code></pre>
<h4 id="20-编写通用应用注意事项"><a href="#20-编写通用应用注意事项" class="headerlink" title="20.编写通用应用注意事项"></a>20.编写通用应用注意事项</h4><p><img src="08a24490.png"><img src="aee33843.png"><img src="b48268e6.png"><img src="ab8866f8.png"><img src="c6a211bc.png"><img src="ef7e5e40.png"></p>
<h4 id="路由处理"><a href="#路由处理" class="headerlink" title="路由处理"></a>路由处理</h4><h5 id="21-路由处理-配置VueRouter"><a href="#21-路由处理-配置VueRouter" class="headerlink" title="21.路由处理-配置VueRouter"></a>21.路由处理-配置VueRouter</h5><p><img src="d37a74a5.png"><img src="a3349a8a.png"></p>
<pre class=" language-shell"><code class="language-shell">npm i vue-router
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// router/index.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">"vue-router"</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'@/pages/Home'</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> createRouter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 兼容前后端(服务端/客户端)</span>
        mode<span class="token punctuation">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
        routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
                name<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>
                component<span class="token punctuation">:</span> Home
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">"/about"</span><span class="token punctuation">,</span>
                name<span class="token punctuation">:</span> <span class="token string">'about'</span><span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">// 异步加载组件</span>
                component<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"@/pages/About"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
                name<span class="token punctuation">:</span> <span class="token string">'error404'</span><span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">// 异步加载组件</span>
                component<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"@/pages/404"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> router
<span class="token punctuation">}</span>
</code></pre>
<h5 id="22-路由处理-将路由注册到根实例"><a href="#22-路由处理-将路由注册到根实例" class="headerlink" title="22.路由处理-将路由注册到根实例"></a>22.路由处理-将路由注册到根实例</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/app.js</span>
<span class="token comment" spellcheck="true">/**
 * 通用启动入口
 */</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createRouter<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./router"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 导出一个工厂函数,用于创建新的</span>
<span class="token comment" spellcheck="true">// 应用程序 router 和 store 实例</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 每次创建的都是独立的vue实例</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        router<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 路由挂载到根实例</span>
        <span class="token comment" spellcheck="true">// 根实例简单的渲染应用程序组件</span>
        render<span class="token punctuation">:</span> h <span class="token operator">=</span><span class="token operator">></span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span> router<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="23-路由处理-适配服务端入口"><a href="#23-路由处理-适配服务端入口" class="headerlink" title="23.路由处理-适配服务端入口"></a>23.路由处理-适配服务端入口</h5><p><img src="7a538d52.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// entry-server.js</span>
<span class="token comment" spellcheck="true">/**
 * 服务端启动入口
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token comment" spellcheck="true">// export default context => {</span>
<span class="token comment" spellcheck="true">//     // 因为有可能会是异步路由钩子函数或组件，所以我们将返回一个 Promise，</span>
<span class="token comment" spellcheck="true">//     // 以便服务器能够等待所有的内容在渲染前，</span>
<span class="token comment" spellcheck="true">//     // 就已经准备就绪。</span>
<span class="token comment" spellcheck="true">//     return new Promise((resolve, reject) => {</span>
<span class="token comment" spellcheck="true">//         const {app, router} = createApp()</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//         // 设置服务器端 router 的位置</span>
<span class="token comment" spellcheck="true">//         router.push(context.url)</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//         // 等到 router 将可能的异步组件和钩子函数解析完</span>
<span class="token comment" spellcheck="true">//         router.onReady(() => {</span>
<span class="token comment" spellcheck="true">//             const matchedComponents = router.getMatchedComponents()</span>
<span class="token comment" spellcheck="true">//             // 匹配不到的路由，执行 reject 函数，并返回 404</span>
<span class="token comment" spellcheck="true">//             if (!matchedComponents.length) {</span>
<span class="token comment" spellcheck="true">//                 return reject({code: 404})</span>
<span class="token comment" spellcheck="true">//             }</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//             // Promise 应该 resolve 应用程序实例，以便它可以渲染</span>
<span class="token comment" spellcheck="true">//             resolve(app)</span>
<span class="token comment" spellcheck="true">//         }, reject)</span>
<span class="token comment" spellcheck="true">//     })</span>
<span class="token comment" spellcheck="true">// }</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> context <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// async返回的就是promise</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span> router<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 设置服务器端 router 的位置</span>
    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 等到 router 将可能的异步组件和钩子函数解析完</span>
    <span class="token comment" spellcheck="true">// new Promise((resolve, reject)=>{</span>
    <span class="token comment" spellcheck="true">//     router.onReady(resolve,reject)</span>
    <span class="token comment" spellcheck="true">// })</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>onReady<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// async 会把非promise数据包装到promise</span>
    <span class="token keyword">return</span> app
<span class="token punctuation">}</span>
</code></pre>
<h5 id="24-路由处理-服务端server适配"><a href="#24-路由处理-服务端server适配" class="headerlink" title="24.路由处理-服务端server适配"></a>24.路由处理-服务端server适配</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// server.js</span>
<span class="token comment" spellcheck="true">// ...</span>
<span class="token comment" spellcheck="true">// 路由处理的渲染函数</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 渲染为纯文本字符串</span>
        <span class="token comment" spellcheck="true">// 会从entry-server里拿到vue实例</span>
        <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 上下文对象(context),可以传入数据,在模板里使用</span>
            title<span class="token punctuation">:</span> <span class="token string">'示例页面'</span><span class="token punctuation">,</span>
            meta<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`
                &lt;meta name="description"  content="一个测试页面"/>
            `</span></span><span class="token punctuation">,</span>
            url<span class="token punctuation">:</span> req<span class="token punctuation">.</span>url
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// html发送到客户端</span>
        <span class="token comment" spellcheck="true">// 防止中文乱码</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf8'</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// res.end(html)</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Internal Server Error.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 服务端路由设置*,意味着所有url路由都会进入这里</span>
<span class="token comment" spellcheck="true">// 进入渲染路由处理,然后渲染完传递给entry-server</span>
server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">,</span> isProd <span class="token operator">?</span>
    render
    <span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 等待renderer重新构建完成后,再调用render渲染</span>
        <span class="token keyword">await</span> onReady
        <span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span> 
</code></pre>
<h5 id="25-路由处理-适配客户端入口"><a href="#25-路由处理-适配客户端入口" class="headerlink" title="25.路由处理-适配客户端入口"></a>25.路由处理-适配客户端入口</h5><p><img src="2d6caf8a.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// entry-client.js</span>
<span class="token comment" spellcheck="true">/**
 * 客户端启动入口
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token comment" spellcheck="true">// 客户端特定引导逻辑……</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span> router<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 这里假定 App.vue 模板中根元素具有 `id="app"`</span>
<span class="token comment" spellcheck="true">// app.$mount('#app')</span>

router<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h5 id="26-路由处理-处理完成"><a href="#26-路由处理-处理完成" class="headerlink" title="26.路由处理-处理完成"></a>26.路由处理-处理完成</h5><p>下载js,并不运行,防止阻塞;<br>preload加载一定会用到的资源<br>prefetch是浏览器空闲时加载的接下来可能用到的资源</p>
<p><img src="085a0d51.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.vue</span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"App"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>

<span class="token operator">&lt;</span>template<span class="token operator">></span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"app"</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>ul<span class="token operator">></span>
            <span class="token operator">&lt;</span>li<span class="token operator">></span>
                <span class="token operator">&lt;</span>router<span class="token operator">-</span>link to<span class="token operator">=</span><span class="token string">"/"</span><span class="token operator">></span>Home<span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>link<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>
            <span class="token operator">&lt;</span>li<span class="token operator">></span>
                <span class="token operator">&lt;</span>router<span class="token operator">-</span>link to<span class="token operator">=</span><span class="token string">"/about"</span><span class="token operator">></span>About<span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>link<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 路由出口 <span class="token operator">--</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>router<span class="token operator">-</span>view<span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span>

<span class="token operator">&lt;</span>style scoped<span class="token operator">></span>

<span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">></span> 
</code></pre>
<h4 id="27-管理页面Head内容"><a href="#27-管理页面Head内容" class="headerlink" title="27.管理页面Head内容"></a>27.管理页面Head内容</h4><p><img src="07d7c161.png"><img src="ed5c928f.png" alt="vue-meta"></p>
<pre class=" language-shell"><code class="language-shell">npm i vue-meta
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/app.js</span>
<span class="token comment" spellcheck="true">/**
 * 通用启动入口
 */</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createRouter<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./router"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> VueMeta <span class="token keyword">from</span> <span class="token string">"vue-meta"</span><span class="token punctuation">;</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueMeta<span class="token punctuation">)</span>

Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    metaInfo<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 页面的标题渲染到%s</span>
        titleTemplate<span class="token punctuation">:</span> <span class="token string">'%s - malred'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// ...</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// entry-server.js</span>
<span class="token comment" spellcheck="true">/**
 * 服务端启动入口
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> context <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// async返回的就是promise</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span> router<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 在路由导航之前得到并设置meta</span>
    <span class="token keyword">const</span> meta <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">$meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 设置服务器端 router 的位置</span>
    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 合并页面meta和通用meta</span>
    context<span class="token punctuation">.</span>meta <span class="token operator">=</span> meta

    <span class="token comment" spellcheck="true">// 等到 router 将可能的异步组件和钩子函数解析完</span>
    <span class="token comment" spellcheck="true">// new Promise((resolve, reject)=>{</span>
    <span class="token comment" spellcheck="true">//     router.onReady(resolve,reject)</span>
    <span class="token comment" spellcheck="true">// })</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>onReady<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// async 会把非promise数据包装到promise</span>
    <span class="token keyword">return</span> app
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!--index.template.html--></span>
<span class="token doctype">&lt;!doctype html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>
          <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width, user-scalable<span class="token punctuation">=</span>no, initial-scale<span class="token punctuation">=</span>1.0, maximum-scale<span class="token punctuation">=</span>1.0, minimum-scale<span class="token punctuation">=</span>1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ie<span class="token punctuation">=</span>edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    {{{ meta.inject().title.text() }}}
    {{{ meta.inject().meta.text() }}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!--内容将渲染到这--></span>
<span class="token comment" spellcheck="true">&lt;!--vue-ssr-outlet--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Home.vue</span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"Home"</span><span class="token punctuation">,</span>
    metaInfo<span class="token punctuation">:</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span><span class="token string">'首页'</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span> 
</code></pre>
<h4 id="数据预取和状态管理"><a href="#数据预取和状态管理" class="headerlink" title="数据预取和状态管理"></a>数据预取和状态管理</h4><h5 id="28-数据预取和状态管理-思路分析"><a href="#28-数据预取和状态管理-思路分析" class="headerlink" title="28.数据预取和状态管理-思路分析"></a>28.数据预取和状态管理-思路分析</h5><p>通过服务端渲染,将从数据接口得到的数据渲染到页面,这里面有一些挑战</p>
<p><img src="3379f340.png"><img src="7555117a.png"><img src="1b379477.png" alt="服务端没有渲染数据"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// post.vue</span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>

    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"Posts"</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
    posts<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 服务端渲染只能用beforeCreate和created</span>
    <span class="token comment" spellcheck="true">// 服务端渲染不会等待异步操作</span>
    <span class="token comment" spellcheck="true">// 所以在服务端渲染axios获取数据不会生效</span>
    <span class="token keyword">async</span> <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Posts Created Start'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>data<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
    url<span class="token punctuation">:</span> <span class="token string">'http://localhost:8848/topics'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// this.posts = data.data</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>posts <span class="token operator">=</span> data
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Posts Created End'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>

<span class="token operator">&lt;</span>template<span class="token operator">></span>
    <span class="token operator">&lt;</span>div<span class="token operator">></span>
        <span class="token operator">&lt;</span>h1<span class="token operator">></span>Post List<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>
        <span class="token operator">&lt;</span>ul<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 虽然服务端不能得到数据<span class="token punctuation">,</span>但是客户端会请求获取数据并渲染 <span class="token operator">--</span><span class="token operator">></span>
            <span class="token operator">&lt;</span>li v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"post in posts"</span>
            <span class="token punctuation">:</span>key<span class="token operator">=</span><span class="token string">"post.id"</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span> 
</code></pre>
<h5 id="29-数据预取和状态管理-数据预取"><a href="#29-数据预取和状态管理-数据预取" class="headerlink" title="29.数据预取和状态管理-数据预取"></a>29.数据预取和状态管理-数据预取</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/store/index.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">"axios"</span><span class="token punctuation">;</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> createStore <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 单独的函数返回,防止交叉请求可能带来的污染</span>
        state<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
            posts<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 修改数据状态的</span>
        mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token function">setPosts</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                state<span class="token punctuation">.</span>posts <span class="token operator">=</span> data
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// 可以执行异步操作</span>
        <span class="token comment" spellcheck="true">// 服务端渲染期间最好让action返回一个promise</span>
        <span class="token comment" spellcheck="true">// 因为服务端渲染会等待每个promise完成后再渲染字符串</span>
        actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// async 默认返回promise</span>
            <span class="token keyword">async</span> <span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">{</span>commit<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span>data<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'http://localhost:8848/topics'</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 调用mutations里定义的函数</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// commit('setPosts', data.data)</span>
                <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'setPosts'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// src/app.js</span>
<span class="token comment" spellcheck="true">/**
 * 通用启动入口
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./store"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ...</span>

<span class="token comment" spellcheck="true">// 导出一个工厂函数,用于创建新的</span>
<span class="token comment" spellcheck="true">// 应用程序 router 和 store 实例</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 每次创建的都是独立的vue实例</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        router<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 路由挂载到根实例</span>
        store<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 容器挂载到根实例</span>
        <span class="token comment" spellcheck="true">// 根实例简单的渲染应用程序组件</span>
        render<span class="token punctuation">:</span> h <span class="token operator">=</span><span class="token operator">></span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> store<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Posts.vue</span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">import</span> <span class="token punctuation">{</span>mapState<span class="token punctuation">,</span> mapActions<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vuex"</span><span class="token punctuation">;</span>

    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"Posts"</span><span class="token punctuation">,</span>
    computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'posts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// Vue SSR 特别为服务端渲染提供的生命周期hook函数</span>
    <span class="token function">serverPrefetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 发起action, 返回promise</span>
    <span class="token comment" spellcheck="true">// this.$store.dispatch('getPosts')</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapActions</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'getPosts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span> 
</code></pre>
<p>运行时发现, 有一瞬间渲染出来title, 但是又没了, 因为服务端和客户端数据不一致, 水合失败, 客户端重新渲染, 导致丢失数据</p>
<h5 id="30-数据预取和状态管理-将预取数据同步到客户端"><a href="#30-数据预取和状态管理-将预取数据同步到客户端" class="headerlink" title="30.数据预取和状态管理-将预取数据同步到客户端"></a>30.数据预取和状态管理-将预取数据同步到客户端</h5><p><img src="76511724.png"><img src="aac023dc.png"><img src="8a5aa27d.png" alt="此时客户端接管了数据,客户端变化也可以修改数据"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// entry-server.js</span>
<span class="token comment" spellcheck="true">/**
 * 服务端启动入口
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> context <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// async返回的就是promise</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> store<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 在路由导航之前得到并设置meta</span>
    <span class="token keyword">const</span> meta <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">$meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 设置服务器端 router 的位置</span>
    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 合并页面meta和通用meta</span>
    context<span class="token punctuation">.</span>meta <span class="token operator">=</span> meta

    <span class="token comment" spellcheck="true">// 等到 router 将可能的异步组件和钩子函数解析完</span>
    <span class="token comment" spellcheck="true">// new Promise((resolve, reject)=>{</span>
    <span class="token comment" spellcheck="true">//     router.onReady(resolve,reject)</span>
    <span class="token comment" spellcheck="true">// })</span>
    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>onReady<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 服务端渲染数据完毕后被调用,可以拿到服务端渲染好的容器数据</span>
    context<span class="token punctuation">.</span>rendered <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 合并到将给客户端的state</span>
        context<span class="token punctuation">.</span>state <span class="token operator">=</span> store<span class="token punctuation">.</span>state
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// async 会把非promise数据包装到promise</span>
    <span class="token keyword">return</span> app
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// entry-client.js</span>
<span class="token comment" spellcheck="true">/**
 * 客户端启动入口
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app'</span>

<span class="token comment" spellcheck="true">// 客户端特定引导逻辑……</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> store<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 这里假定 App.vue 模板中根元素具有 `id="app"`</span>
<span class="token comment" spellcheck="true">// app.$mount('#app')</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 将服务端给的store给到客户端</span>
    store<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>__INITIAL_STATE__<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

router<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="05-模块五-Vue-js-3-0-Composition-APIs-及-3-0-原理剖析"><a href="#05-模块五-Vue-js-3-0-Composition-APIs-及-3-0-原理剖析" class="headerlink" title="05.模块五 Vue.js 3.0 Composition APIs 及 3.0 原理剖析"></a>05.模块五 Vue.js 3.0 Composition APIs 及 3.0 原理剖析</h2><h3 id="04-任务四：Vite-实现原理"><a href="#04-任务四：Vite-实现原理" class="headerlink" title="04.任务四：Vite 实现原理"></a>04.任务四：Vite 实现原理</h3><h4 id="01-Vite"><a href="#01-Vite" class="headerlink" title="01.Vite"></a>01.Vite</h4><p><img src="baa11835.png"><img src="9ef3b4e4.png"><img src="001b2157.png"><img src="14aaff5c.png"><img src="f9f9f91c.png"><br><img src="8d89c4e3.png"><img src="f849bc34.png"><img src="68a4f840.png"><img src="fd23a2dc.png"><img src="0b8c19f2.png"><br><img src="9d077e06.png"></p>
<h4 id="02-Vite-实现原理-静态Web服务器"><a href="#02-Vite-实现原理-静态Web服务器" class="headerlink" title="02.Vite 实现原理-静态Web服务器"></a>02.Vite 实现原理-静态Web服务器</h4><p><img src="693cf39f.png"><img src="4c97d604.png"><img src="0645978e.png"><img src="fc9f01a3.png"><img src="95a31c81.png"><br><img src="fcbca3a3.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span>
#<span class="token operator">!</span><span class="token regex">/usr/</span>
bin <span class="token operator">/</span> env
node
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> send <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-send'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 1. 开启静态文件服务器</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">send</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5173</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running @ http://localhost:5173'</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="03-Vite-实现原理-修改第三方模块的路径"><a href="#03-Vite-实现原理-修改第三方模块的路径" class="headerlink" title="03.Vite 实现原理-修改第三方模块的路径"></a>03.Vite 实现原理-修改第三方模块的路径</h4><p><img src="294716c5.png"><img src="014e9d62.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span>
#<span class="token operator">!</span><span class="token regex">/usr/</span>
bin <span class="token operator">/</span> env
node
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> send <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-send'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 将文件流转字符串</span>
<span class="token keyword">const</span> streamToStr <span class="token operator">=</span> stream <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true">// 不同事件的处理</span>
    stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> chunk <span class="token operator">=</span><span class="token operator">></span> chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 1. 开启静态文件服务器</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">send</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回静态文件时,先判断是不是第三方模块,如果是,就返回模块路径</span>
<span class="token comment" spellcheck="true">// 2. 修改第三方模块的路径</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'application/javascript'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">streamToStr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// import vue from 'vue' 第三方模块需要改为@module/xxx</span>
        <span class="token comment" spellcheck="true">// import app from './app.vue' 相对路径不需要处理,可以正常引入</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> contents<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">from</span>\s<span class="token operator">+</span><span class="token punctuation">[</span><span class="token string">'"])(?!\.\/)/g, '</span>$<span class="token number">1</span><span class="token operator">/</span>@modules<span class="token operator">/</span>'<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5173</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running @ http://localhost:5173'</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="04-Vite-实现原理-加载第三方模块"><a href="#04-Vite-实现原理-加载第三方模块" class="headerlink" title="04.Vite 实现原理-加载第三方模块"></a>04.Vite 实现原理-加载第三方模块</h4><p><img src="2a988500.png"><img src="521a9604.png"><img src="fc48aa3a.png"></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// index.js</span>
#<span class="token operator">!</span><span class="token regex">/usr/</span>
bin <span class="token operator">/</span> env
node
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> send <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-send'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 将文件流转字符串</span>
<span class="token keyword">const</span> streamToStr <span class="token operator">=</span> stream <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 3. 加载第三方模块</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ctx.path --> /@modules/vue</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/@modules/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> moduleName <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> pkgPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>pkgPath<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// pkg.module -> 入口文件</span>
        ctx<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/node_modules'</span><span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>module<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 1. 开启静态文件服务器</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回静态文件时,先判断是不是第三方模块,如果是,就返回模块路径</span>
<span class="token comment" spellcheck="true">// 2. 修改第三方模块的路径</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5173</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running @ http://localhost:5173'</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="05-Vite-实现原理-编译单文件组件"><a href="#05-Vite-实现原理-编译单文件组件" class="headerlink" title="05.Vite 实现原理-编译单文件组件"></a>05.Vite 实现原理-编译单文件组件</h4><p><img src="d7bcfa6a.png"><img src="0d8fa194.png"><img src="3ac7d1d1.png"></p>
<pre class=" language-js"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Readable<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> send <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-send'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> compilerSFC <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/compiler-sfc'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 将文件流转字符串</span>
<span class="token keyword">const</span> streamToStr <span class="token operator">=</span> stream <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> stringToSteam <span class="token operator">=</span> text <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> stream
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 3. 加载第三方模块</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 1. 开启静态文件服务器</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 4. 处理单文件组件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">streamToStr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 可以通过descriptor获取编译后的js代码</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>descriptor<span class="token punctuation">}</span> <span class="token operator">=</span> compilerSFC<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> code
        <span class="token comment" spellcheck="true">// 第一次请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// vue2是script,vue3是scriptSetup</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                code <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>script<span class="token punctuation">.</span>content
                code <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/export\s+default\s+/g</span><span class="token punctuation">,</span> <span class="token string">'const __script = '</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 不是很懂怎么搞setup</span>
            <span class="token comment" spellcheck="true">// else {</span>
            <span class="token comment" spellcheck="true">//     code = descriptor.scriptSetup.content</span>
            <span class="token comment" spellcheck="true">//     code = code.replace(/import\s*(\w+)\s*from\s*['"]([^'"\/.]*)['"]/g, `</span>
            <span class="token comment" spellcheck="true">//         const __script =</span>
            <span class="token comment" spellcheck="true">//     `)</span>
            <span class="token comment" spellcheck="true">// }</span>
            code <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`
                    import { render as __render } from '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?type=template'
                    __script.render = __render
                    export default __script
                `</span></span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'application/javascript'</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token function">stringToSteam</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回静态文件时,先判断是不是第三方模块,如果是,就返回模块路径</span>
<span class="token comment" spellcheck="true">// 2. 修改第三方模块的路径</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'application/javascript'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">streamToStr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// import vue from 'vue' 第三方模块需要改为@module/xxx</span>
        <span class="token comment" spellcheck="true">// import app from './app.vue' 相对路径不需要处理,可以正常引入</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> contents<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">from</span>\s<span class="token operator">+</span><span class="token punctuation">[</span><span class="token string">'"])(?![\.\/])/g, '</span>$<span class="token number">1</span><span class="token operator">/</span>@modules<span class="token operator">/</span>'<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5173</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running @ http://localhost:5173'</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="06-Vite-实现原理-编译单文件组件"><a href="#06-Vite-实现原理-编译单文件组件" class="headerlink" title="06.Vite 实现原理-编译单文件组件"></a>06.Vite 实现原理-编译单文件组件</h4><p><img src="497e198d.png"></p>
<pre class=" language-js"><code class="language-js">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Readable<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> send <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-send'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> compilerSFC <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/compiler-sfc'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 将文件流转字符串</span>
<span class="token keyword">const</span> streamToStr <span class="token operator">=</span> stream <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true">// 不同事件的处理</span>
    stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> chunk <span class="token operator">=</span><span class="token operator">></span> chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">resolve</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> stringToSteam <span class="token operator">=</span> text <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> stream
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 3. 加载第三方模块</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ctx.path --> /@modules/vue</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/@modules/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> moduleName <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> pkgPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>pkgPath<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// pkg.module -> 入口文件</span>
        ctx<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/node_modules'</span><span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>module<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 1. 开启静态文件服务器</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">send</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span>root<span class="token punctuation">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 4. 处理单文件组件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">streamToStr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 可以通过descriptor获取编译后的js代码</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>descriptor<span class="token punctuation">}</span> <span class="token operator">=</span> compilerSFC<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> code
        <span class="token comment" spellcheck="true">// 第一次请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// vue2是script,vue3是scriptSetup</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                code <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>script<span class="token punctuation">.</span>content
                code <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/export\s+default\s+/g</span><span class="token punctuation">,</span> <span class="token string">'const __script = '</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 不是很懂怎么搞setup</span>
            <span class="token comment" spellcheck="true">// else {</span>
            <span class="token comment" spellcheck="true">//     code = descriptor.scriptSetup.content</span>
            <span class="token comment" spellcheck="true">//     code = code.replace(/import\s*(\w+)\s*from\s*['"]([^'"\/.]*)['"]/g, `</span>
            <span class="token comment" spellcheck="true">//         const __script =</span>
            <span class="token comment" spellcheck="true">//     `)</span>
            <span class="token comment" spellcheck="true">// }</span>

            code <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`
                    import { render as __render } from "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?type=template"
                    __script.render = __render
                    export default __script
                `</span></span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 第二次请求</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'template'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 编译模板</span>
            <span class="token keyword">const</span> templateRender <span class="token operator">=</span>
                compilerSFC<span class="token punctuation">.</span><span class="token function">compileTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>source<span class="token punctuation">:</span> descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span>
            code <span class="token operator">=</span> templateRender<span class="token punctuation">.</span>code
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'application/javascript'</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token function">stringToSteam</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 返回静态文件时,先判断是不是第三方模块,如果是,就返回模块路径</span>
<span class="token comment" spellcheck="true">// 2. 修改第三方模块的路径</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'application/javascript'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">streamToStr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// import vue from 'vue' 第三方模块需要改为@module/xxx</span>
        <span class="token comment" spellcheck="true">// import app from './app.vue' 相对路径不需要处理,可以正常引入</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> contents
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">from</span>\s<span class="token operator">+</span><span class="token punctuation">[</span><span class="token string">'"])(?![\.\/])/g, '</span>$<span class="token number">1</span><span class="token operator">/</span>@modules<span class="token operator">/</span>'<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 替换process.env.NODE_ENV</span>
            <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/process\.env\.NODE_ENV/g</span><span class="token punctuation">,</span> <span class="token string">'"development"'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">5173</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running @ http://localhost:5173'</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="4410efff.png" alt="只支持vue2的选项式 API (Options API)"></p>
<h2 id="06-模块六-Vue-js-Vuex-TypeScript-实战项目开发与项目优化"><a href="#06-模块六-Vue-js-Vuex-TypeScript-实战项目开发与项目优化" class="headerlink" title="06.模块六 Vue.js + Vuex + TypeScript 实战项目开发与项目优化"></a>06.模块六 Vue.js + Vuex + TypeScript 实战项目开发与项目优化</h2><h2 id="07-模块七-Vue-js-3-Vite-TypeScript-实战项目开发"><a href="#07-模块七-Vue-js-3-Vite-TypeScript-实战项目开发" class="headerlink" title="07.模块七 Vue.js 3 + Vite + TypeScript 实战项目开发"></a>07.模块七 Vue.js 3 + Vite + TypeScript 实战项目开发</h2><h3 id="01-任务一：搭建项目架构（上）"><a href="#01-任务一：搭建项目架构（上）" class="headerlink" title="01.任务一：搭建项目架构（上）"></a>01.任务一：搭建项目架构（上）</h3><h4 id="01-01-项目初始化"><a href="#01-01-项目初始化" class="headerlink" title="01.01 项目初始化"></a>01.01 项目初始化</h4><p><img src="2d771f3f.png"></p>
<pre class=" language-shell"><code class="language-shell">npm init vite@latest
</code></pre>
<p><img src="79554c73.png"><img src="14b2b961.png" alt="public文件夹里放的是不需要编译构建的资源"></p>
<h4 id="02-02-代码规范和ESLint-基础配置"><a href="#02-02-代码规范和ESLint-基础配置" class="headerlink" title="02.02 代码规范和ESLint-基础配置"></a>02.02 代码规范和ESLint-基础配置</h4><pre class=" language-shell"><code class="language-shell">npm i eslint --save-dev
npx eslint --init
</code></pre>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"lint"</span><span class="token operator">:</span> <span class="token string">"eslint ./src/**/*.{js,jsx,vue,ts,tsx} --fix"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// eslint.cjs</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"env"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"browser"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">"es2021"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"extends"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"standard-with-typescript"</span><span class="token punctuation">,</span>
        <span class="token string">"plugin:vue/vue3-essential"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"overrides"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"env"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"node"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"files"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">".eslintrc.{js,cjs}"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"parserOptions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"sourceType"</span><span class="token punctuation">:</span> <span class="token string">"script"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"parserOptions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"ecmaVersion"</span><span class="token punctuation">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
        extraFileExtensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'.vue'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        parser<span class="token punctuation">:</span> <span class="token string">"@typescript-eslint/parser"</span><span class="token punctuation">,</span>
        project<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"tsconfig.json"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"sourceType"</span><span class="token punctuation">:</span> <span class="token string">"module"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vue"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"rules"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="03-03-代码规范和ESLint-编辑器集成"><a href="#03-03-代码规范和ESLint-编辑器集成" class="headerlink" title="03.03 代码规范和ESLint-编辑器集成"></a>03.03 代码规范和ESLint-编辑器集成</h4><h4 id="04-04-代码规范和ESLint-配置commit钩子"><a href="#04-04-代码规范和ESLint-配置commit钩子" class="headerlink" title="04.04 代码规范和ESLint-配置commit钩子"></a>04.04 代码规范和ESLint-配置commit钩子</h4><p><img src="fe161f63.png"><img src="ffb24298.png"></p>
<pre class=" language-shell"><code class="language-shell">npx mrm@2 lint-staged
</code></pre>
<h4 id="05-05-代码规范和ESLint-在开发和构建的时候进行验证"><a href="#05-05-代码规范和ESLint-在开发和构建的时候进行验证" class="headerlink" title="05.05 代码规范和ESLint-在开发和构建的时候进行验证"></a>05.05 代码规范和ESLint-在开发和构建的时候进行验证</h4><pre class=" language-shell"><code class="language-shell">npm install eslint vite-plugin-eslint --save-dev
</code></pre>
<pre class=" language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>defineConfig<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vite'</span>
<span class="token keyword">import</span> vue <span class="token keyword">from</span> <span class="token string">'@vitejs/plugin-vue'</span>
<span class="token keyword">import</span> eslint <span class="token keyword">from</span> <span class="token string">'vite-plugin-eslint'</span>

<span class="token comment" spellcheck="true">// https://vitejs.dev/config/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">eslint</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        cache<span class="token punctuation">:</span> <span class="token keyword">false</span> <span class="token comment" spellcheck="true">// 禁用eslint缓存</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="06-06-GitCommit规范"><a href="#06-06-GitCommit规范" class="headerlink" title="06.06 GitCommit规范"></a>06.06 GitCommit规范</h4><p><img src="a862c348.png"><img src="f944606d.png"><img src="de23194c.png"><img src="61690260.png"><img src="88b80c2b.png"><br><img src="9ec205c7.png"><img src="4d329e3c.png"><img src="0c1e0064.png"><img src="03dd621a.png"><img src="2c56d36d.png"><br><img src="aee83ffe.png"><img src="25ef5104.png"><img src="180d6a71.png"><img src="c8caff24.png"><img src="e6c42b28.png"><br><img src="1525d0e2.png"></p>
<pre class=" language-shell"><code class="language-shell">npm i --save-dev @commitlint/config-conventional @commitlint/cli
npx husky add .husky/commit-msg 'npx --no-install commitlint --edit "$1"'
</code></pre>
<h4 id="07-07-Vite中的TS环境说明"><a href="#07-07-Vite中的TS环境说明" class="headerlink" title="07.07 Vite中的TS环境说明"></a>07.07 Vite中的TS环境说明</h4><p><img src="726812bb.png"><img src="71691415.png"></p>
<h4 id="08-08-Vue3中的TS支持"><a href="#08-08-Vue3中的TS支持" class="headerlink" title="08.08 Vue3中的TS支持"></a>08.08 Vue3中的TS支持</h4><p><img src="76ea2504.png"><img src="9c9e1fa7.png"><img src="3ce84ec3.png"><img src="eb556464.png"><img src="650494e9.png"><br><img src="97cb2b8e.png"><img src="43fa9690.png"><img src="29b41e2a.png"><img src="72aa047e.png"><img src="f9f7c009.png"><br><img src="3bb79440.png"><img src="731c82c3.png"><img src="a2fcf891.png"><img src="5de470e7.png"><img src="64a7b5a9.png"><br><img src="55a4ee99.png"><img src="ac1b3b84.png"><img src="399ee347.png"></p>
<h4 id="09-09-Vue3中的script-setup语法"><a href="#09-09-Vue3中的script-setup语法" class="headerlink" title="09.09 Vue3中的script-setup语法"></a>09.09 Vue3中的script-setup语法</h4><p><img src="b0c238b7.png"></p>
<h1 id="04-Part-4-·-React-框架原理与实战"><a href="#04-Part-4-·-React-框架原理与实战" class="headerlink" title="04.Part 4 · React 框架原理与实战"></a>04.Part 4 · React 框架原理与实战</h1><h2 id="03-模块三-React-Hooks、Chakra-UI、组件性能优化、封装组件库"><a href="#03-模块三-React-Hooks、Chakra-UI、组件性能优化、封装组件库" class="headerlink" title="03.模块三 React Hooks、Chakra-UI、组件性能优化、封装组件库"></a>03.模块三 React Hooks、Chakra-UI、组件性能优化、封装组件库</h2><h2 id="04-模块四-React-服务端渲染专题（原生实现、Next-js-集成框架、Gatsby）"><a href="#04-模块四-React-服务端渲染专题（原生实现、Next-js-集成框架、Gatsby）" class="headerlink" title="04.模块四 React 服务端渲染专题（原生实现、Next.js 集成框架、Gatsby）"></a>04.模块四 React 服务端渲染专题（原生实现、Next.js 集成框架、Gatsby）</h2><h3 id="01-任务一：ReactSSR"><a href="#01-任务一：ReactSSR" class="headerlink" title="01.任务一：ReactSSR"></a>01.任务一：ReactSSR</h3><h2 id="05-模块五-React-Redux-Ant-Design-TypeScript-实战"><a href="#05-模块五-React-Redux-Ant-Design-TypeScript-实战" class="headerlink" title="05.模块五 React + Redux + Ant Design + TypeScript 实战"></a>05.模块五 React + Redux + Ant Design + TypeScript 实战</h2><h3 id="01-任务一：基础配置"><a href="#01-任务一：基础配置" class="headerlink" title="01.任务一：基础配置"></a>01.任务一：基础配置</h3><h4 id="01-项目介绍"><a href="#01-项目介绍" class="headerlink" title="01.项目介绍"></a>01.项目介绍</h4><p><img src="2ab27350.png"></p>
<h4 id="02-技术栈介绍"><a href="#02-技术栈介绍" class="headerlink" title="02.技术栈介绍"></a>02.技术栈介绍</h4><p><img src="fedea017.png"></p>
<h4 id="03-安装mongodb数据库软件"><a href="#03-安装mongodb数据库软件" class="headerlink" title="03.安装mongodb数据库软件"></a>03.安装mongodb数据库软件</h4><p><img src="7f6f8372.png"><img src="0352cc61.png"></p>
<h1 id="05-Part-5-·-Node-js-全栈开发"><a href="#05-Part-5-·-Node-js-全栈开发" class="headerlink" title="05.Part 5 · Node.js 全栈开发"></a>05.Part 5 · Node.js 全栈开发</h1><h2 id="01-模块一-Node-js-高级编程（核心模块、模块加载机制）"><a href="#01-模块一-Node-js-高级编程（核心模块、模块加载机制）" class="headerlink" title="01.模块一 Node.js 高级编程（核心模块、模块加载机制）"></a>01.模块一 Node.js 高级编程（核心模块、模块加载机制）</h2><h2 id="02-模块二-NoSQL-数据库（MongoDB、Redis）"><a href="#02-模块二-NoSQL-数据库（MongoDB、Redis）" class="headerlink" title="02.模块二 NoSQL 数据库（MongoDB、Redis）"></a>02.模块二 NoSQL 数据库（MongoDB、Redis）</h2><h2 id="03-模块三-Web-开发框架（Express-与-Koa）"><a href="#03-模块三-Web-开发框架（Express-与-Koa）" class="headerlink" title="03.模块三 Web 开发框架（Express 与 Koa）"></a>03.模块三 Web 开发框架（Express 与 Koa）</h2><h2 id="04-模块四-GraphQL-API-开发"><a href="#04-模块四-GraphQL-API-开发" class="headerlink" title="04.模块四 GraphQL API 开发"></a>04.模块四 GraphQL API 开发</h2><h3 id="01-任务一：GraphQL入门，Scheme和类型"><a href="#01-任务一：GraphQL入门，Scheme和类型" class="headerlink" title="01.任务一：GraphQL入门，Scheme和类型"></a>01.任务一：GraphQL入门，Scheme和类型</h3><p><img src="341d2c15.png"></p>
<h3 id="02-使用GraphQL-j"><a href="#02-使用GraphQL-j" class="headerlink" title="02.使用GraphQL.j"></a>02.使用GraphQL.j</h3><pre class=" language-shell"><code class="language-shell">npm init -y
npm install graphql --save
</code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>graphql<span class="token punctuation">,</span> buildSchema<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'graphql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 1. 使用graphql schema语法构建schema</span>
<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token function">buildSchema</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`
    type Query {
        foo: String
        count: Int
    }
`</span></span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 2. 定义schema的resolver</span>
<span class="token keyword">const</span> rootValue <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'bar'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">123</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 3. 查询</span>
<span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token string">'{ foo }'</span>
<span class="token comment" spellcheck="true">// arg: {schema:xxx, source:xxx, rootValue:xxx}</span>
<span class="token function">graphql</span><span class="token punctuation">(</span><span class="token punctuation">{</span>schema<span class="token punctuation">,</span> source<span class="token punctuation">,</span> rootValue<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
source <span class="token operator">=</span> <span class="token string">'{ foo, count }'</span>
<span class="token comment" spellcheck="true">// arg: {schema:xxx, source:xxx, rootValue:xxx}</span>
<span class="token function">graphql</span><span class="token punctuation">(</span><span class="token punctuation">{</span>schema<span class="token punctuation">,</span> source<span class="token punctuation">,</span> rootValue<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="03-结合Expre服务"><a href="#03-结合Expre服务" class="headerlink" title="03.结合Expre服务"></a>03.结合Expre服务</h3><p><img src="00d0fbb7.png"></p>
<pre class=" language-shell"><code class="language-shell">npm i express express-graphql graphql --save
</code></pre>
<p><img src="04d2b212.png"><img src="0a166db2.png"><img src="53b254e1.png"></p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>graphql<span class="token punctuation">,</span> buildSchema<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'graphql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>graphqlHTTP<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-graphql'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 1. 使用graphql schema语法构建schema</span>
<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token function">buildSchema</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`
    type Query {
        foo: String
        count: Int
    }
`</span></span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 2. 定义schema的resolver</span>
<span class="token keyword">const</span> rootValue <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'bar'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">123</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 3. 挂载graphql中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/graphql'</span><span class="token punctuation">,</span> <span class="token function">graphqlHTTP</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    schema<span class="token punctuation">,</span>
    rootValue<span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 开启浏览器graphql IDE工具</span>
    graphiql<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is running at 4000 port'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="04-客户端"><a href="#04-客户端" class="headerlink" title="04.客户端"></a>04.客户端</h3><pre class=" language-shell"><code class="language-shell">npm i cors
</code></pre>
<pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
    <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// graphql 请求方法必须是post</span>
        method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        url<span class="token punctuation">:</span> <span class="token string">'http://localhost:4000/graphql'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            query<span class="token punctuation">:</span> <span class="token string">'{ foo, count }'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span>graphql<span class="token punctuation">,</span> buildSchema<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'graphql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>graphqlHTTP<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-graphql'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cors'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 跨域</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// ...</span>
</code></pre>
<p><img src="36e3c620.png"></p>
<h3 id="05-Query类型"><a href="#05-Query类型" class="headerlink" title="05.Query类型"></a>05.Query类型</h3><p><img src="3ad1bec0.png"><img src="624f23be.png"><img src="37dd4073.png" alt="query只能有一个"></p>
<h3 id="06-标量类型"><a href="#06-标量类型" class="headerlink" title="06.标量类型"></a>06.标量类型</h3><p><img src="60f8b89b.png"><img src="4951908d.png" alt="如果返回的类型可以转换为定义的类型,也是可以的"></p>
<h3 id="07-对象类型"><a href="#07-对象类型" class="headerlink" title="07.对象类型"></a>07.对象类型</h3><p><img src="24708597.png"><img src="92da050a.png"><img src="54aa5118.png"></p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 1. 使用graphql schema语法构建schema</span>
<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token function">buildSchema</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`
    type Query {
        foo: String
        count: Int
        price: Float
        flag: Boolean
        id: ID
        user: User
        article: Article
    }
    
    type Article {
        title: String
        body: String
        author: User
    }
    
    type User {
        name: String
        age: Int
    }
`</span></span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 2. 定义schema的resolver</span>
<span class="token keyword">const</span> rootValue <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'bar'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">123</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1.5</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"fiklsdrhjfgvierhu"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">'Jack'</span><span class="token punctuation">,</span>
            age<span class="token punctuation">:</span> <span class="token number">18</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">article</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            title<span class="token punctuation">:</span> <span class="token string">'标题'</span><span class="token punctuation">,</span>
            body<span class="token punctuation">:</span> <span class="token string">'内容'</span><span class="token punctuation">,</span>
            author<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                name<span class="token punctuation">:</span> <span class="token string">'Jack'</span><span class="token punctuation">,</span>
                age<span class="token punctuation">:</span> <span class="token number">18</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre>
<h3 id="08-数组类型"><a href="#08-数组类型" class="headerlink" title="08.数组类型"></a>08.数组类型</h3><h1 id="06-Part-6-·-泛客户端开发"><a href="#06-Part-6-·-泛客户端开发" class="headerlink" title="06.Part 6 · 泛客户端开发"></a>06.Part 6 · 泛客户端开发</h1><h1 id="07-Part-7-·-商业技术解决方案与高阶技术专题"><a href="#07-Part-7-·-商业技术解决方案与高阶技术专题" class="headerlink" title="07.Part 7 · 商业技术解决方案与高阶技术专题"></a>07.Part 7 · 商业技术解决方案与高阶技术专题</h1><h2 id="01-模块一-微前端解决方案"><a href="#01-模块一-微前端解决方案" class="headerlink" title="01.模块一 微前端解决方案"></a>01.模块一 微前端解决方案</h2><h2 id="02-模块二-前端自动化测试专题"><a href="#02-模块二-前端自动化测试专题" class="headerlink" title="02.模块二 前端自动化测试专题"></a>02.模块二 前端自动化测试专题</h2><h2 id="03-模块三-前端数据可视化专题"><a href="#03-模块三-前端数据可视化专题" class="headerlink" title="03.模块三 前端数据可视化专题"></a>03.模块三 前端数据可视化专题</h2><h2 id="04-模块四-前端性能优化专题"><a href="#04-模块四-前端性能优化专题" class="headerlink" title="04.模块四 前端性能优化专题"></a>04.模块四 前端性能优化专题</h2><h3 id="01-任务一"><a href="#01-任务一" class="headerlink" title="01.任务一"></a>01.任务一</h3><h4 id="01-性能优化介绍"><a href="#01-性能优化介绍" class="headerlink" title="01.性能优化介绍"></a>01.性能优化介绍</h4><p><img src="91466b61.png"><img src="7e3d9fd8.png"><img src="c0a964fc.png"><img src="c09486e4.png"><img src="018bd2cb.png"><br><img src="ea148b69.png"><img src="6bb35d30.png"><img src="ed37f966.png"><img src="1b562ee6.png"><img src="fc5b1151.png"><br><img src="e04aa4f0.png"><img src="765c48c8.png"><img src="6f22a71b.png"></p>
<h4 id="02-Web性能指标介绍"><a href="#02-Web性能指标介绍" class="headerlink" title="02.Web性能指标介绍"></a>02.Web性能指标介绍</h4><p><img src="a1b80f03.png"><img src="1ae36d38.png"><img src="e758f0de.png"><img src="8c6f14d6.png"><img src="23b1bae5.png"></p>
<h4 id="03-RAIL性能模型"><a href="#03-RAIL性能模型" class="headerlink" title="03.RAIL性能模型"></a>03.RAIL性能模型</h4>
            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff;
        background-color: #22AB38;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff;
        background-color: #019FE8;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs">
                        <li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li>
                        <li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('#reward .reward-link').on('click', function () {
            $('#rewardModal').openModal();
        });

        $('#rewardModal .close').on('click', function () {
            $('#rewardModal').closeModal();
        });
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://malred.github.io" class="b-link-green">malred-blog</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2023/10/06/frontend/la-gou-da-qian-duan-gao-xin-xun-lian-ying/zzzz/" class="b-link-green">拉勾大前端高薪训练营</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '676b06df8b7379e50e35',
        clientSecret: '9159b4de0f716ba7bdab9bc02151a90e6961246b',
        repo: 'comment_repo',
        owner: 'malred',
        admin: "malred",
        id: '2023-10-06T20-20-51',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    
        <link rel="stylesheet" href="/libs/gitment/gitment-default.css">
<link rel="stylesheet" href="/css/gitment.css">

<div class="gitment-card card" data-aos="fade-up">
    <div id="gitment-content" class="card-content"></div>
</div>

<script src="/libs/gitment/gitment.js"></script>
<script>
var gitment = new Gitment({
    id: 'Fri Oct 06 2023 20:20:51 GMT+0800',
    owner: 'malred',
    repo: 'comment_repo',
    oauth: {
        client_id: '676b06df8b7379e50e35',
        client_secret: '9159b4de0f716ba7bdab9bc02151a90e6961246b'
    }
});

gitment.render('gitment-content');
</script>
    

    
        <div class="disqus-card card" data-aos="fade-up">
    <div id="disqus_thread" class="card-content">
        <noscript>Please enable JavaScript to view the
            <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
    </div>
</div>

<script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://malred.github.io/2023/10/06/frontend/la-gou-da-qian-duan-gao-xin-xun-lian-ying/zzzz/';
        this.page.identifier = '/2023/10/06/frontend/la-gou-da-qian-duan-gao-xin-xun-lian-ying/zzzz/';
        this.page.title = '拉勾大前端高薪训练营';
    };
    let disqus_shortname = '';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://blinkfox.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'mipjlux8dRwbE7yY1zP3v13z-gzGzoHsz',
        appKey: 'cIy0pwvRAK8cuOCZRjuoHHfy',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '留下友善的评论~'
    });
</script>
    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/10/07/frontend/vue/mksz608-vue3-yuan-ma-jie-xi-da-zao-zi-ji-de-vue3-kuang-jia/zzzz/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="mksz608-Vue3源码解析，打造自己的Vue3框架">
                        
                        <span class="card-title">mksz608-Vue3源码解析，打造自己的Vue3框架</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">第1章 课程导读
第2章 框架设计前瞻 - 框架设计中的一些基本概念2-1前言
2-2编程范式之命令式编程
&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;head>
    &lt;meta char</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2023-10-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/vue/" class="post-category" target="_blank">
                                    vue
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/vue/" target="_blank">
                        <span class="chip bg-color">vue</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/10/06/frontend/flutter/mksz583-ji-yu-flutter3-shi-zhan-kua-ping-tai-duan-shi-pin-app-hun-he-kai-fa-wan-jie/zzzzzzzz/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="mksz583-基于Flutter3.x实战跨平台短视频App混合开发[完结]">
                        
                        <span class="card-title">mksz583-基于Flutter3.x实战跨平台短视频App混合开发[完结]</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">{1}–第1章课程介绍与学习指南
{2}–第2章Flutter整体介绍2-1Flutter技术发展概览
2-2Flutter技术发展概览
2-3Flutter技术发展概览
2-4Flutter的整体框架结构介绍
2-5为什么选择Dart语言</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2023-10-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/flutter/" class="post-category" target="_blank">
                                    flutter
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/flutter/" target="_blank">
                        <span class="chip bg-color">flutter</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站由&copy;<a href="https://blinkfox.github.io/" target="_blank">Blinkfox</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">621.1k</span>
            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/malred" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:malguy2022@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2725953379" class="tooltipped" data-tooltip="QQ联系我: 2725953379" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<!--动态线条背景-->
<script type="text/javascript" color="122 103 238" opacity='0.7' zIndex="-2" count="200"
    src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
<script src="/js/matery.js"></script>
<script src="/js/snow.js"></script>

<!-- 引用Aplayer和metingjs -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script>
<div id="my-aplayer" class="aplayer" data-id="7363940489" data-server="netease" data-type="playlist" data-fixed="true"
    // 吸底模式可以固定播放器于页面底部 data-autoplay="true" data-order="list" data-volume="0.55" data-theme="#cc543a"
    data-preload="auto"></div>  
<!-- <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script> -->
<!-- <script src="https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<script>
    // 对所有链接跳转事件绑定pjax容器container
    $(document).pjax('a[target!=_blank]', '.container', { fragment: '.container', timeout: 8000 })
</script> -->


<!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-MSEYRC5EW5"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-MSEYRC5EW5');
</script>



    <script src="/libs/others/clicklove.js"></script>


    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>