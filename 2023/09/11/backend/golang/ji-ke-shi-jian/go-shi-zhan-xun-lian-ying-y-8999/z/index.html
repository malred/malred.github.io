<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Go 实战训练营, HTML,CSS,React,Vue,Java,Go,微服务,linux">
    <meta name="description" content="07 第一周：Web 框架之 Server 与路由树1. Web 框架概览：学习路线
2. Web 框架概览：Beego 框架分析
package beego

import &#34;github.com/beego/beego/v2/serve">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Go 实战训练营 | malred-blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/logo.png" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">malred-blog</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">malred-blog</div>
        <div class="logo-desc">
            
            前后端学习者,存放知识笔记
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
    </ul>

    <div class="social-link">
    <a href="https://github.com/malred" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:malguy2022@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2725953379" class="tooltipped" data-tooltip="QQ联系我: 2725953379" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
</div>

            </div>
        </div>

        
    </nav>
</header>


<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Go 实战训练营
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/golang/" target="_blank">
                                <span class="chip bg-color">golang</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/golang/" class="post-category" target="_blank">
                                golang
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-09-11
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        30.6k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        172 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="07-第一周：Web-框架之-Server-与路由树"><a href="#07-第一周：Web-框架之-Server-与路由树" class="headerlink" title="07 第一周：Web 框架之 Server 与路由树"></a>07 第一周：Web 框架之 Server 与路由树</h1><h2 id="1-Web-框架概览：学习路线"><a href="#1-Web-框架概览：学习路线" class="headerlink" title="1. Web 框架概览：学习路线"></a>1. Web 框架概览：学习路线</h2><p><img src="20230911194912.png"></p>
<h2 id="2-Web-框架概览：Beego-框架分析"><a href="#2-Web-框架概览：Beego-框架分析" class="headerlink" title="2. Web 框架概览：Beego 框架分析"></a>2. Web 框架概览：Beego 框架分析</h2><p><img src="20230911203113.png"><br><img src="20230911204118.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> beego

<span class="token keyword">import</span> <span class="token string">"github.com/beego/beego/v2/server/web"</span>

<span class="token keyword">type</span> UserController <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    web<span class="token punctuation">.</span>Controller
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>UserController<span class="token punctuation">)</span> <span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"你好，我是malred"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>UserController<span class="token punctuation">)</span> <span class="token function">CreateUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    u <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">BindJSON</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token boolean">_</span> <span class="token operator">=</span> c<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">JSONResp</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> beego

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/beego/beego/v2/server/web"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestUserController</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 这个配置是beego独有的</span>
    web<span class="token punctuation">.</span>BConfig<span class="token punctuation">.</span>CopyRequestBody <span class="token operator">=</span> <span class="token boolean">true</span>
    c <span class="token operator">:=</span> <span class="token operator">&amp;</span>UserController<span class="token punctuation">{</span><span class="token punctuation">}</span>
    web<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token string">"get:GetUser"</span><span class="token punctuation">)</span>
    web<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230911204225.png"><br><img src="20230911204333.png"><br><img src="20230911205127.png"></p>
<blockquote>
<p>作者认为可以将 response 放入 output，request 放入 input</p>
</blockquote>
<p><img src="20230911205140.png"><br><img src="20230911205331.png"></p>
<blockquote>
<p>不同 server 之间是隔离的</p>
</blockquote>
<p><img src="20230911205410.png"></p>
<h2 id="3-Web-框架概览：Gin-框架分析"><a href="#3-Web-框架概览：Gin-框架分析" class="headerlink" title="3. Web 框架概览：Gin 框架分析"></a>3. Web 框架概览：Gin 框架分析</h2><p><img src="20230911210834.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> gin

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> UserController <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>UserController<span class="token punctuation">)</span> <span class="token function">GetUser</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> gin

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"testing"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestUserController_GetUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    g <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    ctrl <span class="token operator">:=</span> <span class="token operator">&amp;</span>UserController<span class="token punctuation">{</span><span class="token punctuation">}</span>
    g<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> ctrl<span class="token punctuation">.</span>GetUser<span class="token punctuation">)</span>
    g<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"hello %s"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    g<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/static"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 读文件</span>
        <span class="token comment" spellcheck="true">// 写响应</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8082"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>handle 接口是核心，作者认为没必要将 static 放入核心接口里，而是可以提供一个实现</p>
</blockquote>
<p><img src="20230911210909.png"><br><img src="20230911211140.png"><br><img src="20230911211239.png"><br><img src="20230911211359.png"><br><img src="20230911211416.png"><br><img src="20230911211424.png"><br><img src="20230911211507.png"><br><img src="20230911211538.png"></p>
<h2 id="4-Web-框架概览：Iris-框架分析"><a href="#4-Web-框架概览：Iris-框架分析" class="headerlink" title="4. Web 框架概览：Iris 框架分析"></a>4. Web 框架概览：Iris 框架分析</h2><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// v12版本需要go1.21</span>
<span class="token keyword">package</span> iris

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/kataras/iris/v12"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestHelloWorld</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app <span class="token operator">:=</span> iris<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx iris<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span><span class="token string">"hello &lt;strong>%s&lt;/strong>!"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">":8083"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230911212541.png"><br><img src="20230911212519.png"><br><img src="20230911212558.png"><br><img src="20230911212612.png"><br><img src="20230911212735.png"><br><img src="20230911212742.png"></p>
<h2 id="5-Web-框架概览：Echo-框架分析与对比总结"><a href="#5-Web-框架概览：Echo-框架分析与对比总结" class="headerlink" title="5. Web 框架概览：Echo 框架分析与对比总结"></a>5. Web 框架概览：Echo 框架分析与对比总结</h2><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> echo

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/labstack/echo/v4"</span>
    <span class="token string">"github.com/labstack/echo/v4/middleware"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestHelloWorld</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// echo instance</span>
    e <span class="token operator">:=</span> echo<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// Middleware</span>
    e<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    e<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span><span class="token function">Recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// Routers</span>
    e<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// Start server</span>
    e<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8084"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Handle</span>
<span class="token keyword">func</span> <span class="token function">hello</span><span class="token punctuation">(</span>c echo<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>作者认为要做隔离就再弄一个 echo 对象，而不是在一个 echo 里放 namespace 和普通 route</p>
</blockquote>
<p><img src="20230911213401.png"><br><img src="20230911213519.png"><br><img src="20230911213611.png"><br><img src="20230911213617.png"></p>
<h2 id="6-Server-详解与面试要点"><a href="#6-Server-详解与面试要点" class="headerlink" title="6. Server 详解与面试要点"></a>6. Server 详解与面试要点</h2><p><img src="20230911213628.png"><br><img src="20230911213643.png"></p>
<p><img src="20230911215720.png"><br><img src="20230911215733.png"><br><img src="20230911215850.png"><br><img src="20230911220059.png"><br><img src="20230911220514.png"><br><img src="20230911221441.png"></p>
<blockquote>
<p>既然有路由管理功能，就得有路由注册的功能</p>
</blockquote>
<p><img src="20230911221831.png"><br><img src="20230911221953.png"><br><img src="20230911222037.png"><br><img src="20230911222414.png"><br><img src="20230912091242.png"><br><img src="20230912091917.png"><br><img src="20230912092153.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// context.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token string">"net/http"</span>

<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Req  <span class="token operator">*</span>http<span class="token punctuation">.</span>Request
    Resp http<span class="token punctuation">.</span>ResponseWriter
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server_test.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"net/http"</span>
    <span class="token boolean">_</span> <span class="token string">"net/http"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestServer</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    h <span class="token operator">:=</span> <span class="token operator">&amp;</span>HTTPServer<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// NewServer</span>

    h<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    handler1 <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    handler2 <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 使用注册一个的也能实现</span>
    h<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handler1</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token function">handler2</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// h:=&amp;HTTPServer{} 才有该方法</span>
    h<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// h.AddRoutes(</span>
    <span class="token comment" spellcheck="true">//     http.MethodGet, "/user", handler1, handler2,</span>
    <span class="token comment" spellcheck="true">// )</span>

    <span class="token comment" spellcheck="true">// 用法1 完全委托给http包</span>
    <span class="token comment" spellcheck="true">// 第二个参数 handler 是我们框架和http包的结合点</span>
    <span class="token comment" spellcheck="true">// http.ListenAndServe(":8081", h)</span>
    <span class="token comment" spellcheck="true">// http.ListenAndServeTLS(":443", "", "", h)</span>

    <span class="token comment" spellcheck="true">// 用法2 自己手动管理</span>
    h<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"net"</span>
    <span class="token string">"net/http"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> HandleFunc <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 确保HTTPServer结构体一定实现了Server</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> Server <span class="token operator">=</span> <span class="token operator">&amp;</span>HTTPServer<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> Server <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span>Handler
    <span class="token function">Start</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token comment" spellcheck="true">// StartHttp() error</span>

    <span class="token comment" spellcheck="true">// AddRoute 需要增加路由注册的功能</span>
    <span class="token comment" spellcheck="true">// method 请求方法</span>
    <span class="token comment" spellcheck="true">// path 路由</span>
    <span class="token comment" spellcheck="true">// handleFunc 业务逻辑</span>
    <span class="token function">AddRoute</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 注册多个(没必要提供，用户可以自己根据AddRoute实现)</span>
    <span class="token comment" spellcheck="true">// AddRoutes(method string, path string, handleFunc ...HandleFunc)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// type HTTPSServer struct {</span>
<span class="token comment" spellcheck="true">//     HTTPServer // 装饰HTTPServer</span>
<span class="token comment" spellcheck="true">// }</span>

<span class="token keyword">type</span> HTTPServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// addr string // 可以创建时传递，而不是通过start传，也是可以的</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// http.Handler的接口</span>
<span class="token comment" spellcheck="true">// 核心方法 处理请求的入口</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 框架代码</span>
    ctx <span class="token operator">:=</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">{</span>
        Req<span class="token punctuation">:</span>  req<span class="token punctuation">,</span>
        Resp<span class="token punctuation">:</span> w<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 接下来就是查找路由并执行命中的业务逻辑</span>
    h<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">serve</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 也可以自己创建server</span>
    <span class="token comment" spellcheck="true">// http.Server{}</span>
    l<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 在这里可以让用户注册 after、start 等回调(生命周期)</span>
    <span class="token comment" spellcheck="true">// 比如往 admin 注册这个实例</span>
    <span class="token comment" spellcheck="true">// 或者执行一些业务所需的前置条件</span>

    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">AddRoute</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 注册到路由树</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"implement me"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 接口定义的东西尽量简洁</span>
<span class="token comment" spellcheck="true">// 提供多种实现</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handleFunc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">Post</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handleFunc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPut<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handleFunc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">Patch</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPatch<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handleFunc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    h<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodDelete<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handleFunc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// func (h *HTTPServer) AddRoutes(method string, path string, handleFunc ...HandleFunc) {</span>
<span class="token comment" spellcheck="true">//     panic("implement me")</span>
<span class="token comment" spellcheck="true">// }</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">StartHttp</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230912092624.png"></p>
<h2 id="7-路由树：Beego、Gin、Echo-实现与设计总结"><a href="#7-路由树：Beego、Gin、Echo-实现与设计总结" class="headerlink" title="7. 路由树：Beego、Gin、Echo 实现与设计总结"></a>7. 路由树：Beego、Gin、Echo 实现与设计总结</h2><p><img src="20230912101625.png"><br><img src="20230912102131.png"><br><img src="20230912102153.png"><br><img src="20230912102833.png"><br><img src="20230912103924.png"><br><img src="20230912104129.png"><br><img src="20230912104156.png"></p>
<blockquote>
<p>gin 路由树的复杂在于要找最长公共前缀，然后重构树</p>
</blockquote>
<h2 id="8-路由树：全静态匹配"><a href="#8-路由树：全静态匹配" class="headerlink" title="8. 路由树：全静态匹配"></a>8. 路由树：全静态匹配</h2><p><img src="20230912104536.png"><br><img src="20230912104625.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router.go</span>
<span class="token keyword">package</span> web

<span class="token comment" spellcheck="true">// 用来支持对路由树的操作</span>
<span class="token comment" spellcheck="true">// 代表路由树（森林）</span>
<span class="token keyword">type</span> router <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Beego Gin HTTP method 对应一棵树</span>
    <span class="token comment" spellcheck="true">// GET 一颗，POST 一颗 ……</span>

    <span class="token comment" spellcheck="true">// http method => 路由树根节点</span>
    trees <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// type tree struct {</span>
<span class="token comment" spellcheck="true">//     root *node</span>
<span class="token comment" spellcheck="true">// }</span>

<span class="token keyword">func</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>router <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>router<span class="token punctuation">{</span>
        trees<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token function">AddRoute</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 注册到路由树</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"implement me"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    path <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// path => 子节点</span>
    children <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node
    <span class="token comment" spellcheck="true">// 需要一个代表用户注册的业务逻辑</span>
    handler HandleFunc
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"net"</span>
    <span class="token string">"net/http"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> HandleFunc <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 确保HTTPServer结构体一定实现了Server</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> Server <span class="token operator">=</span> <span class="token operator">&amp;</span>HTTPServer<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> Server <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span>Handler
    <span class="token function">Start</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token comment" spellcheck="true">// StartHttp() error</span>

    <span class="token comment" spellcheck="true">// AddRoute 需要增加路由注册的功能</span>
    <span class="token comment" spellcheck="true">// method 请求方法</span>
    <span class="token comment" spellcheck="true">// path 路由</span>
    <span class="token comment" spellcheck="true">// handleFunc 业务逻辑</span>
    <span class="token function">AddRoute</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 注册多个(没必要提供，用户可以自己根据AddRoute实现)</span>
    <span class="token comment" spellcheck="true">// AddRoutes(method string, path string, handleFunc ...HandleFunc)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// type HTTPSServer struct {</span>
<span class="token comment" spellcheck="true">//     HTTPServer // 装饰HTTPServer</span>
<span class="token comment" spellcheck="true">// }</span>

<span class="token keyword">type</span> HTTPServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// addr string // 可以创建时传递，而不是通过start传，也是可以的</span>
    <span class="token comment" spellcheck="true">// router</span>
    <span class="token operator">*</span>router <span class="token comment" spellcheck="true">// 因为router实现了AddRoute，所以也可以通过编译</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 初始化server</span>
<span class="token keyword">func</span> <span class="token function">NewHTTPServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>HTTPServer <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>HTTPServer<span class="token punctuation">{</span>
        router<span class="token punctuation">:</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// func (h *HTTPServer) AddRoute(method string, path string, handleFunc HandleFunc) {</span>
<span class="token comment" spellcheck="true">//     // 注册到路由树</span>
<span class="token comment" spellcheck="true">//     panic("implement me")</span>
<span class="token comment" spellcheck="true">// }</span>

<span class="token comment" spellcheck="true">// ...</span>
</code></pre>
<h2 id="9-路由树：TDD-起步"><a href="#9-路由树：TDD-起步" class="headerlink" title="9. 路由树：TDD 起步"></a>9. 路由树：TDD 起步</h2><p><img src="20230912111442.png"><br><img src="20230912191928.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token string">"strings"</span>

<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token function">AddRoute</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 注册到路由树</span>
    root<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 说明还没有根节点</span>
        root <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
            path<span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 处理方法</span>
        r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> root
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// /user/home -> 会被切成3段</span>
    path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// /user -> user</span>
    <span class="token comment" spellcheck="true">// 切割这个 path</span>
    segs <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> seg <span class="token operator">:=</span> <span class="token keyword">range</span> segs <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 递归下去, 中途有节点不存在就创建</span>
        children <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">childOrCreate</span><span class="token punctuation">(</span>seg<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// root向下(深)走</span>
        root <span class="token operator">=</span> children
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 前面root已经走到/user/home, 所以这里添加处理方法</span>
    <span class="token comment" spellcheck="true">// 是对/user/home的处理</span>
    root<span class="token punctuation">.</span>handler <span class="token operator">=</span> handleFunc
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">childOrCreate</span><span class="token punctuation">(</span>seg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>node <span class="token punctuation">{</span>
    <span class="token keyword">if</span> n<span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>seg<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 新建</span>
        res <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
            path<span class="token punctuation">:</span> seg<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>seg<span class="token punctuation">]</span> <span class="token operator">=</span> res
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token keyword">type</span> node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router_test.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"testing"</span>

    <span class="token string">"github.com/stretchr/testify/assert"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestRouter_AddRoute</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. 构造路由树</span>
    testRoutes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/user/home"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> mockHandler HandleFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    r <span class="token operator">:=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> testRoutes <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>method<span class="token punctuation">,</span> route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2. 验证路由树</span>
    wantRouter <span class="token operator">:=</span> <span class="token operator">&amp;</span>router<span class="token punctuation">{</span>
        trees<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
            http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
                children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                    <span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                        path<span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
                        children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                            <span class="token string">"home"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                                path<span class="token punctuation">:</span>    <span class="token string">"home"</span><span class="token punctuation">,</span>
                                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    msg<span class="token punctuation">,</span> ok <span class="token operator">:=</span> wantRouter<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token function">equal</span><span class="token punctuation">(</span>y <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>trees <span class="token punctuation">{</span>
        dst<span class="token punctuation">,</span> ok <span class="token operator">:=</span> y<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"找不到对应的 http method"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        msg<span class="token punctuation">,</span> equal <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>equal <span class="token punctuation">{</span>
            <span class="token keyword">return</span> msg<span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">equal</span><span class="token punctuation">(</span>y <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> n<span class="token punctuation">.</span>path <span class="token operator">!=</span> y<span class="token punctuation">.</span>path <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"节点路径不匹配"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"子节点数量不相等"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 比较handler</span>
    nHandler <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>handler<span class="token punctuation">)</span>
    yHandler <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>handler<span class="token punctuation">)</span>
    <span class="token keyword">if</span> nHandler <span class="token operator">!=</span> yHandler <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"handler 不相等"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> path<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> n<span class="token punctuation">.</span>children <span class="token punctuation">{</span>
        dst<span class="token punctuation">,</span> ok <span class="token operator">:=</span> y<span class="token punctuation">.</span>children<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"子节点 %s 不存在"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        msg<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> msg<span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="10-路由树：静态匹配测试用例"><a href="#10-路由树：静态匹配测试用例" class="headerlink" title="10. 路由树：静态匹配测试用例"></a>10. 路由树：静态匹配测试用例</h2><p><img src="20230912204614.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router_test.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"testing"</span>

    <span class="token string">"github.com/stretchr/testify/assert"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestRouter_addRoute</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. 构造路由树</span>
    testRoutes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/user"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/user/home"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/detail"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/create"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/login"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// {</span>
        <span class="token comment" spellcheck="true">//     method: http.MethodPost,</span>
        <span class="token comment" spellcheck="true">//     path:   "login",</span>
        <span class="token comment" spellcheck="true">// },</span>
        <span class="token comment" spellcheck="true">// {</span>
        <span class="token comment" spellcheck="true">//     method: http.MethodPost,</span>
        <span class="token comment" spellcheck="true">//     path:   "login////",</span>
        <span class="token comment" spellcheck="true">// },</span>
        <span class="token comment" spellcheck="true">// {</span>
        <span class="token comment" spellcheck="true">//     method: http.MethodPost,</span>
        <span class="token comment" spellcheck="true">//     path:   "//login//a//b",</span>
        <span class="token comment" spellcheck="true">// },</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> mockHandler HandleFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    r <span class="token operator">:=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> testRoutes <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>method<span class="token punctuation">,</span> route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2. 验证路由树</span>
    wantRouter <span class="token operator">:=</span> <span class="token operator">&amp;</span>router<span class="token punctuation">{</span>
        trees<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
            http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                path<span class="token punctuation">:</span>    <span class="token string">"/"</span><span class="token punctuation">,</span>
                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                    <span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                        path<span class="token punctuation">:</span>    <span class="token string">"user"</span><span class="token punctuation">,</span>
                        handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                        children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                            <span class="token string">"home"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                                path<span class="token punctuation">:</span>    <span class="token string">"home"</span><span class="token punctuation">,</span>
                                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"order"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                        path<span class="token punctuation">:</span> <span class="token string">"order"</span><span class="token punctuation">,</span>
                        children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                            <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                                path<span class="token punctuation">:</span>    <span class="token string">"detail"</span><span class="token punctuation">,</span>
                                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
                children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                    <span class="token string">"order"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                        path<span class="token punctuation">:</span> <span class="token string">"order"</span><span class="token punctuation">,</span>
                        children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                            <span class="token string">"create"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                                path<span class="token punctuation">:</span>    <span class="token string">"create"</span><span class="token punctuation">,</span>
                                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"login"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                        path<span class="token punctuation">:</span>    <span class="token string">"login"</span><span class="token punctuation">,</span>
                        handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    msg<span class="token punctuation">,</span> ok <span class="token operator">:=</span> wantRouter<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>

    r <span class="token operator">=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Panics</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"web: 路径不能为空字符串"</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Panics</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/a/b/c/"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"web: 路径必须以 / 结尾"</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Panics</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"a/b"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"web: 路径必须以 / 开头"</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Panics</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> "a<span class="token comment" spellcheck="true">//b", mockHandler)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"web: 不能有连续的 /"</span><span class="token punctuation">)</span>

    r <span class="token operator">=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Panics</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"web: 路由冲突, 重复注册: [/]"</span><span class="token punctuation">)</span>

    r <span class="token operator">=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/user/home"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Panics</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/user/home"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"web: 路由冲突, 重复注册: [/user/home]"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token function">equal</span><span class="token punctuation">(</span>y <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">equal</span><span class="token punctuation">(</span>y <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 用来支持对路由树的操作</span>
<span class="token comment" spellcheck="true">// 代表路由树（森林）</span>
<span class="token keyword">type</span> router <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Beego Gin HTTP method 对应一棵树</span>
    <span class="token comment" spellcheck="true">// GET 一颗，POST 一颗 ……</span>

    <span class="token comment" spellcheck="true">// http method => 路由树根节点</span>
    trees <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// type tree struct {</span>
<span class="token comment" spellcheck="true">//     root *node</span>
<span class="token comment" spellcheck="true">// }</span>

<span class="token keyword">func</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>router <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 加一些限制:</span>
<span class="token comment" spellcheck="true">// path 必须以 / 开头, 不能以 / 结尾, 中间不能有连续的 //</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"web: 路径不能为空字符串"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 注册到路由树</span>
    root<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 说明还没有根节点</span>
        root <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
            path<span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 处理方法</span>
        r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> root
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 根节点特殊处理</span>
    <span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">"/"</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> root<span class="token punctuation">.</span>handler <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 根节点重复注册</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"web: 路由冲突, 重复注册: [/]"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        root<span class="token punctuation">.</span>handler <span class="token operator">=</span> handleFunc
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 开头不能没有 /</span>
    <span class="token keyword">if</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"web: 路径必须以 / 开头"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 结尾</span>
    <span class="token keyword">if</span> path <span class="token operator">!=</span> <span class="token string">"/"</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"web: 路径不能以 / 结尾"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 中间连续 //, 可以用string.contains("//")</span>

    <span class="token comment" spellcheck="true">// /user/home -> 会被切成3段</span>
    path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// /user -> user</span>
    <span class="token comment" spellcheck="true">// 切割这个 path</span>
    segs <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> seg <span class="token operator">:=</span> <span class="token keyword">range</span> segs <span class="token punctuation">{</span>
        <span class="token keyword">if</span> seg <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"web: 不能有连续的 /"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 递归下去, 中途有节点不存在就创建</span>
        children <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">childOrCreate</span><span class="token punctuation">(</span>seg<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// root向下(深)走</span>
        root <span class="token operator">=</span> children
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 前面root已经走到/user/home, 所以这里添加处理方法</span>
    <span class="token comment" spellcheck="true">// 是对/user/home的处理</span>
    <span class="token keyword">if</span> root<span class="token punctuation">.</span>handler <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 普通路由重复注册</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"web: 路由冲突, 重复注册: [/%s]"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    root<span class="token punctuation">.</span>handler <span class="token operator">=</span> handleFunc
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">childOrCreate</span><span class="token punctuation">(</span>seg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>node <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230912205259.png"></p>
<blockquote>
<p>将 AddRoute 首字母小写，则变成私有方法，只能用我们暴露的 Get、Post 等方法注册，就不用担心 method 传乱七八糟的字符串</p>
</blockquote>
<blockquote>
<p>而 handler 如果为 nil，则表示根本没注册，一般用户不会这样</p>
</blockquote>
<h2 id="11-路由树：静态匹配之路由查找"><a href="#11-路由树：静态匹配之路由查找" class="headerlink" title="11. 路由树：静态匹配之路由查找"></a>11. 路由树：静态匹配之路由查找</h2><p><img src="20230915160942.png"><br><img src="20230915162037.png"><br><img src="20230915162837.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router_test.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"testing"</span>

    <span class="token string">"github.com/stretchr/testify/assert"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestRouter_findRoute</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testRoutes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodDelete<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/user"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/user/home"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/detail"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/create"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/login"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> mockHandler HandleFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> testRoutes <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>method<span class="token punctuation">,</span> route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>

        wantFound <span class="token builtin">bool</span>
        wantNode  <span class="token operator">*</span>node
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// method不存在</span>
            name<span class="token punctuation">:</span>   <span class="token string">"method not found"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodOptions<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/detail"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 完全命中</span>
            name<span class="token punctuation">:</span>      <span class="token string">"order detail"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/order/detail"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            wantNode<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                path<span class="token punctuation">:</span>    <span class="token string">"detail"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 命中了，但是没有handler</span>
            name<span class="token punctuation">:</span>      <span class="token string">"order"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/order"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            wantNode<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">"order"</span><span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">// order/detail注册的child -> detail</span>
                children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                    <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                        handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                        path<span class="token punctuation">:</span>    <span class="token string">"detail"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 根节点</span>
            name<span class="token punctuation">:</span>      <span class="token string">"root"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodDelete<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            wantNode<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                path<span class="token punctuation">:</span>    <span class="token string">"/"</span><span class="token punctuation">,</span>
                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"path not found"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/404"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            n<span class="token punctuation">,</span> found <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">findRoute</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>method<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantFound<span class="token punctuation">,</span> found<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            msg<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tc<span class="token punctuation">.</span>wantNode<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ...</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token function">findRoute</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 沿着树深度查找下去</span>
    root<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 根节点</span>
    <span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">"/"</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> root<span class="token punctuation">,</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 把path前后的 / 去掉</span>
    path <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 按照 / 切割</span>
    segs <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> seg <span class="token operator">:=</span> <span class="token keyword">range</span> segs <span class="token punctuation">{</span>
        child<span class="token punctuation">,</span> found <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">childOf</span><span class="token punctuation">(</span>seg<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        root <span class="token operator">=</span> child
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 表示有该节点，但是不一定有handler</span>
    <span class="token keyword">return</span> root<span class="token punctuation">,</span> <span class="token boolean">true</span>
    <span class="token comment" spellcheck="true">// return root, root.handler != nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 找到对应child</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">childOf</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> n<span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    child<span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
    <span class="token keyword">return</span> child<span class="token punctuation">,</span> ok
<span class="token punctuation">}</span>
</code></pre>
<h2 id="12-路由树：静态匹配之集成-Server【更多-IT-资料加微信-djy136928775638】"><a href="#12-路由树：静态匹配之集成-Server【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="12. 路由树：静态匹配之集成 Server【更多 IT 资料加微信 djy136928775638】"></a>12. 路由树：静态匹配之集成 Server【更多 IT 资料加微信 djy136928775638】</h2><p><img src="20230915175853.png"><br><img src="20230915180938.png"><br><img src="20230915180813.png"><br><img src="20230915180952.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">serve</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    n<span class="token punctuation">,</span> ok <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">findRoute</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> n<span class="token punctuation">.</span>handler <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 路由没命中，404</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"NOT FOUND"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    n<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="13-路由树：通配符匹配之路由注册【更多-IT-资料加微信-djy136928775638】"><a href="#13-路由树：通配符匹配之路由注册【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="13. 路由树：通配符匹配之路由注册【更多 IT 资料加微信 djy136928775638】"></a>13. 路由树：通配符匹配之路由注册【更多 IT 资料加微信 djy136928775638】</h2><p><img src="20230917213639.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router_test.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"testing"</span>

    <span class="token string">"github.com/stretchr/testify/assert"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestRouter_addRoute</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. 构造路由树</span>
    testRoutes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// {</span>
        <span class="token comment" spellcheck="true">//     method: http.MethodGet,</span>
        <span class="token comment" spellcheck="true">//     path:   "</span><span class="token comment" spellcheck="true">/*",
        // },
        // {
        //     method: http.MethodGet,
        //     path:   "/*/</span><span class="token operator">*</span>"<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// },</span>
        <span class="token comment" spellcheck="true">// {</span>
        <span class="token comment" spellcheck="true">//     method: http.MethodGet,</span>
        <span class="token comment" spellcheck="true">//     path:   "</span><span class="token comment" spellcheck="true">/*/abc/*",
        // },
        // {
        //     method: http.MethodGet,
        //     path:   "/*/</span>abc"<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// },</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/*"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> mockHandler HandleFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    r <span class="token operator">:=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> testRoutes <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>method<span class="token punctuation">,</span> route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2. 验证路由树</span>
    wantRouter <span class="token operator">:=</span> <span class="token operator">&amp;</span>router<span class="token punctuation">{</span>
        trees<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
            http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                path<span class="token punctuation">:</span>    <span class="token string">"/"</span><span class="token punctuation">,</span>
                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                    <span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                        path<span class="token punctuation">:</span>    <span class="token string">"user"</span><span class="token punctuation">,</span>
                        handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                        children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                            <span class="token string">"home"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                                path<span class="token punctuation">:</span>    <span class="token string">"home"</span><span class="token punctuation">,</span>
                                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"order"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                        path<span class="token punctuation">:</span> <span class="token string">"order"</span><span class="token punctuation">,</span>
                        children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                            <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                                path<span class="token punctuation">:</span>    <span class="token string">"detail"</span><span class="token punctuation">,</span>
                                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        starChild<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                            path<span class="token punctuation">:</span>    <span class="token string">"*"</span><span class="token punctuation">,</span>
                            handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">equal</span><span class="token punctuation">(</span>y <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> n<span class="token punctuation">.</span>path <span class="token operator">!=</span> y<span class="token punctuation">.</span>path <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"节点路径不匹配"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"子节点数量不相等"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> n<span class="token punctuation">.</span>starChild <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span>starChild<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>starChild<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> msg<span class="token punctuation">,</span> ok
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>
    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">childOrCreate</span><span class="token punctuation">(</span>seg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>node <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 通配符</span>
    <span class="token keyword">if</span> seg <span class="token operator">==</span> <span class="token string">"*"</span> <span class="token punctuation">{</span>
        n<span class="token punctuation">.</span>starChild <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
            path<span class="token punctuation">:</span> seg<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>starChild
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    path <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 静态匹配的节点</span>
    <span class="token comment" spellcheck="true">// path => 子节点</span>
    children <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node
    <span class="token comment" spellcheck="true">// 通配符(/*)匹配的节点</span>
    starChild <span class="token operator">*</span>node
    <span class="token comment" spellcheck="true">// 需要一个代表用户注册的业务逻辑</span>
    handler HandleFunc
<span class="token punctuation">}</span>
</code></pre>
<h2 id="14-路由树：通配符匹配之路由查找与测试【更多-IT-资料加微信-djy136928775638】"><a href="#14-路由树：通配符匹配之路由查找与测试【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="14. 路由树：通配符匹配之路由查找与测试【更多 IT 资料加微信 djy136928775638】"></a>14. 路由树：通配符匹配之路由查找与测试【更多 IT 资料加微信 djy136928775638】</h2><p><img src="20230917220359.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">childOf</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 优先考虑静态匹配，匹配不上再考虑通配符</span>
    <span class="token keyword">if</span> n<span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// return nil, false</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>starChild<span class="token punctuation">,</span> n<span class="token punctuation">.</span>starChild <span class="token operator">!=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    child<span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>starChild<span class="token punctuation">,</span> n<span class="token punctuation">.</span>starChild <span class="token operator">!=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> child<span class="token punctuation">,</span> ok
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestRouter_findRoute</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testRoutes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/detail"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/*"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> mockHandler HandleFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> testRoutes <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>method<span class="token punctuation">,</span> route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>

        wantFound <span class="token builtin">bool</span>
        wantNode  <span class="token operator">*</span>node
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 完全命中</span>
            name<span class="token punctuation">:</span>      <span class="token string">"order detail"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/order/detail"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            wantNode<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                path<span class="token punctuation">:</span>    <span class="token string">"detail"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 完全命中</span>
            name<span class="token punctuation">:</span>      <span class="token string">"order star"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/order/abc"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            wantNode<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                path<span class="token punctuation">:</span>    <span class="token string">"*"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server_test.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token boolean">_</span> <span class="token string">"net/http"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestServer</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// h := &amp;HTTPServer{} // NewServer</span>
    h <span class="token operator">:=</span> <span class="token function">NewHTTPServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    h<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/order/detail"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"hello order detail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    h<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/order/*"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"hello, %s"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    h<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="20230917221221.png"></p>
<h2 id="15-路由树：参数路径之基本注册和查找【更多-IT-资料加微信-djy136928775638】"><a href="#15-路由树：参数路径之基本注册和查找【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="15. 路由树：参数路径之基本注册和查找【更多 IT 资料加微信 djy136928775638】"></a>15. 路由树：参数路径之基本注册和查找【更多 IT 资料加微信 djy136928775638】</h2><p><img src="20230919082501.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router_test.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"testing"</span>

    <span class="token string">"github.com/stretchr/testify/assert"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestRouter_addRoute</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. 构造路由树</span>
    testRoutes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 路径参数</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/detail/:id"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> mockHandler HandleFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    r <span class="token operator">:=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> testRoutes <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>method<span class="token punctuation">,</span> route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2. 验证路由树</span>
    wantRouter <span class="token operator">:=</span> <span class="token operator">&amp;</span>router<span class="token punctuation">{</span>
        trees<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
            http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                path<span class="token punctuation">:</span>    <span class="token string">"/"</span><span class="token punctuation">,</span>
                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token string">"order"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                        path<span class="token punctuation">:</span> <span class="token string">"order"</span><span class="token punctuation">,</span>
                        children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                            <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                                path<span class="token punctuation">:</span>    <span class="token string">"detail"</span><span class="token punctuation">,</span>
                                handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                                paramChild<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                                    path<span class="token punctuation">:</span>    <span class="token string">":id"</span><span class="token punctuation">,</span>
                                    handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        starChild<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                            path<span class="token punctuation">:</span>    <span class="token string">"*"</span><span class="token punctuation">,</span>
                            handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestRouter_findRoute</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testRoutes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/login/:username"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> mockHandler HandleFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> testRoutes <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>method<span class="token punctuation">,</span> route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>

        wantFound <span class="token builtin">bool</span>
        wantNode  <span class="token operator">*</span>node
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 路径参数匹配</span>
            name<span class="token punctuation">:</span>      <span class="token string">"login username"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/login/wuif"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            wantNode<span class="token punctuation">:</span>  <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>path<span class="token punctuation">:</span> <span class="token string">":username"</span><span class="token punctuation">,</span> handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ...</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router.go</span>

<span class="token keyword">type</span> node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    path <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 静态匹配的节点</span>
    <span class="token comment" spellcheck="true">// path => 子节点</span>
    children <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node
    <span class="token comment" spellcheck="true">// 通配符(/*)匹配的节点</span>
    starChild <span class="token operator">*</span>node
    <span class="token comment" spellcheck="true">// 路径参数</span>
    paramChild <span class="token operator">*</span>node
    <span class="token comment" spellcheck="true">// 需要一个代表用户注册的业务逻辑</span>
    handler HandleFunc
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">childOf</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 优先考虑静态匹配，匹配不上再考虑通配符</span>
    <span class="token keyword">if</span> n<span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> n<span class="token punctuation">.</span>paramChild <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> n<span class="token punctuation">.</span>paramChild<span class="token punctuation">,</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// return nil, false</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>starChild<span class="token punctuation">,</span> n<span class="token punctuation">.</span>starChild <span class="token operator">!=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    child<span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">if</span> n<span class="token punctuation">.</span>paramChild <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> n<span class="token punctuation">.</span>paramChild<span class="token punctuation">,</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>starChild<span class="token punctuation">,</span> n<span class="token punctuation">.</span>starChild <span class="token operator">!=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> child<span class="token punctuation">,</span> ok
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">childOrCreate</span><span class="token punctuation">(</span>seg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>node <span class="token punctuation">{</span>
    <span class="token keyword">if</span> seg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">':'</span> <span class="token punctuation">{</span>
        n<span class="token punctuation">.</span>paramChild <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
            path<span class="token punctuation">:</span> seg<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>paramChild
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="16-路由树：参数路径之校验【更多-IT-资料加微信-djy136928775638】"><a href="#16-路由树：参数路径之校验【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="16. 路由树：参数路径之校验【更多 IT 资料加微信 djy136928775638】"></a>16. 路由树：参数路径之校验【更多 IT 资料加微信 djy136928775638】</h2><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router_test.go</span>
    r <span class="token operator">=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/a/*"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Panics</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/a/:b"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"web: 不允许同时注册路径参数和通配符路径, 已经注册通配符路径"</span><span class="token punctuation">)</span>

    r <span class="token operator">=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/a/:b"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Panics</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> <span class="token string">"/a/*"</span><span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"web: 不允许同时注册路径参数和通配符路径, 已经注册路径参数"</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">childOrCreate</span><span class="token punctuation">(</span>seg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>node <span class="token punctuation">{</span>
    <span class="token keyword">if</span> seg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">':'</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> n<span class="token punctuation">.</span>starChild <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"web: 不允许同时注册路径参数和通配符路径, 已经注册通配符路径"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        n<span class="token punctuation">.</span>paramChild <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
            path<span class="token punctuation">:</span> seg<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>paramChild
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 通配符</span>
    <span class="token keyword">if</span> seg <span class="token operator">==</span> <span class="token string">"*"</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> n<span class="token punctuation">.</span>paramChild <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"web: 不允许同时注册路径参数和通配符路径, 已经注册路径参数"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        n<span class="token punctuation">.</span>starChild <span class="token operator">=</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
            path<span class="token punctuation">:</span> seg<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>starChild
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre>
<h2 id="17-路由树：参数路径之参数值【更多-IT-资料加微信-djy136928775638】"><a href="#17-路由树：参数路径之参数值【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="17. 路由树：参数路径之参数值【更多 IT 资料加微信 djy136928775638】"></a>17. 路由树：参数路径之参数值【更多 IT 资料加微信 djy136928775638】</h2><blockquote>
<p>用户希望直接获取路径参数，我们将 node 和路径参数封装到一个对象并返回</p>
</blockquote>
<p><img src="20230919091729.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router.go</span>
<span class="token keyword">type</span> matchInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    n          <span class="token operator">*</span>node
    pathParams <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token function">findRoute</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>matchInfo<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
    <span class="token comment" spellcheck="true">// 按照 / 切割</span>
    segs <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> pathParams <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> seg <span class="token operator">:=</span> <span class="token keyword">range</span> segs <span class="token punctuation">{</span>
        child<span class="token punctuation">,</span> paramChild<span class="token punctuation">,</span> found <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">childOf</span><span class="token punctuation">(</span>seg<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//命中了路径参数</span>
        <span class="token keyword">if</span> paramChild <span class="token punctuation">{</span>
            <span class="token keyword">if</span> pathParams <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                pathParams <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// path 是 :id 这种形式</span>
            pathParams<span class="token punctuation">[</span>child<span class="token punctuation">.</span>path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> seg
        <span class="token punctuation">}</span>
        root <span class="token operator">=</span> child
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 表示有该节点，但是不一定有handler</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>matchInfo<span class="token punctuation">{</span>n<span class="token punctuation">:</span> root<span class="token punctuation">,</span> pathParams<span class="token punctuation">:</span> pathParams<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
    <span class="token comment" spellcheck="true">// return root, root.handler != nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 找到对应child</span>
<span class="token comment" spellcheck="true">// 参数1：找到的子节点</span>
<span class="token comment" spellcheck="true">// 参数2：找到的child是不是路径参数</span>
<span class="token comment" spellcheck="true">// 参数3：是否找到</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">childOf</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 优先考虑静态匹配，匹配不上再考虑通配符</span>
    <span class="token keyword">if</span> n<span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> n<span class="token punctuation">.</span>paramChild <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> n<span class="token punctuation">.</span>paramChild<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// return nil, false</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>starChild<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span>starChild <span class="token operator">!=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    child<span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">if</span> n<span class="token punctuation">.</span>paramChild <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> n<span class="token punctuation">.</span>paramChild<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> n<span class="token punctuation">.</span>starChild<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span>starChild <span class="token operator">!=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> child<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ok
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestRouter_findRoute</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testRoutes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> mockHandler HandleFunc <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> route <span class="token operator">:=</span> <span class="token keyword">range</span> testRoutes <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>method<span class="token punctuation">,</span> route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> mockHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        method <span class="token builtin">string</span>
        path   <span class="token builtin">string</span>

        wantFound <span class="token builtin">bool</span>
        info      <span class="token operator">*</span>matchInfo
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// method不存在</span>
            name<span class="token punctuation">:</span>   <span class="token string">"method not found"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodOptions<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/order/detail"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 完全命中</span>
            name<span class="token punctuation">:</span>      <span class="token string">"order detail"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/order/detail"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            info<span class="token punctuation">:</span> <span class="token operator">&amp;</span>matchInfo<span class="token punctuation">{</span>
                n<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                    handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                    path<span class="token punctuation">:</span>    <span class="token string">"detail"</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 完全命中</span>
            name<span class="token punctuation">:</span>      <span class="token string">"order star"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/order/abc"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            info<span class="token punctuation">:</span> <span class="token operator">&amp;</span>matchInfo<span class="token punctuation">{</span>
                n<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                    handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                    path<span class="token punctuation">:</span>    <span class="token string">"*"</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 命中了，但是没有handler</span>
            name<span class="token punctuation">:</span>      <span class="token string">"order"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/order"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            info<span class="token punctuation">:</span> <span class="token operator">&amp;</span>matchInfo<span class="token punctuation">{</span>
                n<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                    path<span class="token punctuation">:</span> <span class="token string">"order"</span><span class="token punctuation">,</span>
                    <span class="token comment" spellcheck="true">// order/detail注册的child -> detail</span>
                    children<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>
                        <span class="token string">"detail"</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                            handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                            path<span class="token punctuation">:</span>    <span class="token string">"detail"</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 根节点</span>
            name<span class="token punctuation">:</span>      <span class="token string">"root"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodDelete<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            info<span class="token punctuation">:</span> <span class="token operator">&amp;</span>matchInfo<span class="token punctuation">{</span>
                n<span class="token punctuation">:</span> <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>
                    path<span class="token punctuation">:</span>    <span class="token string">"/"</span><span class="token punctuation">,</span>
                    handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"path not found"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>   <span class="token string">"/404"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 路径参数匹配</span>
            name<span class="token punctuation">:</span>      <span class="token string">"login username"</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span>    http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span>
            path<span class="token punctuation">:</span>      <span class="token string">"/login/wuif"</span><span class="token punctuation">,</span>
            wantFound<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            info<span class="token punctuation">:</span> <span class="token operator">&amp;</span>matchInfo<span class="token punctuation">{</span>
                n<span class="token punctuation">:</span>          <span class="token operator">&amp;</span>node<span class="token punctuation">{</span>path<span class="token punctuation">:</span> <span class="token string">":username"</span><span class="token punctuation">,</span> handler<span class="token punctuation">:</span> mockHandler<span class="token punctuation">}</span><span class="token punctuation">,</span>
                pathParams<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"wuif"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            info<span class="token punctuation">,</span> found <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">findRoute</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>method<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantFound<span class="token punctuation">,</span> found<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>found <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>info<span class="token punctuation">.</span>pathParams<span class="token punctuation">,</span> info<span class="token punctuation">.</span>pathParams<span class="token punctuation">)</span>
            msg<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tc<span class="token punctuation">.</span>info<span class="token punctuation">.</span>n<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>n<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// context.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token string">"net/http"</span>

<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Req        <span class="token operator">*</span>http<span class="token punctuation">.</span>Request
    Resp       http<span class="token punctuation">.</span>ResponseWriter
    PathParams <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">serve</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">,</span> ok <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">findRoute</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> info<span class="token punctuation">.</span>n<span class="token punctuation">.</span>handler <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 路由没命中，404</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"NOT FOUND"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>PathParams <span class="token operator">=</span> info<span class="token punctuation">.</span>pathParams
    info<span class="token punctuation">.</span>n<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="18-路由树总结与面试要点【更多-IT-资料加微信-djy136928775638】"><a href="#18-路由树总结与面试要点【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="18. 路由树总结与面试要点【更多 IT 资料加微信 djy136928775638】"></a>18. 路由树总结与面试要点【更多 IT 资料加微信 djy136928775638】</h2><p><img src="20230919104202.png"><br><img src="20230919104226.png"><br><img src="20230919104527.png"><br><img src="20230919104639.png"><br><img src="20230919104910.png"></p>
<blockquote>
<p>如果注册了非常多的路由，最长公共前缀（gin）的实现性能高一点，但是实现很麻烦</p>
</blockquote>
<p><img src="20230919105024.png"><br><img src="20230919105225.png"></p>
<h2 id="20-第一周作业：实现一棵路由树-选学-【更多-IT-资料加微信-djy136928775638】"><a href="#20-第一周作业：实现一棵路由树-选学-【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="20.第一周作业：实现一棵路由树[选学]【更多 IT 资料加微信 djy136928775638】"></a>20.第一周作业：实现一棵路由树[选学]【更多 IT 资料加微信 djy136928775638】</h2><p><img src="20230919105351.png"><br><img src="20230919105429.png"><br><img src="20230919105628.png"><br><img src="20230919110010.png"><br><img src="20230919110055.png"><br><img src="20230919110110.png"><br><img src="20230919110129.png"><br><img src="20230919110139.png"><br><img src="20230919110159.png"><br><img src="20230919110215.png"><br><img src="20230919110228.png"><br><img src="20230919110237.png"></p>
<h2 id="21-第一周路由树作业讲解-选学-【更多-IT-资料加微信-djy136928775638】"><a href="#21-第一周路由树作业讲解-选学-【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="21.第一周路由树作业讲解[选学]【更多 IT 资料加微信 djy136928775638】"></a>21.第一周路由树作业讲解[选学]【更多 IT 资料加微信 djy136928775638】</h2><blockquote>
<p>它设置了 nodeType，如果查找路由时，所有的都找不到，还加一个判断是否有通配符</p>
</blockquote>
<p><img src="20230919111638.png"><br><img src="20230919111844.png"><br><img src="20230919112226.png"></p>
<p><img src="20230919112234.png"><br><img src="20230919112254.png"><br><img src="20230919112319.png"><br><img src="20230919112342.png"><br><img src="20230919112403.png"></p>
<p><img src="20230919112656.png"></p>
<blockquote>
<p>name(正则表达式)</p>
</blockquote>
<p><img src="20230919112827.png"></p>
<h1 id="08-第二周：Web-框架之-Context-与-AOP-方案"><a href="#08-第二周：Web-框架之-Context-与-AOP-方案" class="headerlink" title="08 第二周：Web 框架之 Context 与 AOP 方案"></a>08 第二周：Web 框架之 Context 与 AOP 方案</h1><h2 id="context"><a href="#context" class="headerlink" title="context"></a>context</h2><h3 id="1-Context-简介【更多-IT-资料加微信-djy136928775638】"><a href="#1-Context-简介【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="1. Context 简介【更多 IT 资料加微信 djy136928775638】"></a>1. Context 简介【更多 IT 资料加微信 djy136928775638】</h3><p><img src="20230919114432.png"><br><img src="20230919114443.png"><br><img src="20230919170440.png"><br><img src="20230919170629.png"><br><img src="20230919170712.png"><br><img src="20230919170805.png"><br><img src="20230919171028.png"></p>
<blockquote>
<p>parseForm 可以多次调用，只会解析一次</p>
</blockquote>
<p><img src="20230919171112.png"></p>
<h3 id="2-Context：Beego-Context-设计分析【更多-IT-资料加微信-djy136928775638】"><a href="#2-Context：Beego-Context-设计分析【更多-IT-资料加微信-djy136928775638】" class="headerlink" title="2. Context：Beego Context 设计分析【更多 IT 资料加微信 djy136928775638】"></a>2. Context：Beego Context 设计分析【更多 IT 资料加微信 djy136928775638】</h3><p><img src="80e3d0e8.png"><img src="ad4d6b71.png"><img src="579251e4.png"></p>
<h3 id="3-Context：Gin-Context-设计分析"><a href="#3-Context：Gin-Context-设计分析" class="headerlink" title="3. Context：Gin Context 设计分析"></a>3. Context：Gin Context 设计分析</h3><p><img src="997dd358.png"><img src="4f85e00b.png"><img src="531628bb.png"></p>
<h3 id="4-Context：Echo-和-Iris-的-Context-设计分析"><a href="#4-Context：Echo-和-Iris-的-Context-设计分析" class="headerlink" title="4. Context：Echo 和 Iris 的 Context 设计分析"></a>4. Context：Echo 和 Iris 的 Context 设计分析</h3><p><img src="b388ea4c.png"><img src="d366e542.png"><img src="d80bbee7.png"><img src="cc6e09ef.png"></p>
<h3 id="5-Context：处理输入输出总结"><a href="#5-Context：处理输入输出总结" class="headerlink" title="5. Context：处理输入输出总结"></a>5. Context：处理输入输出总结</h3><p><img src="d7596c06.png"><img src="0751c7ba.png"></p>
<h3 id="6-Context：处理输入之-Body-输入"><a href="#6-Context：处理输入之-Body-输入" class="headerlink" title="6. Context：处理输入之 Body 输入"></a>6. Context：处理输入之 Body 输入</h3><blockquote>
<p>如果引入小众需求会影响框架的复杂度，或者导致性能等受挫，就不要考虑</p>
</blockquote>
<p><img src="14768230.png"><img src="a92660ee.png"><img src="f790ba19.png"><img src="62c3a20f.png"><img src="bf09637b.png"></p>
<h3 id="7-Context：处理输入之表单输入"><a href="#7-Context：处理输入之表单输入" class="headerlink" title="7. Context：处理输入之表单输入"></a>7. Context：处理输入之表单输入</h3><p><img src="5785620b.png"></p>
<blockquote>
<p>parseForm只解析表单数据</p>
</blockquote>
<p><img src="3fe81696.png"><img src="9ebf4c30.png"><img src="808cde24.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// context.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">FormValue</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">ParseForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//vals, ok := c.Req.Form[key]</span>
    <span class="token comment" spellcheck="true">//if !ok {</span>
    <span class="token comment" spellcheck="true">//    return "", errors.New("web: key 不存在")</span>
    <span class="token comment" spellcheck="true">//}</span>
    <span class="token comment" spellcheck="true">//return vals[0], nil</span>
    <span class="token keyword">return</span> c<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="d6992a63.png"><img src="6daa9165.png"><img src="29bc8580.png"></p>
<h3 id="8-Context：处理输入之查询参数、路径参数和-StringValue"><a href="#8-Context：处理输入之查询参数、路径参数和-StringValue" class="headerlink" title="8. Context：处理输入之查询参数、路径参数和 StringValue"></a>8. Context：处理输入之查询参数、路径参数和 StringValue</h3><p><img src="0c3654ef.png"><img src="8e972054.png"><img src="32b50282.png"><img src="5ff806ce.png"><br><img src="40c76e98.png"><img src="02acf97d.png"><img src="28219f6d.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">QueryValue</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>queryValues <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Query每次会调用parseQuery,而form只调用一次,所以query需要缓存</span>
        <span class="token comment" spellcheck="true">// 缓存</span>
        c<span class="token punctuation">.</span>queryValues <span class="token operator">=</span> c<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    vals<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>queryValues<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"web: key 不存在"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">QueryValueV1</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> StringValue <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>queryValues <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Query每次会调用parseQuery,而form只调用一次,所以query需要缓存</span>
        <span class="token comment" spellcheck="true">// 缓存</span>
        c<span class="token punctuation">.</span>queryValues <span class="token operator">=</span> c<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    vals<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>queryValues<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> StringValue<span class="token punctuation">{</span>
            err<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"web: key 不存在"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> StringValue<span class="token punctuation">{</span>
        val<span class="token punctuation">:</span> vals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">PathValue</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>PathParams<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"web: key 不存在"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> val<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">PathValueV1</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> StringValue <span class="token punctuation">{</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>PathParams<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> StringValue<span class="token punctuation">{</span>
            err<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"web: key 不存在"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> StringValue<span class="token punctuation">{</span>val<span class="token punctuation">:</span> val<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> StringValue <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    val <span class="token builtin">string</span>
    err <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s StringValue<span class="token punctuation">)</span> <span class="token function">AsInt64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>val<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server_test.go</span>
    h<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/values/v1/:id"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 这种就比较方便</span>
        id<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">PathValueV1</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AsInt64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"id 输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"hello, %d"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    h<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/values/:id"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        idStr<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">PathValue</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"id 输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        id<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>idStr<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"id 输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"hello, %d"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="9-Context：处理输出"><a href="#9-Context：处理输出" class="headerlink" title="9. Context：处理输出"></a>9. Context：处理输出</h3><p><img src="9f36d96f.png"><img src="fdda597d.png"><img src="4596daea.png"><img src="85e75565.png"><img src="890c40f7.png"><img src="1efde49d.png"></p>
<h3 id="10-Context-总结与面试要点"><a href="#10-Context-总结与面试要点" class="headerlink" title="10. Context 总结与面试要点"></a>10. Context 总结与面试要点</h3><p><img src="d0d4412c.png" alt="用户自己通过装饰器模式来实现线程安全"><img src="18a48c75.png"><img src="67bacca4.png"><img src="5400baad.png"></p>
<blockquote>
<p>go的泛型功能比较有限</p>
</blockquote>
<p><img src="5fcae41d.png"><img src="4e33c117.png"><img src="c7289621.png"></p>
<h2 id="aop"><a href="#aop" class="headerlink" title="aop"></a>aop</h2><h3 id="11-AOP-简介与不同框架设计概览"><a href="#11-AOP-简介与不同框架设计概览" class="headerlink" title="11. AOP 简介与不同框架设计概览"></a>11. AOP 简介与不同框架设计概览</h3><p><img src="b3121863.png"><img src="a04fb3f7.png"><img src="b8fa6bab.png"><img src="27f96262.png"><img src="fa3602f1.png"><img src="7bf65752.png"><br><img src="58775e9e.png"><img src="9086966c.png"></p>
<h3 id="12-AOP-设计方案：Middleware"><a href="#12-AOP-设计方案：Middleware" class="headerlink" title="12. AOP 设计方案：Middleware"></a>12. AOP 设计方案：Middleware</h3><p><img src="ae82ceb3.png"><img src="5adeb272.png"><img src="312db640.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// middleware.go</span>
<span class="token keyword">package</span> web

<span class="token comment" spellcheck="true">// Middleware 函数式的责任链模式(洋葱模式)</span>
<span class="token keyword">type</span> Middleware <span class="token keyword">func</span><span class="token punctuation">(</span>next HandleFunc<span class="token punctuation">)</span> HandleFunc

<span class="token comment" spellcheck="true">// web框架AOP方案在不同语言有不同叫法</span>
<span class="token comment" spellcheck="true">// Middleware Handler Chain Filter Filter-Chain</span>
<span class="token comment" spellcheck="true">// Interceptor Wrapper</span>

<span class="token comment" spellcheck="true">//type MiddlewareV1 interface {</span>
<span class="token comment" spellcheck="true">//    Invoke(next HandleFunc) HandleFunc</span>
<span class="token comment" spellcheck="true">//}</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//type Interceptor interface {</span>
<span class="token comment" spellcheck="true">//    Before(ctx *Context)</span>
<span class="token comment" spellcheck="true">//    After(ctx *Context)</span>
<span class="token comment" spellcheck="true">//    Surround(ctx *Context)</span>
<span class="token comment" spellcheck="true">//}</span>

<span class="token comment" spellcheck="true">//type Chain []HandleFunc</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//type HandleFuncV1 func(ctx *Context) (next bool)</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//type ChainV1 struct {</span>
<span class="token comment" spellcheck="true">//    handlers []HandleFuncV1</span>
<span class="token comment" spellcheck="true">//}</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//func (c ChainV1) Run(ctx *Context) {</span>
<span class="token comment" spellcheck="true">//    for _, h := range c.handlers {</span>
<span class="token comment" spellcheck="true">//        next := h(ctx)</span>
<span class="token comment" spellcheck="true">//        // 这种是中断执行</span>
<span class="token comment" spellcheck="true">//        if !next {</span>
<span class="token comment" spellcheck="true">//            return</span>
<span class="token comment" spellcheck="true">//        }</span>
<span class="token comment" spellcheck="true">//    }</span>
<span class="token comment" spellcheck="true">//}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server.go</span>
<span class="token keyword">type</span> HTTPServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// addr string // 可以创建时传递，而不是通过start传，也是可以的</span>
    <span class="token comment" spellcheck="true">// router</span>
    router <span class="token comment" spellcheck="true">// 因为router实现了addRoute，所以也可以通过编译</span>

    mdls <span class="token punctuation">[</span><span class="token punctuation">]</span>Middleware
<span class="token punctuation">}</span> 

<span class="token comment" spellcheck="true">// http.Handler的接口</span>
<span class="token comment" spellcheck="true">// 核心方法 处理请求的入口</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 框架代码</span>
    ctx <span class="token operator">:=</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">{</span>
        Req<span class="token punctuation">:</span>  req<span class="token punctuation">,</span>
        Resp<span class="token punctuation">:</span> w<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 最后一个handler是这个</span>
    root <span class="token operator">:=</span> h<span class="token punctuation">.</span>serve
    <span class="token comment" spellcheck="true">// 利用最后一个,从后往前回溯,组装链条</span>
    <span class="token comment" spellcheck="true">// 后一个作为前一个的next 构造链条</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>mdls<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
        root <span class="token operator">=</span> h<span class="token punctuation">.</span>mdls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 这里执行就是从前往后的</span>
    <span class="token function">root</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 接下来就是查找路由并执行命中的业务逻辑</span>
    <span class="token comment" spellcheck="true">//h.serve(ctx)</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>无侵入式比较体现代码功底,但是有可能牺牲一部分性能</p>
</blockquote>
<blockquote>
<p>别的方式, 链式扩散成网状</p>
</blockquote>
<p><img src="2f869904.png"><img src="b0c0fbf5.png"><img src="f09b3e2d.png"></p>
<h3 id="13-Middleware：AccessLog"><a href="#13-Middleware：AccessLog" class="headerlink" title="13. Middleware：AccessLog"></a>13. Middleware：AccessLog</h3><p><img src="5ecaebde.png">![go:build](1ea4c724.png</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// web/accesslog/middleware.go</span>
<span class="token keyword">package</span> accesslog

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/goccy/go-json"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> MiddlewareBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    logFunc <span class="token keyword">func</span><span class="token punctuation">(</span>log <span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">LogFunc</span><span class="token punctuation">(</span>fn <span class="token keyword">func</span><span class="token punctuation">(</span>log <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>MiddlewareBuilder <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span>logFunc <span class="token operator">=</span> fn
    <span class="token keyword">return</span> m
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> web<span class="token punctuation">.</span>Middleware <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next web<span class="token punctuation">.</span>HandleFunc<span class="token punctuation">)</span> web<span class="token punctuation">.</span>HandleFunc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 在这里记录请求</span>
            <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                l <span class="token operator">:=</span> accessLog<span class="token punctuation">{</span>
                    Host<span class="token punctuation">:</span>       ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Host<span class="token punctuation">,</span>
                    Route<span class="token punctuation">:</span>      ctx<span class="token punctuation">.</span>MatchedRoute<span class="token punctuation">,</span>
                    HTTPMethod<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Method<span class="token punctuation">,</span>
                    Path<span class="token punctuation">:</span>       ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
                data<span class="token punctuation">,</span> <span class="token boolean">_</span>     <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
                m<span class="token punctuation">.</span><span class="token function">logFunc</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> accessLog <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Host <span class="token builtin">string</span> <span class="token string">`json:"host,omitempty"`</span>
    <span class="token comment" spellcheck="true">// 命中的路由</span>
    Route      <span class="token builtin">string</span> <span class="token string">`json:"route,omitempty"`</span>
    HTTPMethod <span class="token builtin">string</span> <span class="token string">`json:"http_method,omitempty"`</span>
    Path       <span class="token builtin">string</span> <span class="token string">`json:"path,omitempty"`</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// router.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>router<span class="token punctuation">)</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handleFunc HandleFunc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 根节点特殊处理</span>
    <span class="token keyword">if</span> path <span class="token operator">==</span> <span class="token string">"/"</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        root<span class="token punctuation">.</span>handler <span class="token operator">=</span> handleFunc
        root<span class="token punctuation">.</span>route <span class="token operator">=</span> <span class="token string">"/"</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ... </span>
    root<span class="token punctuation">.</span>handler <span class="token operator">=</span> handleFunc
    root<span class="token punctuation">.</span>route <span class="token operator">=</span> path
<span class="token punctuation">}</span>

<span class="token keyword">type</span> node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// /a/b/* -> /a/b/*</span>
    route <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 当前路由 /a/* -> *</span>
    path <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span> 
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// middleware_e2e_test.go</span>
<span class="token comment" spellcheck="true">//go:build e2e</span>

<span class="token keyword">package</span> accesslog

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"testing"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestMiddlewareBuilderE2E</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    builder <span class="token operator">:=</span> MiddlewareBuilder<span class="token punctuation">{</span><span class="token punctuation">}</span>
    mdls <span class="token operator">:=</span> builder<span class="token punctuation">.</span><span class="token function">LogFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>log <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    server <span class="token operator">:=</span> web<span class="token punctuation">.</span><span class="token function">NewHTTPServer</span><span class="token punctuation">(</span>web<span class="token punctuation">.</span><span class="token function">ServerWithMiddleware</span><span class="token punctuation">(</span>mdls<span class="token punctuation">)</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/a/b/*"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"hello, it's me"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// middleware_test.go</span>
<span class="token keyword">package</span> accesslog

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"testing"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestMiddlewareBuilder</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    builder <span class="token operator">:=</span> MiddlewareBuilder<span class="token punctuation">{</span><span class="token punctuation">}</span>
    mdls <span class="token operator">:=</span> builder<span class="token punctuation">.</span><span class="token function">LogFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>log <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    server <span class="token operator">:=</span> web<span class="token punctuation">.</span><span class="token function">NewHTTPServer</span><span class="token punctuation">(</span>web<span class="token punctuation">.</span><span class="token function">ServerWithMiddleware</span><span class="token punctuation">(</span>mdls<span class="token punctuation">)</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/a/b/*"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello, it's me"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span> <span class="token string">"/a/b/c"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    server<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">serve</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">,</span> ok <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">findRoute</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> info<span class="token punctuation">.</span>n<span class="token punctuation">.</span>handler <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>PathParams <span class="token operator">=</span> info<span class="token punctuation">.</span>pathParams
    ctx<span class="token punctuation">.</span>MatchedRoute <span class="token operator">=</span> info<span class="token punctuation">.</span>n<span class="token punctuation">.</span>route
    info<span class="token punctuation">.</span>n<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// context.go</span>
<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    MatchedRoute <span class="token builtin">string</span>

    <span class="token comment" spellcheck="true">//cookieSameSite http.SameSite</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="4f0cf0b6.png"><img src="e04b110e.png"><img src="f94ad876.png"></p>
<h3 id="14-Middleware：Trace-简介和-OpenTelemetry"><a href="#14-Middleware：Trace-简介和-OpenTelemetry" class="headerlink" title="14. Middleware：Trace 简介和 OpenTelemetry"></a>14. Middleware：Trace 简介和 OpenTelemetry</h3><p><img src="d581281a.png"><img src="65405696.png"><img src="d98bddbe.png"><img src="0395ce95.png"></p>
<blockquote>
<p>一种是用户传数据进来，怎么来的无所谓(编程类接口)，一种是用户传配置文件的路径，我们去读取和解析，这种是强耦合</p>
</blockquote>
<p><img src="54139f3e.png"><img src="9de56d2e.png"></p>
<p><img src="16bd059e.png"><img src="401a1c58.png"><img src="8c1a7c6d.png"></p>
<p><img src="5afcaa34.png"><img src="a8b89094.png"><img src="ccd3ddc1.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// web/middlewares/opentelemetry/middleware.go</span>
<span class="token keyword">package</span> opentelemetry

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"go.opentelemetry.io/otel"</span>
    <span class="token string">"go.opentelemetry.io/otel/attribute"</span>
    <span class="token string">"go.opentelemetry.io/otel/propagation"</span>
    <span class="token string">"go.opentelemetry.io/otel/trace"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> instrumentationName <span class="token operator">=</span> <span class="token string">"web_framework/middlewares/opentelemetry"</span>

<span class="token keyword">type</span> MiddlewareBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Tracer trace<span class="token punctuation">.</span>Tracer
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//func NewMiddlewareBuilder(tracer trace.Tracer) *MiddlewareBuilder {</span>
<span class="token comment" spellcheck="true">//    return &amp;MiddlewareBuilder{tracer}</span>
<span class="token comment" spellcheck="true">//}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> web<span class="token punctuation">.</span>Middleware <span class="token punctuation">{</span>
    <span class="token keyword">if</span> m<span class="token punctuation">.</span>Tracer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        m<span class="token punctuation">.</span>Tracer <span class="token operator">=</span> otel<span class="token punctuation">.</span><span class="token function">GetTracerProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Tracer</span><span class="token punctuation">(</span>instrumentationName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next web<span class="token punctuation">.</span>HandleFunc<span class="token punctuation">)</span> web<span class="token punctuation">.</span>HandleFunc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            reqCtx <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 尝试和客户端的trace结合</span>
            reqCtx <span class="token operator">=</span> otel<span class="token punctuation">.</span><span class="token function">GetTextMapPropagator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span>reqCtx<span class="token punctuation">,</span> propagation<span class="token punctuation">.</span><span class="token function">HeaderCarrier</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Header<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 创建span,这里的spanName(参数2)应该是命中的路由名称,但是现在还不知道</span>
            <span class="token boolean">_</span><span class="token punctuation">,</span> span <span class="token operator">:=</span> m<span class="token punctuation">.</span>Tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>reqCtx<span class="token punctuation">,</span> <span class="token string">"unknown"</span><span class="token punctuation">)</span>
            <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 根据业务自己加</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"http.method"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">)</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"http.url"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// schema -> http/https</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"http.schema"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"http.host"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Host<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 下一步</span>
            <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 执行完next,才有值</span>
            span<span class="token punctuation">.</span><span class="token function">SetName</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>MatchedRoute<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="15-Middleware：OpenTelemetry-测试"><a href="#15-Middleware：OpenTelemetry-测试" class="headerlink" title="15. Middleware：OpenTelemetry 测试"></a>15. Middleware：OpenTelemetry 测试</h3><p><img src="26dc0c47.png"><img src="3cfb29f1.png"><img src="76fbf79d.png"><img src="e3217980.png"><br><img src="409f9334.png"><img src="a5234bba.png"><img src="9b977a8d.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// middleware_e2e_test.go</span>
<span class="token comment" spellcheck="true">//go:build e2e</span>

<span class="token keyword">package</span> opentelemetry

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"go.opentelemetry.io/otel"</span>
    <span class="token string">"go.opentelemetry.io/otel/exporters/zipkin"</span>
    <span class="token string">"go.opentelemetry.io/otel/sdk/resource"</span>
    sdktrace <span class="token string">"go.opentelemetry.io/otel/sdk/trace"</span>
    semcove <span class="token string">"go.opentelemetry.io/otel/semconv/v1.10.0"</span>
    <span class="token string">"log"</span>
    <span class="token string">"os"</span>
    <span class="token string">"testing"</span>
    <span class="token string">"time"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestMiddlewareBuilder_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tracer <span class="token operator">:=</span> otel<span class="token punctuation">.</span><span class="token function">GetTracerProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Tracer</span><span class="token punctuation">(</span>instrumentationName<span class="token punctuation">)</span>
    builder <span class="token operator">:=</span> MiddlewareBuilder<span class="token punctuation">{</span>
        Tracer<span class="token punctuation">:</span> tracer<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    server <span class="token operator">:=</span> web<span class="token punctuation">.</span><span class="token function">NewHTTPServer</span><span class="token punctuation">(</span>web<span class="token punctuation">.</span><span class="token function">ServerWithMiddleware</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    server<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">,</span> span <span class="token operator">:=</span> tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"first_layer"</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">//defer func() {</span>
        <span class="token comment" spellcheck="true">//    // 执行完next,才有值</span>
        <span class="token comment" spellcheck="true">//    span.SetName(ctx.MatchedRoute)</span>
        <span class="token comment" spellcheck="true">//    // 响应码</span>
        <span class="token comment" spellcheck="true">//    span.SetAttributes(attribute.Int("http.status", ctx.RespStatusCode))</span>
        <span class="token comment" spellcheck="true">//    span.End()</span>
        <span class="token comment" spellcheck="true">//}()</span>

        secondC<span class="token punctuation">,</span> second <span class="token operator">:=</span> tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"second_layer"</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> third1 <span class="token operator">:=</span> tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>secondC<span class="token punctuation">,</span> <span class="token string">"third_layer_1"</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
        third1<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> third2 <span class="token operator">:=</span> tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>secondC<span class="token punctuation">,</span> <span class="token string">"third_layer_2"</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">300</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
        third2<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        second<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token boolean">_</span><span class="token punctuation">,</span> first <span class="token operator">:=</span> tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"first_layer_1"</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> first<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//ctx.Resp.Write([]byte("hello,world"))</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">RespJson</span><span class="token punctuation">(</span><span class="token number">202</span><span class="token punctuation">,</span> User<span class="token punctuation">{</span>
            Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">initZipkin</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 一定要加冒号</span>
    server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span> <span class="token string">`json:"name"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">initZipkin</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exporter<span class="token punctuation">,</span> err <span class="token operator">:=</span> zipkin<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
        <span class="token string">"http://tyy:9411/api/v2/spans"</span><span class="token punctuation">,</span>
        zipkin<span class="token punctuation">.</span><span class="token function">WithLogger</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">"opentelemetry-demo"</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span>Lmicroseconds<span class="token operator">|</span>log<span class="token punctuation">.</span>Ldate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    batcher <span class="token operator">:=</span> sdktrace<span class="token punctuation">.</span><span class="token function">NewBatchSpanProcessor</span><span class="token punctuation">(</span>exporter<span class="token punctuation">)</span>
    tp <span class="token operator">:=</span> sdktrace<span class="token punctuation">.</span><span class="token function">NewTracerProvider</span><span class="token punctuation">(</span>
        sdktrace<span class="token punctuation">.</span><span class="token function">WithSpanProcessor</span><span class="token punctuation">(</span>batcher<span class="token punctuation">)</span><span class="token punctuation">,</span>
        sdktrace<span class="token punctuation">.</span><span class="token function">WithResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">NewWithAttributes</span><span class="token punctuation">(</span>
            semcove<span class="token punctuation">.</span>SchemaURL<span class="token punctuation">,</span>
            semcove<span class="token punctuation">.</span>ServiceNameKey<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"opentelemetry-demo"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    otel<span class="token punctuation">.</span><span class="token function">SetTracerProvider</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
    <span class="token comment" spellcheck="true">// 这里执行就是从前往后的</span>

    <span class="token comment" spellcheck="true">// 最后把RespData和RespStatusCode刷新到响应</span>
    <span class="token keyword">var</span> m Middleware <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next HandleFunc<span class="token punctuation">)</span> HandleFunc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 这里就设置了RespData和RespStatusCode</span>
            <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            h<span class="token punctuation">.</span><span class="token function">flushResp</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    root <span class="token operator">=</span> <span class="token function">m</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>

    <span class="token function">root</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 接下来就是查找路由并执行命中的业务逻辑</span>
    <span class="token comment" spellcheck="true">//h.serve(ctx)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">flushResp</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>RespStatusCode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    n<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>RespData<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> n <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>RespData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//log.Fatalln("写入响应失败")</span>
        h<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"写入响应失败 %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">serve</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">,</span> ok <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">findRoute</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> info<span class="token punctuation">.</span>n<span class="token punctuation">.</span>handler <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 路由没命中，404</span>
        <span class="token comment" spellcheck="true">//ctx.Resp.WriteHeader(404)</span>
        <span class="token comment" spellcheck="true">//ctx.Resp.Write([]byte("NOT FOUND"))</span>
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"NOT FOUND"</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> <span class="token number">404</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>PathParams <span class="token operator">=</span> info<span class="token punctuation">.</span>pathParams
    ctx<span class="token punctuation">.</span>MatchedRoute <span class="token operator">=</span> info<span class="token punctuation">.</span>n<span class="token punctuation">.</span>route
    info<span class="token punctuation">.</span>n<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewHTTPServer</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>HTTPServerOption<span class="token punctuation">)</span> <span class="token operator">*</span>HTTPServer <span class="token punctuation">{</span>
    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>HTTPServer<span class="token punctuation">{</span>
        router<span class="token punctuation">:</span> <span class="token function">newRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        log<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>msg <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span>any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token keyword">type</span> HTTPServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// addr string // 可以创建时传递，而不是通过start传，也是可以的</span>
    <span class="token comment" spellcheck="true">// router</span>
    router <span class="token comment" spellcheck="true">// 因为router实现了addRoute，所以也可以通过编译</span>

    mdls <span class="token punctuation">[</span><span class="token punctuation">]</span>Middleware

    log <span class="token keyword">func</span><span class="token punctuation">(</span>msg <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span>any<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">RespJson</span><span class="token punctuation">(</span>code <span class="token builtin">int</span><span class="token punctuation">,</span> val any<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//c.Resp.WriteHeader(code) // 状态码</span>
    <span class="token comment" spellcheck="true">//// 参数1,写了多少数据</span>
    <span class="token comment" spellcheck="true">//n, err := c.Resp.Write(data)</span>
    <span class="token comment" spellcheck="true">//if n != len(data) {</span>
    <span class="token comment" spellcheck="true">//    return errors.New("web: 未写入全部数据")</span>
    <span class="token comment" spellcheck="true">//}</span>
    c<span class="token punctuation">.</span>RespData <span class="token operator">=</span> data
    c<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> code
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request
    <span class="token comment" spellcheck="true">// 如果用了Resp,就绕开了RespData和RespStatusCode,</span>
    <span class="token comment" spellcheck="true">// 部分middleware可能无法运作</span>
    Resp       http<span class="token punctuation">.</span>ResponseWriter
    PathParams <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>

    <span class="token comment" spellcheck="true">// 主要是为了给middleware用</span>
    RespData       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    RespStatusCode <span class="token builtin">int</span>

    queryValues url<span class="token punctuation">.</span>Values

    MatchedRoute <span class="token builtin">string</span>

    <span class="token comment" spellcheck="true">//cookieSameSite http.SameSite</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// web/middlewares/opentelemetry/middleware.go</span>
<span class="token keyword">package</span> opentelemetry

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"go.opentelemetry.io/otel"</span>
    <span class="token string">"go.opentelemetry.io/otel/attribute"</span>
    <span class="token string">"go.opentelemetry.io/otel/propagation"</span>
    <span class="token string">"go.opentelemetry.io/otel/trace"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> instrumentationName <span class="token operator">=</span> <span class="token string">"web_framework/middlewares/opentelemetry"</span>

<span class="token keyword">type</span> MiddlewareBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Tracer trace<span class="token punctuation">.</span>Tracer
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//func NewMiddlewareBuilder(tracer trace.Tracer) *MiddlewareBuilder {</span>
<span class="token comment" spellcheck="true">//    return &amp;MiddlewareBuilder{tracer}</span>
<span class="token comment" spellcheck="true">//}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> web<span class="token punctuation">.</span>Middleware <span class="token punctuation">{</span>
    <span class="token keyword">if</span> m<span class="token punctuation">.</span>Tracer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        m<span class="token punctuation">.</span>Tracer <span class="token operator">=</span> otel<span class="token punctuation">.</span><span class="token function">GetTracerProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Tracer</span><span class="token punctuation">(</span>instrumentationName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next web<span class="token punctuation">.</span>HandleFunc<span class="token punctuation">)</span> web<span class="token punctuation">.</span>HandleFunc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            reqCtx <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 尝试和客户端的trace结合</span>
            reqCtx <span class="token operator">=</span> otel<span class="token punctuation">.</span><span class="token function">GetTextMapPropagator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span>reqCtx<span class="token punctuation">,</span> propagation<span class="token punctuation">.</span><span class="token function">HeaderCarrier</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Header<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 创建span,这里的spanName(参数2)应该是命中的路由名称,但是现在还不知道</span>
            reqCtx<span class="token punctuation">,</span> span <span class="token operator">:=</span> m<span class="token punctuation">.</span>Tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>reqCtx<span class="token punctuation">,</span> <span class="token string">"unknown"</span><span class="token punctuation">)</span>
            <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 根据业务自己加</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"http.method"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">)</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"http.url"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// schema -> http/https</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"http.schema"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"http.host"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Host<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// reqCtx创建完trace,复制给ctx.Req的ctx</span>
            <span class="token comment" spellcheck="true">// 复制的操作耗性能,但是为了使用该ctx,没办法</span>
            ctx<span class="token punctuation">.</span>Req <span class="token operator">=</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>reqCtx<span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 下一步</span>
            <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 执行完next,才有值</span>
            span<span class="token punctuation">.</span><span class="token function">SetName</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>MatchedRoute<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 响应码</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"http.status"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>RespStatusCode<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="16-Middleware：OpenTelemetry-总结"><a href="#16-Middleware：OpenTelemetry-总结" class="headerlink" title="16. Middleware：OpenTelemetry 总结"></a>16. Middleware：OpenTelemetry 总结</h3><p><img src="8465dc3a.png"><img src="0a79bc0e.png"><img src="df7d4194.png"><img src="93ff6209.png"><img src="634f9740.png"><br><img src="dff6ca0f.png"><img src="71de6eab.png"><img src="d273cf23.png"><img src="15c227c8.png"></p>
<h3 id="17-Prometheus-详解"><a href="#17-Prometheus-详解" class="headerlink" title="17. Prometheus 详解"></a>17. Prometheus 详解</h3><p><img src="23ec53ff.png" alt="&quot;这可不是我们公司哒,要是我们公司的,今天我贴出来,明天我就被炒掉啦&quot;"><br><img src="fd714384.png"><img src="c1361ee5.png" alt="namespace那些字符串不能用-,要换成_"><img src="591725e0.png"><img src="8e5b5f5e.png"></p>
<h3 id="18-Middleware：Prometheus"><a href="#18-Middleware：Prometheus" class="headerlink" title="18. Middleware：Prometheus"></a>18. Middleware：Prometheus</h3><p><img src="5633294e.png"><img src="b844e137.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// web/middlewares/prometheus/middleware_test.go</span>
<span class="token comment" spellcheck="true">//go:build e2e</span>

<span class="token keyword">package</span> prometheus

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/prometheus/client_golang/prometheus/promhttp"</span>
    <span class="token string">"math/rand"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"testing"</span>
    <span class="token string">"time"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestMiddlewareBuilder_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    builder <span class="token operator">:=</span> MiddlewareBuilder<span class="token punctuation">{</span>
        Namespace<span class="token punctuation">:</span> <span class="token string">"malred"</span><span class="token punctuation">,</span>
        Subsystem<span class="token punctuation">:</span> <span class="token string">"web"</span><span class="token punctuation">,</span>
        Name<span class="token punctuation">:</span>      <span class="token string">"http_response"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    server <span class="token operator">:=</span> web<span class="token punctuation">.</span><span class="token function">NewHTTPServer</span><span class="token punctuation">(</span>web<span class="token punctuation">.</span><span class="token function">ServerWithMiddleware</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    server<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span><span class="token function">RespJson</span><span class="token punctuation">(</span><span class="token number">202</span><span class="token punctuation">,</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 启动端口让prometheus暴露数据</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/metrics"</span><span class="token punctuation">,</span> promhttp<span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":8082"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

    server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span> <span class="token string">`json:"name"`</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// web/middlewares/prometheus/middleware.go</span>
<span class="token keyword">package</span> prometheus

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/prometheus/client_golang/prometheus"</span>
    <span class="token string">"strconv"</span>
    <span class="token string">"time"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// builder方便扩展</span>
<span class="token keyword">type</span> MiddlewareBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Namespace <span class="token builtin">string</span>
    Subsystem <span class="token builtin">string</span>
    Name      <span class="token builtin">string</span>
    Help      <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> web<span class="token punctuation">.</span>Middleware <span class="token punctuation">{</span>
    vector <span class="token operator">:=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewSummaryVec</span><span class="token punctuation">(</span>prometheus<span class="token punctuation">.</span>SummaryOpts<span class="token punctuation">{</span>
        Namespace<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
        Subsystem<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Subsystem<span class="token punctuation">,</span>
        Name<span class="token punctuation">:</span>      m<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
        Help<span class="token punctuation">:</span>      m<span class="token punctuation">.</span>Help<span class="token punctuation">,</span>
        Objectives<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">float64</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">{</span>
            <span class="token number">0.5</span><span class="token punctuation">:</span>   <span class="token number">0.01</span><span class="token punctuation">,</span>
            <span class="token number">0.75</span><span class="token punctuation">:</span>  <span class="token number">0.01</span><span class="token punctuation">,</span>
            <span class="token number">0.90</span><span class="token punctuation">:</span>  <span class="token number">0.01</span><span class="token punctuation">,</span>
            <span class="token number">0.99</span><span class="token punctuation">:</span>  <span class="token number">0.001</span><span class="token punctuation">,</span>
            <span class="token number">0.999</span><span class="token punctuation">:</span> <span class="token number">0.0001</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"pattern"</span><span class="token punctuation">,</span> <span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 注册观察者</span>
    prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>vector<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 两次调用builder会panic</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next web<span class="token punctuation">.</span>HandleFunc<span class="token punctuation">)</span> web<span class="token punctuation">.</span>HandleFunc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                duration <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                pattern <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>MatchedRoute
                <span class="token keyword">if</span> pattern <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
                    pattern <span class="token operator">=</span> <span class="token string">"unknown"</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Observe 表示响应时间</span>
                vector<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>Method<span class="token punctuation">,</span>
                    strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>RespStatusCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">Observe</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="52c812c6.png"></p>
<h3 id="19-Middleware-例子：错误页面"><a href="#19-Middleware-例子：错误页面" class="headerlink" title="19. Middleware 例子：错误页面"></a>19. Middleware 例子：错误页面</h3><p><img src="cf81eb3d.png"><img src="c38e64d6.png"><img src="6b3348e0.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// middleware_test.go</span>
<span class="token keyword">package</span> errhdl

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"testing"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestNewMiddlewareBuilder</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    builder <span class="token operator">:=</span> <span class="token function">NewMiddlewareBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    builder<span class="token punctuation">.</span><span class="token function">AddCode</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`
        &lt;html>
            &lt;body>
                &lt;h1>NOT FOUND&lt;/h1>
            &lt;/body>
        &lt;/html>
    `</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">AddCode</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`
        &lt;html>
            &lt;body>
                &lt;h1>BAD REQUEST&lt;/h1>
            &lt;/body>
        &lt;/html>
    `</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    server <span class="token operator">:=</span> web<span class="token punctuation">.</span><span class="token function">NewHTTPServer</span><span class="token punctuation">(</span>web<span class="token punctuation">.</span><span class="token function">ServerWithMiddleware</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// web/middlewares/errhdl/middleware.go</span>
<span class="token keyword">package</span> errhdl

<span class="token keyword">import</span> <span class="token string">"web_framework/web"</span>

<span class="token keyword">type</span> MiddlewareBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 这种设计只能返回固定值</span>
    <span class="token comment" spellcheck="true">// 不能动态渲染</span>
    resp <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token function">NewMiddlewareBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>MiddlewareBuilder <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>MiddlewareBuilder<span class="token punctuation">{</span>
        resp<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">AddCode</span><span class="token punctuation">(</span>status <span class="token builtin">int</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token operator">*</span>MiddlewareBuilder <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span>resp<span class="token punctuation">[</span>status<span class="token punctuation">]</span> <span class="token operator">=</span> data
    <span class="token keyword">return</span> m
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> web<span class="token punctuation">.</span>Middleware <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next web<span class="token punctuation">.</span>HandleFunc<span class="token punctuation">)</span> web<span class="token punctuation">.</span>HandleFunc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            resp<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>resp<span class="token punctuation">[</span>ctx<span class="token punctuation">.</span>RespStatusCode<span class="token punctuation">]</span>
            <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 篡改结果</span>
                ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> resp
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="20-Middleware-例子：从-panic-中恢复"><a href="#20-Middleware-例子：从-panic-中恢复" class="headerlink" title="20. Middleware 例子：从 panic 中恢复"></a>20. Middleware 例子：从 panic 中恢复</h3><p><img src="cd5b81f8.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// middleware_test.go</span>
<span class="token keyword">package</span> <span class="token builtin">recover</span>

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"testing"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestMiddlewareBuilder_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    builder <span class="token operator">:=</span> MiddlewareBuilder<span class="token punctuation">{</span>
        Data<span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"你panic了"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        StatusCode<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
        Log<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"panic 路径: %s"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    server <span class="token operator">:=</span> web<span class="token punctuation">.</span><span class="token function">NewHTTPServer</span><span class="token punctuation">(</span>web<span class="token punctuation">.</span><span class="token function">ServerWithMiddleware</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"发生panic"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// web/middlewares/recover/middleware.go</span>
<span class="token keyword">package</span> <span class="token builtin">recover</span>

<span class="token keyword">import</span> <span class="token string">"web_framework/web"</span>

<span class="token keyword">type</span> MiddlewareBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    StatusCode <span class="token builtin">int</span>
    Data       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token comment" spellcheck="true">//Log func(err any)</span>
    Log <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//Log func(stack string)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> web<span class="token punctuation">.</span>Middleware <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next web<span class="token punctuation">.</span>HandleFunc<span class="token punctuation">)</span> web<span class="token punctuation">.</span>HandleFunc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> m<span class="token punctuation">.</span>Data
                    ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> m<span class="token punctuation">.</span>StatusCode
                    m<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="21-Middleware-总结和面试"><a href="#21-Middleware-总结和面试" class="headerlink" title="21. Middleware 总结和面试"></a>21. Middleware 总结和面试</h3><p><img src="d60c0fd6.png"><img src="70d990d7.png"><img src="00e5ce6a.png"><img src="28e9d109.png"><img src="fbb174fc.png"></p>
<h3 id="第二周作业"><a href="#第二周作业" class="headerlink" title="第二周作业"></a>第二周作业</h3><h1 id="09-第三周：Web-框架之页面渲染、文件处理与-Session"><a href="#09-第三周：Web-框架之页面渲染、文件处理与-Session" class="headerlink" title="09 第三周：Web 框架之页面渲染、文件处理与 Session"></a>09 第三周：Web 框架之页面渲染、文件处理与 Session</h1><h2 id="页面渲染"><a href="#页面渲染" class="headerlink" title="页面渲染"></a>页面渲染</h2><h3 id="1-页面渲染：模板引擎接口定义"><a href="#1-页面渲染：模板引擎接口定义" class="headerlink" title="1. 页面渲染：模板引擎接口定义"></a>1. 页面渲染：模板引擎接口定义</h3><p><img src="1e021740.png"><img src="ba83e091.png"><img src="f9572854.png"><img src="0d7ba5aa.png"><img src="6336e6bd.png"><br><img src="66a50c84.png"><img src="d90d6123.png"></p>
<h3 id="2-页面渲染：Template-语法"><a href="#2-页面渲染：Template-语法" class="headerlink" title="2. 页面渲染：Template 语法"></a>2. 页面渲染：Template 语法</h3><p><img src="8df5b09b.png"></p>
<blockquote>
<p>text/template在<strong>中间件</strong>中常用,比如grpc代码生成、谷歌依赖注入的wire、go不支持动态生成类型，所以动态代理一般用代码生成实现</p>
</blockquote>
<p><img src="6cf14708.png"><img src="0a7f4979.png"><img src="dd0a6e98.png"><img src="a4ebcfa1.png"><img src="b7796906.png"><img src="d3eff3ea.png"><br><img src="9b8a1467.png"><img src="990434ea.png"><img src="732fcc4e.png"><img src="74b645d4.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> template_demo

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"bytes"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"html/template"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestHelloWorld</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        Name <span class="token builtin">string</span>
    <span class="token punctuation">}</span>
    tpl <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"hello-world"</span><span class="token punctuation">)</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> tpl<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">`Hello, {{.Name}}`</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    buffer <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">=</span> tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">`Hello, Tom`</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestMapData</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tpl <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"hello-world"</span><span class="token punctuation">)</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> tpl<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">`Hello, {{.Name}}`</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    buffer <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">=</span> tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">`Hello, Tom`</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestSlice</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tpl <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"hello-world"</span><span class="token punctuation">)</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> tpl<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">`Hello, {{index . 0}}`</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    buffer <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">=</span> tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">`Hello, Tom`</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestBasic</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tpl <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"hello-world"</span><span class="token punctuation">)</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> tpl<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">`Hello, {{.}}`</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    buffer <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">=</span> tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">`Hello, 123`</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestInvoke</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tpl <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"hello-world"</span><span class="token punctuation">)</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> tpl<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">`打印数字: {{printf "%.2f" 1.2345}}\n切片长度: {{len .Slice}}\n{{.Hello "Tom" "Jerry"}}`</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    buffer <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">=</span> tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> FnCall<span class="token punctuation">{</span>Slice<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">`打印数字: 1.23\n切片长度: 2\nHello, Tom-Jerry`</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> FnCall <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Slice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f FnCall<span class="token punctuation">)</span> <span class="token function">Hello</span><span class="token punctuation">(</span>first <span class="token builtin">string</span><span class="token punctuation">,</span> last <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Hello, %s-%s"</span><span class="token punctuation">,</span> first<span class="token punctuation">,</span> last<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestFor</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tpl <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"hello-world"</span><span class="token punctuation">)</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> tpl<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">`
{{- range $idx, $ele := .Slice}}
{{- .}}
{{$idx}}-{{$ele}}
{{end}}`</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    buffer <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">=</span> tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> FnCall<span class="token punctuation">{</span>Slice<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">`a
0-a
b
1-b
`</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestForLoop</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tpl <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"hello-world"</span><span class="token punctuation">)</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> tpl<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">`
{{- range $idx, $ele := .}} 
{{- $idx}}
{{- end}}`</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    buffer <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">=</span> tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">`0123456789`</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestIfElse</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        Age <span class="token builtin">int</span>
    <span class="token punctuation">}</span>
    tpl <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"hello-world"</span><span class="token punctuation">)</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> tpl<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">`
{{- if and (gt .Age 0) (le .Age 6) -}}
儿童: (0, 6]
{{- else if and (gt .Age 6) (le .Age 18) -}}
少年: (6. 18]
{{- else -}}
成人: >18
{{- end -}}
`</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    buffer <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">=</span> tpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> User<span class="token punctuation">{</span>Age<span class="token punctuation">:</span> <span class="token number">14</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">`少年: (6. 18]`</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-页面渲染：GoTemplateEngin-实现、面试要点总结"><a href="#3-页面渲染：GoTemplateEngin-实现、面试要点总结" class="headerlink" title="3. 页面渲染：GoTemplateEngin 实现、面试要点总结"></a>3. 页面渲染：GoTemplateEngin 实现、面试要点总结</h3><p><img src="8ef1e249.png"><img src="a9868782.png"><img src="2905d2f4.png"><img src="56065ee9.png"><img src="a80e67ba.png"><img src="b5eac797.png"></p>
<blockquote>
<p>模板引擎涉及编译原理(解释执行)</p>
</blockquote>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// context.go</span>
<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    tplEngine TemplateEngine
    <span class="token comment" spellcheck="true">//cookieSameSite http.SameSite</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Render</span><span class="token punctuation">(</span>tplName <span class="token builtin">string</span><span class="token punctuation">,</span> data any<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    c<span class="token punctuation">.</span>RespData<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span>tplEngine<span class="token punctuation">.</span><span class="token function">Render</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tplName<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusOK
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// server.go</span>
<span class="token keyword">type</span> HTTPServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// addr string // 可以创建时传递，而不是通过start传，也是可以的</span>
    <span class="token comment" spellcheck="true">// router</span>
    router <span class="token comment" spellcheck="true">// 因为router实现了addRoute，所以也可以通过编译</span>

    mdls <span class="token punctuation">[</span><span class="token punctuation">]</span>Middleware

    log <span class="token keyword">func</span><span class="token punctuation">(</span>msg <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span>any<span class="token punctuation">)</span>

    tplEngine TemplateEngine
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">ServerWithTemplateEngine</span><span class="token punctuation">(</span>tplEngin TemplateEngine<span class="token punctuation">)</span> HTTPServerOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>server <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        server<span class="token punctuation">.</span>tplEngine <span class="token operator">=</span> tplEngin
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// http.Handler的接口</span>
<span class="token comment" spellcheck="true">// 核心方法 处理请求的入口</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HTTPServer<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 框架代码</span>
    ctx <span class="token operator">:=</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">{</span>
        Req<span class="token punctuation">:</span>       req<span class="token punctuation">,</span>
        Resp<span class="token punctuation">:</span>      w<span class="token punctuation">,</span>
        tplEngine<span class="token punctuation">:</span> h<span class="token punctuation">.</span>tplEngine<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// template_e2e_test.go</span>
<span class="token comment" spellcheck="true">//go:build e2e</span>

<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"html/template"</span>
    <span class="token string">"log"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestLoginPage</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">ParseGlob</span><span class="token punctuation">(</span><span class="token string">"testdata/tpls/*.gohtml"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    engine <span class="token operator">:=</span> <span class="token operator">&amp;</span>GoTemplateEngine<span class="token punctuation">{</span>
        T<span class="token punctuation">:</span> tpl<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    h <span class="token operator">:=</span> <span class="token function">NewHTTPServer</span><span class="token punctuation">(</span><span class="token function">ServerWithTemplateEngine</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Render</span><span class="token punctuation">(</span><span class="token string">"login.gohtml"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// template.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"bytes"</span>
    <span class="token string">"context"</span>
    <span class="token string">"html/template"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> TemplateEngine <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Render 渲染页面</span>
    <span class="token comment" spellcheck="true">// tplName 模板的名字,按名索引</span>
    <span class="token comment" spellcheck="true">// data 渲染页面用的数据</span>
    <span class="token function">Render</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> tplName <span class="token builtin">string</span><span class="token punctuation">,</span> data any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 渲染页面,数据写入writer</span>
    <span class="token comment" spellcheck="true">//Render(ctx context.Context, tplName string, data any,writer io.Writer) (  error)</span>

    <span class="token comment" spellcheck="true">// 用这个也行,但是会耦合</span>
    <span class="token comment" spellcheck="true">//Render(ctx Context)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> GoTemplateEngine <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    T <span class="token operator">*</span>template<span class="token punctuation">.</span>Template
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>GoTemplateEngine<span class="token punctuation">)</span> <span class="token function">Render</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> tplName <span class="token builtin">string</span><span class="token punctuation">,</span> data any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bs <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>
    err <span class="token operator">:=</span> g<span class="token punctuation">.</span>T<span class="token punctuation">.</span><span class="token function">ExecuteTemplate</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> tplName<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> bs<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<h2 id="文件处理"><a href="#文件处理" class="headerlink" title="文件处理"></a>文件处理</h2><h3 id="4-文件处理：文件基本操作"><a href="#4-文件处理：文件基本操作" class="headerlink" title="4. 文件处理：文件基本操作"></a>4. 文件处理：文件基本操作</h3><p><img src="d189856e.png"><img src="12543f85.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> file_demo

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"os"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestFile</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// working dir</span>
    <span class="token comment" spellcheck="true">// D:\go\projs\web_framework\web\file_demo &lt;nil></span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">Getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"testdata/my_file.txt"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
    n<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 读取了多少</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

    n<span class="token punctuation">,</span> err <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// bad file descriptor 不可写</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 不可写入</span>
    require<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// Access is denied.</span>
    <span class="token comment" spellcheck="true">// 写入了多少</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    f<span class="token punctuation">,</span> err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">"testdata/my_file.txt"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_APPEND<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModeAppend<span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    n<span class="token punctuation">,</span> err <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    f<span class="token punctuation">,</span> err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">"testdata/my_file_copy.txt"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    n<span class="token punctuation">,</span> err <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"hello, world"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-文件处理：文件上传"><a href="#5-文件处理：文件上传" class="headerlink" title="5. 文件处理：文件上传"></a>5. 文件处理：文件上传</h3><p><img src="8e7b9135.png"><img src="a896406c.png"><img src="b7637c23.png"><img src="b857cf23.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// file.go</span>
<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"io"</span>
    <span class="token string">"mime/multipart"</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"os"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> FileUploader <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    FileField <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 返回文件保存路径</span>
    <span class="token comment" spellcheck="true">// 如果框架来设名称要考虑重名问题(可以使用UUID解决)</span>
    DataPathFunc <span class="token keyword">func</span><span class="token punctuation">(</span>file <span class="token operator">*</span>multipart<span class="token punctuation">.</span>FileHeader<span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u FileUploader<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> HandleFunc <span class="token punctuation">{</span>
    <span class="token keyword">if</span> u<span class="token punctuation">.</span>FileField<span class="token operator">==</span><span class="token string">""</span><span class="token punctuation">{</span>
        u<span class="token punctuation">.</span>FileField<span class="token operator">=</span><span class="token string">"file"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> u<span class="token punctuation">.</span>DataPathFunc<span class="token operator">==</span><span class="token boolean">nil</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 设置默认值</span>
        u<span class="token punctuation">.</span>DataPathFunc<span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>file <span class="token operator">*</span>multipart<span class="token punctuation">.</span>FileHeader<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">"testdata"</span><span class="token punctuation">,</span> <span class="token string">"upload"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 上传文件的逻辑</span>
        <span class="token comment" spellcheck="true">// 1. 读取文件内容</span>
        <span class="token comment" spellcheck="true">/*
            // A FileHeader describes a file part of a multipart request.
            type FileHeader struct {
                Filename string
                Header   textproto.MIMEHeader
                Size     int64

                content   []byte
                tmpfile   string
                tmpoff    int64
                tmpshared bool
            }
        */</span>
        file<span class="token punctuation">,</span> fileHeader<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">FormFile</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>FileField<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> <span class="token number">500</span>
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"上传失败 "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 2. 计算目标路径</span>
        <span class="token comment" spellcheck="true">// 将目标路径计算的逻辑交给用户</span>
        dst <span class="token operator">:=</span> u<span class="token punctuation">.</span><span class="token function">DataPathFunc</span><span class="token punctuation">(</span>fileHeader<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 可以尝试把dst里不存在的目录都创建,防止报错</span>
        index <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">LastIndex</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">"\\"</span><span class="token punctuation">)</span>
        err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>dst<span class="token punctuation">[</span><span class="token punctuation">:</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"上传失败 "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// os.O_WRONLY 可写</span>
        <span class="token comment" spellcheck="true">// os.O_TRUNC 存在就清空</span>
        <span class="token comment" spellcheck="true">// os.O_CREATE 不存在就创建</span>
        dstFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_TRUNC<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token punctuation">,</span> 0o666<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"上传失败 "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">defer</span> dstFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 3. 保存文件</span>
        <span class="token comment" spellcheck="true">// buf(参数3)指定每次传输多大一段, 会影响性能</span>
        <span class="token comment" spellcheck="true">// 要考虑复用, 如果传nil, 有默认提供</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">CopyBuffer</span><span class="token punctuation">(</span>dstFile<span class="token punctuation">,</span> file<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"上传失败 "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 4. 返回响应</span>
        ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusOK
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"上传成功"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// file_e2e_test.go</span>
<span class="token comment" spellcheck="true">//go:build e2e</span>

<span class="token keyword">package</span> web

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"html/template"</span>
    <span class="token string">"log"</span>
    <span class="token string">"mime/multipart"</span>
    <span class="token string">"path/filepath"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestFileUpload</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">ParseGlob</span><span class="token punctuation">(</span><span class="token string">"testdata/tpls/*.gohtml"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    engine <span class="token operator">:=</span> <span class="token operator">&amp;</span>GoTemplateEngine<span class="token punctuation">{</span>
        T<span class="token punctuation">:</span> tpl<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    h <span class="token operator">:=</span> <span class="token function">NewHTTPServer</span><span class="token punctuation">(</span><span class="token function">ServerWithTemplateEngine</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Render</span><span class="token punctuation">(</span><span class="token string">"upload.gohtml"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    fu <span class="token operator">:=</span> FileUploader<span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 表单form的name属性</span>
        FileField<span class="token punctuation">:</span> <span class="token string">"myfile"</span><span class="token punctuation">,</span>
        DataPathFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>file <span class="token operator">*</span>multipart<span class="token punctuation">.</span>FileHeader<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">"testdata"</span><span class="token punctuation">,</span> <span class="token string">"upload"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    h<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">,</span> fu<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-html"><code class="language-html">// testdata/upload.gohtml
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/upload<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>myfile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>上传<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<p><img src="2b2ddd4e.png"><img src="daeb541a.png"></p>
<h3 id="6-文件处理：文件下载"><a href="#6-文件处理：文件下载" class="headerlink" title="6. 文件处理：文件下载"></a>6. 文件处理：文件下载</h3><p><img src="95a318fb.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// file_e2e_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestFileDownload</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    h <span class="token operator">:=</span> <span class="token function">NewHTTPServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fd <span class="token operator">:=</span> FileDownloader<span class="token punctuation">{</span>
        Dir<span class="token punctuation">:</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">"testdata"</span><span class="token punctuation">,</span> <span class="token string">"download"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    h<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/download"</span><span class="token punctuation">,</span> fd<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// file.go</span>
<span class="token keyword">type</span> FileDownloader <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Dir <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d FileDownloader<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> HandleFunc <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// xxx?file=xxx</span>
        filename<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">QueryValue</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusBadRequest
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"找不到目标文件"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 安全性提升(一点点)</span>
        filename <span class="token operator">=</span> filepath<span class="token punctuation">.</span><span class="token function">Clean</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        dst <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Dir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 转绝对路径(相对路径可能被拿到私密文件)</span>
        <span class="token comment" spellcheck="true">//dst,err=filepath.Abs(dst)</span>
        <span class="token comment" spellcheck="true">//if strings.Contains(d.Dir,filename){</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token comment" spellcheck="true">//}</span>
        fn <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Base</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span>

        header <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition"</span><span class="token punctuation">,</span> <span class="token string">"attachment;filename="</span><span class="token operator">+</span>fn<span class="token punctuation">)</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Description"</span><span class="token punctuation">,</span> <span class="token string">"File Transfer"</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 同样二进制文件</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">)</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Transfer-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"binary"</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 不会缓存</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Expires"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span> <span class="token string">"must-revalidate"</span><span class="token punctuation">)</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Pragma"</span><span class="token punctuation">,</span> <span class="token string">"public"</span><span class="token punctuation">)</span>

        http<span class="token punctuation">.</span><span class="token function">ServeFile</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">,</span> dst<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>现在的文件下载没有缓存, 而且没有对大文件的处理(分片[需要前后端配合])</p>
</blockquote>
<p><img src="52e06afb.png"></p>
<h3 id="7-文件处理：静态资源处理、面试要点总结"><a href="#7-文件处理：静态资源处理、面试要点总结" class="headerlink" title="7. 文件处理：静态资源处理、面试要点总结"></a>7. 文件处理：静态资源处理、面试要点总结</h3><p><img src="304283f3.png"><img src="a2db97cb.png"><img src="f0dfc32c.png"><img src="6a5ff7b2.png"><img src="fc9007a8.png"><br><img src="4a0d68b1.png"><img src="9dc907c1.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> StaticResourceHandlerOption <span class="token keyword">func</span><span class="token punctuation">(</span>handler <span class="token operator">*</span>StaticResourceHandler<span class="token punctuation">)</span>

<span class="token keyword">type</span> StaticResourceHandler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    dir <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 设置type防止有些浏览器无法解析文件</span>
    <span class="token comment" spellcheck="true">// 根据文件后缀名匹配type</span>
    extensionContextTypeMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    cache                   <span class="token operator">*</span>lru<span class="token punctuation">.</span>Cache <span class="token comment" spellcheck="true">// 缓存</span>
    maxSize                 <span class="token builtin">int</span>        <span class="token comment" spellcheck="true">// 大文件不缓存</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewStaticResourceHandler</span><span class="token punctuation">(</span>dir <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>StaticResourceHandlerOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>StaticResourceHandler<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// New(总共缓存多少个k-y)</span>
    cache<span class="token punctuation">,</span> err <span class="token operator">:=</span> lru<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>StaticResourceHandler<span class="token punctuation">{</span>
        dir<span class="token punctuation">:</span>     dir<span class="token punctuation">,</span>
        cache<span class="token punctuation">:</span>   cache<span class="token punctuation">,</span>
        maxSize<span class="token punctuation">:</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 10MB</span>
        extensionContextTypeMap<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
            <span class="token string">"jpeg"</span><span class="token punctuation">:</span> <span class="token string">"image/jpeg"</span><span class="token punctuation">,</span>
            <span class="token string">"jpg"</span><span class="token punctuation">:</span>  <span class="token string">"image/jpg"</span><span class="token punctuation">,</span>
            <span class="token string">"jpe"</span><span class="token punctuation">:</span>  <span class="token string">"image/jpeg"</span><span class="token punctuation">,</span>
            <span class="token string">"png"</span><span class="token punctuation">:</span>  <span class="token string">"image/png"</span><span class="token punctuation">,</span>
            <span class="token string">"pdf"</span><span class="token punctuation">:</span>  <span class="token string">"image/pdf"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">StaticWithMaxFileSize</span><span class="token punctuation">(</span>maxSize <span class="token builtin">int</span><span class="token punctuation">)</span> StaticResourceHandlerOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>handler <span class="token operator">*</span>StaticResourceHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handler<span class="token punctuation">.</span>maxSize <span class="token operator">=</span> maxSize
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">StaticWithCache</span><span class="token punctuation">(</span>c <span class="token operator">*</span>lru<span class="token punctuation">.</span>Cache<span class="token punctuation">)</span> StaticResourceHandlerOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>handler <span class="token operator">*</span>StaticResourceHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handler<span class="token punctuation">.</span>cache <span class="token operator">=</span> c
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">StaticWithMoreExtension</span><span class="token punctuation">(</span>extMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> StaticResourceHandlerOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>h <span class="token operator">*</span>StaticResourceHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> ext<span class="token punctuation">,</span> contenType <span class="token operator">:=</span> <span class="token keyword">range</span> extMap <span class="token punctuation">{</span>
            h<span class="token punctuation">.</span>extensionContextTypeMap<span class="token punctuation">[</span>ext<span class="token punctuation">]</span> <span class="token operator">=</span> contenType
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>StaticResourceHandler<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. 拿到目标文件名</span>
    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">PathValue</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusBadRequest
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"请求路径错误"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    dst <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>dir<span class="token punctuation">,</span> file<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// jpg/txt/video/audio ...</span>
    ext <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Ext</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    header <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> data<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>extensionContextTypeMap<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">)</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Web-Msg"</span><span class="token punctuation">,</span> <span class="token string">"from cache"</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> <span class="token number">200</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2. 定位到目标文件,读取</span>
    <span class="token comment" spellcheck="true">//dst := filepath.Join(s.dir, file)</span>
    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"服务器系统错误"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 缓存</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> s<span class="token punctuation">.</span>maxSize <span class="token punctuation">{</span>
        s<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 3. 返回</span>
    header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>extensionContextTypeMap<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">)</span>
    header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> data
    ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> <span class="token number">200</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// test</span>
<span class="token keyword">func</span> <span class="token function">TestStaticResourceHandler</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    h <span class="token operator">:=</span> <span class="token function">NewHTTPServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewStaticResourceHandler</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">"testdata"</span><span class="token punctuation">,</span> <span class="token string">"static"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// localhost:8081/static/xxx.jpg</span>
    h<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/static/:file"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>Handle<span class="token punctuation">)</span>
    h<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><h3 id="8-Session：概念与不同框架的-Session-设计分析"><a href="#8-Session：概念与不同框架的-Session-设计分析" class="headerlink" title="8. Session：概念与不同框架的 Session 设计分析"></a>8. Session：概念与不同框架的 Session 设计分析</h3><p><img src="f76b57bc.png"><img src="908081a7.png"><img src="9f69c9e6.png"><img src="035da272.png"><img src="99676c91.png"><br><img src="0c0ee5d9.png"><img src="be9352ef.png"><img src="886057a8.png" alt="flash很少用,讲师举例: 跳转页面有时携带临时的敏感数据可以考虑"><br><img src="7b6d97e8.png" alt="讲师推荐: 直接用gorilla"><br><img src="e50c622a.png" alt="gorilla缓存session,是为了防止太多session每次都写如磁盘会影响性能"><br><img src="d395e58b.png"><img src="2fba7446.png"><img src="81621040.png"><img src="e784f316.png"><br><img src="98abba38.png"><img src="fd9ccf92.png" alt="核心接口(单一职责)不需要很多方法"><img src="9173dac7.png"><img src="a6779562.png"></p>
<h3 id="9-Session：接口设计"><a href="#9-Session：接口设计" class="headerlink" title="9. Session：接口设计"></a>9. Session：接口设计</h3><p><img src="0de844b8.png"><img src="82c8a650.png"><img src="6670a75e.png"><img src="74de0d95.png"><img src="edacb0e9.png"><br><img src="05510189.png"><img src="3e675a60.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// session/types.go</span>
<span class="token keyword">package</span> session

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"net/http"</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 管理session本身</span>
<span class="token keyword">type</span> Store <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Session对应的id谁来指定 ? 要不要让session内部生成id</span>
    <span class="token comment" spellcheck="true">// 要不要在接口维度上设置超时时间</span>
<span class="token function">Generate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>id <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Session<span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token function">Refresh</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>id <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token builtin">error</span>
<span class="token function">Remove</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>id <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token builtin">error</span>
<span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>id <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Session<span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Session <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>key <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>any<span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">Set</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>key <span class="token builtin">string</span><span class="token punctuation">,</span>val <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token builtin">error</span>
    <span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Propagator <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Inject</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span>writer http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">)</span><span class="token builtin">error</span>
    <span class="token function">Extract</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">Remove</span><span class="token punctuation">(</span>writer http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="10-Session：用户使用示例和-Manager-设计"><a href="#10-Session：用户使用示例和-Manager-设计" class="headerlink" title="10. Session：用户使用示例和 Manager 设计"></a>10. Session：用户使用示例和 Manager 设计</h3><p><img src="dfc5d39c.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// types_test.go</span>
<span class="token keyword">package</span> session

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"testing"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSession</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 简单的登录检验</span>
    <span class="token keyword">var</span> m Manager
    server <span class="token operator">:=</span> web<span class="token punctuation">.</span><span class="token function">NewHTTPServer</span><span class="token punctuation">(</span>web<span class="token punctuation">.</span><span class="token function">ServerWithMiddleware</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>next web<span class="token punctuation">.</span>HandleFunc<span class="token punctuation">)</span> web<span class="token punctuation">.</span>HandleFunc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">==</span> <span class="token string">"/login"</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 放行,让用户登录</span>
                <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">GetSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusUnauthorized
                ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"请重新登录"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 刷新session过期时间</span>
            <span class="token boolean">_</span> <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">RefreshSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    server<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 在session之前校验用户名密码</span>

        sess<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InitSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"登录失败"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        err <span class="token operator">=</span> sess<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"nickname"</span><span class="token punctuation">,</span> <span class="token string">"xiaoming"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"登录失败"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusOK
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"登录成功"</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    server<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 清理数据</span>
        err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">RemoveSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"退出失败"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusOK
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"退出成功"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    server<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sess<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">GetSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusUnauthorized
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"请重新登录"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        sess<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"nickname"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// types.go</span>
<span class="token keyword">package</span> session

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"net/http"</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 管理session本身</span>
<span class="token keyword">type</span> Store <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Session对应的id谁来指定 ? 要不要让session内部生成id</span>
    <span class="token comment" spellcheck="true">// 要不要在接口维度上设置超时时间</span>
    <span class="token function">Generate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">Refresh</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">Remove</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Session <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">Set</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> val <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Propagator <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Inject</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> writer http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">Extract</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">Remove</span><span class="token punctuation">(</span>writer http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// manager.go</span>
<span class="token keyword">package</span> session

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/google/uuid"</span>
    <span class="token string">"web_framework/web"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Manager <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Propagator
    Store
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">GetSession</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sessId<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sessId<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">InitSession</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    id <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sess<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Generate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 注入进去响应</span>
    err <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">Inject</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">)</span>
    <span class="token keyword">return</span> sess<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">RemoveSession</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    sess<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">GetSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    err <span class="token operator">=</span> m<span class="token punctuation">.</span>Store<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    err <span class="token operator">=</span> m<span class="token punctuation">.</span>Propagator<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Resp<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">RefreshSession</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    sess<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">GetSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 这里假设session的id不会变</span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="11-Session：web-Context-缓存-Session"><a href="#11-Session：web-Context-缓存-Session" class="headerlink" title="11. Session：web.Context 缓存 Session"></a>11. Session：web.Context 缓存 Session</h3><p><img src="5764f9b7.png"><img src="564028c7.png"><img src="adf0cf0b.png"><img src="f47de357.png"><img src="c7c99751.png"><img src="45f57cb5.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// context.go</span>
<span class="token keyword">type</span> Context <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    UserValues <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any <span class="token comment" spellcheck="true">// 缓存</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// session/manager.go</span>
<span class="token keyword">type</span> Manager <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Propagator
    Store
    CtxSessKey <span class="token builtin">string</span> <span class="token comment" spellcheck="true">// 在ctx缓存中的key</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">GetSession</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> ctx<span class="token punctuation">.</span>UserValues <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>UserValues <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 从缓存中拿</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span>UserValues<span class="token punctuation">[</span>m<span class="token punctuation">.</span>CtxSessKey<span class="token punctuation">]</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span>Session<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    sessId<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    sess<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sessId<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 设置缓存</span>
    ctx<span class="token punctuation">.</span>UserValues<span class="token punctuation">[</span>m<span class="token punctuation">.</span>CtxSessKey<span class="token punctuation">]</span> <span class="token operator">=</span> sess
    <span class="token keyword">return</span> sess<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<h3 id="12-Session：基于内存的实现"><a href="#12-Session：基于内存的实现" class="headerlink" title="12. Session：基于内存的实现"></a>12. Session：基于内存的实现</h3><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// momery/session.go</span>
<span class="token keyword">package</span> momery

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"errors"</span>
    <span class="token string">"fmt"</span>
    cache <span class="token string">"github.com/patrickmn/go-cache"</span>
    <span class="token string">"sync"</span>
    <span class="token string">"time"</span>
    <span class="token string">"web_framework/web/session"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
    errKeyNotFound     <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"session: 找不到key"</span><span class="token punctuation">)</span>
    errSessionNotFound <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"session: 找不到session"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Store <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    mutex      sync<span class="token punctuation">.</span>RWMutex
    sessions   <span class="token operator">*</span>cache<span class="token punctuation">.</span>Cache
    expiration time<span class="token punctuation">.</span>Duration
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewStore</span><span class="token punctuation">(</span>expiration time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token operator">*</span>Store <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Store<span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 缓存过期时间,检查间隔</span>
        sessions<span class="token punctuation">:</span>   cache<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>expiration<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">,</span>
        expiration<span class="token punctuation">:</span> expiration<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Store<span class="token punctuation">)</span> <span class="token function">Generate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 防止在generate的时候有refresh</span>
    s<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> s<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sess <span class="token operator">:=</span> <span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 存起来</span>
    s<span class="token punctuation">.</span>sessions<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> sess<span class="token punctuation">,</span> s<span class="token punctuation">.</span>expiration<span class="token punctuation">)</span>
    <span class="token keyword">return</span> sess<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Store<span class="token punctuation">)</span> <span class="token function">Refresh</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> s<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>sessions<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"session: 该 id 对应的 session 不存在 %s"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span>sessions<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> val<span class="token punctuation">,</span> s<span class="token punctuation">.</span>expiration<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Store<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> s<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>sessions<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Store<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> s<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sess<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>sessions<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errSessionNotFound
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sess<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Session<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Session <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    id         <span class="token builtin">string</span>
    expiration time<span class="token punctuation">.</span>Duration

    <span class="token comment" spellcheck="true">// 控制性强</span>
    <span class="token comment" spellcheck="true">//mutex sync.RWMutex</span>
    <span class="token comment" spellcheck="true">//values map[string]any</span>

    values sync<span class="token punctuation">.</span>Map
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ctrl+I 快捷实现接口</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s Session<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>values<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//return nil, fmt.Errorf("%w, key %s", errKeyNotFound,key)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errKeyNotFound
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> val<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 和第三方交互可以考虑加context</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s Session<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> val <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>values<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Session<span class="token punctuation">)</span> <span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 只读不用太考虑线程安全的问题</span>
    <span class="token keyword">return</span> s<span class="token punctuation">.</span>id
<span class="token punctuation">}</span>
</code></pre>
<h3 id="13-Session：基于-Redis-的实现"><a href="#13-Session：基于-Redis-的实现" class="headerlink" title="13. Session：基于 Redis 的实现"></a>13. Session：基于 Redis 的实现</h3><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// session_e2e_test.go</span>
<span class="token comment" spellcheck="true">//go:build e2e</span>
<span class="token keyword">package</span> redis

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"github.com/redis/go-redis/v9"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestStore_Generate</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> <span class="token function">newStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    id <span class="token operator">:=</span> <span class="token string">"sess_test_id"</span>
    sess<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Generate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    err <span class="token operator">=</span> sess<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    val<span class="token punctuation">,</span> err <span class="token operator">:=</span> sess<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"key1"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Store <span class="token punctuation">{</span>
    rc <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
        Addr<span class="token punctuation">:</span>     <span class="token string">"localhost:6379"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">// Password: "redis",</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">NewStore</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// redis/session.go</span>
<span class="token keyword">package</span> redis

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"errors"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"github.com/redis/go-redis/v9"</span>
    <span class="token string">"time"</span>
    <span class="token string">"web_framework/web/session"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
    errSessionNotFound <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"session: id 对应的 session 不存在"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> StoreOption <span class="token keyword">func</span><span class="token punctuation">(</span>store <span class="token operator">*</span>Store<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// hset</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//    sessionid: key: value</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">// map[string]map[string]string</span>
<span class="token keyword">type</span> Store <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    prefix     <span class="token builtin">string</span>
    client     redis<span class="token punctuation">.</span>Cmdable
    expiration time<span class="token punctuation">.</span>Duration
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewStore</span><span class="token punctuation">(</span>client redis<span class="token punctuation">.</span>Cmdable<span class="token punctuation">,</span> opts <span class="token operator">...</span>StoreOption<span class="token punctuation">)</span> <span class="token operator">*</span>Store <span class="token punctuation">{</span>
    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>Store<span class="token punctuation">{</span>
        expiration<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Minute <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">,</span>
        client<span class="token punctuation">:</span>     client<span class="token punctuation">,</span>
        prefix<span class="token punctuation">:</span>     <span class="token string">"sessid"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// StoreWithPrefix 用户可以设置自己的prefix</span>
<span class="token keyword">func</span> <span class="token function">StoreWithPrefix</span><span class="token punctuation">(</span>prefix <span class="token builtin">string</span><span class="token punctuation">)</span> StoreOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>store <span class="token operator">*</span>Store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span>prefix <span class="token operator">=</span> prefix
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Store<span class="token punctuation">)</span> <span class="token function">Generate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    key <span class="token operator">:=</span> <span class="token function">redisKey</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 如果是用lua脚本,就线程安全</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">HSet</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> id<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> s<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Expire</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> s<span class="token punctuation">.</span>expiration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>
        id<span class="token punctuation">:</span>     id<span class="token punctuation">,</span>
        key<span class="token punctuation">:</span>    key<span class="token punctuation">,</span>
        client<span class="token punctuation">:</span> s<span class="token punctuation">.</span>client<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Store<span class="token punctuation">)</span> <span class="token function">Refresh</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    key <span class="token operator">:=</span> <span class="token function">redisKey</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Expire</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> s<span class="token punctuation">.</span>expiration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errSessionNotFound
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Store<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    key <span class="token operator">:=</span> <span class="token function">redisKey</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Del</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> err
    <span class="token comment" spellcheck="true">//if err != nil {</span>
    <span class="token comment" spellcheck="true">//    return err</span>
    <span class="token comment" spellcheck="true">//}</span>
    <span class="token comment" spellcheck="true">// 代表id对应的session不存在</span>
    <span class="token comment" spellcheck="true">//if cnt == 0 {</span>
    <span class="token comment" spellcheck="true">//}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Store<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>session<span class="token punctuation">.</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 自由决策要不要提取把session存储的用户数据全部提取</span>
    <span class="token comment" spellcheck="true">// 1. 都不拿 // 2. 只拿高频数据(热点数据) // 3. 都拿</span>
    key <span class="token operator">:=</span> <span class="token function">redisKey</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    cnt<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> cnt <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errSessionNotFound
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>
        id<span class="token punctuation">:</span>     id<span class="token punctuation">,</span>
        key<span class="token punctuation">:</span>    key<span class="token punctuation">,</span>
        client<span class="token punctuation">:</span> s<span class="token punctuation">.</span>client<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Session <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    prefix <span class="token builtin">string</span>
    key    <span class="token builtin">string</span>
    id     <span class="token builtin">string</span>
    client redis<span class="token punctuation">.</span>Cmdable
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Session<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//    const lua=`</span>
    <span class="token comment" spellcheck="true">//if redis.call("exists", KEYS[1])</span>
    <span class="token comment" spellcheck="true">//then</span>
    <span class="token comment" spellcheck="true">//    return redis.call("hset", KEYS[1], ARGV[1], ARGV[2])</span>
    <span class="token comment" spellcheck="true">//else</span>
    <span class="token comment" spellcheck="true">//    return -1</span>
    <span class="token comment" spellcheck="true">//end</span>
    <span class="token comment" spellcheck="true">//`</span>
    val<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">HGet</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> s<span class="token punctuation">.</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> val<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Session<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> val <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// KEYS[1] => s.id</span>
    <span class="token keyword">const</span> lua <span class="token operator">=</span> <span class="token string">`
if redis.call("exists", KEYS[1])
then
    return redis.call("hset", KEYS[1], ARGV[1], ARGV[2])
else 
    return -1
end
`</span>
    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> lua<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>s<span class="token punctuation">.</span>key<span class="token punctuation">}</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> res <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errSessionNotFound
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s Session<span class="token punctuation">)</span> <span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">.</span>id
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">redisKey</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s-%s"</span><span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="14-Session：基于-Cookie-的实现"><a href="#14-Session：基于-Cookie-的实现" class="headerlink" title="14. Session：基于 Cookie 的实现"></a>14. Session：基于 Cookie 的实现</h3><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// cookie/propagator</span>
<span class="token keyword">package</span> cookie

<span class="token keyword">import</span> <span class="token string">"net/http"</span>

<span class="token keyword">type</span> Option <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>Propagator<span class="token punctuation">)</span>

<span class="token keyword">type</span> Propagator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    cookieName   <span class="token builtin">string</span>
    cookieOption <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewPropagator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Propagator <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Propagator<span class="token punctuation">{</span>
        cookieName<span class="token punctuation">:</span> <span class="token string">"sessid"</span><span class="token punctuation">,</span>
        cookieOption<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 推荐设置cookie的属性: Domain/Secure/SameSite/HttpOnly</span>
<span class="token keyword">func</span> <span class="token function">WithCookieName</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> Option <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>Propagator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>cookieName <span class="token operator">=</span> name
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Propagator<span class="token punctuation">)</span> <span class="token function">Inject</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> writer http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>  p<span class="token punctuation">.</span>cookieName<span class="token punctuation">,</span>
        Value<span class="token punctuation">:</span> id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 用户可以通过这个对cookie进行操作</span>
    p<span class="token punctuation">.</span><span class="token function">cookieOption</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    http<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Propagator<span class="token punctuation">)</span> <span class="token function">Extract</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cookie<span class="token punctuation">,</span> err <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>cookieName<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cookie<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Propagator<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>writer http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span>   p<span class="token punctuation">.</span>cookieName<span class="token punctuation">,</span>
        MaxAge<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 设置为过期状态</span>
    <span class="token punctuation">}</span>
    http<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="15-Session：测试与面试要点总结"><a href="#15-Session：测试与面试要点总结" class="headerlink" title="15. Session：测试与面试要点总结"></a>15. Session：测试与面试要点总结</h3><p><img src="678d4d86.png"><img src="87f8fd74.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// test/types_test.go</span>
<span class="token keyword">package</span> test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"net/http"</span>
    <span class="token string">"testing"</span>
    <span class="token string">"time"</span>
    <span class="token string">"web_framework/web"</span>
    <span class="token string">"web_framework/web/session"</span>
    <span class="token string">"web_framework/web/session/cookie"</span>
    <span class="token string">"web_framework/web/session/memory"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSession</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 简单的登录检验</span>
    <span class="token keyword">var</span> m <span class="token operator">*</span>session<span class="token punctuation">.</span>Manager <span class="token operator">=</span> <span class="token operator">&amp;</span>session<span class="token punctuation">.</span>Manager<span class="token punctuation">{</span>
        Propagator<span class="token punctuation">:</span> cookie<span class="token punctuation">.</span><span class="token function">NewPropagator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Store<span class="token punctuation">:</span>      memory<span class="token punctuation">.</span><span class="token function">NewStore</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Minute <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        CtxSessKey<span class="token punctuation">:</span> <span class="token string">"sessKey"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    server <span class="token operator">:=</span> web<span class="token punctuation">.</span><span class="token function">NewHTTPServer</span><span class="token punctuation">(</span>web<span class="token punctuation">.</span><span class="token function">ServerWithMiddleware</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>next web<span class="token punctuation">.</span>HandleFunc<span class="token punctuation">)</span> web<span class="token punctuation">.</span>HandleFunc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">==</span> <span class="token string">"/login"</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 放行,让用户登录</span>
                <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">GetSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusUnauthorized
                ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"请重新登录"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 刷新session过期时间</span>
            <span class="token boolean">_</span> <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">RefreshSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    server<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 在session之前校验用户名密码</span>

        sess<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">InitSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"登录失败"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        err <span class="token operator">=</span> sess<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"nickname"</span><span class="token punctuation">,</span> <span class="token string">"xiaoming"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"登录失败"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusOK
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"登录成功"</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    server<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 清理数据</span>
        err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">RemoveSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusInternalServerError
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"退出失败"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusOK
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"退出成功"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    server<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>web<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sess<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">GetSession</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span>RespStatusCode <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusUnauthorized
            ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"请重新登录"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        val<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> sess<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"nickname"</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>RespData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":8081"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>出bug了</p>
</blockquote>
<p><img src="f7fbcdab.png"><img src="079e1706.png"><img src="bfb3b4fc.png"><img src="2b81b295.png"><img src="4e8c6202.png"><img src="7e506f34.png"></p>
<h1 id="10-第四周：ORM-框架之-SELECT-与元数据"><a href="#10-第四周：ORM-框架之-SELECT-与元数据" class="headerlink" title="10 第四周：ORM 框架之 SELECT 与元数据"></a>10 第四周：ORM 框架之 SELECT 与元数据</h1><h2 id="ORM概览"><a href="#ORM概览" class="headerlink" title="ORM概览"></a>ORM概览</h2><h3 id="1-ORM-学习路线图"><a href="#1-ORM-学习路线图" class="headerlink" title="1. ORM 学习路线图"></a>1. ORM 学习路线图</h3><p><img src="ee1efe76.png"></p>
<h3 id="2-ORM-框架概览：Beego-ORM-分析"><a href="#2-ORM-框架概览：Beego-ORM-分析" class="headerlink" title="2. ORM 框架概览：Beego ORM 分析"></a>2. ORM 框架概览：Beego ORM 分析</h3><p><img src="ed5290dc.png"><img src="ad7a2dee.png"><img src="4065cd84.png"><img src="6201eabc.png"><img src="e9858538.png"></p>
<h3 id="3-ORM-框架概览：GORM-和-Ent-分析"><a href="#3-ORM-框架概览：GORM-和-Ent-分析" class="headerlink" title="3. ORM 框架概览：GORM 和 Ent 分析"></a>3. ORM 框架概览：GORM 和 Ent 分析</h3><p><img src="23fcc2f0.png"><img src="b1f90aea.png"><img src="e77b5308.png"><img src="86942299.png"><br><img src="82175cc1.png" alt="go的语言特性限制了动态代理,一般go中都用代码生成来实现"><img src="c16c5071.png"></p>
<h3 id="4-ORM-框架总结和面试要点"><a href="#4-ORM-框架总结和面试要点" class="headerlink" title="4. ORM 框架总结和面试要点"></a>4. ORM 框架总结和面试要点</h3><p><img src="e8442463.png"><img src="bbb76c64.png"><img src="4f9cd6e9.png"><img src="0f0d5f0a.png"></p>
<h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><h3 id="5-SELECT：Beego、GORM、Ent-的-SQL构造分析"><a href="#5-SELECT：Beego、GORM、Ent-的-SQL构造分析" class="headerlink" title="5. SELECT：Beego、GORM、Ent 的 SQL构造分析"></a>5. SELECT：Beego、GORM、Ent 的 SQL构造分析</h3><p><img src="92bccf77.png"><img src="14b8091f.png" alt="可读性差,可扩展性差"><img src="c4cd4ea6.png"><img src="39af2524.png"><br><img src="e9c81ac6.png"><img src="87ae72e3.png"><img src="f8ccdc7e.png"></p>
<h3 id="6-SELECT：核心接口定义"><a href="#6-SELECT：核心接口定义" class="headerlink" title="6. SELECT：核心接口定义"></a>6. SELECT：核心接口定义</h3><p><img src="97fc1fb1.png"><img src="50acafc3.png" alt="这种的query是一次性的,可以用泛型,而前一种的Orm要多个不同表复用,就不好用泛型"><br><img src="e625f4be.png"><img src="0f58204f.png"><img src="9443e121.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// org/types.go</span>
<span class="token keyword">package</span> orm

<span class="token comment" spellcheck="true">// context 包是Go 1.7 引入的标准库，</span>
<span class="token comment" spellcheck="true">// 主要用于在goroutine 之间传递取消信号、超时时间、截止时间以及一些共享的值等。</span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"database/sql"</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// Querier 用于select</span>
<span class="token keyword">type</span> Querier<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 用不用指针(*)都可以</span>
    <span class="token comment" spellcheck="true">// 反射,aop之类的用指针方便点</span>
    <span class="token comment" spellcheck="true">// 指针可能存在内存逃逸问题</span>
    <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">GetMulti</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Executor 用于 INSERT DELETE UPDATE</span>
<span class="token keyword">type</span> Executor <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Exec</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>sql<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> QueryBuilder <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Query <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    SQL  <span class="token builtin">string</span>
    Args <span class="token punctuation">[</span><span class="token punctuation">]</span>any
<span class="token punctuation">}</span>
</code></pre>
<h3 id="7-SELECT：SELECT-语句规范、Selector-定义、FROM-语句实现"><a href="#7-SELECT：SELECT-语句规范、Selector-定义、FROM-语句实现" class="headerlink" title="7. SELECT：SELECT 语句规范、Selector 定义、FROM 语句实现"></a>7. SELECT：SELECT 语句规范、Selector 定义、FROM 语句实现</h3><p><img src="d8069fff.png" alt="sql规范,可以有人遵守有人不遵守,所以不同数据库可能sql是不同的"><br><img src="87e93f03.png"><img src="2098fadb.png"><img src="b92529a9.png"><img src="1cfd1bb2.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSelector_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        builder QueryBuilder

        wantQuery <span class="token operator">*</span>Query
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"not from"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `TestModel`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"from"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"`test_model`"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"empty from"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `TestModel`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"empty table"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `TestModel`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"db table"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"`mybatis`.`test`"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `mybatis`.`test`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TestModel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id        <span class="token builtin">int64</span>
    FirstName <span class="token builtin">string</span>
    Age       <span class="token builtin">int8</span>
    LastName  <span class="token operator">*</span>sql<span class="token punctuation">.</span>NullString
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Selector<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    table <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> sb strings<span class="token punctuation">.</span>Builder
    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM "</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 反射获取表名</span>
        <span class="token keyword">var</span> t T
        typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>typ<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//segs := strings.Split(s.table, ".")</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>table<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span> sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//    func (s *Selector[T]) From(table string) *Selector[T] {</span>
<span class="token comment" spellcheck="true">//        s.table = table</span>
<span class="token comment" spellcheck="true">//        return s</span>
<span class="token comment" spellcheck="true">//    }</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Table</span><span class="token punctuation">(</span>table <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>table <span class="token operator">=</span> table
    <span class="token keyword">return</span> s
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//TODO implement me</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"implement me"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">GetMulti</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//TODO implement me</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"implement me"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="8-SELECT：WHRER-语句、Expression-抽象和面试要点"><a href="#8-SELECT：WHRER-语句、Expression-抽象和面试要点" class="headerlink" title="8. SELECT：WHRER 语句、Expression 抽象和面试要点"></a>8. SELECT：WHRER 语句、Expression 抽象和面试要点</h3><p><img src="cf7209ec.png"><img src="956c173e.png" alt="不定参数传递要解包,这个容易踩坑,可以通过golint-ci等代码检测工具来检查"><br><img src="eeb4075a.png"><img src="5b6b9215.png"><img src="5c445891.png"><img src="ebed95c8.png"><img src="334e4f73.png"><br><img src="22831ff1.png"><img src="1a0d44c4.png"><img src="514ddccd.png"><img src="b3922caf.png"><img src="ec447a38.png"><br><img src="03f4fb21.png"><img src="23c27e62.png"><img src="3afd9425.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Selector<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    table <span class="token builtin">string</span>
    where <span class="token punctuation">[</span><span class="token punctuation">]</span>Predicate
    sb    <span class="token operator">*</span>strings<span class="token punctuation">.</span>Builder
    args  <span class="token punctuation">[</span><span class="token punctuation">]</span>any
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//var sb strings.Builder</span>
    s<span class="token punctuation">.</span>sb <span class="token operator">=</span> <span class="token operator">&amp;</span>strings<span class="token punctuation">.</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 指针类型一定要初始化</span>
    sb <span class="token operator">:=</span> s<span class="token punctuation">.</span>sb
    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM "</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 反射获取表名</span>
        <span class="token keyword">var</span> t T
        typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>typ<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//segs := strings.Split(s.table, ".")</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>table<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>where<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" WHERE "</span><span class="token punctuation">)</span>
        p <span class="token operator">:=</span> s<span class="token punctuation">.</span>where<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>where<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>where<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span>  sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Args<span class="token punctuation">:</span> s<span class="token punctuation">.</span>args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">buildExpression</span><span class="token punctuation">(</span>expr Expression<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> exp <span class="token operator">:=</span> expr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
    <span class="token keyword">case</span> Predicate<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// 处理p</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> exp<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token punctuation">(</span>Predicate<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>op<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>

        <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">=</span> exp<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token punctuation">(</span>Predicate<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> Column<span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token keyword">case</span> value<span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"orm: 不支持的表达式类型 %v"</span><span class="token punctuation">,</span> expr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">addArg</span><span class="token punctuation">(</span>val any<span class="token punctuation">)</span> <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>args <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        s<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>args<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
    <span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Where</span><span class="token punctuation">(</span>ps <span class="token operator">...</span>Predicate<span class="token punctuation">)</span> <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>where <span class="token operator">=</span> ps
    <span class="token keyword">return</span> s
<span class="token punctuation">}</span> 
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// predicate.go</span>
<span class="token keyword">package</span> orm

<span class="token comment" spellcheck="true">// 衍生类型</span>
<span class="token keyword">type</span> op <span class="token builtin">string</span>

<span class="token comment" spellcheck="true">// 别名</span>
<span class="token comment" spellcheck="true">//type op =string</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    opEq  op <span class="token operator">=</span> <span class="token string">"="</span>
    opNot op <span class="token operator">=</span> <span class="token string">"NOT"</span>
    opAnd op <span class="token operator">=</span> <span class="token string">"AND"</span>
    opOr  op <span class="token operator">=</span> <span class="token string">"OR"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o op<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Predicate <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    left  Expression
    op    op
    right Expression
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Eq("id",12)</span>
<span class="token comment" spellcheck="true">// Eq(sub,"id",12)</span>
<span class="token comment" spellcheck="true">// Eq(sub.id,12)</span>
<span class="token comment" spellcheck="true">// Eq("sub.id",12)</span>
<span class="token comment" spellcheck="true">//func Eq(column string, arg any) Predicate {</span>
<span class="token comment" spellcheck="true">//    return Predicate{</span>
<span class="token comment" spellcheck="true">//        Column: column,</span>
<span class="token comment" spellcheck="true">//        Op:     "=",</span>
<span class="token comment" spellcheck="true">//        Arg:    arg,</span>
<span class="token comment" spellcheck="true">//    }</span>
<span class="token comment" spellcheck="true">//}</span>

<span class="token keyword">type</span> Column <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">C</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> Column <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Column<span class="token punctuation">{</span>name<span class="token punctuation">:</span> name<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// C("id").Eq(12)</span>
<span class="token comment" spellcheck="true">// sub.C("id").Eq(12)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c Column<span class="token punctuation">)</span> <span class="token function">Eq</span><span class="token punctuation">(</span>arg any<span class="token punctuation">)</span> Predicate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Predicate<span class="token punctuation">{</span>
        left<span class="token punctuation">:</span>  c<span class="token punctuation">,</span>
        op<span class="token punctuation">:</span>    opEq<span class="token punctuation">,</span>
        right<span class="token punctuation">:</span> value<span class="token punctuation">{</span>val<span class="token punctuation">:</span> arg<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>Column<span class="token punctuation">)</span> <span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Not Not(C("name").Eq("Tom"))</span>
<span class="token keyword">func</span> <span class="token function">Not</span><span class="token punctuation">(</span>p Predicate<span class="token punctuation">)</span> Predicate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Predicate<span class="token punctuation">{</span>
        op<span class="token punctuation">:</span>    opNot<span class="token punctuation">,</span>
        right<span class="token punctuation">:</span> p<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// And C("id").Eq(12).And(C("name").Eq("Tom"))</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>left Predicate<span class="token punctuation">)</span> <span class="token function">And</span><span class="token punctuation">(</span>right Predicate<span class="token punctuation">)</span> Predicate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Predicate<span class="token punctuation">{</span>
        left<span class="token punctuation">:</span>  left<span class="token punctuation">,</span>
        op<span class="token punctuation">:</span>    opAnd<span class="token punctuation">,</span>
        right<span class="token punctuation">:</span> right<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// And C("id").Eq(12).Or(C("name").Eq("Tom"))</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>left Predicate<span class="token punctuation">)</span> <span class="token function">Or</span><span class="token punctuation">(</span>right Predicate<span class="token punctuation">)</span> Predicate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Predicate<span class="token punctuation">{</span>
        left<span class="token punctuation">:</span>  left<span class="token punctuation">,</span>
        op<span class="token punctuation">:</span>    opOr<span class="token punctuation">,</span>
        right<span class="token punctuation">:</span> right<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>Predicate<span class="token punctuation">)</span> <span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Expression 是一个标记接口,代表表达式</span>
<span class="token keyword">type</span> Expression <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> value <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    val any
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSelector_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        builder QueryBuilder

        wantQuery <span class="token operator">*</span>Query
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"where"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `TestModel` WHERE `Age` = ?;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"empty where"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `TestModel`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"not"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">Not</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `TestModel` WHERE  NOT (`Age` = ?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"and"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `TestModel` WHERE (`Age` = ?) AND (`FirstName` = ?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"and"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `TestModel` WHERE (`Age` = ?) OR (`FirstName` = ?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TestModel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id        <span class="token builtin">int64</span>
    FirstName <span class="token builtin">string</span>
    Age       <span class="token builtin">int8</span>
    LastName  <span class="token operator">*</span>sql<span class="token punctuation">.</span>NullString
<span class="token punctuation">}</span>
</code></pre>
<h2 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h2><h3 id="9-元数据简介"><a href="#9-元数据简介" class="headerlink" title="9. 元数据简介"></a>9. 元数据简介</h3><p><img src="0ff87df0.png"><img src="797c588e.png"><img src="c7b30bb2.png"><img src="700fe335.png"><img src="05ef406c.png"><br><img src="2d447406.png"><img src="ba6bca1b.png"><img src="ded4ae0d.png"><img src="8e2047af.png"><img src="a00b1b61.png"><br><img src="22186c5d.png"><img src="eef54378.png"></p>
<h3 id="10-元数据：反射-读字段"><a href="#10-元数据：反射-读字段" class="headerlink" title="10. 元数据：反射-读字段"></a>10. 元数据：反射-读字段</h3><blockquote>
<p>构建中间件必备: 反射 unsafe技术 抽象语法树ast 模板(代码生成等)</p>
</blockquote>
<p><img src="0fdd146f.png"><img src="6d2b248c.png"><img src="50d2aded.png"><img src="61412411.png"><br><img src="3f37fb78.png" alt="取指针对应的elem"><img src="dfb4fbca.png"><img src="c5878fe1.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// field_test.go</span>
<span class="token keyword">package</span> reflect

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"errors"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestIterateFields</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        Name <span class="token builtin">string</span>
        age  <span class="token builtin">int</span>
    <span class="token punctuation">}</span>

    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity any

        wantErr <span class="token builtin">error</span>
        wantRes <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"struct"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> User<span class="token punctuation">{</span>
                Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
                age<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantRes<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span>
                <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">// 私有的无法反射获取,用0值填充</span>
                <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
                Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
                age<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantRes<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span>
                <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">// 私有的无法反射获取,用0值填充</span>
                <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不支持类型"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"multiple pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token operator">*</span>User <span class="token punctuation">{</span>
                res <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
                    Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
                    age<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>res
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantRes<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span>
                <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">// 私有的无法反射获取,用0值填充</span>
                <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"multiple pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span>  <span class="token boolean">nil</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不支持 nil"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"multiple pointer"</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 给nil转为User类型,通过了nil和非struct检查</span>
            entity<span class="token punctuation">:</span>  <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不支持零值"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">IterateFields</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantRes<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// fields.go</span>
<span class="token keyword">package</span> reflect

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"errors"</span>
    <span class="token string">"reflect"</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// IterateFields 遍历字段</span>
<span class="token keyword">func</span> <span class="token function">IterateFields</span><span class="token punctuation">(</span>entity any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 作者习惯: 公共方法都有一个error返回值</span>
    <span class="token keyword">if</span> entity <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不支持 nil"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    <span class="token keyword">if</span> val<span class="token punctuation">.</span><span class="token function">IsZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 零值取Field会报错</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不支持零值"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 如果不是结构体</span>
    <span class="token comment" spellcheck="true">//if typ.Kind() != reflect.Struct {</span>
    <span class="token comment" spellcheck="true">// 指针</span>
    <span class="token comment" spellcheck="true">// for是为了防止多级指针</span>
    <span class="token keyword">for</span> typ<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> reflect<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>
        typ <span class="token operator">=</span> typ<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//  val.Field(i) 的val必须是struct</span>
        val <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> typ<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Struct <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不支持类型"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// struct有多少字段</span>
    numFields <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">NumField</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> numFields<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numFields<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 字段类型</span>
        fieldType <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 字段值</span>
        fieldVal <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// public的字段才能被反射获取</span>
        <span class="token keyword">if</span> fieldType<span class="token punctuation">.</span><span class="token function">IsExported</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 反射获取的值被封装为Value,.Interface()就是获取Value里真正意义上的值</span>
            res<span class="token punctuation">[</span>fieldType<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> fieldVal<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取不到的值就给零值</span>
            res<span class="token punctuation">[</span>fieldType<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> reflect<span class="token punctuation">.</span><span class="token function">Zero</span><span class="token punctuation">(</span>fieldType<span class="token punctuation">.</span>Type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="11-元数据：反射-写字段"><a href="#11-元数据：反射-写字段" class="headerlink" title="11. 元数据：反射-写字段"></a>11. 元数据：反射-写字段</h3><p><img src="78408435.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// fields_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestSetField</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity   any
        field    <span class="token builtin">string</span>
        newValue any

        wantErr <span class="token builtin">error</span>
        <span class="token comment" spellcheck="true">// 修改后的entity</span>
        wantEntity any
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>       <span class="token string">"struct"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span>     User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            field<span class="token punctuation">:</span>      <span class="token string">"Name"</span><span class="token punctuation">,</span>
            newValue<span class="token punctuation">:</span>   <span class="token string">"Jerry"</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span>    errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不可修改字段"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantEntity<span class="token punctuation">:</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>     <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span>   <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            field<span class="token punctuation">:</span>    <span class="token string">"Name"</span><span class="token punctuation">,</span>
            newValue<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//wantErr:    errors.New("不可修改字段"),</span>
            wantEntity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>       <span class="token string">"pointer exported"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span>     <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            field<span class="token punctuation">:</span>      <span class="token string">"age"</span><span class="token punctuation">,</span>
            newValue<span class="token punctuation">:</span>   <span class="token number">16</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span>    errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不可修改字段"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantEntity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">:=</span> <span class="token function">SetField</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>field<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>newValue<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantEntity<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestSet</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment" spellcheck="true">// panic: unaddressable value</span>
    <span class="token comment" spellcheck="true">//reflect.ValueOf(i).Set(reflect.ValueOf(12))</span>
    ptr <span class="token operator">:=</span> <span class="token operator">&amp;</span>i
    reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// fields.go</span>
<span class="token keyword">func</span> <span class="token function">SetField</span><span class="token punctuation">(</span>entity any<span class="token punctuation">,</span> field <span class="token builtin">string</span><span class="token punctuation">,</span> newValue any<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 拿到指针指向的结构体</span>
    <span class="token keyword">for</span> val<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> reflect<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>
        val <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    fieldVal <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token function">FieldByName</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 能否被修改</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>fieldVal<span class="token punctuation">.</span><span class="token function">CanSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不可修改字段"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fieldVal<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="12-元数据：反射-方法"><a href="#12-元数据：反射-方法" class="headerlink" title="12. 元数据：反射-方法"></a>12. 元数据：反射-方法</h3><p><img src="2a2339bf.png"><img src="b0d5a57a.png"><img src="1037e243.png"><img src="0aa1c8ca.png"><img src="462149d2.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// func_call_test.go</span>
<span class="token keyword">package</span> reflect

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"my_framework/orm/reflect/types"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestIterateFunc</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity  any
        wantRes <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>FuncInfo
        wantErr <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"struct"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> types<span class="token punctuation">.</span><span class="token function">NewUser</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantRes<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>FuncInfo<span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 结构体只能访问定义在struct上的</span>
                <span class="token string">"GetAge"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    Name<span class="token punctuation">:</span>        <span class="token string">"GetAge"</span><span class="token punctuation">,</span>
                    InputTypes<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">{</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    OutputTypes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">{</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    Result<span class="token punctuation">:</span>      <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">// 定义在指针上,无法获取到</span>
                <span class="token comment" spellcheck="true">//"ChangeName": {</span>
                <span class="token comment" spellcheck="true">//    Name: "ChangeName",</span>
                <span class="token comment" spellcheck="true">//    InputTypes: []reflect.Type{reflect.TypeOf("")},</span>
                <span class="token comment" spellcheck="true">//},</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"struct"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> types<span class="token punctuation">.</span><span class="token function">NewUserPtr</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantRes<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>FuncInfo<span class="token punctuation">{</span>
                <span class="token string">"GetAge"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    Name<span class="token punctuation">:</span>        <span class="token string">"GetAge"</span><span class="token punctuation">,</span>
                    InputTypes<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">{</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>types<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    OutputTypes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">{</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    Result<span class="token punctuation">:</span>      <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">// 定义在指针上,无法获取到</span>
                <span class="token string">"ChangeName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    Name<span class="token punctuation">:</span>        <span class="token string">"ChangeName"</span><span class="token punctuation">,</span>
                    InputTypes<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">{</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>types<span class="token punctuation">.</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    OutputTypes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    Result<span class="token punctuation">:</span>      <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">IterateFunc</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantRes<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// func_call.go</span>
<span class="token keyword">package</span> reflect

<span class="token keyword">import</span> <span class="token string">"reflect"</span>

<span class="token keyword">func</span> <span class="token function">IterateFunc</span><span class="token punctuation">(</span>entity any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>FuncInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    numMethod <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">NumMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>FuncInfo<span class="token punctuation">,</span> numMethod<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numMethod<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        method <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        fn <span class="token operator">:=</span> method<span class="token punctuation">.</span>Func

        numIn <span class="token operator">:=</span> fn<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NumIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        input <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numIn<span class="token punctuation">)</span>
        inputVals <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numIn<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 方法的第一个参数是该方法所属结构体</span>
        input <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span>
        inputVals <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>inputVals<span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numIn<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            fnInType <span class="token operator">:=</span> fn<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">In</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            input <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> fnInType<span class="token punctuation">)</span>
            inputVals <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>inputVals<span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">Zero</span><span class="token punctuation">(</span>fnInType<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        numOut <span class="token operator">:=</span> fn<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NumOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        output <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numOut<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numOut<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            output <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> fn<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Out</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        resVals <span class="token operator">:=</span> fn<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>inputVals<span class="token punctuation">)</span>
        result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>resVals<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> resVals <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        res<span class="token punctuation">[</span>method<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> FuncInfo<span class="token punctuation">{</span>
            Name<span class="token punctuation">:</span>        method<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
            InputTypes<span class="token punctuation">:</span>  input<span class="token punctuation">,</span>
            OutputTypes<span class="token punctuation">:</span> output<span class="token punctuation">,</span>
            Result<span class="token punctuation">:</span>      result<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> FuncInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name        <span class="token builtin">string</span>
    InputTypes  <span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type
    OutputTypes <span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Type

    Result <span class="token punctuation">[</span><span class="token punctuation">]</span>any
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/types/user.go</span>
<span class="token keyword">package</span> types

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span>
    age  <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewUser</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> age <span class="token builtin">int</span><span class="token punctuation">)</span> User <span class="token punctuation">{</span>
    <span class="token keyword">return</span> User<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
        age<span class="token punctuation">:</span>  age<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewUserPtr</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> age <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>User <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
        age<span class="token punctuation">:</span>  age<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u User<span class="token punctuation">)</span> <span class="token function">GetAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> u<span class="token punctuation">.</span>age
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">ChangeName</span><span class="token punctuation">(</span>newName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    u<span class="token punctuation">.</span>Name <span class="token operator">=</span> newName
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>u User<span class="token punctuation">)</span> <span class="token function">private</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"private"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="13-元数据：反射-遍历"><a href="#13-元数据：反射-遍历" class="headerlink" title="13. 元数据：反射-遍历"></a>13. 元数据：反射-遍历</h3><p><img src="c3c4c309.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// iterate_test.go</span>
<span class="token keyword">package</span> reflect

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestIterateArray</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name   <span class="token builtin">string</span>
        entity any

        wantVals <span class="token punctuation">[</span><span class="token punctuation">]</span>any
        wantErr  <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>     <span class="token string">"arr"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantVals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>     <span class="token string">"slice"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantVals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            vals<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">IterateArrayOrSlice</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantVals<span class="token punctuation">,</span> vals<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestIterateMap</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name   <span class="token builtin">string</span>
        entity any

        wantKeys   <span class="token punctuation">[</span><span class="token punctuation">]</span>any
        wantValues <span class="token punctuation">[</span><span class="token punctuation">]</span>any
        wantErr    <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"map"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
                <span class="token string">"A"</span><span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">,</span>
                <span class="token string">"B"</span><span class="token punctuation">:</span> <span class="token string">"b"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantKeys<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantValues<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// go map 的遍历, key是无序的</span>
            keys<span class="token punctuation">,</span> values<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">IterateMap</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">EqualValues</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>wantKeys<span class="token punctuation">,</span> keys<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">EqualValues</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>wantValues<span class="token punctuation">,</span> values<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// iterate.go</span>
<span class="token keyword">package</span> reflect

<span class="token keyword">import</span> <span class="token string">"reflect"</span>

<span class="token keyword">func</span> <span class="token function">IterateArrayOrSlice</span><span class="token punctuation">(</span>entity any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    res <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> val<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        ele <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        res <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> ele<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// keys,vals,err</span>
<span class="token keyword">func</span> <span class="token function">IterateMap</span><span class="token punctuation">(</span>entity any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    resKeys <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    resValues <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 方式1</span>
    itr <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token function">MapRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> itr<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resKeys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>resKeys<span class="token punctuation">,</span> itr<span class="token punctuation">.</span><span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        resValues <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>resValues<span class="token punctuation">,</span> itr<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 方式2</span>
    <span class="token comment" spellcheck="true">//keys := val.MapKeys()</span>
    <span class="token comment" spellcheck="true">//for _, key := range keys {</span>
    <span class="token comment" spellcheck="true">//    v := val.MapIndex(key)</span>
    <span class="token comment" spellcheck="true">//    resKeys = append(resKeys, key.Interface())</span>
    <span class="token comment" spellcheck="true">//    resValues = append(resValues, v.Interface())</span>
    <span class="token comment" spellcheck="true">//}</span>

    <span class="token keyword">return</span> resKeys<span class="token punctuation">,</span> resValues<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="14-元数据：反射的开源实例、面试要点总结"><a href="#14-元数据：反射的开源实例、面试要点总结" class="headerlink" title="14. 元数据：反射的开源实例、面试要点总结"></a>14. 元数据：反射的开源实例、面试要点总结</h3><p><img src="8c0f37ae.png"><img src="20b858b7.png"><img src="d9b23214.png"><img src="43d9c9a3.png"><img src="da8b0591.png"><br><img src="fb3ddd40.png"><img src="18991abf.png"><img src="90c160b4.png"><img src="03693619.png"><img src="8aea7b8f.png"></p>
<h3 id="15-元数据：反射解析模型"><a href="#15-元数据：反射解析模型" class="headerlink" title="15. 元数据：反射解析模型"></a>15. 元数据：反射解析模型</h3><p><img src="1f1ed2ba.png"><img src="cba714fa.png"><img src="94eeb881.png"><img src="1ca4b3e6.png"><img src="cf884f73.png"><br><img src="875b9671.png"><img src="778096e1.png"><img src="32361897.png"><img src="7f615fa8.png"><img src="75aa869a.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/internal/errs/error.go</span>
<span class="token comment" spellcheck="true">// internal 包里的文件不会被用户访问到</span>
<span class="token keyword">package</span> errs

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"errors"</span>
    <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
    ErrPointerOnly <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"orm: 只支持指向结构体的一级指针"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">NewErrUnsupportedExpression</span><span class="token punctuation">(</span>expr any<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"orm: 不支持的表达式类型 %v"</span><span class="token punctuation">,</span> expr<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_parseModel</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity    any
        wantModel <span class="token operator">*</span>model
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"struct"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//wantModel: &amp;model{</span>
            <span class="token comment" spellcheck="true">//    tableName: "test_model",</span>
            <span class="token comment" spellcheck="true">//    fields: map[string]*field{</span>
            <span class="token comment" spellcheck="true">//        "Id": {</span>
            <span class="token comment" spellcheck="true">//            colName: "id",</span>
            <span class="token comment" spellcheck="true">//        },</span>
            <span class="token comment" spellcheck="true">//        "FirstName": {</span>
            <span class="token comment" spellcheck="true">//            colName: "first_name",</span>
            <span class="token comment" spellcheck="true">//        },</span>
            <span class="token comment" spellcheck="true">//        "LastName": {</span>
            <span class="token comment" spellcheck="true">//            colName: "last_name",</span>
            <span class="token comment" spellcheck="true">//        },</span>
            <span class="token comment" spellcheck="true">//        "Age": {</span>
            <span class="token comment" spellcheck="true">//            colName: "age",</span>
            <span class="token comment" spellcheck="true">//        },</span>
            <span class="token comment" spellcheck="true">//    },</span>
            <span class="token comment" spellcheck="true">//},</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span>ErrPointerOnly<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"test_model"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"Id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"LastName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"Age"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"age"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">parseModel</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"unicode"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> model <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tableName <span class="token builtin">string</span>
    fields    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field
<span class="token punctuation">}</span>

<span class="token keyword">type</span> field <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 列名</span>
    colName <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">parseModel</span><span class="token punctuation">(</span>entity any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    <span class="token keyword">if</span> typ<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Ptr <span class="token operator">||</span> typ<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Struct <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrPointerOnly
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 指针</span>
    <span class="token comment" spellcheck="true">// 可以处理多级指针</span>
    <span class="token comment" spellcheck="true">//for typ.Kind() == reflect.Pointer {</span>
    <span class="token comment" spellcheck="true">// 只能处理一级指针</span>
    <span class="token keyword">if</span> typ<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> reflect<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>
        typ <span class="token operator">=</span> typ<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    numField <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">NumField</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fieldMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">,</span> numField<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numField<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        fd <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        fieldMap<span class="token punctuation">[</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>field<span class="token punctuation">{</span>
            colName<span class="token punctuation">:</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
        tableName<span class="token punctuation">:</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>typ<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        fields<span class="token punctuation">:</span>    fieldMap<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// underscoreName 驼峰命名转下划线</span>
<span class="token keyword">func</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>tableName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> buf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> tableName <span class="token punctuation">{</span>
        <span class="token keyword">if</span> unicode<span class="token punctuation">.</span><span class="token function">IsUpper</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> i <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                buf <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            buf <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token function">byte</span><span class="token punctuation">(</span>unicode<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            buf <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token function">byte</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="16-元数据：利用元数据改造-Selector、元数据阶段总结"><a href="#16-元数据：利用元数据改造-Selector、元数据阶段总结" class="headerlink" title="16. 元数据：利用元数据改造 Selector、元数据阶段总结"></a>16. 元数据：利用元数据改造 Selector、元数据阶段总结</h3><p><img src="76cc85a3.png"><img src="f1db5ee4.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Selector<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    table <span class="token builtin">string</span>
    model <span class="token operator">*</span>model
    where <span class="token punctuation">[</span><span class="token punctuation">]</span>Predicate
    sb    <span class="token operator">*</span>strings<span class="token punctuation">.</span>Builder
    args  <span class="token punctuation">[</span><span class="token punctuation">]</span>any
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//var sb strings.Builder</span>
    s<span class="token punctuation">.</span>sb <span class="token operator">=</span> <span class="token operator">&amp;</span>strings<span class="token punctuation">.</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 指针类型一定要初始化</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    s<span class="token punctuation">.</span>model<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">parseModel</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// new(T) 生成T的指针</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    sb <span class="token operator">:=</span> s<span class="token punctuation">.</span>sb
    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM "</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>tableName<span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//segs := strings.Split(s.table, ".")</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>table<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>where<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span>

    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span>  sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Args<span class="token punctuation">:</span> s<span class="token punctuation">.</span>args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">buildExpression</span><span class="token punctuation">(</span>expr Expression<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> exp <span class="token operator">:=</span> expr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
    <span class="token keyword">case</span> Predicate<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token keyword">case</span> Column<span class="token punctuation">:</span>
        fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fields<span class="token punctuation">[</span>exp<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true">// 传入了错误的字段</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>colName<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token keyword">case</span> value<span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnsupportedExpression</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ...</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSelector_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        builder QueryBuilder

        wantQuery <span class="token operator">*</span>Query
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"not from"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"from"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"`test_model`"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"empty from"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"empty table"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"db table"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"`mybatis`.`test`"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `mybatis`.`test`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"where"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE `age` = ?;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"empty where"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"not"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">Not</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE  NOT (`age` = ?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"and"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE (`age` = ?) AND (`first_name` = ?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"and"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE (`age` = ?) OR (`first_name` = ?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"invalid column"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"XXXX"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"XXXX"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TestModel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id        <span class="token builtin">int64</span>
    FirstName <span class="token builtin">string</span>
    Age       <span class="token builtin">int8</span>
    LastName  <span class="token operator">*</span>sql<span class="token punctuation">.</span>NullString
<span class="token punctuation">}</span>
</code></pre>
<h2 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h2><h3 id="18-第四周作业：DELETE-语句-选学"><a href="#18-第四周作业：DELETE-语句-选学" class="headerlink" title="18.第四周作业：DELETE 语句[选学]"></a>18.第四周作业：DELETE 语句[选学]</h3><p><img src="b146d644.png"><img src="5807b7e3.png"><img src="a1f093c7.png"><img src="5b260a4f.png"><img src="cfebb71a.png"><img src="256aa592.png"></p>
<h3 id="19-第四周-DELETE-作业讲解-选学"><a href="#19-第四周-DELETE-作业讲解-选学" class="headerlink" title="19.第四周 DELETE 作业讲解[选学]"></a>19.第四周 DELETE 作业讲解[选学]</h3><p><img src="21433af3.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// builder.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> builder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    sb   <span class="token operator">*</span>strings<span class="token punctuation">.</span>Builder
    model <span class="token operator">*</span>model
    args <span class="token punctuation">[</span><span class="token punctuation">]</span>any
<span class="token punctuation">}</span> 

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>builder <span class="token punctuation">)</span> <span class="token function">buildExpression</span><span class="token punctuation">(</span>expr Expression<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> exp <span class="token operator">:=</span> expr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
    <span class="token keyword">case</span> Predicate<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// 处理p</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> exp<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token punctuation">(</span>Predicate<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>op<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>

        <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">=</span> exp<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token punctuation">(</span>Predicate<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> Column<span class="token punctuation">:</span>
        fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fields<span class="token punctuation">[</span>exp<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true">// 传入了错误的字段</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>colName<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token keyword">case</span> value<span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnsupportedExpression</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>builder<span class="token punctuation">)</span> <span class="token function">addArg</span><span class="token punctuation">(</span>val any<span class="token punctuation">)</span> <span class="token operator">*</span>builder <span class="token punctuation">{</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>args <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        s<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>args<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
    <span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>builder<span class="token punctuation">)</span> <span class="token function">buildPredicates</span><span class="token punctuation">(</span>ps <span class="token punctuation">[</span><span class="token punctuation">]</span>Predicate<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    p <span class="token operator">:=</span> ps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span>ps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// delete.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Deleter<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    builder
    where <span class="token punctuation">[</span><span class="token punctuation">]</span>Predicate
    table <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Deleter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//var sb strings.Builder</span>
    d<span class="token punctuation">.</span>sb <span class="token operator">=</span> <span class="token operator">&amp;</span>strings<span class="token punctuation">.</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 指针类型一定要初始化</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    d<span class="token punctuation">.</span>model<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">parseModel</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// new(T) 生成T的指针</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    sb <span class="token operator">:=</span> d<span class="token punctuation">.</span>sb
    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"DELETE * FROM "</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> d<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>model<span class="token punctuation">.</span>tableName<span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//segs := strings.Split(d.table, ".")</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>table<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>where<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" WHERE "</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">buildPredicates</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>where<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span>  sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Args<span class="token punctuation">:</span> d<span class="token punctuation">.</span>args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span> 

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Deleter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">From</span><span class="token punctuation">(</span>table <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Deleter<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> d
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Deleter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Where</span><span class="token punctuation">(</span>predicate <span class="token operator">...</span>Predicate<span class="token punctuation">)</span> <span class="token operator">*</span>Deleter<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> d
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// delete_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestDeleter_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        builder QueryBuilder

        wantQuery <span class="token operator">*</span>Query
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"struct"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Deleter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"DELETE * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="11-第五周：ORM-框架之元数据、SQL-编程与结果集处理"><a href="#11-第五周：ORM-框架之元数据、SQL-编程与结果集处理" class="headerlink" title="11 第五周：ORM 框架之元数据、SQL 编程与结果集处理"></a>11 第五周：ORM 框架之元数据、SQL 编程与结果集处理</h1><h2 id="元数据-1"><a href="#元数据-1" class="headerlink" title="元数据"></a>元数据</h2><h3 id="1-元数据：注册中心"><a href="#1-元数据：注册中心" class="headerlink" title="1. 元数据：注册中心"></a>1. 元数据：注册中心</h3><p><img src="70820ea9.png"><img src="7334aa2e.png"><img src="79c7eb31.png"><img src="d466b09b.png"><img src="44294eca.png"><br><img src="7dfcee47.png" alt="超时配置很重要"><img src="71bdd0c9.png"><img src="805ce3fa.png"><img src="c89b3b77.png"><img src="d54086f8.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">type</span> Selector<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    builder
    table <span class="token builtin">string</span>
    where <span class="token punctuation">[</span><span class="token punctuation">]</span>Predicate
    db    <span class="token operator">*</span>DB
<span class="token punctuation">}</span>

<span class="token keyword">func</span> NewSelector<span class="token punctuation">[</span>T any<span class="token punctuation">]</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">{</span>
        db<span class="token punctuation">:</span> db<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSelector_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        builder QueryBuilder

        wantQuery <span class="token operator">*</span>Query
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"not from"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"from"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"`test_model`"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"empty from"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"empty table"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"db table"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"`mybatis`.`test`"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `mybatis`.`test`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"where"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE `age` = ?;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"empty where"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"not"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">Not</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE  NOT (`age` = ?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"and"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE (`age` = ?) AND (`first_name` = ?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"and"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE (`age` = ?) OR (`first_name` = ?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"invalid column"</span><span class="token punctuation">,</span>
            builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"XXXX"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"XXXX"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TestModel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id        <span class="token builtin">int64</span>
    FirstName <span class="token builtin">string</span>
    Age       <span class="token builtin">int8</span>
    LastName  <span class="token operator">*</span>sql<span class="token punctuation">.</span>NullString
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// db.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">type</span> DBOption <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span>

<span class="token keyword">type</span> DB <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    r <span class="token operator">*</span>registry
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewDB</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>DBOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>DB<span class="token punctuation">{</span>
        r<span class="token punctuation">:</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">MustNewDB</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>DBOption<span class="token punctuation">)</span> <span class="token operator">*</span>DB <span class="token punctuation">{</span>
    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewDB</span><span class="token punctuation">(</span>opts<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_parseModel</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity    any
        wantModel <span class="token operator">*</span>model
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"struct"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span>ErrPointerOnly<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"test_model"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"Id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"LastName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"Age"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"age"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> <span class="token operator">&amp;</span>registry<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">parseModel</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestRegistry_Get</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity    any
        wantModel <span class="token operator">*</span>model
        wantErr   <span class="token builtin">error</span>
        cacheSize <span class="token builtin">int</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"test_model"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"Id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"LastName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"Age"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"age"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            cacheSize<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    r <span class="token operator">:=</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 只检测了数量</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>cacheSize<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>models<span class="token punctuation">)</span><span class="token punctuation">)</span>

            typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            m<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>models<span class="token punctuation">[</span>typ<span class="token punctuation">]</span>
            assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token comment" spellcheck="true">// 元数据注册中心</span>
<span class="token keyword">type</span> registry <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    models <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token operator">*</span>model
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>registry <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>registry<span class="token punctuation">{</span>
        models<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token operator">*</span>model<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span>val any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    m<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>models<span class="token punctuation">[</span>typ<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">var</span> err <span class="token builtin">error</span>
        m<span class="token punctuation">,</span> err <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">parseModel</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>models<span class="token punctuation">[</span>typ<span class="token punctuation">]</span> <span class="token operator">=</span> m
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-元数据：注册中心并发问题"><a href="#2-元数据：注册中心并发问题" class="headerlink" title="2. 元数据：注册中心并发问题"></a>2. 元数据：注册中心并发问题</h3><p><img src="e2688d67.png"><img src="14e8363e.png" alt="并发读可以,并发读写不行"><img src="3dbe71cc.png"><img src="4d0731f7.png"><br><img src="f0335a00.png"><img src="bb40372e.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span>val any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    m<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>models<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>typ<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">parseModel</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    r<span class="token punctuation">.</span>models<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-元数据：标签自定义列名"><a href="#3-元数据：标签自定义列名" class="headerlink" title="3. 元数据：标签自定义列名"></a>3. 元数据：标签自定义列名</h3><p><img src="e6374742.png"><img src="734f2399.png"><img src="cfc90541.png"><img src="33151032.png"><img src="dbdc99bb.png"><br><img src="3222e1c9.png"><img src="a03cc0f6.png"><img src="6d245fb4.png"><img src="6132a84d.png"><img src="93f7b26f.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_parseModel</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity    any
        wantModel <span class="token operator">*</span>model
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"struct"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span>ErrPointerOnly<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"test_model"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"Id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"LastName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"Age"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"age"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> <span class="token operator">&amp;</span>registry<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">parseModel</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestRegistry_Get</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity    any
        wantModel <span class="token operator">*</span>model
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"test_model"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"Id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"LastName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"Age"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"age"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"tag"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">{</span>
                <span class="token keyword">type</span> TagTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                    FirstName <span class="token builtin">string</span> <span class="token string">`orm:"column=first_name_t"`</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>TagTable<span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"tag_table"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name_t"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"empty tag"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">{</span>
                <span class="token keyword">type</span> TagTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                    FirstName <span class="token builtin">string</span> <span class="token string">`orm:"column="`</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>TagTable<span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"tag_table"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"column only"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">{</span>
                <span class="token keyword">type</span> TagTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                    FirstName <span class="token builtin">string</span> <span class="token string">`orm:"column"`</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>TagTable<span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrInvalidTagContent</span><span class="token punctuation">(</span><span class="token string">"column"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"invalid tag"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">{</span>
                <span class="token keyword">type</span> TagTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                    FirstName <span class="token builtin">string</span> <span class="token string">`orm:"abc=abc"`</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>TagTable<span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model <span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"tag_table"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> m<span class="token punctuation">)</span>

            typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            cache<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>models<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>typ<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> cache<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token comment" spellcheck="true">// 解析创建model元数据</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">parseModel</span><span class="token punctuation">(</span>entity any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    <span class="token keyword">if</span> typ<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Ptr <span class="token operator">||</span> typ<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Struct <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrPointerOnly
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 指针</span>
    <span class="token comment" spellcheck="true">// 可以处理多级指针</span>
    <span class="token comment" spellcheck="true">//for typ.Kind() == reflect.Pointer {</span>
    <span class="token comment" spellcheck="true">// 只能处理一级指针</span>
    <span class="token keyword">if</span> typ<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> reflect<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>
        typ <span class="token operator">=</span> typ<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    numField <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">NumField</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fieldMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">,</span> numField<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numField<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        fd <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 取tag `xxx:xxx=xxx`</span>
        pair<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">parseTag</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Tag<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 取column: `orm:"column"=xxx`</span>
        colName <span class="token operator">:=</span> pair<span class="token punctuation">[</span>tagKeyColumn<span class="token punctuation">]</span>
        <span class="token keyword">if</span> colName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 用户没有设置,用字段名</span>
            colName <span class="token operator">=</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        fieldMap<span class="token punctuation">[</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>field<span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//colName: underscoreName(fd.Name),</span>
            colName<span class="token punctuation">:</span> colName<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
        tableName<span class="token punctuation">:</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>typ<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        fields<span class="token punctuation">:</span>    fieldMap<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    ID <span class="token builtin">uint64</span> <span class="token string">`orm:"column=id,xxx=bbb"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>tag reflect<span class="token punctuation">.</span>StructTag<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ormTag<span class="token punctuation">,</span> ok <span class="token operator">:=</span> tag<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">"orm"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// orm:"xxx=xxx,xxx=xxx"</span>
    pairs <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>ormTag<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span>
    res <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pairs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pair <span class="token operator">:=</span> <span class="token keyword">range</span> pairs <span class="token punctuation">{</span>
        segs <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> <span class="token string">"="</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>segs<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrInvalidTagContent</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        key <span class="token operator">:=</span> segs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        val <span class="token operator">:=</span> segs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-元数据：接口自定义表名"><a href="#4-元数据：接口自定义表名" class="headerlink" title="4. 元数据：接口自定义表名"></a>4. 元数据：接口自定义表名</h3><p><img src="7bb7bc06.png"><img src="42f864dd.png"><img src="bc8cc906.png"><img src="067afb09.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestRegistry_Get</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity    any
        wantModel <span class="token operator">*</span>model
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"custom table name"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>CustomTableName<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"custom_table_name_t"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"custom table name ptr"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>CustomTableNamePtr<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"custom_table_name_ptr_t"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"custom table name empty ptr"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>CustomTableNameEmpty<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"custom_table_name_empty"</span><span class="token punctuation">,</span>
                fields<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>field<span class="token punctuation">{</span>
                    <span class="token string">"FirstName"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> m<span class="token punctuation">)</span>

            typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            cache<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>models<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>typ<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> cache<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CustomTableName <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    FirstName <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c CustomTableName<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"custom_table_name_t"</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CustomTableNamePtr <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    FirstName <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>CustomTableNamePtr<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"custom_table_name_ptr_t"</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CustomTableNameEmpty <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    FirstName <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c  CustomTableNameEmpty<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">""</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">parseModel</span><span class="token punctuation">(</span>entity any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token keyword">var</span> tableName <span class="token builtin">string</span>
    <span class="token keyword">if</span> tbl<span class="token punctuation">,</span> ok <span class="token operator">:=</span> entity<span class="token punctuation">.</span><span class="token punctuation">(</span>TableName<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        tableName <span class="token operator">=</span> tbl<span class="token punctuation">.</span><span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> tableName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        tableName <span class="token operator">=</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>typ<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>model<span class="token punctuation">{</span>
        tableName<span class="token punctuation">:</span> tableName<span class="token punctuation">,</span>
        fields<span class="token punctuation">:</span>    fieldMap<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// types.go</span>
<span class="token keyword">type</span> TableName <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-元数据：编程方式自定义表名和列名"><a href="#5-元数据：编程方式自定义表名和列名" class="headerlink" title="5. 元数据：编程方式自定义表名和列名"></a>5. 元数据：编程方式自定义表名和列名</h3><p><img src="0b88c94b.png"><img src="dcf49edc.png"><img src="066af011.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>val any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    m<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>models<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>typ<span class="token punctuation">)</span>
    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Model<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Model<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>entity any<span class="token punctuation">,</span> opts <span class="token operator">...</span>ModelOpt<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    <span class="token keyword">if</span> typ<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Ptr <span class="token operator">||</span> typ<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Struct <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrPointerOnly
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 指针</span>
    <span class="token comment" spellcheck="true">// 可以处理多级指针</span>
    <span class="token comment" spellcheck="true">//for elemType.Kind() == reflect.Pointer {</span>
    <span class="token comment" spellcheck="true">// 只能处理一级指针</span>
    <span class="token comment" spellcheck="true">//if typ.Kind() == reflect.Pointer {</span>
    elemType <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//}</span>

    numField <span class="token operator">:=</span> elemType<span class="token punctuation">.</span><span class="token function">NumField</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fieldMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">,</span> numField<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numField<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        fd <span class="token operator">:=</span> elemType<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 取tag `xxx:xxx=xxx`</span>
        pair<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">parseTag</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Tag<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 取column: `orm:"column"=xxx`</span>
        colName <span class="token operator">:=</span> pair<span class="token punctuation">[</span>tagKeyColumn<span class="token punctuation">]</span>
        <span class="token keyword">if</span> colName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 用户没有设置,用字段名</span>
            colName <span class="token operator">=</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        fieldMap<span class="token punctuation">[</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>Field<span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//colName: underscoreName(fd.Name),</span>
            colName<span class="token punctuation">:</span> colName<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> tableName <span class="token builtin">string</span>
    <span class="token keyword">if</span> tbl<span class="token punctuation">,</span> ok <span class="token operator">:=</span> entity<span class="token punctuation">.</span><span class="token punctuation">(</span>TableName<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        tableName <span class="token operator">=</span> tbl<span class="token punctuation">.</span><span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> tableName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        tableName <span class="token operator">=</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>elemType<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
        tableName<span class="token punctuation">:</span> tableName<span class="token punctuation">,</span>
        fields<span class="token punctuation">:</span>    fieldMap<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        err <span class="token operator">:=</span> <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    r<span class="token punctuation">.</span>models<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestModelWithTableName</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    r <span class="token operator">:=</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">ModelWithTableName</span><span class="token punctuation">(</span><span class="token string">"test_model_ttt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"test_model_ttt"</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>tableName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestModelWithColName</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        field   <span class="token builtin">string</span>
        colName <span class="token builtin">string</span>

        wantColName <span class="token builtin">string</span>
        wantErr     <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>        <span class="token string">"column name"</span><span class="token punctuation">,</span>
            field<span class="token punctuation">:</span>       <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
            colName<span class="token punctuation">:</span>     <span class="token string">"first_name_ccc"</span><span class="token punctuation">,</span>
            wantColName<span class="token punctuation">:</span> <span class="token string">"first_name_ccc"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"invalid column name"</span><span class="token punctuation">,</span>
            field<span class="token punctuation">:</span>   <span class="token string">"XXX"</span><span class="token punctuation">,</span>
            colName<span class="token punctuation">:</span> <span class="token string">"first_name_ccc"</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"XXX"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r <span class="token operator">:=</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">ModelWithColumnName</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>field<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>colName<span class="token punctuation">)</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>fields<span class="token punctuation">[</span>tc<span class="token punctuation">.</span>field<span class="token punctuation">]</span>
            require<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantColName<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>colName<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="6-元数据：总结与面试要点"><a href="#6-元数据：总结与面试要点" class="headerlink" title="6. 元数据：总结与面试要点"></a>6. 元数据：总结与面试要点</h3><p><img src="e05a03ce.png"><img src="1c3f9e48.png"><img src="abc7834a.png"><img src="8c1e4812.png"></p>
<h2 id="sql编程"><a href="#sql编程" class="headerlink" title="sql编程"></a>sql编程</h2><h3 id="7-SQL-编程：增删改查"><a href="#7-SQL-编程：增删改查" class="headerlink" title="7. SQL 编程：增删改查"></a>7. SQL 编程：增删改查</h3><p><img src="b57d174f.png"><img src="517ef409.png"><img src="45a87757.png"><img src="49ccb352.png"><img src="856b2a84.png"><br><img src="f07fa40c.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// crud_test.go</span>
<span class="token keyword">package</span> sql_demo

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"log"</span>
    <span class="token string">"time"</span>

    <span class="token comment" spellcheck="true">//_ "github.com/mattn/go-sqlite3"</span>
    <span class="token boolean">_</span> <span class="token string">"github.com/go-sql-driver/mysql"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestDB</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 可以用db</span>
    <span class="token comment" spellcheck="true">//sql.OpenDB()</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 除了select, 都是用的 ExecContext</span>
    <span class="token comment" spellcheck="true">//_, err = db.ExecContext(ctx, `DROP TABLE IF EXISTS test_model;`)</span>

    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">ExecContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">`
CREATE TABLE IF NOT EXISTS test_model(
    id int AUTO_INCREMENT PRIMARY KEY, 
    first_name TEXT NOT NULL,
    age int,
    last_name TEXT NOT NULL
)
`</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//cancel()</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// INSERT 插入</span>
    <span class="token comment" spellcheck="true">// 使用?作为占位符,防止sql注入</span>
    <span class="token comment" spellcheck="true">//res, err := db.ExecContext(ctx, "INSERT INTO test_model(`id`,`first_name`,`age`,`last_name`) VALUES (?,?,?,?)",</span>
    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">ExecContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"INSERT INTO test_model(`first_name`,`age`,`last_name`) VALUES (?,?,?)"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">//1, "Tom", 18, "Jerry")</span>
        <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Jerry"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 全都执行完再cancel</span>
    <span class="token comment" spellcheck="true">//cancel()</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

    affected<span class="token punctuation">,</span> err <span class="token operator">:=</span> res<span class="token punctuation">.</span><span class="token function">RowsAffected</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"受影响行数: "</span><span class="token punctuation">,</span> affected<span class="token punctuation">)</span>

    lastId<span class="token punctuation">,</span> err <span class="token operator">:=</span> res<span class="token punctuation">.</span><span class="token function">LastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// auto_increment才会返回正确的值,如果不是主键自增或者插入失败就会返回0</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"最后插入的id: "</span><span class="token punctuation">,</span> lastId<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// SELECT 查询</span>
    row <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryRowContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM `test_model` WHERE `id`=?"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> row<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tm <span class="token operator">:=</span> TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//// 如果不放心,就把select *换成字段名,然后这里传入字段对应的指针&amp;tm.xxx</span>
    err <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>FirstName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>Age<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>LastName<span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>tm<span class="token punctuation">)</span>

    row <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">QueryRowContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM `test_model` WHERE `id`=?"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 查询不到</span>
    <span class="token comment" spellcheck="true">//log.Println(row.Err())</span>
    <span class="token comment" spellcheck="true">//require.Error(t, sql.ErrNoRows, row.Err())</span>
    err <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>FirstName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>Age<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>LastName<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> sql<span class="token punctuation">.</span>ErrNoRows<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM `test_model` WHERE `id`>?"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tm <span class="token operator">=</span> TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span>
        err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>FirstName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>Age<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>LastName<span class="token punctuation">)</span>
        require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 最后再用</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TestModel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id        <span class="token builtin">int64</span>
    FirstName <span class="token builtin">string</span>
    Age       <span class="token builtin">int8</span>
    LastName  <span class="token operator">*</span>sql<span class="token punctuation">.</span>NullString
<span class="token punctuation">}</span>
</code></pre>
<h3 id="8-SQL-编程：Valuer-和-Scanner-接口"><a href="#8-SQL-编程：Valuer-和-Scanner-接口" class="headerlink" title="8. SQL 编程：Valuer 和 Scanner 接口"></a>8. SQL 编程：Valuer 和 Scanner 接口</h3><p><img src="2c3e1f4f.png"><img src="f0df497c.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// json_test.go</span>
<span class="token keyword">package</span> sql_demo

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestJsonColumn_Value</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    js <span class="token operator">:=</span> JsonColumn<span class="token punctuation">[</span>User<span class="token punctuation">]</span><span class="token punctuation">{</span>Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> Val<span class="token punctuation">:</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    value<span class="token punctuation">,</span> err <span class="token operator">:=</span> js<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Nil</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`{"Name":"Tom"}`</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>

    js <span class="token operator">=</span> JsonColumn<span class="token punctuation">[</span>User<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    value<span class="token punctuation">,</span> err <span class="token operator">=</span> js<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Nil</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Nil</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestJsonColumn_Scan</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name    <span class="token builtin">string</span>
        src     any
        wantErr <span class="token builtin">error</span>
        wantVal User
        valid   <span class="token builtin">bool</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"nil"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"string"</span><span class="token punctuation">,</span>
            src<span class="token punctuation">:</span>     <span class="token string">`{"Name":"Tom"}`</span><span class="token punctuation">,</span>
            wantVal<span class="token punctuation">:</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            valid<span class="token punctuation">:</span>   <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"bytes"</span><span class="token punctuation">,</span>
            src<span class="token punctuation">:</span>     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`{"Name":"Tom"}`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantVal<span class="token punctuation">:</span> User<span class="token punctuation">{</span>Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            valid<span class="token punctuation">:</span>   <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            js <span class="token operator">:=</span> <span class="token operator">&amp;</span>JsonColumn<span class="token punctuation">[</span>User<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
            err <span class="token operator">:=</span> js<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>src<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantVal<span class="token punctuation">,</span> js<span class="token punctuation">.</span>Val<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>valid<span class="token punctuation">,</span> js<span class="token punctuation">.</span>Valid<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// json.go</span>
<span class="token keyword">package</span> sql_demo

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql/driver"</span>
    <span class="token string">"errors"</span>
    <span class="token string">"github.com/goccy/go-json"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> JsonColumn<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Val T
    <span class="token comment" spellcheck="true">// not NULL</span>
    Valid <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j JsonColumn<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>driver<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 如果查出来是null</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>j<span class="token punctuation">.</span>Valid <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>Val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j <span class="token operator">*</span>JsonColumn<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Scan</span><span class="token punctuation">(</span>src any<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token keyword">switch</span> data <span class="token operator">:=</span> src<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// 可以考虑额外处理空字符串</span>
        bs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// 可以考虑处理[]byte{}</span>
        bs <span class="token operator">=</span> data
    <span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// 说明数据库里没数据(null)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"不支持类型"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>j<span class="token punctuation">.</span>Val<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        j<span class="token punctuation">.</span>Valid <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>可以用这种方法给字段加解密，因为是在代码层面上，不会给数据库造成什么压力（如果是让数据库加密就会）</p>
</blockquote>
<p><img src="75ba7979.png"><img src="9db28fd7.png"></p>
<h3 id="9-SQL-编程：事务与隔离级别"><a href="#9-SQL-编程：事务与隔离级别" class="headerlink" title="9. SQL 编程：事务与隔离级别"></a>9. SQL 编程：事务与隔离级别</h3><p><img src="75218373.png"><img src="fc063368.png"><img src="ae5770d8.png"><img src="35148b92.png"><img src="57986b7d.png"><br><img src="e10c8804.png"><img src="803bfab6.png"><img src="a260236c.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// crud_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestTranslation</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">BeginTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>TxOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">ExecContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"INSERT INTO test_model(`first_name`,`age`,`last_name`) VALUES (?,?,?)"</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">//1, "Tom", 18, "Jerry")</span>
        <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Jerry"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 回滚</span>
        err <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 提交事务</span>
    err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

    affected<span class="token punctuation">,</span> err <span class="token operator">:=</span> res<span class="token punctuation">.</span><span class="token function">RowsAffected</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"受影响行数: "</span><span class="token punctuation">,</span> affected<span class="token punctuation">)</span>

    lastId<span class="token punctuation">,</span> err <span class="token operator">:=</span> res<span class="token punctuation">.</span><span class="token function">LastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// auto_increment才会返回正确的值,如果不是主键自增或者插入失败就会返回0</span>
    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"最后插入的id: "</span><span class="token punctuation">,</span> lastId<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="10-SQL-编程：Prepare-Statement"><a href="#10-SQL-编程：Prepare-Statement" class="headerlink" title="10. SQL 编程：Prepare Statement"></a>10. SQL 编程：Prepare Statement</h3><p><img src="19280e11.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// crud_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestPS</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    stmt<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">PrepareContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM  `test_model` WHERE `id`=?"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> stmt<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tm <span class="token operator">:=</span> TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span>
        err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>FirstName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>Age<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>LastName<span class="token punctuation">)</span>
        require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 如果是in,就无法复用</span>
    <span class="token comment" spellcheck="true">// 如果定义很多个prepareStatement,到达数据库上限会报错</span>
    <span class="token comment" spellcheck="true">//stmt, err  = db.PrepareContext(ctx, "SELECT * FROM  `test_model` WHERE `id` in (?,?)")</span>
    <span class="token comment" spellcheck="true">//stmt, err  = db.PrepareContext(ctx, "SELECT * FROM  `test_model` WHERE `id` in (?,?,?)")</span>
    <span class="token comment" spellcheck="true">// 整个应用关闭的时候调用</span>
    <span class="token comment" spellcheck="true">// 什么时候可以被关?有可能正在使用 -> 1.引用计数 2.一次性ps</span>
    stmt<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="11-SQL-编程：sqlmock-入门、SQL-编程面试要点"><a href="#11-SQL-编程：sqlmock-入门、SQL-编程面试要点" class="headerlink" title="11. SQL 编程：sqlmock 入门、SQL 编程面试要点"></a>11. SQL 编程：sqlmock 入门、SQL 编程面试要点</h3><p><img src="753a5a19.png"><img src="68a1683b.png"><img src="a24f6da1.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// sqlmock_test.go</span>
<span class="token keyword">package</span> sql_demo

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"errors"</span>
    <span class="token string">"github.com/DATA-DOG/go-sqlmock"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"log"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSQLMock</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

    mockRows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    mockRows<span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 准备数据</span>
    <span class="token comment" spellcheck="true">// 正则表达式</span>
    mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT id,first_name FROM `user`.*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>mockRows<span class="token punctuation">)</span>
    mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT id FROM `user`.*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnError</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"mock error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// mock准备的顺序和执行的顺序要一致  一一对应</span>
    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"SELECT id,first_name FROM `user` WHERE id=?"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tm <span class="token operator">:=</span> TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span>
        err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tm<span class="token punctuation">.</span>FirstName<span class="token punctuation">)</span>
        require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"SELECT id FROM `user` WHERE id=?"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="结果集"><a href="#结果集" class="headerlink" title="结果集"></a>结果集</h2><h3 id="12-结果集处理：Open-与-OpenDB"><a href="#12-结果集处理：Open-与-OpenDB" class="headerlink" title="12. 结果集处理：Open 与 OpenDB"></a>12. 结果集处理：Open 与 OpenDB</h3><p><img src="0655bf71.png"><img src="df60140a.png"><img src="b6dbd1ca.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// db.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token string">"database/sql"</span>

<span class="token keyword">type</span> DBOption <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// DB 是一个sql.DB的装饰器</span>
<span class="token keyword">type</span> DB <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    r  <span class="token operator">*</span>registry
    db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Open</span><span class="token punctuation">(</span>driver <span class="token builtin">string</span><span class="token punctuation">,</span> dataSoruceName <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>DBOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> dataSoruceName<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">OpenDB</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">OpenDB</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> opts <span class="token operator">...</span>DBOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>DB<span class="token punctuation">{</span>
        r<span class="token punctuation">:</span>  <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        db<span class="token punctuation">:</span> db<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">MustOpen</span><span class="token punctuation">(</span>driver <span class="token builtin">string</span><span class="token punctuation">,</span> dataSoruceName <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>DBOption<span class="token punctuation">)</span> <span class="token operator">*</span>DB <span class="token punctuation">{</span>
    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Open</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> dataSoruceName<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    q<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    db <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>db
    <span class="token comment" spellcheck="true">// 发起查询,并处理结果集</span>
    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">GetMulti</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    q<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    db <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>db
    <span class="token comment" spellcheck="true">// 发起查询,并处理结果集</span>
    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="13-结果集处理：发起查询异常情况"><a href="#13-结果集处理：发起查询异常情况" class="headerlink" title="13. 结果集处理：发起查询异常情况"></a>13. 结果集处理：发起查询异常情况</h3><p><img src="a72ae8da.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestGet</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mockDB<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">OpenDB</span><span class="token punctuation">(</span>mockDB<span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// query error</span>
    mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnError</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"query error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// no rows</span>
    rows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
        <span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>

    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>
        s    <span class="token operator">*</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span>

        wantRes <span class="token operator">*</span>TestModel
        wantErr <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"invalid query"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"query error"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"query error"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"no rows"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"orm: 没有数据"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantRes<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    q<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    db <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>db
    <span class="token comment" spellcheck="true">// 发起查询,并处理结果集</span>
    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//_, err  = db.QueryContext(ctx, q.SQL, q.Args...)</span>
    <span class="token comment" spellcheck="true">// 查询错误</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrNoRows
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// select出来多少列</span>
    cs<span class="token punctuation">,</span> err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Columns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    tp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>

    rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="14-结果集处理：反射处理结果集"><a href="#14-结果集处理：反射处理结果集" class="headerlink" title="14. 结果集处理：反射处理结果集"></a>14. 结果集处理：反射处理结果集</h3><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token keyword">type</span> Field <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 字段名</span>
    goName <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 列名</span>
    colName <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 列的类型</span>
    typ reflect<span class="token punctuation">.</span>Type
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>entity any<span class="token punctuation">,</span> opts <span class="token operator">...</span>ModelOpt<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    fieldMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">,</span> numField<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numField<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        fieldMap<span class="token punctuation">[</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>Field<span class="token punctuation">{</span>
            goName<span class="token punctuation">:</span> fd<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//colName: underscoreName(fd.Name),</span>
            colName<span class="token punctuation">:</span> colName<span class="token punctuation">,</span>
            typ<span class="token punctuation">:</span>     fd<span class="token punctuation">.</span>Type<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    q<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    db <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>db
    <span class="token comment" spellcheck="true">// 发起查询,并处理结果集</span>
    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//_, err  = db.QueryContext(ctx, q.SQL, q.Args...)</span>
    <span class="token comment" spellcheck="true">// 查询错误</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrNoRows
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// select出来多少列</span>
    cs<span class="token punctuation">,</span> err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Columns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    tp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>

    vals <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// c是列名</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fd <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fields <span class="token punctuation">{</span>
            <span class="token keyword">if</span> fd<span class="token punctuation">.</span>colName <span class="token operator">==</span> c <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 反射创建实例</span>
                <span class="token comment" spellcheck="true">// 这里创建的实例是原本类型的指针</span>
                val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>typ<span class="token punctuation">)</span>
                vals <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>vals<span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span>vals<span class="token operator">...</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 把vals填入tp</span>
    tpValue <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// c是列名</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fd <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fields <span class="token punctuation">{</span>
            <span class="token keyword">if</span> fd<span class="token punctuation">.</span>colName <span class="token operator">==</span> c <span class="token punctuation">{</span>
                tpValue<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FieldByName</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>goName<span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">Set</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>vals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> tp<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestGet</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mockDB<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">OpenDB</span><span class="token punctuation">(</span>mockDB<span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// query error</span>
    mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnError</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"query error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// no rows</span>
    rows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
        <span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// data</span>
    rows <span class="token operator">=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
        <span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    rows<span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">,</span> <span class="token string">"Jerry"</span><span class="token punctuation">)</span>
    mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>

    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>
        s    <span class="token operator">*</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span>

        wantRes <span class="token operator">*</span>TestModel
        wantErr <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"invalid query"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"query error"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"query error"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"no rows"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"orm: 没有数据"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>    <span class="token string">"data"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantRes<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>Id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantRes<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="15-结果集处理：代码优化与总结"><a href="#15-结果集处理：代码优化与总结" class="headerlink" title="15. 结果集处理：代码优化与总结"></a>15. 结果集处理：代码优化与总结</h3><p><img src="e73d1f3a.png"><img src="ea005a39.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token keyword">type</span> Model <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tableName <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 字段名-字段定义</span>
    fieldMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field
    <span class="token comment" spellcheck="true">// 列名-字段定义</span>
    columnMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>entity any<span class="token punctuation">,</span> opts <span class="token operator">...</span>ModelOpt<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    fieldMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">,</span> numField<span class="token punctuation">)</span>
    columnMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">,</span> numField<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numField<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        fd <span class="token operator">:=</span> elemType<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 取tag `xxx:xxx=xxx`</span>
        pair<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">parseTag</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Tag<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 取column: `orm:"column"=xxx`</span>
        colName <span class="token operator">:=</span> pair<span class="token punctuation">[</span>tagKeyColumn<span class="token punctuation">]</span>
        <span class="token keyword">if</span> colName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 用户没有设置,用字段名</span>
            colName <span class="token operator">=</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        fdData <span class="token operator">:=</span> <span class="token operator">&amp;</span>Field<span class="token punctuation">{</span>
            goName<span class="token punctuation">:</span> fd<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//colName: underscoreName(fd.Name),</span>
            colName<span class="token punctuation">:</span> colName<span class="token punctuation">,</span>
            typ<span class="token punctuation">:</span>     fd<span class="token punctuation">.</span>Type<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        fieldMap<span class="token punctuation">[</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> fdData
        columnMap<span class="token punctuation">[</span>colName<span class="token punctuation">]</span> <span class="token operator">=</span> fdData
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> tableName <span class="token builtin">string</span>
    <span class="token keyword">if</span> tbl<span class="token punctuation">,</span> ok <span class="token operator">:=</span> entity<span class="token punctuation">.</span><span class="token punctuation">(</span>TableName<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        tableName <span class="token operator">=</span> tbl<span class="token punctuation">.</span><span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> tableName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        tableName <span class="token operator">=</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>elemType<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
        tableName<span class="token punctuation">:</span> tableName<span class="token punctuation">,</span>
        fieldMap<span class="token punctuation">:</span>  fieldMap<span class="token punctuation">,</span>
        columnMap<span class="token punctuation">:</span> columnMap<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        err <span class="token operator">:=</span> <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    r<span class="token punctuation">.</span>models<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Test_parseModel</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity    any
        wantModel <span class="token operator">*</span>Model
        fields    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"struct"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//wantModel: &amp;Model{</span>
            <span class="token comment" spellcheck="true">//    tableName: "test_model",</span>
            <span class="token comment" spellcheck="true">//    fieldMap: map[string]*Field{</span>
            <span class="token comment" spellcheck="true">//        "Id": {</span>
            <span class="token comment" spellcheck="true">//            colName: "id",</span>
            <span class="token comment" spellcheck="true">//        },</span>
            <span class="token comment" spellcheck="true">//        "FirstName": {</span>
            <span class="token comment" spellcheck="true">//            colName: "first_name",</span>
            <span class="token comment" spellcheck="true">//        },</span>
            <span class="token comment" spellcheck="true">//        "LastName": {</span>
            <span class="token comment" spellcheck="true">//            colName: "last_name",</span>
            <span class="token comment" spellcheck="true">//        },</span>
            <span class="token comment" spellcheck="true">//        "Age": {</span>
            <span class="token comment" spellcheck="true">//            colName: "age",</span>
            <span class="token comment" spellcheck="true">//        },</span>
            <span class="token comment" spellcheck="true">//    },</span>
            <span class="token comment" spellcheck="true">//},</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span>ErrPointerOnly<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"test_model"</span><span class="token punctuation">,</span>
                fieldMap<span class="token punctuation">:</span>  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            fields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">{</span>
                <span class="token punctuation">{</span>
                    colName<span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
                    goName<span class="token punctuation">:</span>  <span class="token string">"Id"</span><span class="token punctuation">,</span>
                    typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    goName<span class="token punctuation">:</span>  <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
                    typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    colName<span class="token punctuation">:</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
                    goName<span class="token punctuation">:</span>  <span class="token string">"LastName"</span><span class="token punctuation">,</span>
                    typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    colName<span class="token punctuation">:</span> <span class="token string">"age"</span><span class="token punctuation">,</span>
                    goName<span class="token punctuation">:</span>  <span class="token string">"Age"</span><span class="token punctuation">,</span>
                    typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> <span class="token operator">&amp;</span>registry<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            fieldMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">)</span>
            columnMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> tc<span class="token punctuation">.</span>fields <span class="token punctuation">{</span>
                fieldMap<span class="token punctuation">[</span>f<span class="token punctuation">.</span>goName<span class="token punctuation">]</span> <span class="token operator">=</span> f
                columnMap<span class="token punctuation">[</span>f<span class="token punctuation">.</span>colName<span class="token punctuation">]</span> <span class="token operator">=</span> f
            <span class="token punctuation">}</span>
            tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">.</span>fieldMap <span class="token operator">=</span> fieldMap
            tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">.</span>columnMap <span class="token operator">=</span> columnMap
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestRegistry_Get</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>

        entity    any
        wantModel <span class="token operator">*</span>Model
        fields    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"pointer"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"test_model"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            fields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">{</span>
                <span class="token punctuation">{</span>
                    colName<span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
                    goName<span class="token punctuation">:</span>  <span class="token string">"Id"</span><span class="token punctuation">,</span>
                    typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
                    goName<span class="token punctuation">:</span>  <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
                    typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    colName<span class="token punctuation">:</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
                    goName<span class="token punctuation">:</span>  <span class="token string">"LastName"</span><span class="token punctuation">,</span>
                    typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    colName<span class="token punctuation">:</span> <span class="token string">"age"</span><span class="token punctuation">,</span>
                    goName<span class="token punctuation">:</span>  <span class="token string">"Age"</span><span class="token punctuation">,</span>
                    typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"tag"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">{</span>
                <span class="token keyword">type</span> TagTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                    FirstName <span class="token builtin">string</span> <span class="token string">`orm:"column=first_name_t"`</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>TagTable<span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            fields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">{</span>
                <span class="token punctuation">{</span>
                    colName<span class="token punctuation">:</span> <span class="token string">"first_name_t"</span><span class="token punctuation">,</span>
                    goName<span class="token punctuation">:</span>  <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
                    typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
                tableName<span class="token punctuation">:</span> <span class="token string">"tag_table"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"empty tag"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">{</span>
                <span class="token keyword">type</span> TagTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
                    FirstName <span class="token builtin">string</span> <span class="token string">`orm:"column="`</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>TagTable<span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            fields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">{</span><span class="token punctuation">{</span>
				colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
				goName<span class="token punctuation">:</span>  <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
				typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
				tableName<span class="token punctuation">:</span> <span class="token string">"tag_table"</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">"column only"</span><span class="token punctuation">,</span>
			entity<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">{</span>
				<span class="token keyword">type</span> TagTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
					FirstName <span class="token builtin">string</span> <span class="token string">`orm:"column"`</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> <span class="token operator">&amp;</span>TagTable<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrInvalidTagContent</span><span class="token punctuation">(</span><span class="token string">"column"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span> <span class="token string">"invalid tag"</span><span class="token punctuation">,</span>
			entity<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">{</span>
				<span class="token keyword">type</span> TagTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
					FirstName <span class="token builtin">string</span> <span class="token string">`orm:"abc=abc"`</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">return</span> <span class="token operator">&amp;</span>TagTable<span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			fields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">{</span>
				<span class="token punctuation">{</span>
					colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
					goName<span class="token punctuation">:</span>  <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
					typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
				tableName<span class="token punctuation">:</span> <span class="token string">"tag_table"</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>   <span class="token string">"custom table name"</span><span class="token punctuation">,</span>
			entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>CustomTableName<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			fields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">{</span>
				<span class="token punctuation">{</span>
					colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
					goName<span class="token punctuation">:</span>  <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
					typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
				tableName<span class="token punctuation">:</span> <span class="token string">"custom_table_name_t"</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>   <span class="token string">"custom table name ptr"</span><span class="token punctuation">,</span>
			entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>CustomTableNamePtr<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			fields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">{</span>
				<span class="token punctuation">{</span>
					colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
					goName<span class="token punctuation">:</span>  <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
					typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
				tableName<span class="token punctuation">:</span> <span class="token string">"custom_table_name_ptr_t"</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>   <span class="token string">"custom table name empty ptr"</span><span class="token punctuation">,</span>
			entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>CustomTableNameEmpty<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			fields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">{</span>
				<span class="token punctuation">{</span>
					colName<span class="token punctuation">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
					goName<span class="token punctuation">:</span>  <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
					typ<span class="token punctuation">:</span>     reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			wantModel<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
				tableName<span class="token punctuation">:</span> <span class="token string">"custom_table_name_empty"</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	r <span class="token operator">:=</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
			assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			fieldMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">)</span>
			columnMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">)</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> tc<span class="token punctuation">.</span>fields <span class="token punctuation">{</span>
				fieldMap<span class="token punctuation">[</span>f<span class="token punctuation">.</span>goName<span class="token punctuation">]</span> <span class="token operator">=</span> f
				columnMap<span class="token punctuation">[</span>f<span class="token punctuation">.</span>colName<span class="token punctuation">]</span> <span class="token operator">=</span> f
			<span class="token punctuation">}</span>
			tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">.</span>fieldMap <span class="token operator">=</span> fieldMap
			tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">.</span>columnMap <span class="token operator">=</span> columnMap

			assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> m<span class="token punctuation">)</span>

			typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
			cache<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>models<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>typ<span class="token punctuation">)</span>
			assert<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
			assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantModel<span class="token punctuation">,</span> cache<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CustomTableName <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	FirstName <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c CustomTableName<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">"custom_table_name_t"</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CustomTableNamePtr <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	FirstName <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>CustomTableNamePtr<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">"custom_table_name_ptr_t"</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CustomTableNameEmpty <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	FirstName <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c CustomTableNameEmpty<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">""</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestModelWithTableName</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">ModelWithTableName</span><span class="token punctuation">(</span><span class="token string">"test_model_ttt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"test_model_ttt"</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>tableName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestModelWithColName</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name <span class="token builtin">string</span>

		field   <span class="token builtin">string</span>
		colName <span class="token builtin">string</span>

		wantColName <span class="token builtin">string</span>
		wantErr     <span class="token builtin">error</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>        <span class="token string">"column name"</span><span class="token punctuation">,</span>
			field<span class="token punctuation">:</span>       <span class="token string">"FirstName"</span><span class="token punctuation">,</span>
			colName<span class="token punctuation">:</span>     <span class="token string">"first_name_ccc"</span><span class="token punctuation">,</span>
			wantColName<span class="token punctuation">:</span> <span class="token string">"first_name_ccc"</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"invalid column name"</span><span class="token punctuation">,</span>
			field<span class="token punctuation">:</span>   <span class="token string">"XXX"</span><span class="token punctuation">,</span>
			colName<span class="token punctuation">:</span> <span class="token string">"first_name_ccc"</span><span class="token punctuation">,</span>
			wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"XXX"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			r <span class="token operator">:=</span> <span class="token function">newRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">ModelWithColumnName</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>field<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>colName<span class="token punctuation">)</span><span class="token punctuation">)</span>
			assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>fieldMap<span class="token punctuation">[</span>tc<span class="token punctuation">.</span>field<span class="token punctuation">]</span>
			require<span class="token punctuation">.</span><span class="token function">True</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
			assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantColName<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>colName<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token string">``</span><span class="token string">`

`</span><span class="token string">``</span><span class="token keyword">go</span>
<span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment" spellcheck="true">// ...</span>

	tp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>

	vals <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	valElems <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
		<span class="token comment" spellcheck="true">// c是列名</span>
		fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>columnMap<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment" spellcheck="true">// 反射创建实例</span>
		<span class="token comment" spellcheck="true">// 这里创建的实例是原本类型的指针</span>
		val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>typ<span class="token punctuation">)</span>
		vals <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>vals<span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		valElems <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>valElems<span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span>vals<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token comment" spellcheck="true">// 把vals填入tp</span>
	tpValue <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
		fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>columnMap<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		tpValue<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FieldByName</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>goName<span class="token punctuation">)</span><span class="token punctuation">.</span>
			<span class="token comment" spellcheck="true">//Set(reflect.ValueOf(vals[i]).Elem())</span>
			<span class="token function">Set</span><span class="token punctuation">(</span>valElems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> tp<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token string">``</span><span class="token string">`

`</span><span class="token string">``</span><span class="token keyword">go</span>
<span class="token comment" spellcheck="true">// select_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"database/sql"</span>
	<span class="token string">"errors"</span>
	<span class="token string">"github.com/DATA-DOG/go-sqlmock"</span>
	<span class="token string">"github.com/stretchr/testify/assert"</span>
	<span class="token string">"github.com/stretchr/testify/require"</span>
	<span class="token string">"my_framework/orm/internal/errs"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSelector_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
	require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name <span class="token builtin">string</span>

		builder QueryBuilder

		wantQuery <span class="token operator">*</span>Query
		wantErr   <span class="token builtin">error</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"not from"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"from"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"`test_model`"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"empty from"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"empty table"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"db table"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"`mybatis`.`test`"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `mybatis`.`test`;"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"where"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE `age` = ?;"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"empty where"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model`;"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"not"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">Not</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE  NOT (`age` = ?);"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"and"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE (`age` = ?) AND (`first_name` = ?);"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"and"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
				SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE (`age` = ?) OR (`first_name` = ?);"</span><span class="token punctuation">,</span>
				Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"invalid column"</span><span class="token punctuation">,</span>
			builder<span class="token punctuation">:</span> <span class="token punctuation">(</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Or</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"XXXX"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"XXXX"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestGet</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mockDB<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">OpenDB</span><span class="token punctuation">(</span>mockDB<span class="token punctuation">)</span>
	require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

	<span class="token comment" spellcheck="true">// query error</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnError</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"query error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment" spellcheck="true">// no rows</span>
	rows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
		<span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
	<span class="token comment" spellcheck="true">// data</span>
	rows <span class="token operator">=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
		<span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	rows<span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">,</span> <span class="token string">"Jerry"</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
	<span class="token comment" spellcheck="true">// scan error</span>
	rows <span class="token operator">=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
		<span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	rows<span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">,</span> <span class="token string">"Jerry"</span><span class="token punctuation">)</span>
	mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>

	testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		name <span class="token builtin">string</span>
		s    <span class="token operator">*</span>Selector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span>

		wantRes <span class="token operator">*</span>TestModel
		wantErr <span class="token builtin">error</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"invalid query"</span><span class="token punctuation">,</span>
			s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"query error"</span><span class="token punctuation">,</span>
			s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"query error"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"no rows"</span><span class="token punctuation">,</span>
			s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"orm: 没有数据"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			name<span class="token punctuation">:</span>    <span class="token string">"data"</span><span class="token punctuation">,</span>
			s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			wantRes<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>Id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">//{</span>
        <span class="token comment" spellcheck="true">//    name:    "scan error",</span>
        <span class="token comment" spellcheck="true">//    s:       NewSelector[TestModel](db).Where(C("Id").Lt(1)),</span>
        <span class="token comment" spellcheck="true">//    wantErr: errs.ErrNoRows,</span>
        <span class="token comment" spellcheck="true">//},</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantRes<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TestModel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id        <span class="token builtin">int64</span>
    FirstName <span class="token builtin">string</span>
    Age       <span class="token builtin">int8</span>
    LastName  <span class="token operator">*</span>sql<span class="token punctuation">.</span>NullString
<span class="token punctuation">}</span>
</code></pre>
<h3 id="16-加餐：Option-设计模式"><a href="#16-加餐：Option-设计模式" class="headerlink" title="16. 加餐：Option 设计模式"></a>16. 加餐：Option 设计模式</h3><pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> other

<span class="token keyword">import</span> <span class="token string">"errors"</span>

<span class="token keyword">type</span> MyStructOption <span class="token keyword">func</span><span class="token punctuation">(</span>myStruct <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span>
<span class="token keyword">type</span> MyStructOptionErr <span class="token keyword">func</span><span class="token punctuation">(</span>myStruct <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span> <span class="token builtin">error</span>

<span class="token keyword">type</span> MyStruct <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 有两部分, 1.必须用户输入 2.可选</span>
    <span class="token comment" spellcheck="true">// 必传</span>
    id   <span class="token builtin">uint64</span>
    name <span class="token builtin">string</span>

    <span class="token comment" spellcheck="true">// 可选</span>
    address <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// ...</span>

    field1 <span class="token builtin">int</span>
    field2 <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithField1And2</span><span class="token punctuation">(</span>field1 <span class="token builtin">int</span><span class="token punctuation">,</span> field2 <span class="token builtin">int</span><span class="token punctuation">)</span> MyStructOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>myStruct <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        myStruct<span class="token punctuation">.</span>field1 <span class="token operator">=</span> field1
        myStruct<span class="token punctuation">.</span>field2 <span class="token operator">=</span> field2
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithAddress</span><span class="token punctuation">(</span>address <span class="token builtin">string</span><span class="token punctuation">)</span> MyStructOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>myStruct <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        myStruct<span class="token punctuation">.</span>address <span class="token operator">=</span> address
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithField1And2V1</span><span class="token punctuation">(</span>field1 <span class="token builtin">int</span><span class="token punctuation">,</span> field2 <span class="token builtin">int</span><span class="token punctuation">)</span> MyStructOptionErr <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>myStruct <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        myStruct<span class="token punctuation">.</span>field1 <span class="token operator">=</span> field1
        myStruct<span class="token punctuation">.</span>field2 <span class="token operator">=</span> field2
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithAddressV1</span><span class="token punctuation">(</span>address <span class="token builtin">string</span><span class="token punctuation">)</span> MyStructOptionErr <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>myStruct <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> address <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"地址不能为空"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        myStruct<span class="token punctuation">.</span>address <span class="token operator">=</span> address
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">WithAddressV2</span><span class="token punctuation">(</span>address <span class="token builtin">string</span><span class="token punctuation">)</span> MyStructOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>myStruct <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> address <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            <span class="token function">panic</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"地址不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        myStruct<span class="token punctuation">.</span>address <span class="token operator">=</span> address
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 参数包含用户所有必须传入的字段</span>
<span class="token keyword">func</span> <span class="token function">NewMyStruct</span><span class="token punctuation">(</span>id <span class="token builtin">uint64</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>MyStructOption<span class="token punctuation">)</span> <span class="token operator">*</span>MyStruct <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 必传部分</span>
    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyStruct<span class="token punctuation">{</span>
        id<span class="token punctuation">:</span>   id<span class="token punctuation">,</span>
        name<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 参数包含用户所有必须传入的字段</span>
<span class="token keyword">func</span> <span class="token function">NewMyStructV1</span><span class="token punctuation">(</span>id <span class="token builtin">uint64</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>MyStructOptionErr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>MyStruct<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 必传部分</span>
    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyStruct<span class="token punctuation">{</span>
        id<span class="token punctuation">:</span>   id<span class="token punctuation">,</span>
        name<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h1 id="12-第六周：ORM-框架之结果集处理、SELECT-进阶与-INSERT"><a href="#12-第六周：ORM-框架之结果集处理、SELECT-进阶与-INSERT" class="headerlink" title="12 第六周：ORM 框架之结果集处理、SELECT 进阶与 INSERT"></a>12 第六周：ORM 框架之结果集处理、SELECT 进阶与 INSERT</h1><h2 id="结果集处理"><a href="#结果集处理" class="headerlink" title="结果集处理"></a>结果集处理</h2><h3 id="1-结果集处理：unsafe-入门"><a href="#1-结果集处理：unsafe-入门" class="headerlink" title="1. 结果集处理：unsafe 入门"></a>1. 结果集处理：unsafe 入门</h3><p><img src="72c346eb.png"><img src="387625f7.png"><img src="af4b8ee6.png"><img src="b337f195.png"><img src="b6f8e8dd.png"><br><img src="5d4f7079.png"><img src="8d1dff4f.png"><img src="09122c6e.png"><img src="8dbff44b.png"><img src="685ff801.png"><br><img src="b8f34603.png"><img src="90766cd8.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// accessor.go</span>
<span class="token keyword">package</span> unsafe

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"errors"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"unsafe"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> UnsafeAccessor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    fields  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>FieldMeta
    address unsafe<span class="token punctuation">.</span>Pointer
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewUnsafeAccessor</span><span class="token punctuation">(</span>entity any<span class="token punctuation">)</span> <span class="token operator">*</span>UnsafeAccessor <span class="token punctuation">{</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    typ <span class="token operator">=</span> typ<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    numField <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">NumField</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fields <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>FieldMeta<span class="token punctuation">,</span> numField<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numField<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        fd <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        fields<span class="token punctuation">[</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> FieldMeta<span class="token punctuation">{</span>
            Offset<span class="token punctuation">:</span> fd<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
            typ<span class="token punctuation">:</span>    fd<span class="token punctuation">.</span>Type<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>UnsafeAccessor<span class="token punctuation">{</span>
        fields<span class="token punctuation">:</span>  fields<span class="token punctuation">,</span>
        address<span class="token punctuation">:</span> val<span class="token punctuation">.</span><span class="token function">UnsafePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>UnsafeAccessor<span class="token punctuation">)</span> <span class="token function">Field</span><span class="token punctuation">(</span>field <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 起始地址</span>
    <span class="token comment" spellcheck="true">//a.address</span>
    fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> a<span class="token punctuation">.</span>fields<span class="token punctuation">[</span>field<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"非法字段"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 字段起始地址</span>
    fdAddress <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> fd<span class="token punctuation">.</span>Offset<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 知道类型的情况</span>
    <span class="token comment" spellcheck="true">//return *(*int)(fdAddress), nil</span>
    <span class="token comment" spellcheck="true">// 不知道类型</span>
    <span class="token comment" spellcheck="true">// 根据地址转为对应类型的指针</span>
    <span class="token keyword">return</span> reflect<span class="token punctuation">.</span><span class="token function">NewAt</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> fdAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>UnsafeAccessor<span class="token punctuation">)</span> <span class="token function">SetField</span><span class="token punctuation">(</span>field <span class="token builtin">string</span><span class="token punctuation">,</span> val any<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 起始地址</span>
    <span class="token comment" spellcheck="true">//a.address</span>
    fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> a<span class="token punctuation">.</span>fields<span class="token punctuation">[</span>field<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"非法字段"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 字段起始地址</span>
    fdAddress <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> fd<span class="token punctuation">.</span>Offset<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 知道类型</span>
    <span class="token comment" spellcheck="true">//*(*int)(fdAddress) = val.(int)</span>
    <span class="token comment" spellcheck="true">// 不知道类型</span>
    reflect<span class="token punctuation">.</span><span class="token function">NewAt</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> fdAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> FieldMeta <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Offset <span class="token builtin">uintptr</span>
    typ    reflect<span class="token punctuation">.</span>Type
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// accessor_test.go</span>
<span class="token keyword">package</span> unsafe

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestUnsafeAccessor_Field</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        Name <span class="token builtin">string</span>
        Age  <span class="token builtin">int</span>
    <span class="token punctuation">}</span>

    accessor <span class="token operator">:=</span> <span class="token function">NewUnsafeAccessor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>User<span class="token punctuation">{</span>
        Name<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
        Age<span class="token punctuation">:</span>  <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    field<span class="token punctuation">,</span> err <span class="token operator">:=</span> accessor<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span>

    err <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">SetField</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// iterate_fields_test.go</span>
<span class="token keyword">package</span> unsafe

<span class="token keyword">import</span> <span class="token string">"testing"</span>

<span class="token keyword">func</span> <span class="token function">TestPrintFieldOffset</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name   <span class="token builtin">string</span>
        entity any
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"user"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"user v1"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> UserV1<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">PrintFieldOffset</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 0</span>
    Name    <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 16</span>
    Age     <span class="token builtin">int32</span>
    <span class="token comment" spellcheck="true">// 24</span>
    Alias   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 48</span>
    Address <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> UserV1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 0</span>
    Name    <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 16</span>
    Age     <span class="token builtin">int32</span>
    <span class="token comment" spellcheck="true">// 20</span>
    AgeV1     <span class="token builtin">int32</span>
    <span class="token comment" spellcheck="true">// 24</span>
    Alias   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 48</span>
    Address <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// iterate_fields.go</span>
<span class="token keyword">package</span> unsafe

<span class="token keyword">import</span> <span class="token string">"reflect"</span>

<span class="token keyword">func</span> <span class="token function">PrintFieldOffset</span><span class="token punctuation">(</span>entity any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span>
    numField <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">NumField</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numField<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        field <span class="token operator">:=</span> typ<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>Offset<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="2-结果集处理：unsafe-实现"><a href="#2-结果集处理：unsafe-实现" class="headerlink" title="2. 结果集处理：unsafe 实现"></a>2. 结果集处理：unsafe 实现</h3><p><img src="880a2462.png"><img src="20d7d4a1.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">GetV1</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    q<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    db <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>db
    <span class="token comment" spellcheck="true">// 发起查询,并处理结果集</span>
    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//_, err  = db.QueryContext(ctx, q.SQL, q.Args...)</span>
    <span class="token comment" spellcheck="true">// 查询错误</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrNoRows
    <span class="token punctuation">}</span>

    cs<span class="token punctuation">,</span> err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Columns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> vals <span class="token punctuation">[</span><span class="token punctuation">]</span>any
    tp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>   
    <span class="token comment" spellcheck="true">// 起始地址</span>
    address <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnsafePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// c是列名</span>
        fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>columnMap<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 需要计算偏移量</span>
        <span class="token comment" spellcheck="true">// 起始地址+偏移量</span>
        fdAddress <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> fd<span class="token punctuation">.</span>offset<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 在指定地址上创建原本类型的指针</span>
        <span class="token comment" spellcheck="true">// 得到的是指针类型</span>
        val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">NewAt</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> fdAddress<span class="token punctuation">)</span>
        vals <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>vals<span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span>vals<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> tp<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>entity any<span class="token punctuation">,</span> opts <span class="token operator">...</span>ModelOpt<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    fieldMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">,</span> numField<span class="token punctuation">)</span>
    columnMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field<span class="token punctuation">,</span> numField<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numField<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        fd <span class="token operator">:=</span> elemType<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 取tag `xxx:xxx=xxx`</span>
        pair<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">parseTag</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Tag<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 取column: `orm:"column"=xxx`</span>
        colName <span class="token operator">:=</span> pair<span class="token punctuation">[</span>tagKeyColumn<span class="token punctuation">]</span>
        <span class="token keyword">if</span> colName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 用户没有设置,用字段名</span>
            colName <span class="token operator">=</span> <span class="token function">underscoreName</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        fdData <span class="token operator">:=</span> <span class="token operator">&amp;</span>Field<span class="token punctuation">{</span>
            goName<span class="token punctuation">:</span> fd<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//colName: underscoreName(fd.Name),</span>
            colName<span class="token punctuation">:</span> colName<span class="token punctuation">,</span>
            typ<span class="token punctuation">:</span>     fd<span class="token punctuation">.</span>Type<span class="token punctuation">,</span>
            offset<span class="token punctuation">:</span>  fd<span class="token punctuation">.</span>Offset<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        fieldMap<span class="token punctuation">[</span>fd<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> fdData
        columnMap<span class="token punctuation">[</span>colName<span class="token punctuation">]</span> <span class="token operator">=</span> fdData
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="3-结果集处理：valuer-重构与基准测试"><a href="#3-结果集处理：valuer-重构与基准测试" class="headerlink" title="3. 结果集处理：valuer 重构与基准测试"></a>3. 结果集处理：valuer 重构与基准测试</h3><p><img src="39884fc2.png"><img src="3988f6eb.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    q<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    db <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>db
    <span class="token comment" spellcheck="true">// 发起查询,并处理结果集</span>
    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//_, err  = db.QueryContext(ctx, q.SQL, q.Args...)</span>
    <span class="token comment" spellcheck="true">// 查询错误</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrNoRows
    <span class="token punctuation">}</span>

    tp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>
    val <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">creator</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>model<span class="token punctuation">,</span> tp<span class="token punctuation">)</span>
    err <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">SetColumns</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
    <span class="token keyword">return</span> tp<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// db.go</span>
<span class="token keyword">type</span> DB <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    r       model<span class="token punctuation">.</span>Registry
    db      <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB
    creator valuer<span class="token punctuation">.</span>Creator
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">DBUseReflect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> DBOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span>creator <span class="token operator">=</span> valuer<span class="token punctuation">.</span>NewReflectValue
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">DBUseUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> DBOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span>creator <span class="token operator">=</span> valuer<span class="token punctuation">.</span>NewUnsafeValue
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Open</span><span class="token punctuation">(</span>driver <span class="token builtin">string</span><span class="token punctuation">,</span> dataSoruceName <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>DBOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> dataSoruceName<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">OpenDB</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">OpenDB</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> opts <span class="token operator">...</span>DBOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>DB<span class="token punctuation">{</span>
        r<span class="token punctuation">:</span>       model<span class="token punctuation">.</span><span class="token function">NewRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        db<span class="token punctuation">:</span>      db<span class="token punctuation">,</span>
        creator<span class="token punctuation">:</span> valuer<span class="token punctuation">.</span>NewUnsafeValue<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// value.go</span>
<span class="token keyword">package</span> valuer

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"my_framework/orm/model"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Value <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">SetColumns</span><span class="token punctuation">(</span>rows <span class="token operator">*</span>sql<span class="token punctuation">.</span>Rows<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ValuerV1 <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">SetColumns</span><span class="token punctuation">(</span>ehntity any<span class="token punctuation">,</span> rows <span class="token operator">*</span>sql<span class="token punctuation">.</span>Rows<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Creator <span class="token keyword">func</span><span class="token punctuation">(</span>model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model<span class="token punctuation">,</span> entity any<span class="token punctuation">)</span> Value
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// unsafe.go</span>
<span class="token keyword">package</span> valuer

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"my_framework/orm/model"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"unsafe"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> unsafeValue <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model
    <span class="token comment" spellcheck="true">// *T</span>
    val any
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 如果后续Creator的定义修改,这里会报错,就可以知道发生了改变</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> Creator <span class="token operator">=</span> NewUnsafeValue

<span class="token keyword">func</span> <span class="token punctuation">(</span>u unsafeValue<span class="token punctuation">)</span> <span class="token function">SetColumns</span><span class="token punctuation">(</span>rows <span class="token operator">*</span>sql<span class="token punctuation">.</span>Rows<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    cs<span class="token punctuation">,</span> err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Columns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> vals <span class="token punctuation">[</span><span class="token punctuation">]</span>any
    <span class="token comment" spellcheck="true">// 起始地址</span>
    address <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnsafePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// c是列名</span>
        fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> u<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ColumnMap<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 需要计算偏移量</span>
        <span class="token comment" spellcheck="true">// 起始地址+偏移量</span>
        fdAddress <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> fd<span class="token punctuation">.</span>Offset<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 在指定地址上创建原本类型的指针</span>
        <span class="token comment" spellcheck="true">// 得到的是指针类型</span>
        val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">NewAt</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Typ<span class="token punctuation">,</span> fdAddress<span class="token punctuation">)</span>
        vals <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>vals<span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span>vals<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewUnsafeValue</span><span class="token punctuation">(</span>model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model<span class="token punctuation">,</span> val any<span class="token punctuation">)</span> Value <span class="token punctuation">{</span>
    <span class="token keyword">return</span> unsafeValue<span class="token punctuation">{</span>
        model<span class="token punctuation">:</span> model<span class="token punctuation">,</span>
        val<span class="token punctuation">:</span>   val<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// reflect.go</span>
<span class="token keyword">package</span> valuer

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"my_framework/orm/model"</span>
    <span class="token string">"reflect"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> reflectValue <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model
    <span class="token comment" spellcheck="true">// 对应T的指针</span>
    val any
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token boolean">_</span> Creator <span class="token operator">=</span> NewReflectValue

<span class="token keyword">func</span> <span class="token punctuation">(</span>r reflectValue<span class="token punctuation">)</span> <span class="token function">SetColumns</span><span class="token punctuation">(</span>rows <span class="token operator">*</span>sql<span class="token punctuation">.</span>Rows<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// select出来多少列</span>
    cs<span class="token punctuation">,</span> err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Columns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    vals <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    valElems <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// c是列名</span>
        fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ColumnMap<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 反射创建实例</span>
        <span class="token comment" spellcheck="true">// 这里创建的实例是原本类型的指针</span>
        val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Typ<span class="token punctuation">)</span>
        vals <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>vals<span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        valElems <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>valElems<span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span>vals<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 把vals填入tp</span>
    tpValue <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
        fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ColumnMap<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        tpValue<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FieldByName</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>GoName<span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token comment" spellcheck="true">//Set(reflect.ValueOf(vals[i]).Elem())</span>
            <span class="token function">Set</span><span class="token punctuation">(</span>valElems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewReflectValue</span><span class="token punctuation">(</span>model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model<span class="token punctuation">,</span> val any<span class="token punctuation">)</span> Value <span class="token punctuation">{</span>
    <span class="token keyword">return</span> reflectValue<span class="token punctuation">{</span>
        model<span class="token punctuation">:</span> model<span class="token punctuation">,</span>
        val<span class="token punctuation">:</span>   val<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// reflect_test.go</span>
<span class="token keyword">package</span> valuer

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"github.com/DATA-DOG/go-sqlmock"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"my_framework/orm/model"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> TestModel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id        <span class="token builtin">int64</span>
    FirstName <span class="token builtin">string</span>
    Age       <span class="token builtin">int8</span>
    LastName  <span class="token operator">*</span>sql<span class="token punctuation">.</span>NullString
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestReflectValue_SetColumns</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">testSetColumns</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> NewReflectValue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">testSetColumns</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> create Creator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>
        <span class="token comment" spellcheck="true">// 指针</span>
        entity     any
        rows       <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>sqlmock<span class="token punctuation">.</span>Rows
        wantErr    <span class="token builtin">error</span>
        wantEntity any
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span>   <span class="token string">"set columns"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            rows<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>sqlmock<span class="token punctuation">.</span>Rows <span class="token punctuation">{</span>
                rows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                rows<span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">,</span> <span class="token string">"Jerry"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> rows
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantEntity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                Id<span class="token punctuation">:</span>        <span class="token number">1</span><span class="token punctuation">,</span>
                FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
                Age<span class="token punctuation">:</span>       <span class="token number">18</span><span class="token punctuation">,</span>
                LastName<span class="token punctuation">:</span>  <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 部分列</span>
            name<span class="token punctuation">:</span>   <span class="token string">"partial columns"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            rows<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>sqlmock<span class="token punctuation">.</span>Rows <span class="token punctuation">{</span>
                rows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                rows<span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> rows
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantEntity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                Id<span class="token punctuation">:</span>        <span class="token number">1</span><span class="token punctuation">,</span>
                FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 列的不同顺序</span>
            name<span class="token punctuation">:</span>   <span class="token string">"order"</span><span class="token punctuation">,</span>
            entity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            rows<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>sqlmock<span class="token punctuation">.</span>Rows <span class="token punctuation">{</span>
                rows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                rows<span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> rows
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            wantEntity<span class="token punctuation">:</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                Id<span class="token punctuation">:</span>        <span class="token number">1</span><span class="token punctuation">,</span>
                FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
                Age<span class="token punctuation">:</span>       <span class="token number">18</span><span class="token punctuation">,</span>
                LastName<span class="token punctuation">:</span>  <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">:=</span> model<span class="token punctuation">.</span><span class="token function">NewRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    mockDB<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> mockDB<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> testCases <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 构造rows</span>
            mockRows <span class="token operator">:=</span> tc<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT XX"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>mockRows<span class="token punctuation">)</span>
            rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> mockDB<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"SELECT XX"</span><span class="token punctuation">)</span>
            require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

            rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            model<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            val <span class="token operator">:=</span> <span class="token function">create</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
            val<span class="token punctuation">.</span><span class="token function">SetColumns</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 比较有没有设置好数据</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantEntity<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>entity<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// unsafe_test.go</span>
<span class="token keyword">package</span> valuer

<span class="token keyword">import</span> <span class="token string">"testing"</span>

<span class="token keyword">func</span> <span class="token function">TestUnsafeValue_SetColumns</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">testSetColumns</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> NewUnsafeValue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// value_test.go</span>
<span class="token keyword">package</span> valuer

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql/driver"</span>
    <span class="token string">"github.com/DATA-DOG/go-sqlmock"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"my_framework/orm/model"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// go test -bench=BenchmarkSetColumns -benchtime=10000x -benchmem</span>
<span class="token comment" spellcheck="true">// 单元测试已经确认结果正确,基准测试只需要测试调用</span>
<span class="token keyword">func</span> <span class="token function">BenchmarkSetColumns</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fn <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">,</span> creator Creator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mockDB<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">defer</span> mockDB<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// 构造rows,跑N次,要准备N条</span>
        mockRows <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">NewRows</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"last_name"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        row <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>driver<span class="token punctuation">.</span>Value<span class="token punctuation">{</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">,</span> <span class="token string">"Jerry"</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            mockRows<span class="token punctuation">.</span><span class="token function">AddRow</span><span class="token punctuation">(</span>row<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        mock<span class="token punctuation">.</span><span class="token function">ExpectQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT XX"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WillReturnRows</span><span class="token punctuation">(</span>mockRows<span class="token punctuation">)</span>

        rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> mockDB<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"SELECT XX"</span><span class="token punctuation">)</span>

        r <span class="token operator">:=</span> model<span class="token punctuation">.</span><span class="token function">NewRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        m<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 重置计时器</span>
        b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            val <span class="token operator">:=</span> <span class="token function">creator</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token boolean">_</span> <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">SetColumns</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"reflect"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> NewReflectValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"unsafe"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> NewUnsafeValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-结果集处理：总结与面试要点"><a href="#4-结果集处理：总结与面试要点" class="headerlink" title="4. 结果集处理：总结与面试要点"></a>4. 结果集处理：总结与面试要点</h3><p><img src="7aac89e7.png"><img src="e68dce87.png"><img src="36d6086b.png"><img src="8379875e.png"><img src="92aebe74.png"><br><img src="c77e4f56.png"><img src="68369b8e.png"><img src="0ca9f1b1.png"><img src="aba46cc1.png"><img src="fcd5376f.png"><br><img src="2c4162dd.png"><img src="8f34fe25.png"><img src="aea34c2e.png"><img src="32d1bb05.png"><img src="53dd6615.png"><br><img src="95901b70.png"><img src="3611f829.png"><img src="349062db.png"><img src="0dd921f4.png"><img src="a11d6deb.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// unsafe.go</span>
<span class="token keyword">package</span> valuer

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"my_framework/orm/model"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"unsafe"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> unsafeValue <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model
    <span class="token comment" spellcheck="true">// 起始地址</span>
    address unsafe<span class="token punctuation">.</span>Pointer
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 如果后续Creator的定义修改,这里会报错,就可以知道发生了改变</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> Creator <span class="token operator">=</span> NewUnsafeValue

<span class="token keyword">func</span> <span class="token punctuation">(</span>u unsafeValue<span class="token punctuation">)</span> <span class="token function">SetColumns</span><span class="token punctuation">(</span>rows <span class="token operator">*</span>sql<span class="token punctuation">.</span>Rows<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    cs<span class="token punctuation">,</span> err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Columns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> vals <span class="token punctuation">[</span><span class="token punctuation">]</span>any
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// c是列名</span>
        fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> u<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ColumnMap<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 需要计算偏移量</span>
        <span class="token comment" spellcheck="true">// 起始地址+偏移量</span>
        fdAddress <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> fd<span class="token punctuation">.</span>Offset<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 在指定地址上创建原本类型的指针</span>
        <span class="token comment" spellcheck="true">// 得到的是指针类型</span>
        val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">NewAt</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Typ<span class="token punctuation">,</span> fdAddress<span class="token punctuation">)</span>
        vals <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>vals<span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    err <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span>vals<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewUnsafeValue</span><span class="token punctuation">(</span>model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model<span class="token punctuation">,</span> val any<span class="token punctuation">)</span> Value <span class="token punctuation">{</span>
    address <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnsafePointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> unsafeValue<span class="token punctuation">{</span>
        model<span class="token punctuation">:</span>   model<span class="token punctuation">,</span>
        address<span class="token punctuation">:</span> address<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="SELECT进阶"><a href="#SELECT进阶" class="headerlink" title="SELECT进阶"></a>SELECT进阶</h2><h3 id="5-SELECT-进阶：指定简单列"><a href="#5-SELECT-进阶：指定简单列" class="headerlink" title="5. SELECT 进阶：指定简单列"></a>5. SELECT 进阶：指定简单列</h3><p><img src="10b09bef.png"><img src="c801a730.png"><img src="38152384.png"><img src="3b8f2677.png"><img src="76af385b.png"><br><img src="69480008.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select_test.go </span>
<span class="token keyword">func</span> <span class="token function">TestSelector_Select</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//db := memoryDB(t)</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name      <span class="token builtin">string</span>
        s         QueryBuilder
        wantQuery <span class="token operator">*</span>Query
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"multiple columns"</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//s:    NewSelector[TestModel](db).Select("first_name", "last_name"),</span>
            s<span class="token punctuation">:</span> NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"LastName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"SELECT `first_name`,`last_name` FROM `test_model`;"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"invalid columns"</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//s:    NewSelector[TestModel](db).Select("first_name", "last_name"),</span>
            s<span class="token punctuation">:</span>       NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Invalid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"Invalid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token comment" spellcheck="true">// Selectable 是一个标记接口</span>
<span class="token comment" spellcheck="true">// 代表的是查找的列或者聚合函数等</span>
<span class="token keyword">type</span> Selectable <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">selectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Selector<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    builder
    table   <span class="token builtin">string</span>
    where   <span class="token punctuation">[</span><span class="token punctuation">]</span>Predicate
    db      <span class="token operator">*</span>DB
    columns <span class="token punctuation">[</span><span class="token punctuation">]</span>Selectable
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Select</span><span class="token punctuation">(</span>cols <span class="token operator">...</span>Selectable<span class="token punctuation">)</span> <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>columns <span class="token operator">=</span> cols
    <span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
    sb <span class="token operator">:=</span> s<span class="token punctuation">.</span>sb

    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"SELECT "</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 是否指定列</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>columns<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> col <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>columns <span class="token punctuation">{</span>
            <span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 在添加字段前添加 ,</span>
            <span class="token comment" spellcheck="true">// 相对于在前一个col后加 ,</span>
            <span class="token keyword">if</span> i <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            err <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">buildColumn</span><span class="token punctuation">(</span>col<span class="token punctuation">.</span><span class="token punctuation">(</span>Column<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">` FROM `</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// build.go </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>builder<span class="token punctuation">)</span> <span class="token function">buildExpression</span><span class="token punctuation">(</span>expr Expression<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> exp <span class="token operator">:=</span> expr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
    <span class="token keyword">case</span> Predicate<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// 处理p</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> exp<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token punctuation">(</span>Predicate<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>op<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>

        <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">=</span> exp<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token punctuation">(</span>Predicate<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> Column<span class="token punctuation">:</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">buildColumn</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
    <span class="token keyword">case</span> value<span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnsupportedExpression</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>builder<span class="token punctuation">)</span> <span class="token function">buildColumn</span><span class="token punctuation">(</span>c Column<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>c<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true">// 传入了错误的字段</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// column.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">type</span> Column <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">C</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> Column <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Column<span class="token punctuation">{</span>name<span class="token punctuation">:</span> name<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Eq</span>
<span class="token comment" spellcheck="true">// C("id").Eq(12)</span>
<span class="token comment" spellcheck="true">// sub.C("id").Eq(12)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c Column<span class="token punctuation">)</span> <span class="token function">Eq</span><span class="token punctuation">(</span>arg any<span class="token punctuation">)</span> Predicate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Predicate<span class="token punctuation">{</span>
        left<span class="token punctuation">:</span>  c<span class="token punctuation">,</span>
        op<span class="token punctuation">:</span>    opEq<span class="token punctuation">,</span>
        right<span class="token punctuation">:</span> value<span class="token punctuation">{</span>val<span class="token punctuation">:</span> arg<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c Column<span class="token punctuation">)</span> <span class="token function">Lt</span><span class="token punctuation">(</span>arg any<span class="token punctuation">)</span> Predicate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Predicate<span class="token punctuation">{</span>
        left<span class="token punctuation">:</span>  c<span class="token punctuation">,</span>
        op<span class="token punctuation">:</span>    opLt<span class="token punctuation">,</span>
        right<span class="token punctuation">:</span> value<span class="token punctuation">{</span>val<span class="token punctuation">:</span> arg<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>Column<span class="token punctuation">)</span> <span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c Column<span class="token punctuation">)</span> <span class="token function">selectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="6-SELECT-进阶：指定聚合函数"><a href="#6-SELECT-进阶：指定聚合函数" class="headerlink" title="6. SELECT 进阶：指定聚合函数"></a>6. SELECT 进阶：指定聚合函数</h3><p><img src="64f0b5c6.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// aggregate.go</span>
<span class="token keyword">package</span> orm

<span class="token comment" spellcheck="true">// Aggregate 聚合函数</span>
<span class="token comment" spellcheck="true">// AVG("age"), SUM("age"), COUNT("age"), MAX("age"), MIN("age")</span>
<span class="token keyword">type</span> Aggregate <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    fn  <span class="token builtin">string</span>
    arg <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a Aggregate<span class="token punctuation">)</span> <span class="token function">selectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Avg</span><span class="token punctuation">(</span>col <span class="token builtin">string</span><span class="token punctuation">)</span> Aggregate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Aggregate<span class="token punctuation">{</span>
        fn<span class="token punctuation">:</span>  <span class="token string">"AVG"</span><span class="token punctuation">,</span>
        arg<span class="token punctuation">:</span> col<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Sum</span><span class="token punctuation">(</span>col <span class="token builtin">string</span><span class="token punctuation">)</span> Aggregate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Aggregate<span class="token punctuation">{</span>
        fn<span class="token punctuation">:</span>  <span class="token string">"SUM"</span><span class="token punctuation">,</span>
        arg<span class="token punctuation">:</span> col<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Count</span><span class="token punctuation">(</span>col <span class="token builtin">string</span><span class="token punctuation">)</span> Aggregate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Aggregate<span class="token punctuation">{</span>
        fn<span class="token punctuation">:</span>  <span class="token string">"COUNT"</span><span class="token punctuation">,</span>
        arg<span class="token punctuation">:</span> col<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Max</span><span class="token punctuation">(</span>col <span class="token builtin">string</span><span class="token punctuation">)</span> Aggregate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Aggregate<span class="token punctuation">{</span>
        fn<span class="token punctuation">:</span>  <span class="token string">"MAX"</span><span class="token punctuation">,</span>
        arg<span class="token punctuation">:</span> col<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Min</span><span class="token punctuation">(</span>col <span class="token builtin">string</span><span class="token punctuation">)</span> Aggregate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Aggregate<span class="token punctuation">{</span>
        fn<span class="token punctuation">:</span>  <span class="token string">"MIN"</span><span class="token punctuation">,</span>
        arg<span class="token punctuation">:</span> col<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestSelector_Select</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//db := memoryDB(t)</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name      <span class="token builtin">string</span>
        s         QueryBuilder
        wantQuery <span class="token operator">*</span>Query
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"avg"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>    NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token function">Avg</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"SELECT AVG(`age`) FROM `test_model`;"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"sum"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>    NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"SELECT SUM(`age`) FROM `test_model`;"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"sum invalid"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>    NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token string">"Invalid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"Invalid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"sum"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>    NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Avg</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"SELECT SUM(`age`),AVG(`age`) FROM `test_model`;"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
    sb <span class="token operator">:=</span> s<span class="token punctuation">.</span>sb

    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"SELECT "</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">buildColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">` FROM `</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">buildColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>columns<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> col <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>columns <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 在添加字段前添加 ,</span>
        <span class="token comment" spellcheck="true">// 相对于在前一个col后加 ,</span>
        <span class="token keyword">if</span> i <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> c <span class="token operator">:=</span> col<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> Column<span class="token punctuation">:</span>
            err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> Aggregate<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true">// 如果是聚合函数</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>fn<span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
            err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>arg<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="7-SELECT-进阶：原生表达式"><a href="#7-SELECT-进阶：原生表达式" class="headerlink" title="7. SELECT 进阶：原生表达式"></a>7. SELECT 进阶：原生表达式</h3><p><img src="b6c3554c.png"><img src="098694e0.png"><img src="b755ab01.png"><img src="83980170.png"><img src="871d219b.png"><br><img src="00962068.png"><img src="846d3cdd.png"><img src="30e7d1cf.png"><img src="94ab2445.png"><img src="657bdcc7.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// expression.go</span>
<span class="token keyword">package</span> orm

<span class="token comment" spellcheck="true">// Expression 是一个标记接口,代表表达式</span>
<span class="token keyword">type</span> Expression <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// RawExpr 代表原生表达式</span>
<span class="token keyword">type</span> RawExpr <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    raw  <span class="token builtin">string</span>
    args <span class="token punctuation">[</span><span class="token punctuation">]</span>any
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r RawExpr<span class="token punctuation">)</span> <span class="token function">selectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r RawExpr<span class="token punctuation">)</span> <span class="token function">expr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Raw</span><span class="token punctuation">(</span>expr <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span>any<span class="token punctuation">)</span> RawExpr <span class="token punctuation">{</span>
    <span class="token keyword">return</span> RawExpr<span class="token punctuation">{</span>
        raw<span class="token punctuation">:</span>  expr<span class="token punctuation">,</span>
        args<span class="token punctuation">:</span> args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r RawExpr<span class="token punctuation">)</span> <span class="token function">AsPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Predicate<span class="token punctuation">{</span>
     <span class="token keyword">return</span> Predicate<span class="token punctuation">{</span>
         left<span class="token punctuation">:</span> r<span class="token punctuation">,</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="8-SELECT-进阶：别名"><a href="#8-SELECT-进阶：别名" class="headerlink" title="8. SELECT 进阶：别名"></a>8. SELECT 进阶：别名</h3><p><img src="0b7991f2.png"><img src="39010d7a.png"><img src="1494ab6b.png"><img src="7d933c14.png"><img src="2df631a0.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// builder.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>builder<span class="token punctuation">)</span> <span class="token function">buildColumn</span><span class="token punctuation">(</span>c Column<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>c<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true">// 传入了错误的字段</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>alias <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" AS `"</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>alias<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// column.go</span>
<span class="token keyword">type</span> Column <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name  <span class="token builtin">string</span>
    alias <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 不可变设计</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c Column<span class="token punctuation">)</span> <span class="token function">As</span><span class="token punctuation">(</span>alias <span class="token builtin">string</span><span class="token punctuation">)</span> Column <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Column<span class="token punctuation">{</span>
        name<span class="token punctuation">:</span>  c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        alias<span class="token punctuation">:</span> alias<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestSelector_Select</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//db := memoryDB(t)</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name      <span class="token builtin">string</span>
        s         QueryBuilder
        wantQuery <span class="token operator">*</span>Query
        wantErr   <span class="token builtin">error</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"column alias"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>    NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token string">"my_name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"SELECT `first_name` AS `my_name` FROM `test_model`;"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"column alias agg"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>    NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token function">Avg</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token string">"my_name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"SELECT AVG(`first_name`) AS `my_name` FROM `test_model`;"</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"column alias in where"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">:</span>    NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span><span class="token string">"my_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"SELECT * FROM `test_model` WHERE `id` = ?;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// aggregate.go</span>
<span class="token keyword">type</span> Aggregate <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    fn    <span class="token builtin">string</span>
    arg   <span class="token builtin">string</span>
    alias <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a Aggregate<span class="token punctuation">)</span> <span class="token function">As</span><span class="token punctuation">(</span>alias <span class="token builtin">string</span><span class="token punctuation">)</span> Aggregate <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Aggregate<span class="token punctuation">{</span>
        fn<span class="token punctuation">:</span>    a<span class="token punctuation">.</span>fn<span class="token punctuation">,</span>
        arg<span class="token punctuation">:</span>   a<span class="token punctuation">.</span>arg<span class="token punctuation">,</span>
        alias<span class="token punctuation">:</span> alias<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="INSERT"><a href="#INSERT" class="headerlink" title="INSERT"></a>INSERT</h2><h3 id="9-INSERT：INSERT-语句概览"><a href="#9-INSERT：INSERT-语句概览" class="headerlink" title="9. INSERT：INSERT 语句概览"></a>9. INSERT：INSERT 语句概览</h3><p><img src="51346e5d.png"><img src="6544d33c.png"><img src="5661d957.png"><img src="c364304d.png"><img src="767e79c5.png"></p>
<h3 id="10-INSERT：最简实现"><a href="#10-INSERT：最简实现" class="headerlink" title="10. INSERT：最简实现"></a>10. INSERT：最简实现</h3><p><img src="7cd89da8.png"><img src="673197b1.png"><img src="61325ac5.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// model.go</span>
<span class="token keyword">type</span> Model <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    TableName <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 为了保证顺序遍历</span>
    Fields <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Field
    <span class="token comment" spellcheck="true">// 字段名-字段定义</span>
    FieldMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field
    <span class="token comment" spellcheck="true">// 列名-字段定义</span>
    ColumnMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Field
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>registry<span class="token punctuation">)</span> <span class="token function">Registry</span><span class="token punctuation">(</span>entity any<span class="token punctuation">,</span> opts <span class="token operator">...</span>ModelOpt<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Model<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>Model<span class="token punctuation">{</span>
        TableName<span class="token punctuation">:</span> tableName<span class="token punctuation">,</span>
        FieldMap<span class="token punctuation">:</span>  fieldMap<span class="token punctuation">,</span>
        ColumnMap<span class="token punctuation">:</span> columnMap<span class="token punctuation">,</span>
        Fields<span class="token punctuation">:</span>    fields<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"reflect"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Inserter<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    values <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>T
    db     <span class="token operator">*</span>DB
<span class="token punctuation">}</span>

<span class="token keyword">func</span> NewInserter<span class="token punctuation">[</span>T any<span class="token punctuation">]</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">{</span>
        db<span class="token punctuation">:</span> db<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Values</span><span class="token punctuation">(</span>vals <span class="token operator">...</span><span class="token operator">*</span>T<span class="token punctuation">)</span> <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    i<span class="token punctuation">.</span>values <span class="token operator">=</span> vals
    <span class="token keyword">return</span> i
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrInsertZeroRow
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> sb strings<span class="token punctuation">.</span>Builder
    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO "</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 拿到元数据</span>
    m<span class="token punctuation">,</span> err <span class="token operator">:=</span> i<span class="token punctuation">.</span>db<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 拼接表名</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>TableName<span class="token punctuation">)</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 显示地指定列的顺序,不然很难处理</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 遍历map的顺序是随机的,不能遍历fieldmap或colmap拼接(x,x,x,x)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>Fields <span class="token punctuation">{</span>
        <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>

    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" VALUES "</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//sb.WriteByte('(')</span>
    args <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Fields<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> j<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>values <span class="token punctuation">{</span>
        <span class="token keyword">if</span> j <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>Fields <span class="token punctuation">{</span>
            <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 读取参数</span>
            arg <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">FieldByName</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>GoName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> arg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span>  sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Args<span class="token punctuation">:</span> args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert_test.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestInserter_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>
        i    QueryBuilder

        wantErr   <span class="token builtin">error</span>
        wantQuery <span class="token operator">*</span>Query
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 插入一行</span>
            name<span class="token punctuation">:</span> <span class="token string">"single insert"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                Id<span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span>  <span class="token string">"INSERT INTO `test_model`(`id`,`first_name`,`age`,`last_name`) VALUES (?,?,?,?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 插入多行</span>
            name<span class="token punctuation">:</span> <span class="token string">"multiple insert"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span>
                <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                    Id<span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                    Id<span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Dummy"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Shan"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"INSERT INTO `test_model`(`id`,`first_name`,`age`,`last_name`) VALUES (?,?,?,?),(?,?,?,?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Dummy"</span><span class="token punctuation">,</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Shan"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 插入多行</span>
            name<span class="token punctuation">:</span>    <span class="token string">"no rowinsert"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span>       NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span>ErrInsertZeroRow<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>i<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="11-INSERT：指定列"><a href="#11-INSERT：指定列" class="headerlink" title="11. INSERT：指定列"></a>11. INSERT：指定列</h3><p><img src="cc44c1ab.png"><img src="6d1880d1.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Columns</span><span class="token punctuation">(</span>cols <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    i<span class="token punctuation">.</span>columns <span class="token operator">=</span> cols
    <span class="token keyword">return</span> i
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>

    fields <span class="token operator">:=</span> m<span class="token punctuation">.</span>Fields
    <span class="token comment" spellcheck="true">// 用户指定了列</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>columns<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        fields <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>model<span class="token punctuation">.</span>Field<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fd <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>columns <span class="token punctuation">{</span>
            fdMeta<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
            <span class="token comment" spellcheck="true">// 传入错误的列</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            fields <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fields<span class="token punctuation">,</span> fdMeta<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 遍历map的顺序是随机的,不能遍历fieldmap或colmap拼接(x,x,x,x)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> fields <span class="token punctuation">{</span>
        <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>

    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" VALUES "</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//sb.WriteByte('(')</span>
    args <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">len</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> j<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>values <span class="token punctuation">{</span>
        <span class="token keyword">if</span> j <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> fields <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span>  sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Args<span class="token punctuation">:</span> args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestInserter_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>
        i    QueryBuilder

        wantErr   <span class="token builtin">error</span>
        wantQuery <span class="token operator">*</span>Query
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 部分列</span>
            name<span class="token punctuation">:</span> <span class="token string">"partial columns"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Columns</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">,</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Values</span><span class="token punctuation">(</span>
                    <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                        Id<span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                        Id<span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Dummy"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"INSERT INTO `test_model`(`id`,`first_name`) VALUES (?,?),(?,?);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Dummy"</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="12-INSERT：UPSERT-API-定义"><a href="#12-INSERT：UPSERT-API-定义" class="headerlink" title="12. INSERT：UPSERT API 定义"></a>12. INSERT：UPSERT API 定义</h3><p><img src="c3ac1564.png"><img src="e4987cf4.png"><img src="4930bbe1.png"><img src="57229700.png"><img src="4551e240.png"><br><img src="57c70e1c.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert.go</span>
<span class="token keyword">type</span> OnDuplicateKeyBuilder<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> OnDuplicateKey<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    assigns <span class="token punctuation">[</span><span class="token punctuation">]</span>Assignable
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Assignable <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Inserter<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    values  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>T
    db      <span class="token operator">*</span>DB
    columns <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">//onDuplicateKey []Assignable</span>
    onDuplicateKey <span class="token operator">*</span>OnDuplicateKey<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//func (i *Inserter[T]) OnDuplicateKey(assigns ...Assignable) *Inserter[T] {</span>
<span class="token comment" spellcheck="true">//    i.onDuplicateKey = assigns</span>
<span class="token comment" spellcheck="true">//    return i</span>
<span class="token comment" spellcheck="true">//}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>OnDuplicateKeyBuilder<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>assigns <span class="token operator">...</span>Assignable<span class="token punctuation">)</span> <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>onDuplicateKey <span class="token operator">=</span> <span class="token operator">&amp;</span>OnDuplicateKey<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">{</span>
        assigns<span class="token punctuation">:</span> assigns<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> o<span class="token punctuation">.</span>i
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">OnDuplicateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>OnDuplicateKeyBuilder<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>OnDuplicateKeyBuilder<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">{</span>
        i<span class="token punctuation">:</span> i<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="13-INSERT：MySQL-UPSERT-基本实现"><a href="#13-INSERT：MySQL-UPSERT-基本实现" class="headerlink" title="13. INSERT：MySQL UPSERT 基本实现"></a>13. INSERT：MySQL UPSERT 基本实现</h3><p><img src="3960a275.png"><img src="d56f5753.png"><img src="2b1ecb9e.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>i Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" VALUES "</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//sb.WriteByte('(')</span>
    args <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">len</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> j<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>values <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// on duplicate</span>
    <span class="token keyword">if</span> i<span class="token punctuation">.</span>onDuplicateKey <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" ON DUPLICATE KEY UPDATE "</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> assign <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>onDuplicateKey<span class="token punctuation">.</span>assigns <span class="token punctuation">{</span>
            <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">switch</span> a <span class="token operator">:=</span> assign<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> Assignment<span class="token punctuation">:</span>
                fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>a<span class="token punctuation">.</span>col<span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>col<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"=?"</span><span class="token punctuation">)</span>
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> a<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
            <span class="token keyword">case</span> Column<span class="token punctuation">:</span>
                fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>a<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"=VALUES("</span><span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
                sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnsupportedAssignable</span><span class="token punctuation">(</span>assign<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span>  sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Args<span class="token punctuation">:</span> args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// assignment.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">type</span> Assignment <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    col <span class="token builtin">string</span>
    val any
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>Assignment<span class="token punctuation">)</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Assign</span><span class="token punctuation">(</span>col <span class="token builtin">string</span><span class="token punctuation">,</span> val any<span class="token punctuation">)</span> Assignment <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Assignment<span class="token punctuation">{</span>
        col<span class="token punctuation">:</span> col<span class="token punctuation">,</span> val<span class="token punctuation">:</span> val<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestInserter_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>
        i    QueryBuilder

        wantErr   <span class="token builtin">error</span>
        wantQuery <span class="token operator">*</span>Query
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"upsert"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                Id<span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">OnDuplicateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>
                <span class="token function">Assign</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">,</span> <span class="token string">"Deng"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">Assign</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"INSERT INTO `test_model`(`id`,`first_name`,`age`,`last_name`) VALUES (?,?,?,?)"</span> <span class="token operator">+</span>
                    <span class="token string">" ON DUPLICATE KEY UPDATE `first_name`=?,`age`=?;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"Deng"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"update insert column"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span>
                <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                    Id<span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                    Id<span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Dummy"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Shan"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">OnDuplicateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"INSERT INTO `test_model`(`id`,`first_name`,`age`,`last_name`) VALUES (?,?,?,?),(?,?,?,?)"</span> <span class="token operator">+</span>
                    <span class="token string">" ON DUPLICATE KEY UPDATE `first_name`=VALUES(`first_name`),`age`=VALUES(`age`);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Dummy"</span><span class="token punctuation">,</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Shan"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>i<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="14-INSERT：方言抽象-Dialect"><a href="#14-INSERT：方言抽象-Dialect" class="headerlink" title="14. INSERT：方言抽象 Dialect"></a>14. INSERT：方言抽象 Dialect</h3><p><img src="0ec59668.png"><img src="41188968.png"><img src="5d4113d2.png"><img src="de7ad698.png"><img src="3c16d4bb.png"><img src="2ed34148.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// dialect.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Dialect <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// quoter 就是为了解决引号问题</span>
    <span class="token comment" spellcheck="true">// Mysql</span>
    <span class="token function">quoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">byte</span>

    <span class="token function">buildOnDuplicateKey</span><span class="token punctuation">(</span>sb strings<span class="token punctuation">.</span>Builder<span class="token punctuation">,</span> odk <span class="token operator">*</span>OnDuplicateKey<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> standardSQL <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s standardSQL<span class="token punctuation">)</span> <span class="token function">quoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">byte</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//TODO implement me</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"implement me"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s standardSQL<span class="token punctuation">)</span> <span class="token function">buildOnDuplicateKey</span><span class="token punctuation">(</span>sb strings<span class="token punctuation">.</span>Builder<span class="token punctuation">,</span> odk <span class="token operator">*</span>OnDuplicateKey<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//TODO implement me</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"implement me"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> mysqlDialect <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    standardSQL
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m mysqlDialect<span class="token punctuation">)</span> <span class="token function">quoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">byte</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'`'</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m mysqlDialect<span class="token punctuation">)</span> <span class="token function">buildOnDuplicateKey</span><span class="token punctuation">(</span>sb strings<span class="token punctuation">.</span>Builder<span class="token punctuation">,</span> odk <span class="token operator">*</span>OnDuplicateKey<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> sqliteDialect <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    standardSQL
<span class="token punctuation">}</span>

<span class="token keyword">type</span> postgreDialect <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    standardSQL
<span class="token punctuation">}</span>
</code></pre>
<h3 id="15-INSERT：builder-抽象与重构"><a href="#15-INSERT：builder-抽象与重构" class="headerlink" title="15. INSERT：builder 抽象与重构"></a>15. INSERT：builder 抽象与重构</h3><p><img src="f1fa1b34.png"><img src="60bf1454.png"><img src="47e29280.png"><img src="07c6ea80.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// build.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"my_framework/orm/model"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> builder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    sb    <span class="token operator">*</span>strings<span class="token punctuation">.</span>Builder
    model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model
    args  <span class="token punctuation">[</span><span class="token punctuation">]</span>any

    dialect Dialect
    quoter  <span class="token builtin">byte</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>builder<span class="token punctuation">)</span> <span class="token function">quote</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>quoter<span class="token punctuation">)</span>
    b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>quoter<span class="token punctuation">)</span>
<span class="token punctuation">}</span> 

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>builder<span class="token punctuation">)</span> <span class="token function">buildExpression</span><span class="token punctuation">(</span>expr Expression<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> exp <span class="token operator">:=</span> expr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
    <span class="token keyword">case</span> Predicate<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// 处理p</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> exp<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token punctuation">(</span>Predicate<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> exp<span class="token punctuation">.</span>op <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>op<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">=</span> exp<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token punctuation">(</span>Predicate<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">case</span> Column<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">// 防止where加as</span>
        exp<span class="token punctuation">.</span>alias <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">buildColumn</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
    <span class="token keyword">case</span> value<span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
    <span class="token keyword">case</span> RawExpr<span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>raw<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>args<span class="token operator">...</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnsupportedExpression</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span> 

<span class="token comment" spellcheck="true">// ...</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert.go</span>
<span class="token keyword">type</span> Inserter<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    builder
    values  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>T
    db      <span class="token operator">*</span>DB
    columns <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">//onDuplicateKey []Assignable</span>
    onDuplicateKey <span class="token operator">*</span>OnDuplicateKey
<span class="token punctuation">}</span>

<span class="token keyword">func</span> NewInserter<span class="token punctuation">[</span>T any<span class="token punctuation">]</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">{</span>
        builder<span class="token punctuation">:</span> builder<span class="token punctuation">{</span>
            dialect<span class="token punctuation">:</span> db<span class="token punctuation">.</span>dialect<span class="token punctuation">,</span>
            quoter<span class="token punctuation">:</span>  db<span class="token punctuation">.</span>dialect<span class="token punctuation">.</span><span class="token function">quoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sb<span class="token punctuation">:</span> <span class="token operator">&amp;</span>strings<span class="token punctuation">.</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        db<span class="token punctuation">:</span> db<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrInsertZeroRow
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//var sb strings.Builder</span>
    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO "</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 拿到元数据</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    i<span class="token punctuation">.</span>model<span class="token punctuation">,</span> err <span class="token operator">=</span> i<span class="token punctuation">.</span>db<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 拼接表名</span>
    <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
    <span class="token comment" spellcheck="true">//sb.WriteString(m.TableName)</span>
    <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
    i<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TableName<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 显示地指定列的顺序,不然很难处理</span>
    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>

    fields <span class="token operator">:=</span> i<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Fields
    <span class="token comment" spellcheck="true">// 用户指定了列</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>columns<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        fields <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>model<span class="token punctuation">.</span>Field<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fd <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>columns <span class="token punctuation">{</span>
            fdMeta<span class="token punctuation">,</span> ok <span class="token operator">:=</span> i<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
            <span class="token comment" spellcheck="true">// 传入错误的列</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            fields <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fields<span class="token punctuation">,</span> fdMeta<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 遍历map的顺序是随机的,不能遍历fieldmap或colmap拼接(x,x,x,x)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> fields <span class="token punctuation">{</span>
        <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//i.sb.WriteByte('`')</span>
        <span class="token comment" spellcheck="true">//i.sb.WriteString(field.ColName)</span>
        <span class="token comment" spellcheck="true">//i.sb.WriteByte('`')</span>
        i<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>

    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" VALUES "</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//sb.WriteByte('(')</span>
    i<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">len</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> j<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>values <span class="token punctuation">{</span>
        <span class="token keyword">if</span> j <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> fields <span class="token punctuation">{</span>
            <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
                i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 读取参数</span>
            arg <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">FieldByName</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>GoName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">//args = append(args, arg)</span>
            i<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// on duplicate</span>
    <span class="token keyword">if</span> i<span class="token punctuation">.</span>onDuplicateKey <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> i<span class="token punctuation">.</span>dialect<span class="token punctuation">.</span><span class="token function">buildOnDuplicateKey</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">.</span>builder<span class="token punctuation">,</span> i<span class="token punctuation">.</span>onDuplicateKey<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span>  i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Args<span class="token punctuation">:</span> i<span class="token punctuation">.</span>args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// select.go</span>
<span class="token keyword">type</span> Selector<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    builder
    table   <span class="token builtin">string</span>
    where   <span class="token punctuation">[</span><span class="token punctuation">]</span>Predicate
    db      <span class="token operator">*</span>DB
    columns <span class="token punctuation">[</span><span class="token punctuation">]</span>Selectable
<span class="token punctuation">}</span>

<span class="token keyword">func</span> NewSelector<span class="token punctuation">[</span>T any<span class="token punctuation">]</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">{</span>
        builder<span class="token punctuation">:</span> builder<span class="token punctuation">{</span>
            dialect<span class="token punctuation">:</span> db<span class="token punctuation">.</span>dialect<span class="token punctuation">,</span>
            quoter<span class="token punctuation">:</span>  db<span class="token punctuation">.</span>dialect<span class="token punctuation">.</span><span class="token function">quoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sb<span class="token punctuation">:</span> <span class="token operator">&amp;</span>strings<span class="token punctuation">.</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        db<span class="token punctuation">:</span> db<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//var sb strings.Builder</span>
    s<span class="token punctuation">.</span>sb <span class="token operator">=</span> <span class="token operator">&amp;</span>strings<span class="token punctuation">.</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 指针类型一定要初始化</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    s<span class="token punctuation">.</span>model<span class="token punctuation">,</span> err <span class="token operator">=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// new(T) 生成T的指针</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    sb <span class="token operator">:=</span> s<span class="token punctuation">.</span>sb

    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"SELECT "</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">buildColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">` FROM `</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> s<span class="token punctuation">.</span>table <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TableName<span class="token punctuation">)</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//segs := strings.Split(s.table, ".")</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>table<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>where<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" WHERE "</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">buildPredicates</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>where<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span>  sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Args<span class="token punctuation">:</span> s<span class="token punctuation">.</span>args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// db.go</span>
<span class="token comment" spellcheck="true">// DB 是一个sql.DB的装饰器</span>
<span class="token keyword">type</span> DB <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    r       model<span class="token punctuation">.</span>Registry
    db      <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB
    creator valuer<span class="token punctuation">.</span>Creator
    dialect Dialect
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">DBWithDialect</span><span class="token punctuation">(</span>d Dialect<span class="token punctuation">)</span> DBOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span>dialect <span class="token operator">=</span> d
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">OpenDB</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> opts <span class="token operator">...</span>DBOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res <span class="token operator">:=</span> <span class="token operator">&amp;</span>DB<span class="token punctuation">{</span>
        r<span class="token punctuation">:</span>       model<span class="token punctuation">.</span><span class="token function">NewRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        db<span class="token punctuation">:</span>      db<span class="token punctuation">,</span>
        creator<span class="token punctuation">:</span> valuer<span class="token punctuation">.</span>NewUnsafeValue<span class="token punctuation">,</span>
        dialect<span class="token punctuation">:</span> DialectMysql<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// dialect.go</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
    DialectMysql   Dialect <span class="token operator">=</span> mysqlDialect<span class="token punctuation">{</span><span class="token punctuation">}</span>
    DialectSqlLite Dialect <span class="token operator">=</span> sqliteDialect<span class="token punctuation">{</span><span class="token punctuation">}</span>
    DialectPostgre Dialect <span class="token operator">=</span> postgreDialect<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m mysqlDialect<span class="token punctuation">)</span> <span class="token function">buildOnDuplicateKey</span><span class="token punctuation">(</span>b <span class="token operator">*</span>builder<span class="token punctuation">,</span> odk <span class="token operator">*</span>OnDuplicateKey<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" ON DUPLICATE KEY UPDATE "</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> assign <span class="token operator">:=</span> <span class="token keyword">range</span> odk<span class="token punctuation">.</span>assigns <span class="token punctuation">{</span>
        <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> a <span class="token operator">:=</span> assign<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> Assignment<span class="token punctuation">:</span>
            fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>a<span class="token punctuation">.</span>col<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>col<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteString(fd.ColName)</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            b<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
            b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"=?"</span><span class="token punctuation">)</span>
            b<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
        <span class="token keyword">case</span> Column<span class="token punctuation">:</span>
            fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>a<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteString(fd.ColName)</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            b<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
            b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"=VALUES("</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteString(fd.ColName)</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            b<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
            b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnsupportedAssignable</span><span class="token punctuation">(</span>assign<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="16-INSERT：SQLite-UPSERT-实现、方言抽象局限性"><a href="#16-INSERT：SQLite-UPSERT-实现、方言抽象局限性" class="headerlink" title="16. INSERT：SQLite UPSERT 实现、方言抽象局限性"></a>16. INSERT：SQLite UPSERT 实现、方言抽象局限性</h3><p><img src="f5ae2874.png"><img src="2672fdd7.png"><img src="0aa7384f.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// dialect.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s sqliteDialect<span class="token punctuation">)</span> <span class="token function">quoter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">byte</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'`'</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s sqliteDialect<span class="token punctuation">)</span> <span class="token function">buildOnDuplicateKey</span><span class="token punctuation">(</span>b <span class="token operator">*</span>builder<span class="token punctuation">,</span> odk <span class="token operator">*</span>OnDuplicateKey<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" ON CONFLICT("</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> col <span class="token operator">:=</span> <span class="token keyword">range</span> odk<span class="token punctuation">.</span>conflictColumns <span class="token punctuation">{</span>
        <span class="token keyword">if</span> i <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        err <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token function">buildColumn</span><span class="token punctuation">(</span>Column<span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> col<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">") DO UPDATE SET "</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> assign <span class="token operator">:=</span> <span class="token keyword">range</span> odk<span class="token punctuation">.</span>assigns <span class="token punctuation">{</span>
        <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> a <span class="token operator">:=</span> assign<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> Assignment<span class="token punctuation">:</span>
            fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>a<span class="token punctuation">.</span>col<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>col<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteString(fd.ColName)</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            b<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
            b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"=?"</span><span class="token punctuation">)</span>
            b<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>val<span class="token punctuation">)</span>
        <span class="token keyword">case</span> Column<span class="token punctuation">:</span>
            fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>a<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteString(fd.ColName)</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            b<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
            b<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"=excluded."</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteString(fd.ColName)</span>
            <span class="token comment" spellcheck="true">//b.sb.WriteByte('`')</span>
            b<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnsupportedAssignable</span><span class="token punctuation">(</span>assign<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestSqlite_upsert_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"sqlite"</span><span class="token punctuation">,</span>
        <span class="token string">"file:test.db?cache=shared&amp;mode=memory"</span><span class="token punctuation">,</span>
        <span class="token function">DBWithDialect</span><span class="token punctuation">(</span>DialectSqlLite<span class="token punctuation">)</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>
        i    QueryBuilder

        wantErr   <span class="token builtin">error</span>
        wantQuery <span class="token operator">*</span>Query
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"upsert"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                Id<span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">OnDuplicateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConflictColumns</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">,</span> <span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>
                <span class="token function">Assign</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">,</span> <span class="token string">"Deng"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">Assign</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"INSERT INTO `test_model`(`id`,`first_name`,`age`,`last_name`) VALUES (?,?,?,?)"</span> <span class="token operator">+</span>
                    <span class="token string">" ON CONFLICT(`first_name`,`age`) UPDATE `first_name`=excluded.`first_name`,`age`=excluded.`age`;"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"Deng"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"update insert column"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span>
                <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                    Id<span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>
                    Id<span class="token punctuation">:</span> <span class="token number">13</span><span class="token punctuation">,</span> FirstName<span class="token punctuation">:</span> <span class="token string">"Dummy"</span><span class="token punctuation">,</span> Age<span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">,</span> LastName<span class="token punctuation">:</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Shan"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">OnDuplicateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"FirstName"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantQuery<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
                SQL<span class="token punctuation">:</span> <span class="token string">"INSERT INTO `test_model`(`id`,`first_name`,`age`,`last_name`) VALUES (?,?,?,?),(?,?,?,?)"</span> <span class="token operator">+</span>
                    <span class="token string">" ON DUPLICATE KEY UPDATE `first_name`=VALUES(`first_name`),`age`=VALUES(`age`);"</span><span class="token punctuation">,</span>
                Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Jerry"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Dummy"</span><span class="token punctuation">,</span> <span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">{</span>String<span class="token punctuation">:</span> <span class="token string">"Shan"</span><span class="token punctuation">,</span> Valid<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> tc<span class="token punctuation">.</span>i<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantQuery<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="17-INSERT：INSERT-执行"><a href="#17-INSERT：INSERT-执行" class="headerlink" title="17. INSERT：INSERT 执行"></a>17. INSERT：INSERT 执行</h3><p><img src="fa0726fb.png"><img src="ab4ee5c3.png"><img src="020159cc.png"><img src="9f08215d.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// types.go</span>
<span class="token keyword">type</span> Executor <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//Exec(ctx context.Context) (sql.Result, error)</span>
    <span class="token function">Exec</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> Result
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// result.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token string">"database/sql"</span>

<span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    err <span class="token builtin">error</span>
    res sql<span class="token punctuation">.</span>Result
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r Result<span class="token punctuation">)</span> <span class="token function">LastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> r<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> r<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">LastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r Result<span class="token punctuation">)</span> <span class="token function">RowsAffected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> r<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> r<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">RowsAffected</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r Result<span class="token punctuation">)</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> r<span class="token punctuation">.</span>err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert_test.go</span>
<span class="token keyword">func</span> <span class="token function">TestInserter_Exec</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mockDB<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> err <span class="token operator">:=</span> sqlmock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">OpenDB</span><span class="token punctuation">(</span>mockDB<span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        name <span class="token builtin">string</span>
        i    <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true">//wantRes Result</span>
        wantErr  <span class="token builtin">error</span>
        affected <span class="token builtin">int64</span>
    <span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"query error"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">Columns</span><span class="token punctuation">(</span><span class="token string">"Invalid"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span><span class="token string">"Invalid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"db error"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span> <span class="token punctuation">{</span>
                mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">WillReturnError</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"db error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            wantErr<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"db error"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"exec"</span><span class="token punctuation">,</span>
            i<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span> <span class="token punctuation">{</span>
                res <span class="token operator">:=</span> driver<span class="token punctuation">.</span><span class="token function">RowsAffected</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                mock<span class="token punctuation">.</span><span class="token function">ExpectExec</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO .*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">WillReturnResult</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                <span class="token keyword">return</span> NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            affected<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tc <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tc<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res <span class="token operator">:=</span> tc<span class="token punctuation">.</span>i<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            affected<span class="token punctuation">,</span> err <span class="token operator">:=</span> res<span class="token punctuation">.</span><span class="token function">RowsAffected</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>wantErr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tc<span class="token punctuation">.</span>affected<span class="token punctuation">,</span> affected<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Exec</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> Result <span class="token punctuation">{</span>
    q<span class="token punctuation">,</span> err <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Result<span class="token punctuation">{</span>
            err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> i<span class="token punctuation">.</span>db<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Result<span class="token punctuation">{</span>
        err<span class="token punctuation">:</span> err<span class="token punctuation">,</span> res<span class="token punctuation">:</span> res<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="18-INSERT：unsafe-读取字段、总结与面试要点"><a href="#18-INSERT：unsafe-读取字段、总结与面试要点" class="headerlink" title="18. INSERT：unsafe 读取字段、总结与面试要点"></a>18. INSERT：unsafe 读取字段、总结与面试要点</h3><p><img src="6279f847.png"><img src="0c1ba29a.png"><img src="36e12da7.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// insert.go </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">BuildUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrInsertZeroRow
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//var sb strings.Builder</span>
    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO "</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 拿到元数据</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    i<span class="token punctuation">.</span>model<span class="token punctuation">,</span> err <span class="token operator">=</span> i<span class="token punctuation">.</span>db<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 拼接表名</span>
    <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
    <span class="token comment" spellcheck="true">//sb.WriteString(m.TableName)</span>
    <span class="token comment" spellcheck="true">//sb.WriteByte('`')</span>
    i<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TableName<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 显示地指定列的顺序,不然很难处理</span>
    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>

    fields <span class="token operator">:=</span> i<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Fields
    <span class="token comment" spellcheck="true">// 用户指定了列</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>columns<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        fields <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>model<span class="token punctuation">.</span>Field<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fd <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>columns <span class="token punctuation">{</span>
            fdMeta<span class="token punctuation">,</span> ok <span class="token operator">:=</span> i<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
            <span class="token comment" spellcheck="true">// 传入错误的列</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            fields <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fields<span class="token punctuation">,</span> fdMeta<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 遍历map的顺序是随机的,不能遍历fieldmap或colmap拼接(x,x,x,x)</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> fields <span class="token punctuation">{</span>
        <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//i.sb.WriteByte('`')</span>
        <span class="token comment" spellcheck="true">//i.sb.WriteString(field.ColName)</span>
        <span class="token comment" spellcheck="true">//i.sb.WriteByte('`')</span>
        i<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>ColName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>

    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" VALUES "</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//sb.WriteByte('(')</span>
    i<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">len</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> j<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> i<span class="token punctuation">.</span>values <span class="token punctuation">{</span>
        <span class="token keyword">if</span> j <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
            i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>

        v <span class="token operator">:=</span> i<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">creator</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>model<span class="token punctuation">,</span> val<span class="token punctuation">)</span>

        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> fields <span class="token punctuation">{</span>
            <span class="token keyword">if</span> idx <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
                i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// 读取参数</span>
            arg<span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Filed</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>GoName<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//args = append(args, arg)</span>
            i<span class="token punctuation">.</span><span class="token function">addArg</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// on duplicate</span>
    <span class="token keyword">if</span> i<span class="token punctuation">.</span>onDuplicateKey <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> i<span class="token punctuation">.</span>dialect<span class="token punctuation">.</span><span class="token function">buildOnDuplicateKey</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">.</span>builder<span class="token punctuation">,</span> i<span class="token punctuation">.</span>onDuplicateKey<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Query<span class="token punctuation">{</span>
        SQL<span class="token punctuation">:</span>  i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Args<span class="token punctuation">:</span> i<span class="token punctuation">.</span>args<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// unsafe.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>u unsafeValue<span class="token punctuation">)</span> <span class="token function">Filed</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> u<span class="token punctuation">.</span>model<span class="token punctuation">.</span>FieldMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownField</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fdAddr <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token operator">+</span> fd<span class="token punctuation">.</span>Offset<span class="token punctuation">)</span>
    val <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">NewAt</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>Typ<span class="token punctuation">,</span> fdAddr<span class="token punctuation">)</span>
    <span class="token keyword">return</span> val<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// reflect.go</span>
<span class="token keyword">package</span> valuer

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"database/sql"</span>
    <span class="token string">"my_framework/orm/internal/errs"</span>
    <span class="token string">"my_framework/orm/model"</span>
    <span class="token string">"reflect"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> reflectValue <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model
    <span class="token comment" spellcheck="true">// 对应T的指针</span>
    <span class="token comment" spellcheck="true">//val any</span>
    val reflect<span class="token punctuation">.</span>Value
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r reflectValue<span class="token punctuation">)</span> <span class="token function">Filed</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//if _, ok := r.val.Type().FieldByName(name); !ok {</span>
    <span class="token comment" spellcheck="true">//    return nil, errors.New("")</span>
    <span class="token comment" spellcheck="true">//}</span>
    <span class="token comment" spellcheck="true">//val:=r.val.FieldByName(name)</span>
    <span class="token comment" spellcheck="true">//if val==(reflect.Value{}){</span>
    <span class="token comment" spellcheck="true">//    // err</span>
    <span class="token comment" spellcheck="true">//}</span>
    <span class="token keyword">return</span> r<span class="token punctuation">.</span>val<span class="token punctuation">.</span><span class="token function">FieldByName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token boolean">_</span> Creator <span class="token operator">=</span> NewReflectValue

<span class="token keyword">func</span> <span class="token punctuation">(</span>r reflectValue<span class="token punctuation">)</span> <span class="token function">SetColumns</span><span class="token punctuation">(</span>rows <span class="token operator">*</span>sql<span class="token punctuation">.</span>Rows<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>

    <span class="token comment" spellcheck="true">// 把vals填入tp</span>
    <span class="token comment" spellcheck="true">//tpValue := reflect.ValueOf(r.val)</span>
    tpValue <span class="token operator">:=</span> r<span class="token punctuation">.</span>val
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
        fd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ColumnMap<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            <span class="token keyword">return</span> errs<span class="token punctuation">.</span><span class="token function">NewErrUnknownColumn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        tpValue<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FieldByName</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>GoName<span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token comment" spellcheck="true">//Set(reflect.ValueOf(vals[i]).Elem())</span>
            <span class="token function">Set</span><span class="token punctuation">(</span>valElems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewReflectValue</span><span class="token punctuation">(</span>model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model<span class="token punctuation">,</span> val any<span class="token punctuation">)</span> Value <span class="token punctuation">{</span>
    <span class="token keyword">return</span> reflectValue<span class="token punctuation">{</span>
        model<span class="token punctuation">:</span> model<span class="token punctuation">,</span>
        val<span class="token punctuation">:</span>   reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// value.go</span>
<span class="token keyword">type</span> Value <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Filed</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">SetColumns</span><span class="token punctuation">(</span>rows <span class="token operator">*</span>sql<span class="token punctuation">.</span>Rows<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="b91aff44.png"></p>
<h3 id="20-第六周作业：丰富-SELECT-语句-选学-【更多IT资料加微信djy136928775638】"><a href="#20-第六周作业：丰富-SELECT-语句-选学-【更多IT资料加微信djy136928775638】" class="headerlink" title="20.第六周作业：丰富 SELECT 语句[选学]【更多IT资料加微信djy136928775638】"></a>20.第六周作业：丰富 SELECT 语句[选学]【更多IT资料加微信djy136928775638】</h3><h3 id="21-第六周-SELECT-作业讲解-选学-【更多IT资料加微信djy136928775638】"><a href="#21-第六周-SELECT-作业讲解-选学-【更多IT资料加微信djy136928775638】" class="headerlink" title="21.第六周 SELECT 作业讲解[选学]【更多IT资料加微信djy136928775638】"></a>21.第六周 SELECT 作业讲解[选学]【更多IT资料加微信djy136928775638】</h3><h1 id="13-第七周：ORM-框架之事务-API、AOP-方案与集成测试"><a href="#13-第七周：ORM-框架之事务-API、AOP-方案与集成测试" class="headerlink" title="13 第七周：ORM 框架之事务 API、AOP 方案与集成测试"></a>13 第七周：ORM 框架之事务 API、AOP 方案与集成测试</h1><h2 id="事务api"><a href="#事务api" class="headerlink" title="事务api"></a>事务api</h2><h3 id="1-事务-API：不同框架设计分析、设计与实现"><a href="#1-事务-API：不同框架设计分析、设计与实现" class="headerlink" title="1. 事务 API：不同框架设计分析、设计与实现"></a>1. 事务 API：不同框架设计分析、设计与实现</h3><p><img src="3f554a34.png"><img src="5ec981d0.png"><img src="9ed6f9ce.png"><img src="6f36bad9.png"><img src="187b3838.png"><br><img src="688d076e.png"><img src="6bda301c.png"><img src="ecd4eee2.png"><img src="89eecd3f.png"><img src="ce7932e5.png"></p>
<h3 id="2-事务-API：事务闭包-API、总结与面试要点"><a href="#2-事务-API：事务闭包-API、总结与面试要点" class="headerlink" title="2. 事务 API：事务闭包 API、总结与面试要点"></a>2. 事务 API：事务闭包 API、总结与面试要点</h3><p><img src="68793b5b.png"><img src="2f8d0af5.png"><img src="7fc08767.png"><img src="3f645271.png"><img src="46cdd43b.png"><br><img src="412ea42b.png"><img src="099b1c39.png"><img src="a1d94c3f.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/transaction.go</span>
<span class="token keyword">package</span> orm

<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">type</span> Tx <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx
    db <span class="token operator">*</span>DB

    <span class="token comment" spellcheck="true">// 给事务扩散方案</span>
    done <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Tx<span class="token punctuation">)</span> <span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    t<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Tx<span class="token punctuation">)</span> <span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    t<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Tx<span class="token punctuation">)</span> <span class="token function">RollbackIfNotCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    t<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span>
    err <span class="token operator">:=</span> t<span class="token punctuation">.</span>tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 已经提交过</span>
    <span class="token keyword">if</span> err <span class="token operator">==</span> sql<span class="token punctuation">.</span>ErrTxDone <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/db.go</span>
<span class="token keyword">package</span> orm

<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">type</span> txKey <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token function">BeginTxV2</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> opts <span class="token operator">*</span>sql<span class="token punctuation">.</span>TxOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>Tx<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>txKey<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    tx<span class="token punctuation">,</span> ok <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Tx<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 存在事务并且从未提交</span>
    <span class="token keyword">if</span> ok <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>tx<span class="token punctuation">.</span>done <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ctx<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">BeginTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> txKey<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 必须要已有事务</span>
<span class="token comment" spellcheck="true">//func (db *DB) BeginTxV3(ctx context.Context, opts *sql.TxOptions) (  *Tx, error) {</span>
<span class="token comment" spellcheck="true">//    val := ctx.Value(txKey{})</span>
<span class="token comment" spellcheck="true">//    tx, ok := val.(*Tx)</span>
<span class="token comment" spellcheck="true">//    if ok {</span>
<span class="token comment" spellcheck="true">//        return tx, nil</span>
<span class="token comment" spellcheck="true">//    }</span>
<span class="token comment" spellcheck="true">//    return  nil,errors.New("没有事务")</span>
<span class="token comment" spellcheck="true">//}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token function">DoTx</span><span class="token punctuation">(</span>
    ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span>
    fn <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> tx <span class="token operator">*</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">,</span>
    opts <span class="token operator">*</span>sql<span class="token punctuation">.</span>TxOptions<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">BeginTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>
    panicked <span class="token operator">:=</span> <span class="token boolean">true</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> panicked <span class="token operator">||</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            e <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            err <span class="token operator">=</span> errs<span class="token punctuation">.</span><span class="token function">NewErrFailedToRollbackTx</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> e<span class="token punctuation">,</span> panicked<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    err <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
    panicked <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre>
<h2 id="AOP-方案"><a href="#AOP-方案" class="headerlink" title="AOP 方案"></a>AOP 方案</h2><h3 id="3-AOP-方案：不同框架设计分析、方案总结"><a href="#3-AOP-方案：不同框架设计分析、方案总结" class="headerlink" title="3. AOP 方案：不同框架设计分析、方案总结"></a>3. AOP 方案：不同框架设计分析、方案总结</h3><p><img src="a7eb72ef.png"><img src="6620d7a1.png"><img src="590dbde8.png"><img src="44cf99c0.png"><img src="6d135179.png"><br><img src="472c9f98.png"><img src="da4bdde5.png"><img src="68a1d433.png"><img src="91f1e3d2.png"><img src="ef2e4250.png"><br><img src="0a685bc6.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/middleware.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token string">"context"</span>

<span class="token keyword">type</span> QueryContent <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 查询类型, 标记增删改查</span>
    Type <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 代表的是查询本身</span>
    Builder QueryBuilder
<span class="token punctuation">}</span>

<span class="token keyword">type</span> QueryResult <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Result 在不同查询下, 类型不同</span>
    <span class="token comment" spellcheck="true">// select *T/[]*T</span>
    <span class="token comment" spellcheck="true">// 其他就是 Result</span>
    Result any
    <span class="token comment" spellcheck="true">// Err 是查询本身出的问题</span>
    Err <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Handler <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> qc <span class="token operator">*</span>QueryContent<span class="token punctuation">)</span> <span class="token operator">*</span>QueryResult

<span class="token keyword">type</span> Middleware <span class="token keyword">func</span><span class="token punctuation">(</span>next Handler<span class="token punctuation">)</span> Handler
</code></pre>
<h3 id="4-AOP-方案：Middleware-接入与-querylog"><a href="#4-AOP-方案：Middleware-接入与-querylog" class="headerlink" title="4. AOP 方案：Middleware 接入与 querylog"></a>4. AOP 方案：Middleware 接入与 querylog</h3><p><img src="799fb956.png"><img src="67f2f820.png"><img src="d2c5f2ac.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">//orm/middleware/querylog/middleware_test.go</span>
<span class="token keyword">package</span> querylog

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"database/sql"</span>
    <span class="token boolean">_</span> <span class="token string">"github.com/go-sql-driver/mysql"</span>
    <span class="token string">"github.com/stretchr/testify/assert"</span>
    <span class="token string">"github.com/stretchr/testify/require"</span>
    <span class="token string">"my_framework/orm"</span>
    <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestMiddlewareBuilder_Build</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> query <span class="token builtin">string</span>
    <span class="token keyword">var</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span>any
    m <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>MiddlewareBuilder<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">LogFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>q <span class="token builtin">string</span><span class="token punctuation">,</span> as <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        query <span class="token operator">=</span> q
        args <span class="token operator">=</span> as
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> orm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span>
        <span class="token string">"root:123456@tcp(127.0.0.1:3307)/mybatis"</span><span class="token punctuation">,</span>
        orm<span class="token punctuation">.</span><span class="token function">DBWithMiddlewares</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    require<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> orm<span class="token punctuation">.</span>NewSelector<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>orm<span class="token punctuation">.</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string">"Id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM `test_model` WHERE `id` = ?;"</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>

    orm<span class="token punctuation">.</span>NewInserter<span class="token punctuation">[</span>TestModel<span class="token punctuation">]</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Values</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TestModel<span class="token punctuation">{</span>Id<span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"INSERT INTO `test_model`(`id`,`first_name`,`age`,`last_name`) VALUES (?,?,?,?);"</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span>
    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">{</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>sql<span class="token punctuation">.</span>NullString<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TestModel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Id        <span class="token builtin">int64</span>
    FirstName <span class="token builtin">string</span>
    Age       <span class="token builtin">int8</span>
    LastName  <span class="token operator">*</span>sql<span class="token punctuation">.</span>NullString
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/middleware/querylog/middleware.go</span>
<span class="token keyword">package</span> querylog

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"log"</span>
    <span class="token string">"my_framework/orm"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> MiddlewareBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    logFunc <span class="token keyword">func</span><span class="token punctuation">(</span>query <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//logFunc func(query string, args ...)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewMiddlewareBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>MiddlewareBuilder <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>MiddlewareBuilder<span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 用户自己提供日志打印</span>
        logFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>query <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"sql: %s, args: %v\n"</span><span class="token punctuation">,</span> query<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">LogFunc</span><span class="token punctuation">(</span>fn <span class="token keyword">func</span><span class="token punctuation">(</span>query <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span>any<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>MiddlewareBuilder <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span>logFunc <span class="token operator">=</span> fn
    <span class="token keyword">return</span> m
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> orm<span class="token punctuation">.</span>Middleware <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next orm<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> orm<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> qc <span class="token operator">*</span>orm<span class="token punctuation">.</span>QueryContent<span class="token punctuation">)</span> <span class="token operator">*</span>orm<span class="token punctuation">.</span>QueryResult <span class="token punctuation">{</span>

            q<span class="token punctuation">,</span> err <span class="token operator">:=</span> qc<span class="token punctuation">.</span>Builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 记录吗?</span>
                <span class="token comment" spellcheck="true">//log.Println("构造 SQL 出错", err)</span>
                <span class="token keyword">return</span> <span class="token operator">&amp;</span>orm<span class="token punctuation">.</span>QueryResult<span class="token punctuation">{</span>
                    Err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//log.Println("sql: %s, args: %v \n", q.SQL, q.Args)</span>
            m<span class="token punctuation">.</span><span class="token function">logFunc</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token punctuation">)</span>

            res <span class="token operator">:=</span> <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> qc<span class="token punctuation">)</span>
            <span class="token keyword">return</span> res
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">//orm/insert.go</span>
<span class="token keyword">package</span> orm

<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Exec</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> Result <span class="token punctuation">{</span>
    root <span class="token operator">:=</span> i<span class="token punctuation">.</span>execHandler
    <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>db<span class="token punctuation">.</span>mdls<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 遍历并使用中间件</span>
        root <span class="token operator">=</span> i<span class="token punctuation">.</span>db<span class="token punctuation">.</span>mdls<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    res <span class="token operator">:=</span> <span class="token function">root</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QueryContent<span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span>    <span class="token string">"INSERT"</span><span class="token punctuation">,</span>
        Builder<span class="token punctuation">:</span> i<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> sqlRes sql<span class="token punctuation">.</span>Result
    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        sqlRes <span class="token operator">=</span> res<span class="token punctuation">.</span>Result<span class="token punctuation">.</span><span class="token punctuation">(</span>sql<span class="token punctuation">.</span>Result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Result<span class="token punctuation">{</span>
        err<span class="token punctuation">:</span> res<span class="token punctuation">.</span>Err<span class="token punctuation">,</span>
        res<span class="token punctuation">:</span> sqlRes<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token boolean">_</span> Handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Inserter<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>execHandler

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">execHandler</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> qc <span class="token operator">*</span>QueryContent<span class="token punctuation">)</span> <span class="token operator">*</span>QueryResult <span class="token punctuation">{</span>
    q<span class="token punctuation">,</span> err <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>QueryResult<span class="token punctuation">{</span>
            Err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
            Result<span class="token punctuation">:</span> Result<span class="token punctuation">{</span>
                err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">,</span> err <span class="token operator">:=</span> i<span class="token punctuation">.</span>db<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>QueryResult<span class="token punctuation">{</span>
        Err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
        Result<span class="token punctuation">:</span> Result<span class="token punctuation">{</span>
            err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
            res<span class="token punctuation">:</span> res<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">//orm/select.go</span>
<span class="token keyword">package</span> orm

<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root <span class="token operator">:=</span> s<span class="token punctuation">.</span>getHandler
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>mdls<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 遍历并使用中间件</span>
        root <span class="token operator">=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>mdls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    res <span class="token operator">:=</span> <span class="token function">root</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QueryContent<span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span>    <span class="token string">"SELECT"</span><span class="token punctuation">,</span>
        Builder<span class="token punctuation">:</span> s<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span>Result<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>Err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>Err
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token boolean">_</span> Handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Selector<span class="token punctuation">[</span>any<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getHandler

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">getHandler</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> qc <span class="token operator">*</span>QueryContent<span class="token punctuation">)</span> <span class="token operator">*</span>QueryResult <span class="token punctuation">{</span>
    q<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>QueryResult<span class="token punctuation">{</span>
            Err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    db <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>db
    <span class="token comment" spellcheck="true">// 发起查询,并处理结果集</span>
    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> q<span class="token punctuation">.</span>SQL<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//_, err  = db.QueryContext(ctx, q.SQL, q.Args...)</span>
    <span class="token comment" spellcheck="true">// 查询错误</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>QueryResult<span class="token punctuation">{</span>
            Err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>QueryResult<span class="token punctuation">{</span>
            Err<span class="token punctuation">:</span> ErrNoRows<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    tp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>
    val <span class="token operator">:=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">creator</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>model<span class="token punctuation">,</span> tp<span class="token punctuation">)</span>
    err <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">SetColumns</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>QueryResult<span class="token punctuation">{</span>
        Result<span class="token punctuation">:</span> tp<span class="token punctuation">,</span>
        Err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/db.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">type</span> DB <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//r       model.Registry</span>
    db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB
    <span class="token comment" spellcheck="true">//creator valuer.Creator</span>
    <span class="token comment" spellcheck="true">//dialect Dialect</span>
    core
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">DBWithMiddlewares</span><span class="token punctuation">(</span>mdls <span class="token operator">...</span>Middleware<span class="token punctuation">)</span> DBOption <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token operator">*</span>DB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span>mdls <span class="token operator">=</span> mdls
        <span class="token comment" spellcheck="true">//db.mdls = append(db.mdls, mdls...)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ...</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/core.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"my_framework/orm/internal/valuer"</span>
    <span class="token string">"my_framework/orm/model"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> core <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    model   <span class="token operator">*</span>model<span class="token punctuation">.</span>Model
    dialect Dialect
    creator valuer<span class="token punctuation">.</span>Creator
    r       model<span class="token punctuation">.</span>Registry
    mdls    <span class="token punctuation">[</span><span class="token punctuation">]</span>Middleware
<span class="token punctuation">}</span>
</code></pre>
<h3 id="5-AOP-方案：Middleware-各种实现、总结与面试要点"><a href="#5-AOP-方案：Middleware-各种实现、总结与面试要点" class="headerlink" title="5. AOP 方案：Middleware 各种实现、总结与面试要点"></a>5. AOP 方案：Middleware 各种实现、总结与面试要点</h3><p><img src="4c06f5fa.png"><img src="0c88b4a0.png"><img src="91ee3314.png"><img src="b43869f9.png"><img src="7c5b3ed2.png"><img src="5257fae6.png"><br><img src="43be8cf7.png"><img src="bf380c74.png"><img src="eb481702.png"></p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/middleware/opentelemetry/middleware.go</span>
<span class="token keyword">package</span> opentelemetry

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"go.opentelemetry.io/otel"</span>
    <span class="token string">"go.opentelemetry.io/otel/attribute"</span>
    <span class="token string">"go.opentelemetry.io/otel/trace"</span>
    <span class="token string">"my_framework/orm"</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> instrumentationName <span class="token operator">=</span> <span class="token string">"orm/middleware/opentelemetry/middleware.go"</span>

<span class="token keyword">type</span> MiddlewareBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Tracer trace<span class="token punctuation">.</span>Tracer
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> orm<span class="token punctuation">.</span>Middleware <span class="token punctuation">{</span>
    <span class="token keyword">if</span> m<span class="token punctuation">.</span>Tracer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        m<span class="token punctuation">.</span>Tracer <span class="token operator">=</span> otel<span class="token punctuation">.</span><span class="token function">GetTracerProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Tracer</span><span class="token punctuation">(</span>instrumentationName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next orm<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> orm<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> qc <span class="token operator">*</span>orm<span class="token punctuation">.</span>QueryContent<span class="token punctuation">)</span> <span class="token operator">*</span>orm<span class="token punctuation">.</span>QueryResult <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// span name: select-test_model</span>
            <span class="token comment" spellcheck="true">// insert-test_model</span>
            tbl <span class="token operator">:=</span> qc<span class="token punctuation">.</span>Model<span class="token punctuation">.</span>TableName
            spanCtx<span class="token punctuation">,</span> span <span class="token operator">:=</span> m<span class="token punctuation">.</span>Tracer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s-%s"</span><span class="token punctuation">,</span> qc<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> tbl<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            q<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> qc<span class="token punctuation">.</span>Builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> q <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"sql"</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>SQL<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">,</span> tbl<span class="token punctuation">)</span><span class="token punctuation">)</span>
            span<span class="token punctuation">.</span><span class="token function">SetAttributes</span><span class="token punctuation">(</span>attribute<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"component"</span><span class="token punctuation">,</span> <span class="token string">"orm"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            res <span class="token operator">:=</span> <span class="token function">next</span><span class="token punctuation">(</span>spanCtx<span class="token punctuation">,</span> qc<span class="token punctuation">)</span>
            <span class="token keyword">if</span> res<span class="token punctuation">.</span>Err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                span<span class="token punctuation">.</span><span class="token function">RecordError</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/middleware/prometheus/middleware.go</span>
<span class="token keyword">package</span> prometheus

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"github.com/prometheus/client_golang/prometheus"</span>
    <span class="token string">"my_framework/orm"</span>
    <span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> MiddlewareBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Namespace <span class="token builtin">string</span>
    Subsystem <span class="token builtin">string</span>
    Name      <span class="token builtin">string</span>
    Help      <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m MiddlewareBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> orm<span class="token punctuation">.</span>Middleware <span class="token punctuation">{</span>
    vector <span class="token operator">:=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewSummaryVec</span><span class="token punctuation">(</span>prometheus<span class="token punctuation">.</span>SummaryOpts<span class="token punctuation">{</span>
        Namespace<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
        Subsystem<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Subsystem<span class="token punctuation">,</span>
        Name<span class="token punctuation">:</span>      m<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
        Help<span class="token punctuation">:</span>      m<span class="token punctuation">.</span>Help<span class="token punctuation">,</span>
        Objectives<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">float64</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">{</span>
            <span class="token number">0.5</span><span class="token punctuation">:</span>   <span class="token number">0.01</span><span class="token punctuation">,</span>
            <span class="token number">0.75</span><span class="token punctuation">:</span>  <span class="token number">0.01</span><span class="token punctuation">,</span>
            <span class="token number">0.90</span><span class="token punctuation">:</span>  <span class="token number">0.01</span><span class="token punctuation">,</span>
            <span class="token number">0.99</span><span class="token punctuation">:</span>  <span class="token number">0.001</span><span class="token punctuation">,</span>
            <span class="token number">0.999</span><span class="token punctuation">:</span> <span class="token number">0.0001</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"table"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 注册观察者</span>
    prometheus<span class="token punctuation">.</span><span class="token function">MustRegister</span><span class="token punctuation">(</span>vector<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 两次调用builder会panic</span>

    <span class="token comment" spellcheck="true">// errCounterVec 记录错误数</span>
    <span class="token comment" spellcheck="true">// histogram 也行</span>
    <span class="token comment" spellcheck="true">// active query</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next orm<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> orm<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> qc <span class="token operator">*</span>orm<span class="token punctuation">.</span>QueryContent<span class="token punctuation">)</span> <span class="token operator">*</span>orm<span class="token punctuation">.</span>QueryResult <span class="token punctuation">{</span>
            startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 执行时间</span>
                vector<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>qc<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> qc<span class="token punctuation">.</span>Model<span class="token punctuation">.</span>TableName<span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">Observe</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> qc<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/select.go</span>
<span class="token keyword">package</span> orm

<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//var sb strings.Builder</span>
    s<span class="token punctuation">.</span>sb <span class="token operator">=</span> <span class="token operator">&amp;</span>strings<span class="token punctuation">.</span>Builder<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 指针类型一定要初始化</span>

    <span class="token keyword">if</span> s<span class="token punctuation">.</span>model <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> err <span class="token builtin">error</span>
        s<span class="token punctuation">.</span>model<span class="token punctuation">,</span> err <span class="token operator">=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// new(T) 生成T的指针</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    sb <span class="token operator">:=</span> s<span class="token punctuation">.</span>sb

    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Selector<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    s<span class="token punctuation">.</span>model<span class="token punctuation">,</span> err <span class="token operator">=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// new(T) 生成T的指针</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    root <span class="token operator">:=</span> s<span class="token punctuation">.</span>getHandler

    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>mdls<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 遍历并使用中间件</span>
        root <span class="token operator">=</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span>mdls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    res <span class="token operator">:=</span> <span class="token function">root</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QueryContent<span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span>    <span class="token string">"SELECT"</span><span class="token punctuation">,</span>
        Builder<span class="token punctuation">:</span> s<span class="token punctuation">,</span>
        Model<span class="token punctuation">:</span>   s<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> res<span class="token punctuation">.</span>Result <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span>Result<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>Err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>Err
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/insert.go</span>

<span class="token keyword">package</span> orm
<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Query<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrInsertZeroRow
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//var sb strings.Builder</span>
    i<span class="token punctuation">.</span>sb<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO "</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    <span class="token keyword">if</span> i<span class="token punctuation">.</span>model <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 拿到元数据</span>
        i<span class="token punctuation">.</span>model<span class="token punctuation">,</span> err <span class="token operator">=</span> i<span class="token punctuation">.</span>db<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 拼接表名</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Inserter<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Exec</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> Result <span class="token punctuation">{</span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    i<span class="token punctuation">.</span>model<span class="token punctuation">,</span> err <span class="token operator">=</span> i<span class="token punctuation">.</span>db<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Result<span class="token punctuation">{</span>
            err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    root <span class="token operator">:=</span> i<span class="token punctuation">.</span>execHandler
    <span class="token comment" spellcheck="true">// ...</span>
    res <span class="token operator">:=</span> <span class="token function">root</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>QueryContent<span class="token punctuation">{</span>
        Type<span class="token punctuation">:</span>    <span class="token string">"INSERT"</span><span class="token punctuation">,</span>
        Builder<span class="token punctuation">:</span> i<span class="token punctuation">,</span>
        Model<span class="token punctuation">:</span>   i<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// orm/middleware.go</span>
<span class="token keyword">package</span> orm

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"my_framework/orm/model"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> QueryContent <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 查询类型, 标记增删改查</span>
    Type <span class="token builtin">string</span>
    <span class="token comment" spellcheck="true">// 代表的是查询本身</span>
    Builder QueryBuilder
    <span class="token comment" spellcheck="true">//</span>
    Model <span class="token operator">*</span>model<span class="token punctuation">.</span>Model
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ...</span>
</code></pre>
<h2 id="集成测试"><a href="#集成测试" class="headerlink" title="集成测试"></a>集成测试</h2><h3 id="6-集成测试：起步与-MySQL-的增删改查"><a href="#6-集成测试：起步与-MySQL-的增删改查" class="headerlink" title="6. 集成测试：起步与 MySQL 的增删改查"></a>6. 集成测试：起步与 MySQL 的增删改查</h3><p><img src="z/923d7504.png"><img src="z/2612ee29.png"><img src="z/b6fc7800.png"><img src="z/7024ccd2.png"><br>// … 跳过</p>
<h2 id="原生查询详解"><a href="#原生查询详解" class="headerlink" title="原生查询详解"></a>原生查询详解</h2><p><img src="z/5aa304ad.png"><img src="z/01e97cbf.png"><img src="z/66cb28f3.png"><img src="z/683088ef.png"><img src="z/f4abc296.png"></p>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff;
        background-color: #22AB38;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff;
        background-color: #019FE8;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs">
                        <li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li>
                        <li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('#reward .reward-link').on('click', function () {
            $('#rewardModal').openModal();
        });

        $('#rewardModal .close').on('click', function () {
            $('#rewardModal').closeModal();
        });
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://malred.github.io" class="b-link-green">malred-blog</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2023/09/11/backend/golang/ji-ke-shi-jian/go-shi-zhan-xun-lian-ying-y-8999/z/" class="b-link-green">Go 实战训练营</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '676b06df8b7379e50e35',
        clientSecret: '9159b4de0f716ba7bdab9bc02151a90e6961246b',
        repo: 'comment_repo',
        owner: 'malred',
        admin: "malred",
        id: '2023-09-11T19-34-53',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    
        <link rel="stylesheet" href="/libs/gitment/gitment-default.css">
<link rel="stylesheet" href="/css/gitment.css">

<div class="gitment-card card" data-aos="fade-up">
    <div id="gitment-content" class="card-content"></div>
</div>

<script src="/libs/gitment/gitment.js"></script>
<script>
var gitment = new Gitment({
    id: 'Mon Sep 11 2023 19:34:53 GMT+0800',
    owner: 'malred',
    repo: 'comment_repo',
    oauth: {
        client_id: '676b06df8b7379e50e35',
        client_secret: '9159b4de0f716ba7bdab9bc02151a90e6961246b'
    }
});

gitment.render('gitment-content');
</script>
    

    
        <div class="disqus-card card" data-aos="fade-up">
    <div id="disqus_thread" class="card-content">
        <noscript>Please enable JavaScript to view the
            <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
    </div>
</div>

<script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://malred.github.io/2023/09/11/backend/golang/ji-ke-shi-jian/go-shi-zhan-xun-lian-ying-y-8999/z/';
        this.page.identifier = '/2023/09/11/backend/golang/ji-ke-shi-jian/go-shi-zhan-xun-lian-ying-y-8999/z/';
        this.page.title = 'Go 实战训练营';
    };
    let disqus_shortname = '';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://blinkfox.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'mipjlux8dRwbE7yY1zP3v13z-gzGzoHsz',
        appKey: 'cIy0pwvRAK8cuOCZRjuoHHfy',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '留下友善的评论~'
    });
</script>
    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/09/11/frontend/zhu-feng-jia-gou-2021/z/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="珠峰架构2021">
                        
                        <span class="card-title">珠峰架构2021</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">预习课(架构)2021 第一期 Vue3 架构课任务 1：1.vue3 变化介绍_【海量资源-：www.1.com】
webpack(202011)(架构)(全)任务 1：1.201122.webpack 的核心概念_【海量资源-：www.</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2023-09-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%89%8D%E7%AB%AF/" class="post-category" target="_blank">
                                    前端
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%89%8D%E7%AB%AF/" target="_blank">
                        <span class="chip bg-color">前端</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/08/29/frontend/android/android-proxy/android-proxy/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="安卓项目下载问题解决">
                        
                        <span class="card-title">安卓项目下载问题解决</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">
在项目的 settings.gradle 里加入

pluginManagement {
    repositories {
        // 就是这个
        maven { url 'https://maven.aliy</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2023-08-29
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/android/" class="post-category" target="_blank">
                                    android
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/android/" target="_blank">
                        <span class="chip bg-color">android</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站由&copy;<a href="https://blinkfox.github.io/" target="_blank">Blinkfox</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">671.3k</span>
            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/malred" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:malguy2022@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2725953379" class="tooltipped" data-tooltip="QQ联系我: 2725953379" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<!--动态线条背景-->
<script type="text/javascript" color="122 103 238" opacity='0.7' zIndex="-2" count="200"
    src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
    </script>
<script src="/js/matery.js"></script>
<script src="/js/snow.js"></script>

<!-- 引用Aplayer和metingjs -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script>
<div id="my-aplayer" class="aplayer" data-id="7363940489" data-server="netease" data-type="playlist" data-fixed="true"
    // 吸底模式可以固定播放器于页面底部 data-autoplay="true" data-order="list" data-volume="0.55" data-theme="#cc543a"
    data-preload="auto"></div>  
<!-- <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script> -->
<!-- <script src="https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<script>
    // 对所有链接跳转事件绑定pjax容器container
    $(document).pjax('a[target!=_blank]', '.container', { fragment: '.container', timeout: 8000 })
</script> -->


<!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-MSEYRC5EW5"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-MSEYRC5EW5');
</script>



    <script src="/libs/others/clicklove.js"></script>


    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>